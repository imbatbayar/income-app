{
  "income-app": {
    "files": [
      {
        "path": "app/components/Map/DeliveryRouteMap.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport { MapContainer, TileLayer, Polyline, CircleMarker, Tooltip } from \"react-leaflet\";\r\nimport \"leaflet/dist/leaflet.css\";\r\nimport { useMemo } from \"react\";\r\nimport { makeCurvedLinePoints } from \"./useCurvedLine\";\r\n\r\ntype LatLng = { lat: number; lng: number };\r\n\r\nexport default function DeliveryRouteMap({\r\n  pickup,\r\n  dropoff,\r\n  height = 240,\r\n}: {\r\n  pickup: LatLng;\r\n  dropoff: LatLng;\r\n  height?: number;\r\n}) {\r\n  const points = useMemo(() => makeCurvedLinePoints(pickup, dropoff, 32), [pickup, dropoff]);\r\n\r\n  const center: [number, number] = [(pickup.lat + dropoff.lat) / 2, (pickup.lng + dropoff.lng) / 2];\r\n\r\n  const bounds = useMemo(() => {\r\n    const minLat = Math.min(pickup.lat, dropoff.lat);\r\n    const maxLat = Math.max(pickup.lat, dropoff.lat);\r\n    const minLng = Math.min(pickup.lng, dropoff.lng);\r\n    const maxLng = Math.max(pickup.lng, dropoff.lng);\r\n\r\n    const padLat = (maxLat - minLat) * 0.18 || 0.01;\r\n    const padLng = (maxLng - minLng) * 0.18 || 0.01;\r\n\r\n    return [\r\n      [minLat - padLat, minLng - padLng],\r\n      [maxLat + padLat, maxLng + padLng],\r\n    ] as [[number, number], [number, number]];\r\n  }, [pickup, dropoff]);\r\n\r\n  return (\r\n    <div style={{ height }}>\r\n      <MapContainer\r\n        center={center}\r\n        zoom={13}\r\n        bounds={bounds}\r\n        scrollWheelZoom={false}\r\n        style={{ height: \"100%\", width: \"100%\" }}\r\n      >\r\n        <TileLayer\r\n          attribution=\"&copy; OpenStreetMap contributors\"\r\n          url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\r\n        />\r\n\r\n        <Polyline positions={points} pathOptions={{ weight: 4, opacity: 0.9 }} />\r\n\r\n        <CircleMarker center={[pickup.lat, pickup.lng]} radius={8} pathOptions={{ color: \"#16a34a\", weight: 3 }}>\r\n          <Tooltip direction=\"top\" offset={[0, -10]} opacity={1}>\r\n            –ê–≤–∞—Ö\r\n          </Tooltip>\r\n        </CircleMarker>\r\n\r\n        <CircleMarker center={[dropoff.lat, dropoff.lng]} radius={8} pathOptions={{ color: \"#dc2626\", weight: 3 }}>\r\n          <Tooltip direction=\"top\" offset={[0, -10]} opacity={1}>\r\n            –•“Ø—Ä–≥—ç—Ö\r\n          </Tooltip>\r\n        </CircleMarker>\r\n      </MapContainer>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/components/Map/useCurvedLine.ts",
        "summary": "",
        "content": "// app/components/Map/useCurvedLine.ts\r\n// 2 —Ü—ç–≥–∏–π–Ω —Ö–æ–æ—Ä–æ–Ω–¥ \"–∑–∞–º —à–∏–≥\" —Ö–∞—Ä–∞–≥–¥–∞—Ö –Ω—É–º (curved polyline) “Ø“Ø—Å–≥—ç–Ω—ç.\r\n// ‚ö†Ô∏è Routing –ë–ò–® ‚Äî –∑”©–≤—Ö”©–Ω —á–∏–≥–ª—ç–ª–∏–π–Ω preview –¥“Ø—Ä—Å–ª—ç–ª.\r\n\r\ntype LatLng = { lat: number; lng: number };\r\n\r\nexport function makeCurvedLinePoints(a: LatLng, b: LatLng, segments = 24): [number, number][] {\r\n  // Midpoint\r\n  const mid = { lat: (a.lat + b.lat) / 2, lng: (a.lng + b.lng) / 2 };\r\n\r\n  // Vector from a -> b\r\n  const dx = b.lng - a.lng;\r\n  const dy = b.lat - a.lat;\r\n\r\n  // Distance (rough)\r\n  const dist = Math.sqrt(dx * dx + dy * dy);\r\n\r\n  // Perpendicular offset (tunable)\r\n  // dist –∏—Ö—Å—ç—Ö —Ç—É—Å–∞–º –±–∞–≥–∞ –∑—ç—Ä—ç–≥ –∏–ª“Ø“Ø –Ω—É–º –≥–∞—Ä–Ω–∞, –≥—ç—Ö–¥—ç—ç —Ö—ç—Ç \"—Å—ç—Ä–≤–∏–π—Ö–≥“Ø–π\"\r\n  const k = Math.min(0.25, Math.max(0.08, dist * 0.35));\r\n\r\n  // Perpendicular vector (-dx, dy)\r\n  const ctrl = {\r\n    lat: mid.lat + -dx * k,\r\n    lng: mid.lng + dy * k,\r\n  };\r\n\r\n  const pts: [number, number][] = [];\r\n  const n = Math.max(8, Math.min(80, segments));\r\n\r\n  for (let i = 0; i <= n; i++) {\r\n    const t = i / n;\r\n\r\n    // Quadratic Bezier:\r\n    // P(t) = (1-t)^2 A + 2(1-t)t C + t^2 B\r\n    const one = 1 - t;\r\n\r\n    const lat = one * one * a.lat + 2 * one * t * ctrl.lat + t * t * b.lat;\r\n    const lng = one * one * a.lng + 2 * one * t * ctrl.lng + t * t * b.lng;\r\n\r\n    pts.push([lat, lng]);\r\n  }\r\n\r\n  return pts;\r\n}\r\n"
      },
      {
        "path": "app/driver/delivery/[id]/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n/* ===========================\r\n * app/driver/delivery/[id]/page.tsx (FINAL)\r\n *\r\n * ‚úÖ DRIVER detail:\r\n * - OPEN: \"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç\" / \"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö\"\r\n * - ASSIGNED: –∑”©–≤—Ö”©–Ω —Å–æ–Ω–≥–æ–≥–¥—Å–æ–Ω –∂–æ–ª–æ–æ—á \"–ó–∞–º–¥ –≥–∞—Ä—Å–∞–Ω\" -> ON_ROUTE\r\n * - ON_ROUTE: –∑”©–≤—Ö”©–Ω —Å–æ–Ω–≥–æ–≥–¥—Å–æ–Ω –∂–æ–ª–æ–æ—á \"–•“Ø—Ä–≥—ç–ª—Å—ç–Ω\" -> DELIVERED\r\n * - ON_ROUTE / DELIVERED: \"–ú–∞—Ä–≥–∞–∞–Ω\" —Ç–æ–≤—á –±–∞–π–Ω–∞\r\n * - DISPUTE: \"–®–∏–π–¥—ç–≥–¥—Å—ç–Ω\" (DISPUTE -> CLOSED)\r\n * - DELIVERED: \"–¢”©–ª–±”©—Ä –∞–≤—Å–Ω–∞–∞ –±–∞—Ç–ª–∞—Ö\" (driver_confirmed_payment toggle)\r\n *   -> —Ö—ç—Ä—ç–≤ seller_marked_paid=true –±–æ–ª CLOSED (deliveryLogic.shouldCloseDelivery)\r\n * + Map: pickup(–Ω–æ–≥–æ–æ–Ω) -> dropoff(—É–ª–∞–∞–Ω) –Ω—É–º –∑—É—Ä–∞–∞—Å—Ç–∞–π preview (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –±–∞–π–≤–∞–ª)\r\n *\r\n * NOTE: –≠–Ω—ç —Ñ–∞–π–ª FINAL. –î–∞—Ö–∏–∂ –¥–∞–≤—Ç–∞–∂ –∑–∞—Å–∞—Ö–≥“Ø–π.\r\n * =========================== */\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useParams, useRouter, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport {\r\n  DeliveryStatus,\r\n  getDriverTabForStatus,\r\n  shouldCloseDelivery,\r\n} from \"@/lib/deliveryLogic\";\r\n\r\n// ‚úÖ relative import (alias –∞—Å—É—É–¥–∞–ª–≥“Ø–π)\r\nimport DeliveryRouteMap from \"../../../components/Map/DeliveryRouteMap\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryDetail = {\r\n  id: string;\r\n  seller_id: string;\r\n\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n\r\n  // ‚úÖ Map coords\r\n  pickup_lat: number | null;\r\n  pickup_lng: number | null;\r\n  dropoff_lat: number | null;\r\n  dropoff_lng: number | null;\r\n\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n\r\n  chosen_driver_id: string | null;\r\n\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n  closed_at: string | null;\r\n\r\n  dispute_reason: string | null;\r\n  dispute_opened_at: string | null;\r\n\r\n  seller_hidden: boolean;\r\n};\r\n\r\ntype BidLite = {\r\n  id: string;\r\n  driver_id: string;\r\n  delivery_id: string;\r\n  created_at: string;\r\n};\r\n\r\n// ---------------- helpers ----------------\r\n\r\nfunction fmtPrice(n: number | null | undefined) {\r\n  const v = Number(n || 0);\r\n  return v ? `${v.toLocaleString(\"mn-MN\")}‚ÇÆ` : \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n}\r\n\r\nfunction fmtDT(iso: string | null | undefined) {\r\n  if (!iso) return \"\";\r\n  try {\r\n    return new Date(iso).toLocaleString(\"mn-MN\", { hour12: false });\r\n  } catch {\r\n    return iso || \"\";\r\n  }\r\n}\r\n\r\nfunction typeLabel(deliveryType: string | null): { icon: string; label: string } {\r\n  switch (deliveryType) {\r\n    case \"apartment\":\r\n      return { icon: \"üèô\", label: \"–ë–∞–π—Ä\" };\r\n    case \"ger\":\r\n      return { icon: \"üè†\", label: \"–ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª\" };\r\n    case \"camp\":\r\n      return { icon: \"üèï\", label: \"–õ–∞–≥–µ—Ä\" };\r\n    case \"countryside\":\r\n      return { icon: \"üöå\", label: \"–û—Ä–æ–Ω –Ω—É—Ç–∞–≥\" };\r\n    default:\r\n      return { icon: \"üì¶\", label: \"–•“Ø—Ä–≥—ç–ª—Ç\" };\r\n  }\r\n}\r\n\r\nfunction badge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return { text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\", cls: \"bg-emerald-50 text-emerald-700 border-emerald-100\" };\r\n    case \"ASSIGNED\":\r\n      return { text: \"–¢–∞–Ω–¥ –æ–Ω–æ–æ—Å–æ–Ω\", cls: \"bg-sky-50 text-sky-700 border-sky-100\" };\r\n    case \"ON_ROUTE\":\r\n      return { text: \"–ó–∞–º–¥\", cls: \"bg-indigo-50 text-indigo-700 border-indigo-100\" };\r\n    case \"DELIVERED\":\r\n      return { text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\", cls: \"bg-amber-50 text-amber-700 border-amber-100\" };\r\n    case \"DISPUTE\":\r\n      return { text: \"–ú–∞—Ä–≥–∞–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    case \"CLOSED\":\r\n      return { text: \"–•–∞–∞–≥–¥—Å–∞–Ω\", cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n    case \"CANCELLED\":\r\n      return { text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    default:\r\n      return { text: status, cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n  }\r\n}\r\n\r\n// ---------------- page ----------------\r\n\r\nexport default function DriverDeliveryDetailPage() {\r\n  const router = useRouter();\r\n  const params = useParams<{ id: string }>();\r\n  const sp = useSearchParams();\r\n\r\n  const id = params?.id;\r\n  const backTab = sp.get(\"tab\");\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [delivery, setDelivery] = useState<DeliveryDetail | null>(null);\r\n\r\n  const [myBid, setMyBid] = useState<BidLite | null>(null);\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [msg, setMsg] = useState<string | null>(null);\r\n\r\n  const [bidLoading, setBidLoading] = useState(false);\r\n  const [cancelBidLoading, setCancelBidLoading] = useState(false);\r\n\r\n  const [markOnRouteLoading, setMarkOnRouteLoading] = useState(false);\r\n  const [markDeliveredLoading, setMarkDeliveredLoading] = useState(false);\r\n  const [confirmPayLoading, setConfirmPayLoading] = useState(false);\r\n\r\n  // dispute\r\n  const [showDispute, setShowDispute] = useState(false);\r\n  const [disputeReason, setDisputeReason] = useState(\"\");\r\n  const [disputeLoading, setDisputeLoading] = useState(false);\r\n  const [resolveLoading, setResolveLoading] = useState(false);\r\n\r\n  // ---------------- auth ----------------\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) return router.replace(\"/\");\r\n      const u: IncomeUser = JSON.parse(raw);\r\n      if (u.role !== \"driver\") return router.replace(\"/\");\r\n      setUser(u);\r\n    } catch {\r\n      router.replace(\"/\");\r\n    }\r\n  }, [router]);\r\n\r\n  // ---------------- fetch ----------------\r\n  useEffect(() => {\r\n    if (!user || !id) return;\r\n    void fetchAll();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user, id]);\r\n\r\n  async function fetchAll() {\r\n    setLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          seller_id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          pickup_lat,\r\n          pickup_lng,\r\n          dropoff_lat,\r\n          dropoff_lng,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          chosen_driver_id,\r\n          seller_marked_paid,\r\n          driver_confirmed_payment,\r\n          closed_at,\r\n          dispute_reason,\r\n          dispute_opened_at,\r\n          seller_hidden\r\n        `\r\n        )\r\n        .eq(\"id\", id)\r\n        .maybeSingle();\r\n\r\n      if (e1 || !data) {\r\n        setDelivery(null);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\");\r\n        return;\r\n      }\r\n\r\n      const d: DeliveryDetail = {\r\n        id: data.id,\r\n        seller_id: data.seller_id,\r\n        from_address: data.from_address,\r\n        to_address: data.to_address,\r\n        note: data.note,\r\n\r\n        pickup_lat: (data as any).pickup_lat ?? null,\r\n        pickup_lng: (data as any).pickup_lng ?? null,\r\n        dropoff_lat: (data as any).dropoff_lat ?? null,\r\n        dropoff_lng: (data as any).dropoff_lng ?? null,\r\n\r\n        status: data.status as DeliveryStatus,\r\n        created_at: data.created_at,\r\n        price_mnt: data.price_mnt,\r\n        delivery_type: data.delivery_type,\r\n        chosen_driver_id: data.chosen_driver_id,\r\n\r\n        seller_marked_paid: !!data.seller_marked_paid,\r\n        driver_confirmed_payment: !!data.driver_confirmed_payment,\r\n        closed_at: data.closed_at,\r\n\r\n        dispute_reason: (data as any).dispute_reason ?? null,\r\n        dispute_opened_at: (data as any).dispute_opened_at ?? null,\r\n\r\n        seller_hidden: !!(data as any).seller_hidden,\r\n      };\r\n\r\n      setDelivery(d);\r\n\r\n      // my bid\r\n      const { data: b, error: e2 } = await supabase\r\n        .from(\"driver_bids\")\r\n        .select(\"id, driver_id, delivery_id, created_at\")\r\n        .eq(\"delivery_id\", d.id)\r\n        .eq(\"driver_id\", user!.id)\r\n        .maybeSingle();\r\n\r\n      if (e2) setMyBid(null);\r\n      else setMyBid((b as any) || null);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  // ---------------- navigation ----------------\r\n  function goBack() {\r\n    if (backTab) return router.push(`/driver?tab=${encodeURIComponent(backTab)}`);\r\n    if (!delivery) return router.push(\"/driver?tab=OPEN\");\r\n    return router.push(`/driver?tab=${getDriverTabForStatus(delivery.status)}`);\r\n  }\r\n\r\n  // ---------------- derived ----------------\r\n  const isChosenDriver = useMemo(() => {\r\n    if (!delivery || !user) return false;\r\n    return !!delivery.chosen_driver_id && delivery.chosen_driver_id === user.id;\r\n  }, [delivery, user]);\r\n\r\n  const canBid = useMemo(() => {\r\n    if (!delivery) return false;\r\n    return delivery.status === \"OPEN\";\r\n  }, [delivery]);\r\n\r\n  const canMarkOnRoute = useMemo(() => {\r\n    if (!delivery) return false;\r\n    return delivery.status === \"ASSIGNED\" && isChosenDriver;\r\n  }, [delivery, isChosenDriver]);\r\n\r\n  const canMarkDelivered = useMemo(() => {\r\n    if (!delivery) return false;\r\n    return delivery.status === \"ON_ROUTE\" && isChosenDriver;\r\n  }, [delivery, isChosenDriver]);\r\n\r\n  // ‚úÖ –ú–∞—Ä–≥–∞–∞–Ω ‚Äî –∑”©–≤—Ö”©–Ω ON_ROUTE / DELIVERED\r\n  const canOpenDispute = useMemo(() => {\r\n    if (!delivery) return false;\r\n    if (delivery.status === \"DISPUTE\") return false;\r\n    return delivery.status === \"ON_ROUTE\" || delivery.status === \"DELIVERED\";\r\n  }, [delivery]);\r\n\r\n  const hasMap =\r\n    !!delivery &&\r\n    delivery.pickup_lat != null &&\r\n    delivery.pickup_lng != null &&\r\n    delivery.dropoff_lat != null &&\r\n    delivery.dropoff_lng != null;\r\n\r\n  // ---------------- actions ----------------\r\n\r\n  async function placeBid() {\r\n    if (!delivery || !user) return;\r\n    if (!canBid) {\r\n      setError(\"–ó”©–≤—Ö”©–Ω –ù—ç—ç–ª—Ç—Ç—ç–π “Ø–µ–¥ —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–Ω—ç.\");\r\n      return;\r\n    }\r\n    if (myBid) {\r\n      setError(\"–¢–∞ –∞–ª—å —Ö—ç–¥–∏–π–Ω —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Å—ç–Ω –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    setBidLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"driver_bids\")\r\n        .insert({ delivery_id: delivery.id, driver_id: user.id })\r\n        .select(\"id, driver_id, delivery_id, created_at\")\r\n        .maybeSingle();\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–•“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setMyBid((data as any) || null);\r\n      setMsg(\"–•“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–ª—ç—ç.\");\r\n    } finally {\r\n      setBidLoading(false);\r\n    }\r\n  }\r\n\r\n  async function cancelBid() {\r\n    if (!delivery || !user) return;\r\n    if (!myBid) return;\r\n\r\n    setCancelBidLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { error } = await supabase.from(\"driver_bids\").delete().eq(\"id\", myBid.id).eq(\"driver_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setMyBid(null);\r\n      setMsg(\"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞–≥–¥–ª–∞–∞.\");\r\n    } finally {\r\n      setCancelBidLoading(false);\r\n    }\r\n  }\r\n\r\n  async function markOnRoute() {\r\n    if (!delivery || !user) return;\r\n    if (!canMarkOnRoute) {\r\n      setError(\"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ç–∞–Ω–¥ –æ–Ω–æ–æ–≥–¥–æ–æ–≥“Ø–π —ç—Å–≤—ç–ª —Ç”©–ª”©–≤ –±—É—Ä—É—É –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    setMarkOnRouteLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"ON_ROUTE\" })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"status\", \"ASSIGNED\")\r\n        .eq(\"chosen_driver_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ó–∞–º–¥ –≥–∞—Ä—Å–∞–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"ON_ROUTE\" });\r\n      setMsg(\"–ó–∞–º–¥ –≥–∞—Ä—Å–∞–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\");\r\n      setTimeout(() => router.push(\"/driver?tab=ON_ROUTE\"), 450);\r\n    } finally {\r\n      setMarkOnRouteLoading(false);\r\n    }\r\n  }\r\n\r\n  async function markDelivered() {\r\n    if (!delivery || !user) return;\r\n    if (!canMarkDelivered) {\r\n      setError(\"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ç–∞–Ω–¥ –æ–Ω–æ–æ–≥–¥–æ–æ–≥“Ø–π —ç—Å–≤—ç–ª —Ç”©–ª”©–≤ –±—É—Ä—É—É –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    setMarkDeliveredLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"DELIVERED\" })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"status\", \"ON_ROUTE\")\r\n        .eq(\"chosen_driver_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–•“Ø—Ä–≥—ç—Å—ç–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"DELIVERED\" });\r\n      setMsg(\"–•“Ø—Ä–≥—ç—Å—ç–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\");\r\n      setTimeout(() => router.push(\"/driver?tab=DELIVERED\"), 450);\r\n    } finally {\r\n      setMarkDeliveredLoading(false);\r\n    }\r\n  }\r\n\r\n  async function toggleDriverConfirmedPayment() {\r\n    if (!delivery || !user) return;\r\n\r\n    if (!(delivery.status === \"DELIVERED\" || delivery.status === \"CLOSED\")) {\r\n      setError(\"–ó”©–≤—Ö”©–Ω '–•“Ø—Ä–≥—ç—Å—ç–Ω' “Ø–µ–¥ —Ç”©–ª–±”©—Ä –±–∞—Ç–∞–ª–Ω–∞.\");\r\n      return;\r\n    }\r\n    if (!isChosenDriver) {\r\n      setError(\"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ç–∞–Ω–¥ –æ–Ω–æ–æ–≥–¥–æ–æ–≥“Ø–π –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    setConfirmPayLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const next = !delivery.driver_confirmed_payment;\r\n\r\n      const willClose = shouldCloseDelivery({\r\n        status: delivery.status,\r\n        seller_marked_paid: delivery.seller_marked_paid,\r\n        driver_confirmed_payment: next,\r\n      });\r\n\r\n      const nextStatus: DeliveryStatus = willClose ? \"CLOSED\" : delivery.status;\r\n      const closedAt = willClose ? new Date().toISOString() : delivery.closed_at;\r\n\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          driver_confirmed_payment: next,\r\n          status: nextStatus,\r\n          closed_at: closedAt,\r\n        })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"chosen_driver_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–¢”©–ª–±”©—Ä –±–∞—Ç–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({\r\n        ...delivery,\r\n        driver_confirmed_payment: next,\r\n        status: nextStatus,\r\n        closed_at: closedAt,\r\n      });\r\n\r\n      setMsg(next ? \"–¢”©–ª–±”©—Ä –∞–≤—Å–Ω–∞–∞ –±–∞—Ç–∞–ª–ª–∞–∞.\" : \"–¢”©–ª–±”©—Ä–∏–π–Ω –±–∞—Ç–∞–ª–≥–∞–∞–≥ —Ü—É—Ü–∞–ª–ª–∞–∞.\");\r\n    } finally {\r\n      setConfirmPayLoading(false);\r\n    }\r\n  }\r\n\r\n  async function openDispute() {\r\n    if (!delivery || !user) return;\r\n\r\n    const reason = disputeReason.trim();\r\n    if (!reason) {\r\n      setError(\"–ú–∞—Ä–≥–∞–∞–Ω—ã —à–∞–ª—Ç–≥–∞–∞–Ω–∞–∞ –±–∏—á–Ω—ç “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!canOpenDispute) {\r\n      setError(\"–≠–Ω—ç —Ç”©–ª”©–≤ –¥—ç—ç—Ä –º–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö –±–æ–ª–æ–º–∂–≥“Ø–π.\");\r\n      return;\r\n    }\r\n\r\n    setDisputeLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const openedAt = new Date().toISOString();\r\n\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          status: \"DISPUTE\",\r\n          dispute_reason: reason,\r\n          dispute_opened_at: openedAt,\r\n        })\r\n        .eq(\"id\", delivery.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({\r\n        ...delivery,\r\n        status: \"DISPUTE\",\r\n        dispute_reason: reason,\r\n        dispute_opened_at: openedAt,\r\n      });\r\n\r\n      setShowDispute(false);\r\n      setDisputeReason(\"\");\r\n      setMsg(\"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç–≥–¥–ª—ç—ç.\");\r\n      setTimeout(() => router.push(\"/driver?tab=DISPUTE\"), 450);\r\n    } finally {\r\n      setDisputeLoading(false);\r\n    }\r\n  }\r\n\r\n  async function resolveDispute() {\r\n    if (!delivery) return;\r\n    if (delivery.status !== \"DISPUTE\") return;\r\n\r\n    setResolveLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const closedAt = new Date().toISOString();\r\n\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"CLOSED\", closed_at: closedAt })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"status\", \"DISPUTE\");\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ú–∞—Ä–≥–∞–∞–Ω—ã–≥ —à–∏–π–¥—ç–≥–¥—Å—ç–Ω –±–æ–ª–≥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"CLOSED\", closed_at: closedAt });\r\n      setMsg(\"–ú–∞—Ä–≥–∞–∞–Ω —à–∏–π–¥—ç–≥–¥–ª—ç—ç. –•“Ø—Ä–≥—ç–ª—Ç —Ö–∞–∞–≥–¥–ª–∞–∞.\");\r\n      setTimeout(() => router.push(\"/driver?tab=CLOSED\"), 450);\r\n    } finally {\r\n      setResolveLoading(false);\r\n    }\r\n  }\r\n\r\n  // ---------------- UI ----------------\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50\">\r\n        <div className=\"max-w-3xl mx-auto px-4 py-6 space-y-4\">\r\n          <div className=\"h-10 w-32 bg-slate-200 rounded-xl animate-pulse\" />\r\n          <div className=\"h-28 bg-white border border-slate-200 rounded-2xl animate-pulse\" />\r\n          <div className=\"h-44 bg-white border border-slate-200 rounded-2xl animate-pulse\" />\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) return null;\r\n\r\n  const t = typeLabel(delivery?.delivery_type ?? null);\r\n  const b = delivery ? badge(delivery.status) : null;\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <main className=\"max-w-3xl mx-auto px-4 py-6 space-y-4\">\r\n        {/* header */}\r\n        <div className=\"flex items-center justify-between gap-3\">\r\n          <button\r\n            onClick={goBack}\r\n            className=\"inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50\"\r\n          >\r\n            ‚Üê –ë—É—Ü–∞—Ö\r\n          </button>\r\n\r\n          {delivery && b && (\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"text-xs text-slate-500\">{t.icon}</span>\r\n              <span className={`text-[11px] px-3 py-1.5 rounded-full border ${b.cls}`}>\r\n                {b.text}\r\n              </span>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* alerts */}\r\n        {error && (\r\n          <div className=\"rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700\">\r\n            {error}\r\n          </div>\r\n        )}\r\n        {msg && (\r\n          <div className=\"rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800\">\r\n            {msg}\r\n          </div>\r\n        )}\r\n\r\n        {!delivery ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white px-4 py-6\">\r\n            <p className=\"text-sm text-slate-700\">–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.</p>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* main card */}\r\n            <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n              <div className=\"flex items-start justify-between gap-4\">\r\n                <div className=\"space-y-1\">\r\n                  <h1 className=\"text-lg font-semibold text-slate-900\">\r\n                    {t.label} #{delivery.id.slice(0, 6)}\r\n                  </h1>\r\n                  <p className=\"text-xs text-slate-500\">“Æ“Ø—Å–≥—ç—Å—ç–Ω: {fmtDT(delivery.created_at)}</p>\r\n                </div>\r\n\r\n                <div className=\"text-right\">\r\n                  <div className=\"text-xs text-slate-500\">“Æ–Ω—ç</div>\r\n                  <div className=\"text-base font-semibold text-slate-900\">{fmtPrice(delivery.price_mnt)}</div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3\">\r\n                  <div className=\"text-[11px] text-slate-500\">–ê–í–ê–•</div>\r\n                  <div className=\"text-sm text-slate-900 mt-1\">{delivery.from_address || \"‚Äî\"}</div>\r\n                </div>\r\n\r\n                <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3\">\r\n                  <div className=\"text-[11px] text-slate-500\">–•“Æ–†–ì–≠–•</div>\r\n                  <div className=\"text-sm text-slate-900 mt-1\">{delivery.to_address || \"‚Äî\"}</div>\r\n                </div>\r\n              </div>\r\n\r\n              {delivery.note && (\r\n                <div className=\"rounded-xl border border-slate-200 bg-white p-3\">\r\n                  <div className=\"text-[11px] text-slate-500\">–¢–∞–π–ª–±–∞—Ä</div>\r\n                  <div className=\"text-sm text-slate-900 mt-1 whitespace-pre-wrap\">{delivery.note}</div>\r\n                </div>\r\n              )}\r\n\r\n              {!isChosenDriver && delivery.status !== \"OPEN\" && delivery.chosen_driver_id && (\r\n                <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3\">\r\n                  <div className=\"text-xs text-slate-700\">\r\n                    –≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç ”©”©—Ä –∂–æ–ª–æ–æ—á–∏–¥ –æ–Ω–æ–æ–≥–¥—Å–æ–Ω –±–∞–π–Ω–∞.\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {delivery.status === \"DISPUTE\" && (\r\n                <div className=\"rounded-xl border border-rose-200 bg-rose-50 p-3\">\r\n                  <div className=\"text-sm font-semibold text-rose-800\">–ú–∞—Ä–≥–∞–∞–Ω—Ç–∞–π</div>\r\n                  <div className=\"text-xs text-rose-700 mt-1 whitespace-pre-wrap\">\r\n                    {delivery.dispute_reason || \"‚Äî\"}\r\n                  </div>\r\n                  <div className=\"text-[11px] text-rose-600 mt-1\">\r\n                    –ù—ç—ç—Å—ç–Ω: {fmtDT(delivery.dispute_opened_at)}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </section>\r\n\r\n            {/* map preview */}\r\n            {hasMap && (\r\n              <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n                <h2 className=\"text-sm font-semibold text-slate-900\">–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —á–∏–≥–ª—ç–ª</h2>\r\n                <div className=\"overflow-hidden rounded-xl border border-slate-200\">\r\n                  <DeliveryRouteMap\r\n                    pickup={{ lat: delivery.pickup_lat!, lng: delivery.pickup_lng! }}\r\n                    dropoff={{ lat: delivery.dropoff_lat!, lng: delivery.dropoff_lng! }}\r\n                    height={260}\r\n                  />\r\n                </div>\r\n              </section>\r\n            )}\r\n\r\n            {/* actions */}\r\n            <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n              <h2 className=\"text-sm font-semibold text-slate-900\">“Æ–π–ª–¥—ç–ª</h2>\r\n\r\n              <div className=\"flex flex-wrap items-center gap-2\">\r\n                {/* OPEN: Bid */}\r\n                {delivery.status === \"OPEN\" && (\r\n                  <>\r\n                    {!myBid ? (\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => void placeBid()}\r\n                        disabled={bidLoading}\r\n                        className=\"text-xs px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                      >\r\n                        {bidLoading ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Ö\"}\r\n                      </button>\r\n                    ) : (\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => void cancelBid()}\r\n                        disabled={cancelBidLoading}\r\n                        className=\"text-xs px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-60\"\r\n                      >\r\n                        {cancelBidLoading ? \"–¶—É—Ü–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö\"}\r\n                      </button>\r\n                    )}\r\n                  </>\r\n                )}\r\n\r\n                {/* ASSIGNED -> ON_ROUTE */}\r\n                {delivery.status === \"ASSIGNED\" && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void markOnRoute()}\r\n                    disabled={!canMarkOnRoute || markOnRouteLoading}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {markOnRouteLoading ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ó–∞–º–¥ –≥–∞—Ä—Å–∞–Ω\"}\r\n                  </button>\r\n                )}\r\n\r\n                {/* ON_ROUTE -> DELIVERED */}\r\n                {delivery.status === \"ON_ROUTE\" && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void markDelivered()}\r\n                    disabled={!canMarkDelivered || markDeliveredLoading}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {markDeliveredLoading ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Ä–≥—ç–ª—Å—ç–Ω\"}\r\n                  </button>\r\n                )}\r\n\r\n                {/* ‚úÖ –ú–∞—Ä–≥–∞–∞–Ω (ON_ROUTE / DELIVERED) */}\r\n                {(delivery.status === \"ON_ROUTE\" || delivery.status === \"DELIVERED\") && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setShowDispute(true)}\r\n                    className=\"text-xs px-4 py-2 rounded-xl border border-rose-300 bg-rose-50 text-rose-700 hover:bg-rose-100\"\r\n                  >\r\n                    –ú–∞—Ä–≥–∞–∞–Ω\r\n                  </button>\r\n                )}\r\n\r\n                {/* ‚úÖ DISPUTE –¥—ç—ç—Ä \"–®–∏–π–¥—ç–≥–¥—Å—ç–Ω\" */}\r\n                {delivery.status === \"DISPUTE\" && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void resolveDispute()}\r\n                    disabled={resolveLoading}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {resolveLoading ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–®–∏–π–¥—ç–≥–¥—Å—ç–Ω\"}\r\n                  </button>\r\n                )}\r\n\r\n                {/* DELIVERED/CLOSED: confirm payment */}\r\n                {(delivery.status === \"DELIVERED\" || delivery.status === \"CLOSED\") && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void toggleDriverConfirmedPayment()}\r\n                    disabled={confirmPayLoading || !isChosenDriver}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {confirmPayLoading\r\n                      ? \"–ë–∞—Ç–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\"\r\n                      : delivery.driver_confirmed_payment\r\n                      ? \"–¢”©–ª–±”©—Ä–∏–π–Ω –±–∞—Ç–∞–ª–≥–∞–∞ —Ü—É—Ü–ª–∞—Ö\"\r\n                      : \"–¢”©–ª–±”©—Ä –∞–≤—Å–Ω–∞–∞ –±–∞—Ç–ª–∞—Ö\"}\r\n                  </button>\r\n                )}\r\n              </div>\r\n\r\n              {/* Payment status */}\r\n              <div className=\"pt-2 border-t border-slate-200\">\r\n                <div className=\"text-[11px] text-slate-600\">\r\n                  –•—É–¥–∞–ª–¥–∞–≥—á:{\" \"}\r\n                  <span className={delivery.seller_marked_paid ? \"text-emerald-700\" : \"text-slate-600\"}>\r\n                    {delivery.seller_marked_paid ? \"–¢”©–ª—Å”©–Ω\" : \"–¢”©–ª”©”©–≥“Ø–π\"}\r\n                  </span>\r\n                  {\" ¬∑ \"}\r\n                  –ñ–æ–ª–æ–æ—á:{\" \"}\r\n                  <span className={delivery.driver_confirmed_payment ? \"text-emerald-700\" : \"text-slate-600\"}>\r\n                    {delivery.driver_confirmed_payment ? \"–ê–≤—Å–∞–Ω\" : \"–ë–∞—Ç–ª–∞–∞–≥“Ø–π\"}\r\n                  </span>\r\n                </div>\r\n\r\n                {delivery.status === \"CLOSED\" && (\r\n                  <div className=\"mt-3 rounded-xl border border-emerald-200 bg-emerald-50 p-3\">\r\n                    <div className=\"text-sm font-semibold text-emerald-800\">–•–∞–∞–≥–¥—Å–∞–Ω</div>\r\n                    <p className=\"text-xs text-emerald-700 mt-1\">\r\n                      {delivery.closed_at ? `(${fmtDT(delivery.closed_at)})` : \"\"} –¢”©–ª–±”©—Ä–∏–π–Ω —Ç–æ–æ—Ü–æ–æ –¥—É—É—Å—Å–∞–Ω.\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </section>\r\n\r\n            {/* dispute modal */}\r\n            {showDispute && (\r\n              <div className=\"fixed inset-0 z-20 flex items-center justify-center bg-black/30 px-4\">\r\n                <div className=\"max-w-md w-full rounded-2xl bg-white shadow-lg border border-slate-200 px-4 py-4 space-y-3\">\r\n                  <h3 className=\"text-sm font-semibold text-slate-900\">–ú–∞—Ä–≥–∞–∞–Ω “Ø“Ø—Å–≥—ç—Ö (driver)</h3>\r\n                  <p className=\"text-xs text-slate-600\">–¢–æ–≤—á, —Ç–æ–¥–æ—Ä—Ö–æ–π —à–∞–ª—Ç–≥–∞–∞–Ω–∞–∞ –±–∏—á–Ω—ç “Ø“Ø.</p>\r\n                  <textarea\r\n                    value={disputeReason}\r\n                    onChange={(e) => setDisputeReason(e.target.value)}\r\n                    rows={4}\r\n                    className=\"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-800 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-rose-500\"\r\n                    placeholder=\"–Æ—É –±–æ–ª—Å–æ–Ω —Ç–∞–ª–∞–∞—Ä‚Ä¶\"\r\n                  />\r\n                  <div className=\"flex items-center justify-end gap-2 pt-1\">\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setShowDispute(false)}\r\n                      disabled={disputeLoading}\r\n                      className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n                    >\r\n                      –ë–æ–ª–∏—Ö\r\n                    </button>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={async () => {\r\n                        if (disputeLoading) return;\r\n                        setDisputeLoading(true);\r\n                        try {\r\n                          await openDispute();\r\n                        } finally {\r\n                          setDisputeLoading(false);\r\n                        }\r\n                      }}\r\n                      disabled={disputeLoading}\r\n                      className=\"text-[11px] px-3 py-1.5 rounded-full bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-60\"\r\n                    >\r\n                      {disputeLoading ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö\"}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </>\r\n        )}\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/driver/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n/* ===========================\r\n * app/driver/page.tsx (FINAL v4)\r\n *\r\n * ‚úÖ –®–ò–ù–≠ –õ–û–ì–ò–ö:\r\n * - \"–ù—ç—ç–ª—Ç—Ç—ç–π\" —Ç–∞–±: OPEN —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥ (–º–∏–Ω–∏–π —Ö“Ø—Å—ç–ª—Ç –±–∞–π—Ö–≥“Ø–π)\r\n * - \"–•“Ø—Å—ç–ª—Ç\" —Ç–∞–±: OPEN —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥ (–º–∏–Ω–∏–π —Ö“Ø—Å—ç–ª—Ç—Ç—ç–π)\r\n * - \"–ù–∞–º–∞–π–≥ —Å–æ–Ω–≥–æ—Å–æ–Ω\": ASSIGNED + chosen_driver_id = me\r\n * - \"–ó–∞–º–¥\" / \"–•“Ø—Ä–≥—ç—Å—ç–Ω\" / \"–•–∞–∞–≥–¥—Å–∞–Ω\" / \"–ú–∞—Ä–≥–∞–∞–Ω\": –∑”©–≤—Ö”©–Ω –º–∏–Ω–∏–π –æ–Ω–æ–æ–≥–¥—Å–æ–Ω —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥\r\n * - –•“Ø—Å—ç–ª—Ç —Ç–∞–± –¥—ç—ç—Ä—ç—ç—Å —Ü—É—Ü–∞–ª–±–∞–ª -> –ù—ç—ç–ª—Ç—Ç—ç–π —Ä“Ø“Ø –±—É—Ü–Ω–∞\r\n * - –°–æ–Ω–≥–æ–≥–¥—Å–æ–Ω (ASSIGNED) –±–æ–ª —Ü—É—Ü–ª–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π (–∑”©–≤—Ö”©–Ω seller –ª —Ü—É—Ü–∞–ª–Ω–∞)\r\n *\r\n * ‚úÖ QUICK:\r\n * - DELIVERED –¥—ç—ç—Ä \"–¢”©–ª–±”©—Ä –∞–≤—Å–∞–Ω\" quick —Ç–æ–≤—á\r\n * - CLOSED –¥—ç—ç—Ä \"–•–∞–∞–≥–¥—Å–∞–Ω–∞–∞—Å —É—Å—Ç–≥–∞—Ö\" (driver_hidden=true)\r\n * =========================== */\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport {\r\n  DeliveryStatus,\r\n  DRIVER_TABS,\r\n  DriverTabId,\r\n  getDriverTabForStatus,\r\n  shouldCloseDelivery,\r\n} from \"@/lib/deliveryLogic\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryRow = {\r\n  id: string;\r\n  seller_id: string;\r\n\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n\r\n  chosen_driver_id: string | null;\r\n\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n\r\n  dispute_opened_at: string | null;\r\n  closed_at: string | null;\r\n\r\n  driver_hidden: boolean;\r\n};\r\n\r\ntype BidLite = {\r\n  id: string;\r\n  driver_id: string;\r\n  delivery_id: string;\r\n  created_at: string;\r\n};\r\n\r\nfunction fmtPrice(n: number | null | undefined) {\r\n  const v = Number(n || 0);\r\n  return v ? `${v.toLocaleString(\"mn-MN\")}‚ÇÆ` : \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n}\r\n\r\nfunction fmtDT(iso: string | null | undefined) {\r\n  if (!iso) return \"\";\r\n  try {\r\n    return new Date(iso).toLocaleString(\"mn-MN\", { hour12: false });\r\n  } catch {\r\n    return String(iso);\r\n  }\r\n}\r\n\r\nfunction shorten(s: string | null, max = 70) {\r\n  if (!s) return \"‚Äî\";\r\n  const t = s.trim();\r\n  if (t.length <= max) return t;\r\n  return t.slice(0, max).replace(/\\s+$/, \"\") + \"‚Ä¶\";\r\n}\r\n\r\nfunction typeLabel(deliveryType: string | null): { icon: string; label: string } {\r\n  switch (deliveryType) {\r\n    case \"apartment\":\r\n      return { icon: \"üèô\", label: \"–ë–∞–π—Ä\" };\r\n    case \"ger\":\r\n      return { icon: \"üè†\", label: \"–ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª\" };\r\n    case \"camp\":\r\n      return { icon: \"üèï\", label: \"–õ–∞–≥–µ—Ä\" };\r\n    case \"countryside\":\r\n      return { icon: \"üöå\", label: \"–û—Ä–æ–Ω –Ω—É—Ç–∞–≥\" };\r\n    default:\r\n      return { icon: \"üì¶\", label: \"–•“Ø—Ä–≥—ç–ª—Ç\" };\r\n  }\r\n}\r\n\r\nfunction badge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return { text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\", cls: \"bg-emerald-50 text-emerald-700 border-emerald-100\" };\r\n    case \"ASSIGNED\":\r\n      return { text: \"–û–Ω–æ—Å–æ–Ω\", cls: \"bg-sky-50 text-sky-700 border-sky-100\" };\r\n    case \"ON_ROUTE\":\r\n      return { text: \"–ó–∞–º–¥\", cls: \"bg-indigo-50 text-indigo-700 border-indigo-100\" };\r\n    case \"DELIVERED\":\r\n      return { text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\", cls: \"bg-amber-50 text-amber-700 border-amber-100\" };\r\n    case \"DISPUTE\":\r\n      return { text: \"–ú–∞—Ä–≥–∞–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    case \"CLOSED\":\r\n      return { text: \"–•–∞–∞–≥–¥—Å–∞–Ω\", cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n    case \"CANCELLED\":\r\n      return { text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    default:\r\n      return { text: status, cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n  }\r\n}\r\n\r\nfunction Pill({\r\n  label,\r\n  value,\r\n  accent = \"slate\",\r\n}: {\r\n  label: string;\r\n  value: string;\r\n  accent?: \"emerald\" | \"rose\" | \"sky\" | \"slate\";\r\n}) {\r\n  const acc =\r\n    accent === \"emerald\"\r\n      ? \"bg-emerald-50 border-emerald-100 text-emerald-800\"\r\n      : accent === \"rose\"\r\n      ? \"bg-rose-50 border-rose-100 text-rose-800\"\r\n      : accent === \"sky\"\r\n      ? \"bg-sky-50 border-sky-100 text-sky-800\"\r\n      : \"bg-slate-50 border-slate-200 text-slate-800\";\r\n\r\n  return (\r\n    <div className={`rounded-xl border px-3 py-2 ${acc}`}>\r\n      <div className=\"text-[11px] opacity-70\">{label}</div>\r\n      <div className=\"text-sm font-semibold leading-snug\">{value}</div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function DriverDashboardPage() {\r\n  const router = useRouter();\r\n  const sp = useSearchParams();\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [activeTab, setActiveTab] = useState<DriverTabId>(\"OPEN\");\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [items, setItems] = useState<DeliveryRow[]>([]);\r\n  const [myBids, setMyBids] = useState<Record<string, BidLite>>({});\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [msg, setMsg] = useState<string | null>(null);\r\n  const [actLoading, setActLoading] = useState<Record<string, boolean>>({});\r\n\r\n  // auth\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) return router.replace(\"/\");\r\n      const u: IncomeUser = JSON.parse(raw);\r\n      if (u.role !== \"driver\") return router.replace(\"/\");\r\n      setUser(u);\r\n    } catch {\r\n      router.replace(\"/\");\r\n    }\r\n  }, [router]);\r\n\r\n  // init tab\r\n  useEffect(() => {\r\n    const urlTab = sp.get(\"tab\");\r\n    const valid = DRIVER_TABS.some((t) => t.id === (urlTab as any));\r\n    if (urlTab && valid) {\r\n      setActiveTab(urlTab as DriverTabId);\r\n      localStorage.setItem(\"driverActiveTab\", urlTab);\r\n      return;\r\n    }\r\n    const stored = localStorage.getItem(\"driverActiveTab\");\r\n    const validStored = DRIVER_TABS.some((t) => t.id === (stored as any));\r\n    if (stored && validStored) setActiveTab(stored as DriverTabId);\r\n  }, [sp]);\r\n\r\n  function changeTab(tab: DriverTabId) {\r\n    setActiveTab(tab);\r\n    localStorage.setItem(\"driverActiveTab\", tab);\r\n    router.push(`/driver?tab=${tab}`);\r\n  }\r\n\r\n  // fetch\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    void fetchAll(user.id);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id]);\r\n\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    const onFocus = () => void fetchAll(user.id);\r\n    window.addEventListener(\"focus\", onFocus);\r\n    return () => window.removeEventListener(\"focus\", onFocus);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id]);\r\n\r\n  async function fetchAll(driverId: string) {\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // ‚úÖ OPEN –±“Ø—Ö —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥ (driver_hidden —à“Ø“Ø–ª—Ç —Ö–∏–π–Ω—ç)\r\n      // ‚úÖ –ë—É—Å–∞–¥ —Ç”©–ª”©–≤“Ø“Ø–¥: –∑”©–≤—Ö”©–Ω –Ω–∞–¥–∞–¥ –æ–Ω–æ–æ–≥–¥—Å–æ–Ω\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          seller_id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          chosen_driver_id,\r\n          seller_marked_paid,\r\n          driver_confirmed_payment,\r\n          dispute_opened_at,\r\n          closed_at,\r\n          driver_hidden\r\n        `\r\n        )\r\n        .or(`status.eq.OPEN,chosen_driver_id.eq.${driverId}`)\r\n        .eq(\"driver_hidden\", false)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (e1) throw e1;\r\n\r\n      const base: DeliveryRow[] = (data || []).map((d: any) => ({\r\n        id: d.id,\r\n        seller_id: d.seller_id,\r\n        from_address: d.from_address,\r\n        to_address: d.to_address,\r\n        note: d.note,\r\n        status: d.status,\r\n        created_at: d.created_at,\r\n        price_mnt: d.price_mnt,\r\n        delivery_type: d.delivery_type,\r\n        chosen_driver_id: d.chosen_driver_id,\r\n        seller_marked_paid: !!d.seller_marked_paid,\r\n        driver_confirmed_payment: !!d.driver_confirmed_payment,\r\n        dispute_opened_at: d.dispute_opened_at,\r\n        closed_at: d.closed_at,\r\n        driver_hidden: !!d.driver_hidden,\r\n      }));\r\n\r\n      // my bids\r\n      const { data: bids, error: e2 } = await supabase\r\n        .from(\"driver_bids\")\r\n        .select(\"id, driver_id, delivery_id, created_at\")\r\n        .eq(\"driver_id\", driverId);\r\n\r\n      if (e2) throw e2;\r\n\r\n      const bm: Record<string, BidLite> = {};\r\n      (bids || []).forEach((b: any) => {\r\n        bm[b.delivery_id] = b;\r\n      });\r\n\r\n      setItems(base);\r\n      setMyBids(bm);\r\n      setMsg(null);\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"”®–≥”©–≥–¥”©–ª —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  // --------- ACTIONS ---------\r\n\r\n  async function placeBid(deliveryId: string) {\r\n    if (!user) return;\r\n    setActLoading((p) => ({ ...p, [deliveryId]: true }));\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"driver_bids\")\r\n        .insert({ delivery_id: deliveryId, driver_id: user.id })\r\n        .select(\"id, driver_id, delivery_id, created_at\")\r\n        .maybeSingle();\r\n\r\n      if (e1) throw e1;\r\n\r\n      setMyBids((p) => ({ ...p, [deliveryId]: data as any }));\r\n      setMsg(\"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–ª—ç—ç.\");\r\n      changeTab(\"REQUESTS\");\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–•“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setActLoading((p) => ({ ...p, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  async function cancelBid(deliveryId: string) {\r\n    if (!user) return;\r\n    const b = myBids[deliveryId];\r\n    if (!b) return;\r\n\r\n    // ‚úÖ –°–æ–Ω–≥–æ–≥–¥—Å–æ–Ω –±–æ–ª —Ü—É—Ü–ª–∞—Ö–≥“Ø–π (OPEN –¥—ç—ç—Ä –ª —Ü—É—Ü–ª–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π)\r\n    const cur = items.find((x) => x.id === deliveryId);\r\n    if (cur && cur.status !== \"OPEN\") {\r\n      setError(\"–°–æ–Ω–≥–æ–≥–¥—Å–æ–Ω/—è–≤–∂ –±—É–π —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä —Ö“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π.\");\r\n      return;\r\n    }\r\n\r\n    setActLoading((p) => ({ ...p, [deliveryId]: true }));\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { error: e1 } = await supabase\r\n        .from(\"driver_bids\")\r\n        .delete()\r\n        .eq(\"id\", b.id)\r\n        .eq(\"driver_id\", user.id);\r\n\r\n      if (e1) throw e1;\r\n\r\n      setMyBids((p) => {\r\n        const c = { ...p };\r\n        delete c[deliveryId];\r\n        return c;\r\n      });\r\n\r\n      setMsg(\"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞–≥–¥–ª–∞–∞.\");\r\n      changeTab(\"OPEN\");\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setActLoading((p) => ({ ...p, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  async function quickConfirmPayment(deliveryId: string) {\r\n    if (!user) return;\r\n\r\n    setActLoading((p) => ({ ...p, [deliveryId]: true }));\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const cur = items.find((x) => x.id === deliveryId);\r\n      if (!cur) return;\r\n\r\n      if (!(cur.status === \"DELIVERED\" && cur.chosen_driver_id === user.id)) {\r\n        setError(\"–ó”©–≤—Ö”©–Ω '–•“Ø—Ä–≥—ç—Å—ç–Ω' “Ø–µ–¥ —Ç”©–ª–±”©—Ä –±–∞—Ç–∞–ª–Ω–∞.\");\r\n        return;\r\n      }\r\n\r\n      const next = true;\r\n      const willClose = shouldCloseDelivery({\r\n        status: cur.status,\r\n        seller_marked_paid: cur.seller_marked_paid,\r\n        driver_confirmed_payment: next,\r\n      });\r\n\r\n      const nextStatus: DeliveryStatus = willClose ? \"CLOSED\" : \"DELIVERED\";\r\n      const closedAt = willClose ? new Date().toISOString() : cur.closed_at;\r\n\r\n      const { error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          driver_confirmed_payment: next,\r\n          status: nextStatus,\r\n          closed_at: closedAt,\r\n        })\r\n        .eq(\"id\", deliveryId)\r\n        .eq(\"chosen_driver_id\", user.id)\r\n        .eq(\"status\", \"DELIVERED\");\r\n\r\n      if (e1) throw e1;\r\n\r\n      await fetchAll(user.id);\r\n      setMsg(\"–¢”©–ª–±”©—Ä –∞–≤—Å–Ω–∞–∞ –±–∞—Ç–∞–ª–ª–∞–∞.\");\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–¢”©–ª–±”©—Ä –±–∞—Ç–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setActLoading((p) => ({ ...p, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  async function hideClosedForDriver(deliveryId: string) {\r\n    if (!user) return;\r\n    setActLoading((p) => ({ ...p, [deliveryId]: true }));\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ driver_hidden: true })\r\n        .eq(\"id\", deliveryId);\r\n\r\n      if (e1) throw e1;\r\n\r\n      await fetchAll(user.id);\r\n      setMsg(\"–•–∞–∞–≥–¥—Å–∞–Ω–∞–∞—Å —É—Å—Ç–≥–∞–ª–∞–∞.\");\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–£—Å—Ç–≥–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setActLoading((p) => ({ ...p, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  // --------- FILTER + COUNTS ---------\r\n\r\n  const filtered = useMemo(() => {\r\n    if (!user) return [];\r\n\r\n    return items.filter((d) => {\r\n      // OPEN –±–∞ REQUESTS –Ω—å OPEN —Å—Ç–∞—Ç—É—Å –¥—ç—ç—Ä \"myBid\" –±–∞–π–≥–∞–∞/—ç—Å—ç—Ö—ç—ç—Ä —Å–∞–ª–Ω–∞\r\n      const hasMyBid = !!myBids[d.id];\r\n      const isMine = d.chosen_driver_id === user.id;\r\n\r\n      if (activeTab === \"OPEN\") {\r\n        return d.status === \"OPEN\" && !hasMyBid;\r\n      }\r\n      if (activeTab === \"REQUESTS\") {\r\n        return d.status === \"OPEN\" && hasMyBid;\r\n      }\r\n\r\n      // –±—É—Å–∞–¥ —Ç–∞–±—É—É–¥: status + –∑”©–≤—Ö”©–Ω –º–∏–Ω–∏–π –æ–Ω–æ–æ–≥–¥—Å–æ–Ω\r\n      return getDriverTabForStatus(d.status) === activeTab && isMine;\r\n    });\r\n  }, [activeTab, items, myBids, user]);\r\n\r\n  const tabCounts = useMemo(() => {\r\n    if (!user) return Object.fromEntries(DRIVER_TABS.map((t) => [t.id, 0])) as Record<string, number>;\r\n\r\n    const c: Record<string, number> = {};\r\n    for (const t of DRIVER_TABS) c[t.id] = 0;\r\n\r\n    for (const d of items) {\r\n      const hasMyBid = !!myBids[d.id];\r\n      const isMine = d.chosen_driver_id === user.id;\r\n\r\n      if (d.status === \"OPEN\") {\r\n        if (hasMyBid) c[\"REQUESTS\"] = (c[\"REQUESTS\"] || 0) + 1;\r\n        else c[\"OPEN\"] = (c[\"OPEN\"] || 0) + 1;\r\n        continue;\r\n      }\r\n\r\n      // –±—É—Å–∞–¥ —Ç”©–ª”©–≤“Ø“Ø–¥ –∑”©–≤—Ö”©–Ω –º–∏–Ω–∏–π—Ö–∏–π–≥ —Ç–æ–æ–ª–Ω–æ\r\n      if (!isMine) continue;\r\n\r\n      const tab = getDriverTabForStatus(d.status);\r\n      c[tab] = (c[tab] || 0) + 1;\r\n    }\r\n\r\n    return c;\r\n  }, [items, myBids, user]);\r\n\r\n  // --------- UI ---------\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <div className=\"mx-auto max-w-5xl px-4 pb-12 pt-6\">\r\n        <div className=\"mb-4\">\r\n          <div className=\"text-xs text-slate-500\">–ñ–æ–ª–æ–æ—á</div>\r\n        </div>\r\n\r\n        <div className=\"mb-5 flex flex-wrap gap-2\">\r\n          {DRIVER_TABS.map((t) => {\r\n            const isActive = t.id === activeTab;\r\n            const n = tabCounts[t.id] || 0;\r\n            return (\r\n              <button\r\n                key={t.id}\r\n                onClick={() => changeTab(t.id)}\r\n                className={`rounded-xl border px-3 py-2 text-sm font-semibold transition ${\r\n                  isActive\r\n                    ? \"border-slate-900 bg-white text-slate-900 shadow-sm\"\r\n                    : \"border-slate-200 bg-white text-slate-600 hover:border-slate-300\"\r\n                }`}\r\n              >\r\n                {t.label} <span className=\"ml-1 text-xs opacity-70\">({n})</span>\r\n              </button>\r\n            );\r\n          })}\r\n        </div>\r\n\r\n        {error && (\r\n          <div className=\"mb-4 rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800\">\r\n            {error}\r\n          </div>\r\n        )}\r\n        {msg && (\r\n          <div className=\"mb-4 rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800\">\r\n            {msg}\r\n          </div>\r\n        )}\r\n\r\n        {loading ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-slate-600\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n        ) : filtered.length === 0 ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-slate-600\">\r\n            –≠–Ω—ç —Ç–∞–± –¥—ç—ç—Ä –æ–¥–æ–æ–≥–æ–æ—Ä —Ö“Ø—Ä–≥—ç–ª—Ç –∞–ª–≥–∞.\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid gap-4\">\r\n            {filtered.map((d) => {\r\n              const b = badge(d.status);\r\n              const t = typeLabel(d.delivery_type);\r\n\r\n              const from = shorten(d.from_address, 48);\r\n              const to = shorten(d.to_address, 48);\r\n              const what = shorten(d.note, 80);\r\n\r\n              const hasMyBid = !!myBids[d.id];\r\n              const isMine = user ? d.chosen_driver_id === user.id : false;\r\n\r\n              return (\r\n                <div key={d.id} className=\"rounded-3xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n                  <div className=\"flex flex-wrap items-center justify-between gap-3\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span className=\"text-lg\">{t.icon}</span>\r\n                      <span className=\"text-sm font-semibold text-slate-900\">{t.label}</span>\r\n                      <span className={`rounded-full border px-2.5 py-1 text-xs font-semibold ${b.cls}`}>\r\n                        {b.text}\r\n                      </span>\r\n                      {isMine && d.status !== \"OPEN\" && (\r\n                        <span className=\"rounded-full border border-slate-200 bg-slate-50 px-2.5 py-1 text-xs font-semibold text-slate-700\">\r\n                          –¢–∞–Ω–¥\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"text-xs text-slate-500\">{fmtDT(d.created_at)}</div>\r\n                  </div>\r\n\r\n                  <div className=\"mt-4 grid gap-3 md:grid-cols-3\">\r\n                    <Pill label=\"–•–∞–∞–Ω–∞–∞—Å\" value={from} accent=\"emerald\" />\r\n                    <Pill label=\"–•–∞–∞—à–∞–∞\" value={to} accent=\"rose\" />\r\n                    <Pill label=\"–Æ—É —Ö“Ø—Ä–≥—ç—Ö\" value={what} accent=\"sky\" />\r\n                  </div>\r\n\r\n                  <div className=\"mt-4 flex flex-wrap items-center justify-between gap-3\">\r\n                    <div className=\"flex flex-wrap items-center gap-2\">\r\n                      <span className=\"rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900\">\r\n                        {fmtPrice(d.price_mnt)}\r\n                      </span>\r\n                    </div>\r\n\r\n                    <div className=\"flex flex-wrap gap-2\">\r\n                      {/* OPEN tab: request */}\r\n                      {activeTab === \"OPEN\" && d.status === \"OPEN\" && !hasMyBid && (\r\n                        <button\r\n                          onClick={() => placeBid(d.id)}\r\n                          disabled={!!actLoading[d.id]}\r\n                          className=\"rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60\"\r\n                        >\r\n                          {actLoading[d.id] ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç\"}\r\n                        </button>\r\n                      )}\r\n\r\n                      {/* REQUESTS tab: cancel */}\r\n                      {activeTab === \"REQUESTS\" && d.status === \"OPEN\" && hasMyBid && (\r\n                        <button\r\n                          onClick={() => cancelBid(d.id)}\r\n                          disabled={!!actLoading[d.id]}\r\n                          className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:border-slate-300 disabled:opacity-60\"\r\n                        >\r\n                          {actLoading[d.id] ? \"–¶—É—Ü–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö\"}\r\n                        </button>\r\n                      )}\r\n\r\n                      {/* DELIVERED quick */}\r\n                      {activeTab === \"DELIVERED\" &&\r\n                        d.status === \"DELIVERED\" &&\r\n                        isMine &&\r\n                        !d.driver_confirmed_payment && (\r\n                          <button\r\n                            onClick={() => quickConfirmPayment(d.id)}\r\n                            disabled={!!actLoading[d.id]}\r\n                            className=\"rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                          >\r\n                            {actLoading[d.id] ? \"–ë–∞—Ç–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–¢”©–ª–±”©—Ä –∞–≤—Å–∞–Ω\"}\r\n                          </button>\r\n                        )}\r\n\r\n                      {/* CLOSED: hide */}\r\n                      {activeTab === \"CLOSED\" &&\r\n                        (d.status === \"CLOSED\" || d.status === \"CANCELLED\") &&\r\n                        isMine && (\r\n                          <button\r\n                            onClick={() => hideClosedForDriver(d.id)}\r\n                            disabled={!!actLoading[d.id]}\r\n                            className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:border-slate-300 disabled:opacity-60\"\r\n                          >\r\n                            {actLoading[d.id] ? \"–£—Å—Ç–≥–∞–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•–∞–∞–≥–¥—Å–∞–Ω–∞–∞—Å —É—Å—Ç–≥–∞—Ö\"}\r\n                          </button>\r\n                        )}\r\n\r\n                      <button\r\n                        onClick={() => router.push(`/driver/delivery/${d.id}?tab=${activeTab}`)}\r\n                        className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300\"\r\n                      >\r\n                        –î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"mt-10 flex items-center justify-between gap-3 text-xs text-slate-500\">\r\n          <span>INCOME ¬∑ Driver</span>\r\n          <button\r\n            onClick={() => {\r\n              try {\r\n                localStorage.removeItem(\"incomeUser\");\r\n              } catch {}\r\n              router.push(\"/\");\r\n            }}\r\n            className=\"rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:border-slate-300\"\r\n          >\r\n            –ì–∞—Ä–∞—Ö\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/layout.tsx",
        "summary": "",
        "content": "import type { Metadata } from \"next\";\nimport { Geist, Geist_Mono } from \"next/font/google\";\nimport \"./globals.css\";\n\nconst geistSans = Geist({\n  variable: \"--font-geist-sans\",\n  subsets: [\"latin\"],\n});\n\nconst geistMono = Geist_Mono({\n  variable: \"--font-geist-mono\",\n  subsets: [\"latin\"],\n});\n\nexport const metadata: Metadata = {\n  title: \"Create Next App\",\n  description: \"Generated by create next app\",\n};\n\nexport default function RootLayout({\n  children,\n}: Readonly<{\n  children: React.ReactNode;\n}>) {\n  return (\n    <html lang=\"en\">\n      <body\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n      >\n        {children}\n      </body>\n    </html>\n  );\n}\n"
      },
      {
        "path": "app/page.tsx",
        "summary": "",
        "content": "\"use client\";\n\nimport { FormEvent, useState } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { supabase } from \"@/lib/supabase\";\n\nexport default function LoginPage() {\n  const router = useRouter();\n\n  const [identifier, setIdentifier] = useState(\"\"); // –∏–º—ç–π–ª —ç—Å–≤—ç–ª —É—Ç–∞—Å\n  const [password, setPassword] = useState(\"\"); // 4 –æ—Ä–æ–Ω—Ç–æ–π PIN\n  const [showPassword, setShowPassword] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [error, setError] = useState(\"\");\n\n  async function handleSubmit(e: FormEvent<HTMLFormElement>) {\n    e.preventDefault();\n    setError(\"\");\n\n    if (!identifier.trim() || !password.trim()) {\n      setError(\"–ò–º—ç–π–ª/—É—Ç–∞—Å –±–æ–ª–æ–Ω –Ω—É—É—Ü “Ø–≥—ç—ç –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\n      return;\n    }\n\n    setIsSubmitting(true);\n\n    const { data, error: selectError } = await supabase\n      .from(\"users\")\n      .select(\"*\")\n      .or(`email.eq.${identifier},phone.eq.${identifier}`)\n      .maybeSingle();\n\n    if (selectError) {\n      console.error(selectError);\n      setIsSubmitting(false);\n      setError(\"–°–µ—Ä–≤–µ—Ä–∏–π–Ω –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\n      return;\n    }\n\n    if (!data) {\n      setIsSubmitting(false);\n      setError(\"–ò–π–º —Ö—ç—Ä—ç–≥–ª—ç–≥—á –±“Ø—Ä—Ç–≥—ç–ª–≥“Ø–π –±–∞–π–Ω–∞.\");\n      return;\n    }\n\n    if (data.pin !== password) {\n      setIsSubmitting(false);\n      setError(\"–ù—É—É—Ü “Ø–≥ –±—É—Ä—É—É –±–∞–π–Ω–∞.\");\n      return;\n    }\n\n    // ‚úÖ –ê–º–∂–∏–ª—Ç—Ç–∞–π –Ω—ç–≤—Ç—ç—Ä–≤—ç–ª localStorage-–¥ —Ö–∞–¥–≥–∞–ª–∞–∞–¥ role-–æ–æ—Ä –Ω—å —á–∏–≥–ª“Ø“Ø–ª–Ω—ç\n    const user = {\n      id: data.id,\n      role: data.role,\n      name: data.name,\n      phone: data.phone,\n      email: data.email,\n    };\n\n    if (typeof window !== \"undefined\") {\n      localStorage.setItem(\"incomeUser\", JSON.stringify(user));\n    }\n\n    setIsSubmitting(false);\n\n    if (data.role === \"seller\") {\n      router.push(\"/seller\");\n    } else {\n      router.push(\"/driver\");\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen bg-slate-50 flex items-center justify-center px-4\">\n      <div className=\"w-full max-w-md\">\n        {/* Top logo / title */}\n        <div className=\"mb-8 text-center\">\n          <div className=\"inline-flex items-center justify-center rounded-full bg-emerald-50 px-4 py-2 mb-3\">\n            <span className=\"text-sm font-semibold text-emerald-700\">\n              INCOME\n            </span>\n          </div>\n          <h1 className=\"text-2xl font-semibold text-slate-900\">\n            –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω marketplace\n          </h1>\n          <p className=\"mt-2 text-sm text-slate-500\">\n            –£—Ç–∞—Å —ç—Å–≤—ç–ª –∏–º—ç–π–ª—ç—ç—Ä—ç—ç –Ω—ç–≤—Ç—ç—Ä—á, —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Å–∏—Å—Ç–µ–º—ç—ç –∞—à–∏–≥–ª–∞.\n          </p>\n        </div>\n\n        {/* Card */}\n        <div className=\"bg-white rounded-2xl shadow-sm border border-slate-100 p-6\">\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-1\">\n            –ù—ç–≤—Ç—Ä—ç—Ö\n          </h2>\n          <p className=\"text-sm text-slate-500 mb-6\">\n            ”®–º–Ω”© –±“Ø—Ä—Ç–≥“Ø“Ø–ª—Å—ç–Ω –∏–º—ç–π–ª —ç—Å–≤—ç–ª —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞—Ä –Ω—ç–≤—Ç—ç—Ä–Ω—ç.\n          </p>\n\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            {/* Email / Phone */}\n            <div>\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\n                –ò–º—ç–π–ª —ç—Å–≤—ç–ª —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä\n              </label>\n              <input\n                type=\"text\"\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\n                placeholder=\"example@mail.com —ç—Å–≤—ç–ª 88xxxxxx\"\n                value={identifier}\n                onChange={(e) => setIdentifier(e.target.value)}\n              />\n            </div>\n\n            {/* Password */}\n            <div>\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\n                –ù—É—É—Ü “Ø–≥ (4 –æ—Ä–æ–Ω—Ç–æ–π PIN)\n              </label>\n              <div className=\"relative\">\n                <input\n                  type={showPassword ? \"text\" : \"password\"}\n                  className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50 pr-10 tracking-[0.3em]\"\n                  placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                />\n                <button\n                  type=\"button\"\n                  className=\"absolute inset-y-0 right-0 px-3 text-xs text-slate-500 hover:text-slate-700\"\n                  onClick={() => setShowPassword((v) => !v)}\n                >\n                  {showPassword ? \"–ù—É—É—Ö\" : \"–•–∞—Ä–∞—Ö\"}\n                </button>\n              </div>\n            </div>\n\n            {/* Error */}\n            {error && (\n              <div className=\"rounded-xl bg-red-50 text-red-700 text-sm px-3 py-2\">\n                {error}\n              </div>\n            )}\n\n            {/* Submit */}\n            <button\n              type=\"submit\"\n              disabled={isSubmitting}\n              className=\"w-full inline-flex items-center justify-center rounded-xl bg-emerald-600 text-white text-sm font-semibold py-2.5 mt-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-emerald-700 transition-colors\"\n            >\n              {isSubmitting ? \"–ù—ç–≤—Ç—Ä—ç–∂ –±–∞–π–Ω–∞...\" : \"–ù—ç–≤—Ç—Ä—ç—Ö\"}\n            </button>\n          </form>\n\n          {/* Divider */}\n          <div className=\"flex items-center mt-6 mb-4\">\n            <div className=\"flex-1 h-px bg-slate-200\" />\n            <span className=\"mx-3 text-xs text-slate-400\">—ç—Å–≤—ç–ª</span>\n            <div className=\"flex-1 h-px bg-slate-200\" />\n          </div>\n\n          {/* Register link */}\n          <p className=\"text-sm text-slate-600 text-center\">\n            –®–∏–Ω—ç —Ö—ç—Ä—ç–≥–ª—ç–≥—á “Ø“Ø?{\" \"}\n            <Link\n              href=\"/register\"\n              className=\"font-semibold text-emerald-600 hover:text-emerald-700\"\n            >\n              –ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö\n            </Link>\n          </p>\n        </div>\n\n        {/* Footer */}\n        <p className=\"mt-6 text-xs text-slate-400 text-center\">\n          INCOME v1.0 ¬∑ BABA &amp; Hypatia ¬∑ 2025\n        </p>\n      </div>\n    </div>\n  );\n}\n"
      },
      {
        "path": "app/register/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport { FormEvent, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { supabase } from \"@/lib/supabase\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\nexport default function RegisterPage() {\r\n  const router = useRouter();\r\n\r\n  const [role, setRole] = useState<Role>(\"seller\");\r\n  const [name, setName] = useState(\"\");\r\n  const [phone, setPhone] = useState(\"\");\r\n  const [email, setEmail] = useState(\"\");\r\n  const [pin, setPin] = useState(\"\");\r\n  const [pin2, setPin2] = useState(\"\");\r\n  const [showPin, setShowPin] = useState(false);\r\n  const [agree, setAgree] = useState(false);\r\n\r\n  const [error, setError] = useState(\"\");\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n  const roleLabel = role === \"seller\" ? \"–•—É–¥–∞–ª–¥–∞–≥—á\" : \"–ñ–æ–ª–æ–æ—á\";\r\n\r\n  async function handleSubmit(e: FormEvent<HTMLFormElement>) {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n\r\n    // --- –§—Ä–æ–Ω—Ç —Ç–∞–ª—ã–Ω —à–∞–ª–≥–∞–ª—Ç ---\r\n    if (!name.trim()) {\r\n      setError(\"–ù—ç—Ä—ç—ç –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!phone.trim()) {\r\n      setError(\"–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞ –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!email.trim()) {\r\n      setError(\"–ò–º—ç–π–ª —Ö–∞—è–≥–∞–∞ –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!email.includes(\"@\") || !email.includes(\".\")) {\r\n      setError(\"–ò–º—ç–π–ª —Ö–∞—è–≥–∞–∞ –∑”©–≤ —Ñ–æ—Ä–º–∞—Ç—Ç–∞–π –æ—Ä—É—É–ª–Ω–∞ —É—É.\");\r\n      return;\r\n    }\r\n    if (!/^\\d{4}$/.test(pin)) {\r\n      setError(\"–ù—É—É—Ü “Ø–≥ 4 –æ—Ä–æ–Ω—Ç–æ–π —Ç–æ–æ –±–∞–π—Ö —ë—Å—Ç–æ–π.\");\r\n      return;\r\n    }\r\n    if (pin !== pin2) {\r\n      setError(\"–ù—É—É—Ü “Ø–≥ —Ö–æ—ë—Ä —Ç–∞–∞—Ä–∞—Ö–≥“Ø–π –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n    if (!agree) {\r\n      setError(\"–ê—à–∏–≥–ª–∞—Ö –Ω”©—Ö—Ü”©–ª—Ç—ç–π —Ç–∞–Ω–∏–ª—Ü–∞–∂ –∑”©–≤—à”©”©—Ä”©—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π.\");\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    // --- –£—Ç–∞—Å / –∏–º—ç–π–ª –¥–∞–≤—Ç–∞–≥–¥–∞–∂ –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞ ---\r\n    const { data: existing, error: existsError } = await supabase\r\n      .from(\"users\")\r\n      .select(\"id\")\r\n      .or(`phone.eq.${phone},email.eq.${email}`)\r\n      .maybeSingle();\r\n\r\n    if (existsError) {\r\n      console.error(existsError);\r\n      setIsSubmitting(false);\r\n      setError(\"–°–µ—Ä–≤–µ—Ä–∏–π–Ω –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ä–∞–∞ –¥–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n      return;\r\n    }\r\n\r\n    if (existing) {\r\n      setIsSubmitting(false);\r\n      setError(\"–≠–Ω—ç —É—Ç–∞—Å —ç—Å–≤—ç–ª –∏–º—ç–π–ª—ç—ç—Ä –∞–ª—å —Ö—ç–¥–∏–π–Ω –±“Ø—Ä—Ç–≥“Ø“Ø–ª—Å—ç–Ω –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    // --- –ñ–∏–Ω—Ö—ç–Ω—ç insert ---\r\n    const { error: insertError } = await supabase.from(\"users\").insert({\r\n      role,\r\n      name,\r\n      phone,\r\n      email,\r\n      pin, // v2 –¥—ç—ç—Ä PIN-–≥ hash —Ö–∏–π–Ω—ç\r\n    });\r\n\r\n    if (insertError) {\r\n      console.error(insertError);\r\n      setIsSubmitting(false);\r\n      setError(\"–ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      return;\r\n    }\r\n\r\n    // –ê–º–∂–∏–ª—Ç—Ç–∞–π ‚Üí Login —Ä—É—É\r\n    setIsSubmitting(false);\r\n    router.push(\"/\");\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50 flex items-center justify-center px-4\">\r\n      <div className=\"w-full max-w-md\">\r\n        {/* Top logo / title */}\r\n        <div className=\"mb-8 text-center\">\r\n          <div className=\"inline-flex items-center justify-center rounded-full bg-emerald-50 px-4 py-2 mb-3\">\r\n            <span className=\"text-sm font-semibold text-emerald-700\">\r\n              INCOME\r\n            </span>\r\n          </div>\r\n          <h1 className=\"text-2xl font-semibold text-slate-900\">\r\n            –ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö\r\n          </h1>\r\n          <p className=\"mt-2 text-sm text-slate-500\">\r\n            –ñ–æ–ª–æ–æ—á —ç—Å–≤—ç–ª –•—É–¥–∞–ª–¥–∞–≥—á —Ö—ç–ª–±—ç—Ä—ç—ç—Ä –Ω—ç–≥ —É–¥–∞–∞ –±“Ø—Ä—Ç–≥“Ø“Ø–ª–∂ –∞—à–∏–≥–ª–∞–Ω–∞.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Card */}\r\n        <div className=\"bg-white rounded-2xl shadow-sm border border-slate-100 p-6\">\r\n          {/* Role toggle */}\r\n          <div className=\"flex mb-6 rounded-xl bg-slate-50 p-1\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setRole(\"seller\")}\r\n              className={`flex-1 text-sm font-medium py-2 rounded-lg transition ${\r\n                role === \"seller\"\r\n                  ? \"bg-white shadow-sm text-emerald-700\"\r\n                  : \"text-slate-500\"\r\n              }`}\r\n            >\r\n              –•—É–¥–∞–ª–¥–∞–≥—á\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setRole(\"driver\")}\r\n              className={`flex-1 text-sm font-medium py-2 rounded-lg transition ${\r\n                role === \"driver\"\r\n                  ? \"bg-white shadow-sm text-emerald-700\"\r\n                  : \"text-slate-500\"\r\n              }`}\r\n            >\r\n              –ñ–æ–ª–æ–æ—á\r\n            </button>\r\n          </div>\r\n\r\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n            {/* Name */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ù—ç—Ä\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\r\n                placeholder=\"–ñ–∏—à—ç—ç: –ë–∞—Ç–±–∞—è—Ä\"\r\n                value={name}\r\n                onChange={(e) => setName(e.target.value)}\r\n              />\r\n            </div>\r\n\r\n            {/* Phone */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä\r\n              </label>\r\n              <input\r\n                type=\"tel\"\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\r\n                placeholder=\"–ñ–∏—à—ç—ç: 88112233\"\r\n                value={phone}\r\n                onChange={(e) => setPhone(e.target.value)}\r\n              />\r\n              <p className=\"mt-1 text-xs text-slate-400\">\r\n                –ù—ç–≥ —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞—Ä –∑”©–≤—Ö”©–Ω –Ω—ç–≥ –ª —É–¥–∞–∞ –±“Ø—Ä—Ç–≥“Ø“Ø–ª–Ω—ç.\r\n              </p>\r\n            </div>\r\n\r\n            {/* Email */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ò–º—ç–π–ª —Ö–∞—è–≥\r\n              </label>\r\n              <input\r\n                type=\"email\"\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\r\n                placeholder=\"example@mail.com\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n              />\r\n              <p className=\"mt-1 text-xs text-slate-400\">\r\n                –ò–º—ç–π–ª—ç—ç—Ä –Ω—É—É—Ü “Ø–≥ —Å—ç—Ä–≥—ç—ç—Ö, –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö –º—ç–¥—ç—ç–ª—ç–ª –æ—á–Ω–æ.\r\n              </p>\r\n            </div>\r\n\r\n            {/* PIN */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ù—É—É—Ü “Ø–≥ (4 –æ—Ä–æ–Ω—Ç–æ–π PIN)\r\n              </label>\r\n              <div className=\"relative\">\r\n                <input\r\n                  type={showPin ? \"text\" : \"password\"}\r\n                  inputMode=\"numeric\"\r\n                  maxLength={4}\r\n                  className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50 pr-10 tracking-[0.3em]\"\r\n                  placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                  value={pin}\r\n                  onChange={(e) => {\r\n                    const v = e.target.value.replace(/\\D/g, \"\");\r\n                    setPin(v);\r\n                  }}\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"absolute inset-y-0 right-0 px-3 text-xs text-slate-500 hover:text-slate-700\"\r\n                  onClick={() => setShowPin((v) => !v)}\r\n                >\r\n                  {showPin ? \"–ù—É—É—Ö\" : \"–•–∞—Ä–∞—Ö\"}\r\n                </button>\r\n              </div>\r\n              <p className=\"mt-1 text-xs text-slate-400\">\r\n                –ó”©–≤—Ö”©–Ω 4 –æ—Ä–æ–Ω—Ç–æ–π —Ç–æ–æ –±–∞–π—Ö–∞–∞—Ä —Ç–æ—Ö–∏—Ä—É—É–ª–Ω–∞ (–∂–∏—à—ç—ç: 1234).\r\n              </p>\r\n            </div>\r\n\r\n            {/* PIN confirm */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ù—É—É—Ü “Ø–≥ –¥–∞–≤—Ç–∞—Ö\r\n              </label>\r\n              <input\r\n                type={showPin ? \"text\" : \"password\"}\r\n                inputMode=\"numeric\"\r\n                maxLength={4}\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50 tracking-[0.3em]\"\r\n                placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                value={pin2}\r\n                onChange={(e) => {\r\n                  const v = e.target.value.replace(/\\D/g, \"\");\r\n                  setPin2(v);\r\n                }}\r\n              />\r\n            </div>\r\n\r\n            {/* Terms */}\r\n            <div className=\"flex items-start gap-2 pt-1\">\r\n              <input\r\n                id=\"agree\"\r\n                type=\"checkbox\"\r\n                checked={agree}\r\n                onChange={(e) => setAgree(e.target.checked)}\r\n                className=\"mt-1 h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500\"\r\n              />\r\n              <label\r\n                htmlFor=\"agree\"\r\n                className=\"text-xs text-slate-600 leading-relaxed\"\r\n              >\r\n                –ë–∏ INCOME —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω marketplace-–∏–π–Ω –∞—à–∏–≥–ª–∞—Ö –Ω”©—Ö—Ü”©–ª, —Ö—É–≤–∏–π–Ω\r\n                –º—ç–¥—ç—ç–ª—ç–ª –∞—à–∏–≥–ª–∞—Ö –∂—É—Ä–º—ã–≥ —É–Ω—à–∏–∂ —Ç–∞–Ω–∏–ª—Ü—Å–∞–Ω –±”©–≥”©”©–¥{\" \"}\r\n                <span className=\"font-semibold\">–∑”©–≤—à”©”©—Ä—á –±–∞–π–Ω–∞.</span>\r\n              </label>\r\n            </div>\r\n\r\n            {/* Error */}\r\n            {error && (\r\n              <div className=\"rounded-xl bg-red-50 text-red-700 text-sm px-3 py-2\">\r\n                {error}\r\n              </div>\r\n            )}\r\n\r\n            {/* Submit */}\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isSubmitting}\r\n              className=\"w-full inline-flex items-center justify-center rounded-xl bg-emerald-600 text-white text-sm font-semibold py-2.5 mt-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-emerald-700 transition-colors\"\r\n            >\r\n              {isSubmitting\r\n                ? \"–ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç–∂ –±–∞–π–Ω–∞...\"\r\n                : `${roleLabel} –±“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö`}\r\n            </button>\r\n          </form>\r\n\r\n          {/* Divider */}\r\n          <div className=\"flex items-center mt-6 mb-4\">\r\n            <div className=\"flex-1 h-px bg-slate-200\" />\r\n            <span className=\"mx-3 text-xs text-slate-400\">—ç—Å–≤—ç–ª</span>\r\n            <div className=\"flex-1 h-px bg-slate-200\" />\r\n          </div>\r\n\r\n          {/* Back to login */}\r\n          <p className=\"text-sm text-slate-600 text-center\">\r\n            –ê–ª—å —Ö—ç–¥–∏–π–Ω –±“Ø—Ä—Ç–≥—ç–ª—Ç—ç–π —é—É?{\" \"}\r\n            <Link\r\n              href=\"/\"\r\n              className=\"font-semibold text-emerald-600 hover:text-emerald-700\"\r\n            >\r\n              –ù—ç–≤—Ç—Ä—ç—Ö\r\n            </Link>\r\n          </p>\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <p className=\"mt-6 text-xs text-slate-400 text-center\">\r\n          INCOME v1.0 ¬∑ {roleLabel} –±“Ø—Ä—Ç–≥—ç–ª ¬∑ –ú–æ–Ω–≥–æ–ª\r\n        </p>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/seller/delivery/[id]/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n/* ===========================\r\n * app/seller/delivery/[id]/page.tsx (FINAL)\r\n *\r\n * ‚úÖ 7 —Å–∞–π–∂—Ä—É—É–ª–∞–ª—Ç—ã–Ω —ç–Ω—ç —Ö—É—É–¥—Å–∞–Ω–¥ —Ö–∞–º–∞–∞—Ä–∞—Ö –¥“Ø—Ä—ç–º:\r\n * 1) UI: –•–∞–∞–Ω–∞–∞—Å/—Ö–∞–∞—à–∞–∞/—Ç–∞–π–ª–±–∞—Ä/“Ø–Ω—ç –Ω—å —Ç—É—Å —Ç—É—Å–¥–∞–∞ section\r\n * 2) \"–•“Ø—Ä–≥—ç–ª—Ç –≥–∞—Ä—Å–∞–Ω\" –∑”©–≤—Ö”©–Ω ASSIGNED (–∂–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–Ω—ã –¥–∞—Ä–∞–∞) “Ø–µ–¥ –ª —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞\r\n * 3) \"–ú–∞—Ä–≥–∞–∞–Ω\" –∑”©–≤—Ö”©–Ω ON_ROUTE / DELIVERED “Ø–µ–¥ –ª —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞\r\n * 5) DISPUTE –¥—ç—ç—Ä \"–®–∏–π–¥—ç–≥–¥—Å—ç–Ω\" —Ç–æ–≤—á –±–∞–π–Ω–∞\r\n * 6) \"–•–∞–∞–≥–¥—Å–∞–Ω\" –±“Ø–ª–≥–∏–π–Ω (CLOSED/DELIVERED/CANCELLED) —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥–∏–π–≥ seller_hidden=true –±–æ–ª–≥–æ–∂ —É—Å—Ç–≥–∞–∂ (–Ω—É—É–∂) –±–æ–ª–Ω–æ\r\n * + Map: pickup (–Ω–æ–≥–æ–æ–Ω) -> dropoff (—É–ª–∞–∞–Ω) –Ω—É–º –∑—É—Ä–∞–∞—Å—Ç–∞–π preview (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –±–∞–π–≤–∞–ª)\r\n * =========================== */\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useParams, useRouter, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport DeliveryRouteMap from \"../../../components/Map/DeliveryRouteMap\";\r\nimport {\r\n  DeliveryStatus,\r\n  getSellerTabForStatus,\r\n  shouldCloseDelivery,\r\n} from \"@/lib/deliveryLogic\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryDetail = {\r\n  id: string;\r\n  seller_id: string;\r\n\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n\r\n  // ‚úÖ Map coords\r\n  pickup_lat: number | null;\r\n  pickup_lng: number | null;\r\n  dropoff_lat: number | null;\r\n  dropoff_lng: number | null;\r\n\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n\r\n  chosen_driver_id: string | null;\r\n\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n  closed_at: string | null;\r\n\r\n  dispute_reason: string | null;\r\n  dispute_opened_at: string | null;\r\n\r\n  seller_hidden: boolean;\r\n};\r\n\r\ntype DriverPublic = {\r\n  id: string;\r\n  name: string | null;\r\n  phone: string | null;\r\n};\r\n\r\ntype BidRow = {\r\n  id: string;\r\n  driver_id: string;\r\n  created_at: string;\r\n  driver: DriverPublic | null;\r\n};\r\n\r\n// ---------------- helpers ----------------\r\n\r\nfunction fmtPrice(n: number | null | undefined) {\r\n  const v = Number(n || 0);\r\n  return v ? `${v.toLocaleString(\"mn-MN\")}‚ÇÆ` : \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n}\r\n\r\nfunction fmtDT(iso: string | null | undefined) {\r\n  if (!iso) return \"\";\r\n  try {\r\n    return new Date(iso).toLocaleString(\"mn-MN\", { hour12: false });\r\n  } catch {\r\n    return iso;\r\n  }\r\n}\r\n\r\nfunction typeLabel(deliveryType: string | null): { icon: string; label: string } {\r\n  switch (deliveryType) {\r\n    case \"apartment\":\r\n      return { icon: \"üèô\", label: \"–ë–∞–π—Ä\" };\r\n    case \"ger\":\r\n      return { icon: \"üè†\", label: \"–ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª\" };\r\n    case \"camp\":\r\n      return { icon: \"üèï\", label: \"–õ–∞–≥–µ—Ä\" };\r\n    case \"countryside\":\r\n      return { icon: \"üöå\", label: \"–û—Ä–æ–Ω –Ω—É—Ç–∞–≥\" };\r\n    default:\r\n      return { icon: \"üì¶\", label: \"–•“Ø—Ä–≥—ç–ª—Ç\" };\r\n  }\r\n}\r\n\r\nfunction badge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return { text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\", cls: \"bg-emerald-50 text-emerald-700 border-emerald-100\" };\r\n    case \"ASSIGNED\":\r\n      return { text: \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\", cls: \"bg-sky-50 text-sky-700 border-sky-100\" };\r\n    case \"ON_ROUTE\":\r\n      return { text: \"–ó–∞–º–¥\", cls: \"bg-indigo-50 text-indigo-700 border-indigo-100\" };\r\n    case \"DELIVERED\":\r\n      return { text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\", cls: \"bg-amber-50 text-amber-700 border-amber-100\" };\r\n    case \"DISPUTE\":\r\n      return { text: \"–ú–∞—Ä–≥–∞–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    case \"CLOSED\":\r\n      return { text: \"–•–∞–∞–≥–¥—Å–∞–Ω\", cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n    case \"CANCELLED\":\r\n      return { text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    default:\r\n      return { text: status, cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n  }\r\n}\r\n\r\n// ---------------- page ----------------\r\n\r\nexport default function SellerDeliveryDetailPage() {\r\n  const router = useRouter();\r\n  const params = useParams<{ id: string }>();\r\n  const sp = useSearchParams();\r\n\r\n  const id = params?.id;\r\n  const backTab = sp.get(\"tab\");\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [delivery, setDelivery] = useState<DeliveryDetail | null>(null);\r\n  const [bids, setBids] = useState<BidRow[]>([]);\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [loadingBids, setLoadingBids] = useState(true);\r\n\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [msg, setMsg] = useState<string | null>(null);\r\n\r\n  const [chooseLoading, setChooseLoading] = useState<string | null>(null);\r\n  const [markOnRouteLoading, setMarkOnRouteLoading] = useState(false);\r\n  const [markPaidLoading, setMarkPaidLoading] = useState(false);\r\n  const [cancelLoading, setCancelLoading] = useState(false);\r\n  const [hideLoading, setHideLoading] = useState(false);\r\n\r\n  // dispute\r\n  const [showDispute, setShowDispute] = useState(false);\r\n  const [disputeReason, setDisputeReason] = useState(\"\");\r\n  const [disputeLoading, setDisputeLoading] = useState(false);\r\n  const [resolveLoading, setResolveLoading] = useState(false);\r\n\r\n  // ---------------- auth ----------------\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) return router.replace(\"/\");\r\n      const u: IncomeUser = JSON.parse(raw);\r\n      if (u.role !== \"seller\") return router.replace(\"/\");\r\n      setUser(u);\r\n    } catch {\r\n      router.replace(\"/\");\r\n    }\r\n  }, [router]);\r\n\r\n  // ---------------- fetch ----------------\r\n  useEffect(() => {\r\n    if (!user || !id) return;\r\n    void fetchAll();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user, id]);\r\n\r\n  async function fetchAll() {\r\n    setLoading(true);\r\n    setLoadingBids(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      // delivery\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          seller_id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          pickup_lat,\r\n          pickup_lng,\r\n          dropoff_lat,\r\n          dropoff_lng,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          chosen_driver_id,\r\n          seller_marked_paid,\r\n          driver_confirmed_payment,\r\n          closed_at,\r\n          dispute_reason,\r\n          dispute_opened_at,\r\n          seller_hidden\r\n        `\r\n        )\r\n        .eq(\"id\", id)\r\n        .maybeSingle();\r\n\r\n      if (e1 || !data) {\r\n        setDelivery(null);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\");\r\n        return;\r\n      }\r\n\r\n      if (data.seller_id !== user!.id) {\r\n        setDelivery(null);\r\n        setError(\"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ç–∞–Ω—ã —ç—Ä—Ö—ç–Ω–¥ –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.\");\r\n        return;\r\n      }\r\n\r\n      const d: DeliveryDetail = {\r\n        id: data.id,\r\n        seller_id: data.seller_id,\r\n\r\n        from_address: data.from_address,\r\n        to_address: data.to_address,\r\n        note: data.note,\r\n\r\n        pickup_lat: (data as any).pickup_lat ?? null,\r\n        pickup_lng: (data as any).pickup_lng ?? null,\r\n        dropoff_lat: (data as any).dropoff_lat ?? null,\r\n        dropoff_lng: (data as any).dropoff_lng ?? null,\r\n\r\n        status: data.status as DeliveryStatus,\r\n        created_at: data.created_at,\r\n        price_mnt: data.price_mnt,\r\n        delivery_type: data.delivery_type,\r\n\r\n        chosen_driver_id: data.chosen_driver_id,\r\n\r\n        seller_marked_paid: !!data.seller_marked_paid,\r\n        driver_confirmed_payment: !!data.driver_confirmed_payment,\r\n        closed_at: data.closed_at,\r\n\r\n        dispute_reason: (data as any).dispute_reason ?? null,\r\n        dispute_opened_at: (data as any).dispute_opened_at ?? null,\r\n\r\n        seller_hidden: !!(data as any).seller_hidden,\r\n      };\r\n\r\n      setDelivery(d);\r\n\r\n      // bids (only useful on OPEN, but safe to fetch always)\r\n      const { data: bidRows, error: e2 } = await supabase\r\n        .from(\"driver_bids\")\r\n        .select(\r\n          `\r\n          id,\r\n          driver_id,\r\n          created_at,\r\n          driver:driver_id (\r\n            id,\r\n            name,\r\n            phone\r\n          )\r\n        `\r\n        )\r\n        .eq(\"delivery_id\", id)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (e2) setBids([]);\r\n      else setBids((bidRows as any) || []);\r\n    } finally {\r\n      setLoading(false);\r\n      setLoadingBids(false);\r\n    }\r\n  }\r\n\r\n  // ---------------- navigation ----------------\r\n  function goBack() {\r\n    if (backTab) return router.push(`/seller?tab=${encodeURIComponent(backTab)}`);\r\n    if (!delivery) return router.push(\"/seller?tab=OPEN\");\r\n    return router.push(`/seller?tab=${getSellerTabForStatus(delivery.status)}`);\r\n  }\r\n\r\n  // ---------------- actions ----------------\r\n\r\n  // OPEN -> choose driver -> ASSIGNED\r\n  async function chooseDriver(driverId: string) {\r\n    if (!delivery || !user) return;\r\n    if (delivery.status !== \"OPEN\") {\r\n      setError(\"–ó”©–≤—Ö”©–Ω –ù—ç—ç–ª—Ç—Ç—ç–π “Ø–µ–¥ –∂–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ–Ω–æ.\");\r\n      return;\r\n    }\r\n\r\n    setChooseLoading(driverId);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"ASSIGNED\", chosen_driver_id: driverId })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id)\r\n        .eq(\"status\", \"OPEN\");\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"ASSIGNED\", chosen_driver_id: driverId });\r\n      setMsg(\"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ–ª–æ–æ.\");\r\n      setTimeout(() => router.push(\"/seller?tab=ASSIGNED\"), 350);\r\n    } finally {\r\n      setChooseLoading(null);\r\n    }\r\n  }\r\n\r\n  // ASSIGNED -> ON_ROUTE  ‚úÖ (—Ö–∞—Ä–∞–≥–¥–∞—Ö: –∑”©–≤—Ö”©–Ω ASSIGNED “Ø–µ–¥)\r\n  async function markOnRoute() {\r\n    if (!delivery || !user) return;\r\n\r\n    if (delivery.status !== \"ASSIGNED\") {\r\n      setError(\"–ó”©–≤—Ö”©–Ω '–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω' “Ø–µ–¥ '–•“Ø—Ä–≥—ç–ª—Ç –≥–∞—Ä—Å–∞–Ω' –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–Ω—ç.\");\r\n      return;\r\n    }\r\n    if (!delivery.chosen_driver_id) {\r\n      setError(\"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ–≥–¥–æ–æ–≥“Ø–π –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    setMarkOnRouteLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"ON_ROUTE\" })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id)\r\n        .eq(\"status\", \"ASSIGNED\");\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ó–∞–º–¥ –≥–∞—Ä—Å–∞–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"ON_ROUTE\" });\r\n      setMsg(\"–ó–∞–º–¥ –≥–∞—Ä—Å–∞–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\");\r\n      setTimeout(() => router.push(\"/seller?tab=ON_ROUTE\"), 450);\r\n    } finally {\r\n      setMarkOnRouteLoading(false);\r\n    }\r\n  }\r\n\r\n  // DELIVERED/CLOSED: seller payment toggle\r\n  async function toggleSellerPaid() {\r\n    if (!delivery || !user) return;\r\n\r\n    if (!(delivery.status === \"DELIVERED\" || delivery.status === \"CLOSED\")) {\r\n      setError(\"–ó”©–≤—Ö”©–Ω '–•“Ø—Ä–≥—ç—Å—ç–Ω' “Ø–µ–¥ —Ç”©–ª–±”©—Ä —Ç—ç–º–¥—ç–≥–ª—ç–Ω—ç.\");\r\n      return;\r\n    }\r\n\r\n    setMarkPaidLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const nextPaid = !delivery.seller_marked_paid;\r\n\r\n      const willClose = shouldCloseDelivery({\r\n        status: delivery.status,\r\n        seller_marked_paid: nextPaid,\r\n        driver_confirmed_payment: delivery.driver_confirmed_payment,\r\n      });\r\n\r\n      const nextStatus: DeliveryStatus = willClose ? \"CLOSED\" : delivery.status;\r\n      const closedAt = willClose ? new Date().toISOString() : delivery.closed_at;\r\n\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          seller_marked_paid: nextPaid,\r\n          status: nextStatus,\r\n          closed_at: closedAt,\r\n        })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–¢”©–ª–±”©—Ä —Ç—ç–º–¥—ç–≥–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({\r\n        ...delivery,\r\n        seller_marked_paid: nextPaid,\r\n        status: nextStatus,\r\n        closed_at: closedAt,\r\n      });\r\n\r\n      setMsg(nextPaid ? \"–¢”©–ª–±”©—Ä —Ç”©–ª—Å”©–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\" : \"–¢”©–ª–±”©—Ä–∏–π–Ω —Ç—ç–º–¥—ç–≥–ª—ç–≥—ç—ç–≥ —Ü—É—Ü–∞–ª–ª–∞–∞.\");\r\n    } finally {\r\n      setMarkPaidLoading(false);\r\n    }\r\n  }\r\n\r\n  // cancel -> CANCELLED (seller)\r\n  async function cancelDelivery() {\r\n    if (!delivery || !user) return;\r\n\r\n    if (delivery.status === \"CLOSED\") {\r\n      setError(\"–•–∞–∞–≥–¥—Å–∞–Ω —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ —Ü—É—Ü–ª–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π.\");\r\n      return;\r\n    }\r\n    if (delivery.status === \"CANCELLED\") {\r\n      setError(\"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –∞–ª—å —Ö—ç–¥–∏–π–Ω —Ü—É—Ü–ª–∞–≥–¥—Å–∞–Ω.\");\r\n      return;\r\n    }\r\n\r\n    setCancelLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"CANCELLED\" })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–¶—É—Ü–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"CANCELLED\" });\r\n      setMsg(\"–•“Ø—Ä–≥—ç–ª—Ç —Ü—É—Ü–ª–∞–≥–¥–ª–∞–∞.\");\r\n      setTimeout(() => router.push(\"/seller?tab=CLOSED\"), 350);\r\n    } finally {\r\n      setCancelLoading(false);\r\n    }\r\n  }\r\n\r\n  // ‚úÖ \"–•–∞–∞–≥–¥—Å–∞–Ω\" –±“Ø–ª–≥–∏–π–Ω —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ —É—Å—Ç–≥–∞—Ö (seller_hidden=true)\r\n  // (CLOSED / DELIVERED / CANCELLED –¥—ç—ç—Ä –∞–∂–∏–ª–ª–∞–Ω–∞)\r\n  const canHideFromClosedGroup = useMemo(() => {\r\n    if (!delivery) return false;\r\n    return (\r\n      delivery.status === \"CLOSED\" ||\r\n      delivery.status === \"DELIVERED\" ||\r\n      delivery.status === \"CANCELLED\"\r\n    );\r\n  }, [delivery]);\r\n\r\n  async function hideFromClosedGroup() {\r\n    if (!delivery || !user) return;\r\n\r\n    if (!canHideFromClosedGroup) {\r\n      setError(\"–ó”©–≤—Ö”©–Ω —Ö–∞–∞–≥–¥—Å–∞–Ω –±“Ø–ª–≥–∏–π–Ω (–•–∞–∞–≥–¥—Å–∞–Ω/–•“Ø—Ä–≥—ç—Å—ç–Ω/–¶—É—Ü–∞–ª—Å–∞–Ω) —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ –ª —É—Å—Ç–≥–∞–∂ (–Ω—É—É–∂) –±–æ–ª–Ω–æ.\");\r\n      return;\r\n    }\r\n\r\n    setHideLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ seller_hidden: true })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–£—Å—Ç–≥–∞—Ö (–Ω—É—É—Ö) “Ø–µ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setMsg(\"–•–∞–∞–≥–¥—Å–∞–Ω —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ —É—Å—Ç–≥–∞–ª–∞–∞ (–Ω—É—É—Å–Ω–∞–∞).\");\r\n      setTimeout(() => router.push(\"/seller?tab=CLOSED\"), 450);\r\n    } finally {\r\n      setHideLoading(false);\r\n    }\r\n  }\r\n\r\n  // ‚úÖ –ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö –±–æ–ª–æ–º–∂ (–ó”©–≤—Ö”©–Ω ON_ROUTE / DELIVERED)\r\n  const canOpenDispute = useMemo(() => {\r\n    if (!delivery) return false;\r\n    if (delivery.status === \"DISPUTE\") return false;\r\n    return delivery.status === \"ON_ROUTE\" || delivery.status === \"DELIVERED\";\r\n  }, [delivery]);\r\n\r\n  async function openDispute() {\r\n    if (!delivery || !user) return;\r\n\r\n    const reason = disputeReason.trim();\r\n    if (!reason) {\r\n      setError(\"–ú–∞—Ä–≥–∞–∞–Ω—ã —à–∞–ª—Ç–≥–∞–∞–Ω–∞–∞ –±–∏—á–Ω—ç “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!canOpenDispute) {\r\n      setError(\"–≠–Ω—ç —Ç”©–ª”©–≤ –¥—ç—ç—Ä –º–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö –±–æ–ª–æ–º–∂–≥“Ø–π.\");\r\n      return;\r\n    }\r\n\r\n    setDisputeLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const openedAt = new Date().toISOString();\r\n\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          status: \"DISPUTE\",\r\n          dispute_reason: reason,\r\n          dispute_opened_at: openedAt,\r\n        })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({\r\n        ...delivery,\r\n        status: \"DISPUTE\",\r\n        dispute_reason: reason,\r\n        dispute_opened_at: openedAt,\r\n      });\r\n\r\n      setShowDispute(false);\r\n      setDisputeReason(\"\");\r\n      setMsg(\"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç–≥–¥–ª—ç—ç.\");\r\n      setTimeout(() => router.push(\"/seller?tab=DISPUTE\"), 450);\r\n    } finally {\r\n      setDisputeLoading(false);\r\n    }\r\n  }\r\n\r\n  // ‚úÖ –ú–∞—Ä–≥–∞–∞–Ω—ã–≥ \"–®–∏–π–¥—ç–≥–¥—Å—ç–Ω\" –±–æ–ª–≥–æ—Ö (DISPUTE -> CLOSED)\r\n  async function resolveDispute() {\r\n    if (!delivery || !user) return;\r\n    if (delivery.status !== \"DISPUTE\") return;\r\n\r\n    setResolveLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const closedAt = new Date().toISOString();\r\n\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          status: \"CLOSED\",\r\n          closed_at: closedAt,\r\n        })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id)\r\n        .eq(\"status\", \"DISPUTE\");\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ú–∞—Ä–≥–∞–∞–Ω—ã–≥ —à–∏–π–¥—ç–≥–¥—Å—ç–Ω –±–æ–ª–≥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"CLOSED\", closed_at: closedAt });\r\n      setMsg(\"–ú–∞—Ä–≥–∞–∞–Ω —à–∏–π–¥—ç–≥–¥–ª—ç—ç. –•“Ø—Ä–≥—ç–ª—Ç —Ö–∞–∞–≥–¥–ª–∞–∞.\");\r\n      setTimeout(() => router.push(\"/seller?tab=CLOSED\"), 450);\r\n    } finally {\r\n      setResolveLoading(false);\r\n    }\r\n  }\r\n\r\n  // ---------------- UI ----------------\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50\">\r\n        <div className=\"max-w-3xl mx-auto px-4 py-6 space-y-4\">\r\n          <div className=\"h-10 w-32 bg-slate-200 rounded-xl animate-pulse\" />\r\n          <div className=\"h-28 bg-white border border-slate-200 rounded-2xl animate-pulse\" />\r\n          <div className=\"h-44 bg-white border border-slate-200 rounded-2xl animate-pulse\" />\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) return null;\r\n\r\n  const t = typeLabel(delivery?.delivery_type ?? null);\r\n  const b = delivery ? badge(delivery.status) : null;\r\n\r\n  const hasMap =\r\n    !!delivery &&\r\n    delivery.pickup_lat != null &&\r\n    delivery.pickup_lng != null &&\r\n    delivery.dropoff_lat != null &&\r\n    delivery.dropoff_lng != null;\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <main className=\"max-w-3xl mx-auto px-4 py-6 space-y-4\">\r\n        {/* header */}\r\n        <div className=\"flex items-center justify-between gap-3\">\r\n          <button\r\n            onClick={goBack}\r\n            className=\"inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50\"\r\n          >\r\n            ‚Üê –ë—É—Ü–∞—Ö\r\n          </button>\r\n\r\n          {delivery && b && (\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"text-xs text-slate-500\">{t.icon}</span>\r\n              <span className={`text-[11px] px-3 py-1.5 rounded-full border ${b.cls}`}>\r\n                {b.text}\r\n              </span>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* alerts */}\r\n        {error && (\r\n          <div className=\"rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700\">\r\n            {error}\r\n          </div>\r\n        )}\r\n        {msg && (\r\n          <div className=\"rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800\">\r\n            {msg}\r\n          </div>\r\n        )}\r\n\r\n        {!delivery ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white px-4 py-6\">\r\n            <p className=\"text-sm text-slate-700\">–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.</p>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* main card */}\r\n            <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n              <div className=\"flex items-start justify-between gap-4\">\r\n                <div className=\"space-y-1\">\r\n                  <h1 className=\"text-lg font-semibold text-slate-900\">\r\n                    {t.label} #{delivery.id.slice(0, 6)}\r\n                  </h1>\r\n                  <p className=\"text-xs text-slate-500\">“Æ“Ø—Å–≥—ç—Å—ç–Ω: {fmtDT(delivery.created_at)}</p>\r\n                </div>\r\n\r\n                <div className=\"text-right\">\r\n                  <div className=\"text-xs text-slate-500\">“Æ–Ω—ç</div>\r\n                  <div className=\"text-base font-semibold text-slate-900\">{fmtPrice(delivery.price_mnt)}</div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3\">\r\n                  <div className=\"text-[11px] text-slate-500\">–ê–í–ê–•</div>\r\n                  <div className=\"text-sm text-slate-900 mt-1\">{delivery.from_address || \"‚Äî\"}</div>\r\n                </div>\r\n\r\n                <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3\">\r\n                  <div className=\"text-[11px] text-slate-500\">–•“Æ–†–ì–≠–•</div>\r\n                  <div className=\"text-sm text-slate-900 mt-1\">{delivery.to_address || \"‚Äî\"}</div>\r\n                </div>\r\n              </div>\r\n\r\n              {delivery.note && (\r\n                <div className=\"rounded-xl border border-slate-200 bg-white p-3\">\r\n                  <div className=\"text-[11px] text-slate-500\">–¢–∞–π–ª–±–∞—Ä</div>\r\n                  <div className=\"text-sm text-slate-900 mt-1 whitespace-pre-wrap\">{delivery.note}</div>\r\n                </div>\r\n              )}\r\n\r\n              {delivery.status === \"DISPUTE\" && (\r\n                <div className=\"rounded-xl border border-rose-200 bg-rose-50 p-3\">\r\n                  <div className=\"text-sm font-semibold text-rose-800\">–ú–∞—Ä–≥–∞–∞–Ω—Ç–∞–π</div>\r\n                  <div className=\"text-xs text-rose-700 mt-1 whitespace-pre-wrap\">\r\n                    {delivery.dispute_reason || \"‚Äî\"}\r\n                  </div>\r\n                  <div className=\"text-[11px] text-rose-600 mt-1\">\r\n                    –ù—ç—ç—Å—ç–Ω: {fmtDT(delivery.dispute_opened_at)}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </section>\r\n\r\n            {/* map preview */}\r\n            {hasMap && (\r\n              <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n                <h2 className=\"text-sm font-semibold text-slate-900\">–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —á–∏–≥–ª—ç–ª</h2>\r\n                <div className=\"overflow-hidden rounded-xl border border-slate-200\">\r\n                  <DeliveryRouteMap\r\n                    pickup={{ lat: delivery.pickup_lat!, lng: delivery.pickup_lng! }}\r\n                    dropoff={{ lat: delivery.dropoff_lat!, lng: delivery.dropoff_lng! }}\r\n                    height={260}\r\n                  />\r\n                </div>\r\n              </section>\r\n            )}\r\n\r\n            {/* actions */}\r\n            <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n              <h2 className=\"text-sm font-semibold text-slate-900\">“Æ–π–ª–¥—ç–ª</h2>\r\n\r\n              {/* OPEN: bids list */}\r\n              {delivery.status === \"OPEN\" && (\r\n                <div className=\"space-y-2\">\r\n                  <div className=\"text-xs text-slate-600\">–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Ö:</div>\r\n\r\n                  {loadingBids ? (\r\n                    <div className=\"text-xs text-slate-500\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n                  ) : bids.length === 0 ? (\r\n                    <div className=\"text-xs text-slate-500\">–û–¥–æ–æ–≥–æ–æ—Ä —Å–∞–Ω–∞–ª –∏—Ä—ç—ç–≥“Ø–π.</div>\r\n                  ) : (\r\n                    <div className=\"space-y-2\">\r\n                      {bids.map((b) => (\r\n                        <div\r\n                          key={b.id}\r\n                          className=\"rounded-xl border border-slate-200 bg-slate-50 p-3 flex items-center justify-between gap-2\"\r\n                        >\r\n                          <div className=\"min-w-0\">\r\n                            <div className=\"text-sm font-semibold text-slate-900 truncate\">\r\n                              {b.driver?.name || \"–ù—ç—Ä–≥“Ø–π –∂–æ–ª–æ–æ—á\"}\r\n                            </div>\r\n                            <div className=\"text-[11px] text-slate-600\">\r\n                              {b.driver?.phone ? `üìû ${b.driver.phone}` : \"üìû ‚Äî\"} ¬∑ –ò–ª–≥—ç—ç—Å—ç–Ω:{\" \"}\r\n                              {fmtDT(b.created_at)}\r\n                            </div>\r\n                          </div>\r\n\r\n                          <div className=\"flex items-center gap-2\">\r\n                            {b.driver?.phone && (\r\n                              <a\r\n                                href={`tel:${b.driver.phone}`}\r\n                                className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50\"\r\n                              >\r\n                                –ó–∞–ª–≥–∞—Ö\r\n                              </a>\r\n                            )}\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => void chooseDriver(b.driver_id)}\r\n                              disabled={chooseLoading === b.driver_id}\r\n                              className=\"text-[11px] px-4 py-2 rounded-full bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                            >\r\n                              {chooseLoading === b.driver_id ? \"–°–æ–Ω–≥–æ–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–°–æ–Ω–≥–æ—Ö\"}\r\n                            </button>\r\n                          </div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              )}\r\n\r\n              {/* Quick actions row */}\r\n              <div className=\"flex flex-wrap items-center gap-2\">\r\n                {/* ‚úÖ \"–•“Ø—Ä–≥—ç–ª—Ç –≥–∞—Ä—Å–∞–Ω\" ‚Äî –∑”©–≤—Ö”©–Ω ASSIGNED “Ø–µ–¥ –•–ê–†–ê–ì–î–ê–ù–ê */}\r\n                {delivery.status === \"ASSIGNED\" && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void markOnRoute()}\r\n                    disabled={!delivery.chosen_driver_id || markOnRouteLoading}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                    title=\"ASSIGNED -> ON_ROUTE\"\r\n                  >\r\n                    {markOnRouteLoading ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Ä–≥—ç–ª—Ç –≥–∞—Ä—Å–∞–Ω\"}\r\n                  </button>\r\n                )}\r\n\r\n                {/* ‚úÖ –ú–∞—Ä–≥–∞–∞–Ω ‚Äî –∑”©–≤—Ö”©–Ω ON_ROUTE/DELIVERED “Ø–µ–¥ –•–ê–†–ê–ì–î–ê–ù–ê */}\r\n                {(delivery.status === \"ON_ROUTE\" || delivery.status === \"DELIVERED\") && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setShowDispute(true)}\r\n                    className=\"text-xs px-4 py-2 rounded-xl border border-rose-300 bg-rose-50 text-rose-700 hover:bg-rose-100\"\r\n                  >\r\n                    –ú–∞—Ä–≥–∞–∞–Ω\r\n                  </button>\r\n                )}\r\n\r\n                {/* ‚úÖ DISPUTE –¥—ç—ç—Ä \"–®–∏–π–¥—ç–≥–¥—Å—ç–Ω\" */}\r\n                {delivery.status === \"DISPUTE\" && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void resolveDispute()}\r\n                    disabled={resolveLoading}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                    title=\"DISPUTE -> CLOSED\"\r\n                  >\r\n                    {resolveLoading ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–®–∏–π–¥—ç–≥–¥—Å—ç–Ω\"}\r\n                  </button>\r\n                )}\r\n\r\n                {/* –¶—É—Ü–ª–∞—Ö (—Ö–∞–∞–≥–¥—Å–∞–Ω–¥ –±–æ–ª –∑”©–≤—à”©”©—Ä”©—Ö–≥“Ø–π) */}\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => void cancelDelivery()}\r\n                  disabled={cancelLoading || delivery.status === \"CLOSED\" || delivery.status === \"CANCELLED\"}\r\n                  className=\"text-xs px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                >\r\n                  {cancelLoading ? \"–¶—É—Ü–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–¶—É—Ü–ª–∞—Ö\"}\r\n                </button>\r\n\r\n                {/* ‚úÖ –•–∞–∞–≥–¥—Å–∞–Ω –±“Ø–ª—ç–≥ –¥—ç—ç—Ä —É—Å—Ç–≥–∞—Ö (–Ω—É—É—Ö) */}\r\n                {canHideFromClosedGroup && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void hideFromClosedGroup()}\r\n                    disabled={hideLoading}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                    title=\"seller_hidden=true\"\r\n                  >\r\n                    {hideLoading ? \"–£—Å—Ç–≥–∞–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•–∞–∞–≥–¥—Å–∞–Ω–∞–∞—Å —É—Å—Ç–≥–∞—Ö\"}\r\n                  </button>\r\n                )}\r\n              </div>\r\n\r\n              {/* Payment block */}\r\n              <div className=\"pt-2 border-t border-slate-200\">\r\n                <div className=\"flex flex-wrap items-center justify-between gap-3\">\r\n                  <div className=\"space-y-1\">\r\n                    <div className=\"text-sm font-semibold text-slate-900\">–¢”©–ª–±”©—Ä</div>\r\n                    <div className=\"text-[11px] text-slate-500\">\r\n                      –•—É–¥–∞–ª–¥–∞–≥—á:{\" \"}\r\n                      <span className={delivery.seller_marked_paid ? \"text-emerald-700\" : \"text-slate-600\"}>\r\n                        {delivery.seller_marked_paid ? \"–¢”©–ª—Å”©–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Å—ç–Ω\" : \"–¢”©–ª”©”©–≥“Ø–π\"}\r\n                      </span>\r\n                      {\" ¬∑ \"}\r\n                      –ñ–æ–ª–æ–æ—á:{\" \"}\r\n                      <span className={delivery.driver_confirmed_payment ? \"text-emerald-700\" : \"text-slate-600\"}>\r\n                        {delivery.driver_confirmed_payment ? \"–ê–≤—Å–∞–Ω –≥—ç–∂ –±–∞—Ç–∞–ª—Å–∞–Ω\" : \"–ë–∞—Ç–ª–∞–∞–≥“Ø–π\"}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void toggleSellerPaid()}\r\n                    disabled={markPaidLoading || !(delivery.status === \"DELIVERED\" || delivery.status === \"CLOSED\")}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {markPaidLoading\r\n                      ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\"\r\n                      : delivery.seller_marked_paid\r\n                      ? \"–¢”©–ª–±”©—Ä–∏–π–Ω —Ç—ç–º–¥—ç–≥–ª—ç–≥—ç—ç —Ü—É—Ü–ª–∞—Ö\"\r\n                      : \"–¢”©–ª–±”©—Ä —Ç”©–ª—Å–Ω”©”© –±–∞—Ç–ª–∞—Ö\"}\r\n                  </button>\r\n                </div>\r\n\r\n                {delivery.status === \"CLOSED\" && (\r\n                  <div className=\"mt-3 rounded-xl border border-emerald-200 bg-emerald-50 p-3\">\r\n                    <div className=\"text-sm font-semibold text-emerald-800\">–•–∞–∞–≥–¥—Å–∞–Ω</div>\r\n                    <p className=\"text-xs text-emerald-700 mt-1\">\r\n                      {delivery.closed_at ? `(${fmtDT(delivery.closed_at)})` : \"\"} –¢”©–ª–±”©—Ä–∏–π–Ω —Ç–æ–æ—Ü–æ–æ –¥—É—É—Å—Å–∞–Ω.\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </section>\r\n\r\n            {/* dispute modal */}\r\n            {showDispute && (\r\n              <div className=\"fixed inset-0 z-20 flex items-center justify-center bg-black/30 px-4\">\r\n                <div className=\"max-w-md w-full rounded-2xl bg-white shadow-lg border border-slate-200 px-4 py-4 space-y-3\">\r\n                  <h3 className=\"text-sm font-semibold text-slate-900\">–ú–∞—Ä–≥–∞–∞–Ω “Ø“Ø—Å–≥—ç—Ö (seller)</h3>\r\n                  <p className=\"text-xs text-slate-600\">–¢–æ–≤—á, —Ç–æ–¥–æ—Ä—Ö–æ–π —à–∞–ª—Ç–≥–∞–∞–Ω–∞–∞ –±–∏—á–Ω—ç “Ø“Ø.</p>\r\n                  <textarea\r\n                    value={disputeReason}\r\n                    onChange={(e) => setDisputeReason(e.target.value)}\r\n                    rows={4}\r\n                    className=\"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-800 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-rose-500\"\r\n                    placeholder=\"–Æ—É –±–æ–ª—Å–æ–Ω —Ç–∞–ª–∞–∞—Ä‚Ä¶\"\r\n                  />\r\n                  <div className=\"flex items-center justify-end gap-2 pt-1\">\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setShowDispute(false)}\r\n                      disabled={disputeLoading}\r\n                      className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n                    >\r\n                      –ë–æ–ª–∏—Ö\r\n                    </button>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={async () => {\r\n                        if (disputeLoading) return;\r\n                        setDisputeLoading(true);\r\n                        try {\r\n                          await openDispute();\r\n                        } finally {\r\n                          setDisputeLoading(false);\r\n                        }\r\n                      }}\r\n                      disabled={disputeLoading}\r\n                      className=\"text-[11px] px-3 py-1.5 rounded-full bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-60\"\r\n                    >\r\n                      {disputeLoading ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö\"}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </>\r\n        )}\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/seller/new-delivery/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport \"leaflet/dist/leaflet.css\";\r\n\r\nimport dynamic from \"next/dynamic\";\r\nimport L from \"leaflet\";\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype LatLng = { lat: number; lng: number };\r\n\r\n// ‚úÖ undefined-–∏–π–≥ —á –∑”©–≤ —Ö”©—Ä–≤“Ø“Ø–ª–Ω—ç\r\nfunction numOrNull(v: number | null | undefined) {\r\n  if (typeof v !== \"number\" || Number.isNaN(v)) return null;\r\n  return v;\r\n}\r\n\r\nfunction isValidLatLng(p: LatLng | null) {\r\n  if (!p) return false;\r\n  return (\r\n    typeof p.lat === \"number\" &&\r\n    typeof p.lng === \"number\" &&\r\n    !Number.isNaN(p.lat) &&\r\n    !Number.isNaN(p.lng) &&\r\n    Math.abs(p.lat) <= 90 &&\r\n    Math.abs(p.lng) <= 180\r\n  );\r\n}\r\n\r\nasync function geocodeOne(query: string): Promise<LatLng | null> {\r\n  const q = String(query || \"\").trim();\r\n  if (!q) return null;\r\n\r\n  const url =\r\n    \"https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=0&q=\" +\r\n    encodeURIComponent(q);\r\n\r\n  const res = await fetch(url, { headers: { Accept: \"application/json\" } });\r\n  if (!res.ok) return null;\r\n\r\n  const data = (await res.json()) as any[];\r\n  if (!data || !data.length) return null;\r\n\r\n  const lat = Number(data[0].lat);\r\n  const lng = Number(data[0].lon);\r\n  if (Number.isNaN(lat) || Number.isNaN(lng)) return null;\r\n\r\n  return { lat, lng };\r\n}\r\n\r\n// ‚úÖ divIcon marker (–Ω–æ–≥–æ–æ–Ω/—É–ª–∞–∞–Ω –¥—É–≥—É–π)\r\nfunction circleIcon(color: \"green\" | \"red\") {\r\n  const fill = color === \"green\" ? \"#10b981\" : \"#ef4444\";\r\n  const stroke = color === \"green\" ? \"#065f46\" : \"#7f1d1d\";\r\n\r\n  return L.divIcon({\r\n    className: \"\",\r\n    html: `<div style=\"\r\n      width:16px;height:16px;border-radius:999px;\r\n      background:${fill}; border:2px solid ${stroke};\r\n      box-shadow:0 2px 10px rgba(0,0,0,.18);\r\n    \"></div>`,\r\n    iconSize: [16, 16],\r\n    iconAnchor: [8, 8],\r\n  });\r\n}\r\n\r\n/**\r\n * ‚úÖ LeafletMap ‚Äî react-leaflet-–∏–π–≥ –∑”©–≤—Ö”©–Ω client –¥—ç—ç—Ä –ª –∞—á–∞–∞–ª–Ω–∞\r\n * - pickup green marker\r\n * - dropoff red marker\r\n * - dashed polyline (round cap)\r\n * - fitBounds –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä\r\n *\r\n * react-leaflet v5: whenCreated –±–∞–π—Ö–≥“Ø–π ‚Üí ref –∞—à–∏–≥–ª–∞–Ω–∞.\r\n */\r\nconst LeafletMap = dynamic(async () => {\r\n  const RL = await import(\"react-leaflet\");\r\n  const { MapContainer, TileLayer, Marker, Polyline } = RL;\r\n\r\n  type Props = {\r\n    center: LatLng;\r\n    pickup: LatLng | null;\r\n    dropoff: LatLng | null;\r\n    onPickupChange: (p: LatLng) => void;\r\n    onDropoffChange: (p: LatLng) => void;\r\n  };\r\n\r\n  function Inner({ center, pickup, dropoff, onPickupChange, onDropoffChange }: Props) {\r\n    const mapRef = useRef<L.Map | null>(null);\r\n\r\n    const polyline = useMemo(() => {\r\n      if (!isValidLatLng(pickup) || !isValidLatLng(dropoff)) return null;\r\n      return [\r\n        [pickup!.lat, pickup!.lng],\r\n        [dropoff!.lat, dropoff!.lng],\r\n      ] as [number, number][];\r\n    }, [pickup, dropoff]);\r\n\r\n    useEffect(() => {\r\n      if (!mapRef.current) return;\r\n      if (!isValidLatLng(pickup) || !isValidLatLng(dropoff)) return;\r\n\r\n      const bounds = L.latLngBounds([pickup!.lat, pickup!.lng], [dropoff!.lat, dropoff!.lng]);\r\n      mapRef.current.fitBounds(bounds.pad(0.25), { animate: true });\r\n    }, [pickup, dropoff]);\r\n\r\n    return (\r\n      <MapContainer\r\n        ref={(map) => {\r\n          mapRef.current = (map as unknown as L.Map) || null;\r\n        }}\r\n        center={[center.lat, center.lng]}\r\n        zoom={13}\r\n        scrollWheelZoom\r\n        style={{ height: \"100%\", width: \"100%\" }}\r\n      >\r\n        <TileLayer\r\n          attribution=\"&copy; OpenStreetMap contributors\"\r\n          url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\r\n        />\r\n\r\n        {isValidLatLng(pickup) && (\r\n          <Marker\r\n            position={[pickup!.lat, pickup!.lng]}\r\n            draggable\r\n            icon={circleIcon(\"green\")}\r\n            eventHandlers={{\r\n              dragend: (e: any) => {\r\n                const ll = e.target.getLatLng();\r\n                onPickupChange({ lat: ll.lat, lng: ll.lng });\r\n              },\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {isValidLatLng(dropoff) && (\r\n          <Marker\r\n            position={[dropoff!.lat, dropoff!.lng]}\r\n            draggable\r\n            icon={circleIcon(\"red\")}\r\n            eventHandlers={{\r\n              dragend: (e: any) => {\r\n                const ll = e.target.getLatLng();\r\n                onDropoffChange({ lat: ll.lat, lng: ll.lng });\r\n              },\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {polyline && (\r\n          <Polyline\r\n            positions={polyline}\r\n            pathOptions={{\r\n              color: \"#111827\",\r\n              weight: 6,\r\n              opacity: 0.85,\r\n              dashArray: \"10 12\",\r\n              lineCap: \"round\",\r\n              lineJoin: \"round\",\r\n            }}\r\n          />\r\n        )}\r\n      </MapContainer>\r\n    );\r\n  }\r\n\r\n  return Inner;\r\n}, { ssr: false });\r\n\r\nexport default function NewDeliveryPage() {\r\n  const router = useRouter();\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n\r\n  const [deliveryType, setDeliveryType] = useState(\"apartment\");\r\n  const [fromAddress, setFromAddress] = useState(\"\");\r\n  const [toAddress, setToAddress] = useState(\"\");\r\n  const [receiverPhone, setReceiverPhone] = useState(\"\");\r\n  const [note, setNote] = useState(\"\");\r\n  const [price, setPrice] = useState(\"\");\r\n\r\n  const [pickup, setPickup] = useState<LatLng | null>(null);\r\n  const [dropoff, setDropoff] = useState<LatLng | null>(null);\r\n\r\n  const [geoLoadingFrom, setGeoLoadingFrom] = useState(false);\r\n  const [geoLoadingTo, setGeoLoadingTo] = useState(false);\r\n\r\n  const [loadingUser, setLoadingUser] = useState(true);\r\n  const [sending, setSending] = useState(false);\r\n\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [success, setSuccess] = useState(false);\r\n\r\n  const ubCenter: LatLng = useMemo(() => ({ lat: 47.9186, lng: 106.917 }), []);\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) {\r\n        router.replace(\"/\");\r\n        return;\r\n      }\r\n\r\n      const parsed: IncomeUser = JSON.parse(raw);\r\n\r\n      if (parsed.role !== \"seller\") {\r\n        router.replace(\"/driver\");\r\n        return;\r\n      }\r\n\r\n      setUser(parsed);\r\n\r\n      const savedFrom = window.localStorage.getItem(\"incomeLastFromAddress\");\r\n      if (savedFrom && savedFrom.trim().length > 0) {\r\n        setFromAddress(savedFrom);\r\n      }\r\n\r\n      setLoadingUser(false);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —É–Ω—à–∏—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      setLoadingUser(false);\r\n    }\r\n  }, [router]);\r\n\r\n  async function handleGeocodeFrom() {\r\n    setError(null);\r\n    const q = fromAddress.trim();\r\n    if (!q) return setError(\"–ê–í–ê–• —Ö–∞—è–≥ —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.\");\r\n\r\n    try {\r\n      setGeoLoadingFrom(true);\r\n      const p = await geocodeOne(q);\r\n      if (!p) return setError(\"–ê–í–ê–• —Ö–∞—è–≥ –æ–ª–¥—Å–æ–Ω–≥“Ø–π. –ò–ª“Ø“Ø —Ç–æ–¥–æ—Ä—Ö–æ–π –±–∏—á—ç—ç–¥ –¥–∞—Ö–∏–Ω —Ö–∞–π–Ω–∞ —É—É.\");\r\n      setPickup(p);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–ê–í–ê–• —Ö–∞—è–≥ —Ö–∞–π—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setGeoLoadingFrom(false);\r\n    }\r\n  }\r\n\r\n  async function handleGeocodeTo() {\r\n    setError(null);\r\n    const q = toAddress.trim();\r\n    if (!q) return setError(\"–•“Æ–†–ì–≠–• —Ö–∞—è–≥ —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.\");\r\n\r\n    try {\r\n      setGeoLoadingTo(true);\r\n      const p = await geocodeOne(q);\r\n      if (!p) return setError(\"–•“Æ–†–ì–≠–• —Ö–∞—è–≥ –æ–ª–¥—Å–æ–Ω–≥“Ø–π. –ò–ª“Ø“Ø —Ç–æ–¥–æ—Ä—Ö–æ–π –±–∏—á—ç—ç–¥ –¥–∞—Ö–∏–Ω —Ö–∞–π–Ω–∞ —É—É.\");\r\n      setDropoff(p);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–•“Æ–†–ì–≠–• —Ö–∞—è–≥ —Ö–∞–π—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setGeoLoadingTo(false);\r\n    }\r\n  }\r\n\r\n  async function ensureCoordsBeforeSubmit() {\r\n    if (!isValidLatLng(pickup)) {\r\n      const p = await geocodeOne(fromAddress);\r\n      if (p) setPickup(p);\r\n    }\r\n    if (!isValidLatLng(dropoff)) {\r\n      const p = await geocodeOne(toAddress);\r\n      if (p) setDropoff(p);\r\n    }\r\n  }\r\n\r\n  async function handleSubmit(e: React.FormEvent) {\r\n    e.preventDefault();\r\n    if (!user) return;\r\n\r\n    setError(null);\r\n    setSuccess(false);\r\n\r\n    if (!fromAddress.trim()) return setError(\"–ê–í–ê–• —Ö–∞—è–≥ —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.\");\r\n    if (!toAddress.trim()) return setError(\"–•“Æ–†–ì–≠–• —Ö–∞—è–≥ —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.\");\r\n    if (!receiverPhone.trim()) return setError(\"–•“Æ–õ–≠–≠–ù –ê–í–ê–• —Ö“Ø–Ω–∏–π —É—Ç–∞—Å –∑–∞–∞–≤–∞–ª.\");\r\n    if (!price.trim() || isNaN(Number(price))) return setError(\"“Æ–Ω—ç (‚ÇÆ) –∑”©–≤ –æ—Ä—É—É–ª–Ω–∞ —É—É.\");\r\n\r\n    try {\r\n      setSending(true);\r\n\r\n      await ensureCoordsBeforeSubmit();\r\n\r\n      const hasPick = isValidLatLng(pickup);\r\n      const hasDrop = isValidLatLng(dropoff);\r\n\r\n      if (!hasPick || !hasDrop) {\r\n        setSending(false);\r\n        setError(\"Map –¥—ç—ç—Ä –Ω–æ–≥–æ–æ–Ω/—É–ª–∞–∞–Ω —Ü—ç–≥–∏–π–≥ –±–∞–π—Ä–ª—É—É–ª–∞–∞–¥ (—ç—Å–≤—ç–ª –•–∞–π—Ö –¥–∞—Ä–∂) –¥–∞—Ö–∏–Ω –∏–ª–≥—ç—ç–Ω—ç “Ø“Ø.\");\r\n        return;\r\n      }\r\n\r\n      const { error: insertError } = await supabase.from(\"deliveries\").insert({\r\n        seller_id: user.id,\r\n        delivery_type: deliveryType,\r\n        from_address: fromAddress,\r\n        to_address: toAddress,\r\n        receiver_phone: receiverPhone,\r\n        note,\r\n        price_mnt: Number(price),\r\n        status: \"OPEN\",\r\n\r\n        pickup_lat: numOrNull(pickup?.lat),\r\n        pickup_lng: numOrNull(pickup?.lng),\r\n        dropoff_lat: numOrNull(dropoff?.lat),\r\n        dropoff_lng: numOrNull(dropoff?.lng),\r\n      });\r\n\r\n      if (insertError) {\r\n        console.error(insertError);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        setSending(false);\r\n        return;\r\n      }\r\n\r\n      window.localStorage.setItem(\"incomeLastFromAddress\", fromAddress);\r\n\r\n      setSuccess(true);\r\n      setTimeout(() => router.push(\"/seller\"), 900);\r\n    } catch (err) {\r\n      console.error(err);\r\n      setError(\"–°–µ—Ä–≤–µ—Ä—Ç—ç–π —Ö–æ–ª–±–æ–≥–¥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setSending(false);\r\n    }\r\n  }\r\n\r\n  const mapCenter = useMemo(() => {\r\n    if (isValidLatLng(pickup)) return pickup!;\r\n    if (isValidLatLng(dropoff)) return dropoff!;\r\n    return ubCenter;\r\n  }, [pickup, dropoff, ubCenter]);\r\n\r\n  if (loadingUser) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-slate-500 text-sm\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-slate-500 text-sm\">–ù—ç–≤—Ç—Ä—ç—ç–≥“Ø–π –±–∞–π–Ω–∞.</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <header className=\"border-b border-slate-200 bg-white\">\r\n        <div className=\"max-w-3xl mx-auto px-4 py-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"inline-flex items-center justify-center rounded-full bg-emerald-50 px-3 py-1\">\r\n              <span className=\"text-xs font-semibold text-emerald-700\">INCOME</span>\r\n            </div>\r\n            <div>\r\n              <h1 className=\"text-sm font-semibold text-slate-900\">–•“Ø—Ä–≥—ç–ª—Ç “Ø“Ø—Å–≥—ç—Ö</h1>\r\n              <p className=\"text-xs text-slate-500\">–•–∞—è–≥–∞–∞ –æ—Ä—É—É–ª–∞–∞–¥ map –¥—ç—ç—Ä —Ü—ç–≥—ç—ç –±–∞–π—Ä–ª—É—É–ª–∞–∞—Ä–∞–π.</p>\r\n            </div>\r\n          </div>\r\n\r\n          <button\r\n            onClick={() => router.push(\"/seller\")}\r\n            className=\"mt-3 text-xs px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n          >\r\n            ‚Üê –ë—É—Ü–∞—Ö\r\n          </button>\r\n        </div>\r\n      </header>\r\n\r\n      <main className=\"max-w-3xl mx-auto px-4 py-6 space-y-5\">\r\n        {error && (\r\n          <div className=\"text-xs text-red-600 bg-red-50 border border-red-100 rounded-xl px-3 py-2\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        {success && (\r\n          <div className=\"text-xs text-emerald-600 bg-emerald-50 border border-emerald-100 rounded-xl px-3 py-2\">\r\n            –•“Ø—Ä–≥—ç–ª—Ç –∞–º–∂–∏–ª—Ç—Ç–∞–π “Ø“Ø—Å–≥—ç–≥–¥–ª—ç—ç!\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"rounded-2xl border border-slate-200 bg-white p-3 shadow-sm\">\r\n          <div className=\"mb-2 flex items-center justify-between gap-2\">\r\n            <div className=\"text-sm font-semibold text-slate-900\">Map</div>\r\n            <div className=\"text-[11px] text-slate-500\">üü¢ —ç—Ö–ª—ç—Ö ¬∑ üî¥ –¥—É—É—Å–∞—Ö (—á–∏—Ä–∂ –±–∞–π—Ä–ª—É—É–ª–∂ –±–æ–ª–Ω–æ)</div>\r\n          </div>\r\n\r\n          <div className=\"h-[320px] w-full overflow-hidden rounded-2xl border border-slate-200\">\r\n            <LeafletMap\r\n              center={mapCenter}\r\n              pickup={pickup}\r\n              dropoff={dropoff}\r\n              onPickupChange={setPickup}\r\n              onDropoffChange={setDropoff}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid gap-2 md:grid-cols-2\">\r\n            <div className=\"rounded-xl border border-emerald-100 bg-emerald-50 px-3 py-2\">\r\n              <div className=\"text-[11px] text-emerald-700/80\">üü¢ –≠—Ö–ª—ç—Ö —Ü—ç–≥</div>\r\n              <div className=\"text-xs font-semibold text-emerald-900\">\r\n                {isValidLatLng(pickup) ? `${pickup!.lat.toFixed(5)}, ${pickup!.lng.toFixed(5)}` : \"–¢–æ—Ö–∏—Ä—É—É–ª–∞–∞–≥“Ø–π\"}\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"rounded-xl border border-rose-100 bg-rose-50 px-3 py-2\">\r\n              <div className=\"text-[11px] text-rose-700/80\">üî¥ –î—É—É—Å–∞—Ö —Ü—ç–≥</div>\r\n              <div className=\"text-xs font-semibold text-rose-900\">\r\n                {isValidLatLng(dropoff) ? `${dropoff!.lat.toFixed(5)}, ${dropoff!.lng.toFixed(5)}` : \"–¢–æ—Ö–∏—Ä—É—É–ª–∞–∞–≥“Ø–π\"}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <form onSubmit={handleSubmit} className=\"space-y-5\">\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Ç”©—Ä”©–ª</label>\r\n            <select\r\n              value={deliveryType}\r\n              onChange={(e) => setDeliveryType(e.target.value)}\r\n              className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm\"\r\n            >\r\n              <option value=\"apartment\">üèô –ë–∞–π—Ä</option>\r\n              <option value=\"ger\">üè† –ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª</option>\r\n              <option value=\"camp\">üèï –õ–∞–≥–µ—Ä</option>\r\n              <option value=\"countryside\">üöå –û—Ä–æ–Ω –Ω—É—Ç–∞–≥ (—É–Ω–∞–∞–Ω–¥ —Ç–∞–≤–∏—Ö)</option>\r\n            </select>\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">“Æ–Ω—ç (‚ÇÆ)</label>\r\n            <input\r\n              type=\"number\"\r\n              inputMode=\"numeric\"\r\n              className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm\"\r\n              placeholder=\"–ñ: 5000\"\r\n              value={price}\r\n              onChange={(e) => setPrice(e.target.value)}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">–ê–í–ê–• —Ö–∞—è–≥</label>\r\n            <div className=\"flex gap-2\">\r\n              <input\r\n                type=\"text\"\r\n                className=\"flex-1 border border-slate-300 rounded-xl px-3 py-2 text-sm\"\r\n                placeholder=\"–ñ: –ë–ì–î, 3-—Ä —Ö–æ—Ä–æ–æ, 5-—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª‚Ä¶\"\r\n                value={fromAddress}\r\n                onChange={(e) => setFromAddress(e.target.value)}\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleGeocodeFrom}\r\n                disabled={geoLoadingFrom}\r\n                className=\"shrink-0 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:border-slate-300 disabled:opacity-60\"\r\n              >\r\n                {geoLoadingFrom ? \"...\" : \"–•–∞–π—Ö\"}\r\n              </button>\r\n            </div>\r\n            <p className=\"text-[11px] text-slate-400\">\r\n              –ù—ç–≥ —É–¥–∞–∞ –±”©–≥–ª”©—Å–Ω–∏–π –¥–∞—Ä–∞–∞ –¥–∞—Ä–∞–∞–≥–∏–π–Ω —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥—ç–¥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –≥–∞—Ä—á –∏—Ä–Ω—ç.\r\n            </p>\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">–•“Æ–†–ì–≠–• —Ö–∞—è–≥</label>\r\n            <div className=\"flex gap-2\">\r\n              <input\r\n                type=\"text\"\r\n                className=\"flex-1 border border-slate-300 rounded-xl px-3 py-2 text-sm\"\r\n                placeholder=\"–ñ: –°–ë–î, 6-—Ä —Ö–æ—Ä–æ–æ, –≠–Ω—Ö —Ç–∞–π–≤–Ω—ã ”©—Ä–≥”©–Ω —á”©–ª”©”©‚Ä¶\"\r\n                value={toAddress}\r\n                onChange={(e) => setToAddress(e.target.value)}\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleGeocodeTo}\r\n                disabled={geoLoadingTo}\r\n                className=\"shrink-0 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:border-slate-300 disabled:opacity-60\"\r\n              >\r\n                {geoLoadingTo ? \"...\" : \"–•–∞–π—Ö\"}\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">–•“Æ–õ–≠–≠–ù –ê–í–ê–• —Ö“Ø–Ω–∏–π —É—Ç–∞—Å</label>\r\n            <input\r\n              type=\"text\"\r\n              className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm\"\r\n              placeholder=\"–ñ: 9911XXXX\"\r\n              value={receiverPhone}\r\n              onChange={(e) => setReceiverPhone(e.target.value)}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">–Æ—É —Ö“Ø—Ä–≥“Ø“Ø–ª—ç—Ö –≥—ç–∂ –±–∞–π–≥–∞–∞ (—Ç–æ–≤—á)</label>\r\n            <textarea\r\n              className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm h-20\"\r\n              placeholder=\"–ñ: 2 —Ö–∞–π—Ä—Ü–∞–≥ —É—Å, 1 —Ç–æ–Ω–æ–≥ —Ç”©—Ö”©”©—Ä”©–º–∂‚Ä¶\"\r\n              value={note}\r\n              onChange={(e) => setNote(e.target.value)}\r\n            />\r\n          </div>\r\n\r\n          <div>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={sending}\r\n              className=\"w-full rounded-xl bg-emerald-600 text-white text-sm font-medium px-4 py-2 hover:bg-emerald-700 disabled:bg-emerald-400 transition\"\r\n            >\r\n              {sending ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Ä–≥—ç–ª—Ç “Ø“Ø—Å–≥—ç—Ö\"}\r\n            </button>\r\n\r\n            <div className=\"mt-2 text-[11px] text-slate-500\">\r\n              –ò–ª–≥—ç—ç—Ö “Ø–µ–¥: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –æ–ª–¥–æ—Ö–≥“Ø–π –±–æ–ª map –¥—ç—ç—Ä 2 —Ü—ç–≥—ç—ç –±–∞–π—Ä–ª—É—É–ª—Å–Ω—ã –¥–∞—Ä–∞–∞ –∏–ª–≥—ç—ç–Ω—ç.\r\n            </div>\r\n          </div>\r\n        </form>\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/seller/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n/* ===========================\r\n * app/seller/page.tsx (FINAL v2)\r\n *\r\n * ‚úÖ 7 —Å–∞–π–∂—Ä—É—É–ª–∞–ª—Ç—ã–Ω –¥–∞–≥—É—É —Ç–∞–±/–ª–æ–≥–∏–∫ —Ö—ç–≤—ç—ç—Ä\r\n * ‚úÖ OPEN –∫–∞—Ä—Ç—ã–Ω UI: –•–∞–∞–Ω–∞–∞—Å ‚Üí –•–∞–∞—à–∞–∞ ‚Üí –Æ—É (—Ç—É—Å —Ç—É—Å–¥–∞–∞)\r\n * ‚úÖ \"–•“Ø—Ä–≥—ç–ª—Ç –Ω—ç–º—ç—Ö\" —Ç–æ–≤—á–∏–π–≥ –±—É—Ü–∞–∞–∂ –æ—Ä—É—É–ª—Å–∞–Ω\r\n * =========================== */\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport {\r\n  DeliveryStatus,\r\n  SELLER_TABS,\r\n  SellerTabId,\r\n  getSellerTabForStatus,\r\n} from \"@/lib/deliveryLogic\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryRow = {\r\n  id: string;\r\n  seller_id: string;\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n  chosen_driver_id: string | null;\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n  closed_at: string | null;\r\n  dispute_reason: string | null;\r\n  dispute_opened_at: string | null;\r\n  seller_hidden: boolean;\r\n\r\n  // UI-only\r\n  bid_count?: number;\r\n};\r\n\r\nfunction fmtPrice(n: number | null | undefined) {\r\n  const v = Number(n || 0);\r\n  return v ? `${v.toLocaleString(\"mn-MN\")}‚ÇÆ` : \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n}\r\n\r\nfunction fmtDT(iso: string | null | undefined) {\r\n  if (!iso) return \"\";\r\n  try {\r\n    return new Date(iso).toLocaleString(\"mn-MN\", { hour12: false });\r\n  } catch {\r\n    return String(iso);\r\n  }\r\n}\r\n\r\nfunction shorten(s: string | null, max = 70) {\r\n  if (!s) return \"‚Äî\";\r\n  const t = s.trim();\r\n  if (t.length <= max) return t;\r\n  return t.slice(0, max).replace(/\\s+$/, \"\") + \"‚Ä¶\";\r\n}\r\n\r\nfunction typeLabel(deliveryType: string | null): { icon: string; label: string } {\r\n  switch (deliveryType) {\r\n    case \"apartment\":\r\n      return { icon: \"üèô\", label: \"–ë–∞–π—Ä\" };\r\n    case \"ger\":\r\n      return { icon: \"üè†\", label: \"–ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª\" };\r\n    case \"camp\":\r\n      return { icon: \"üèï\", label: \"–õ–∞–≥–µ—Ä\" };\r\n    case \"countryside\":\r\n      return { icon: \"üöå\", label: \"–û—Ä–æ–Ω –Ω—É—Ç–∞–≥\" };\r\n    default:\r\n      return { icon: \"üì¶\", label: \"–•“Ø—Ä–≥—ç–ª—Ç\" };\r\n  }\r\n}\r\n\r\nfunction badge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return { text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\", cls: \"bg-emerald-50 text-emerald-700 border-emerald-100\" };\r\n    case \"ASSIGNED\":\r\n      return { text: \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\", cls: \"bg-sky-50 text-sky-700 border-sky-100\" };\r\n    case \"ON_ROUTE\":\r\n      return { text: \"–ó–∞–º–¥\", cls: \"bg-indigo-50 text-indigo-700 border-indigo-100\" };\r\n    case \"DELIVERED\":\r\n      return { text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\", cls: \"bg-amber-50 text-amber-700 border-amber-100\" };\r\n    case \"DISPUTE\":\r\n      return { text: \"–ú–∞—Ä–≥–∞–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    case \"CLOSED\":\r\n      return { text: \"–•–∞–∞–≥–¥—Å–∞–Ω\", cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n    case \"CANCELLED\":\r\n      return { text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    default:\r\n      return { text: status, cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n  }\r\n}\r\n\r\nfunction filterByTab(tab: SellerTabId, items: DeliveryRow[]) {\r\n  return items.filter((d) => getSellerTabForStatus(d.status) === tab);\r\n}\r\n\r\nfunction Pill({\r\n  label,\r\n  value,\r\n  accent = \"slate\",\r\n}: {\r\n  label: string;\r\n  value: string;\r\n  accent?: \"emerald\" | \"rose\" | \"sky\" | \"slate\" | \"amber\" | \"indigo\";\r\n}) {\r\n  const acc =\r\n    accent === \"emerald\"\r\n      ? \"bg-emerald-50 border-emerald-100 text-emerald-800\"\r\n      : accent === \"rose\"\r\n      ? \"bg-rose-50 border-rose-100 text-rose-800\"\r\n      : accent === \"sky\"\r\n      ? \"bg-sky-50 border-sky-100 text-sky-800\"\r\n      : accent === \"amber\"\r\n      ? \"bg-amber-50 border-amber-100 text-amber-800\"\r\n      : accent === \"indigo\"\r\n      ? \"bg-indigo-50 border-indigo-100 text-indigo-800\"\r\n      : \"bg-slate-50 border-slate-200 text-slate-800\";\r\n\r\n  return (\r\n    <div className={`rounded-xl border px-3 py-2 ${acc}`}>\r\n      <div className=\"text-[11px] opacity-70\">{label}</div>\r\n      <div className=\"text-sm font-semibold leading-snug\">{value}</div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function SellerDashboardPage() {\r\n  const router = useRouter();\r\n  const sp = useSearchParams();\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [activeTab, setActiveTab] = useState<SellerTabId>(\"OPEN\");\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [items, setItems] = useState<DeliveryRow[]>([]);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [msg, setMsg] = useState<string | null>(null);\r\n\r\n  const [actLoading, setActLoading] = useState<Record<string, boolean>>({});\r\n\r\n  // auth\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) return router.replace(\"/\");\r\n      const u: IncomeUser = JSON.parse(raw);\r\n      if (u.role !== \"seller\") return router.replace(\"/\");\r\n      setUser(u);\r\n    } catch {\r\n      router.replace(\"/\");\r\n    }\r\n  }, [router]);\r\n\r\n  // init tab\r\n  useEffect(() => {\r\n    const urlTab = sp.get(\"tab\");\r\n    const valid = SELLER_TABS.some((t) => t.id === (urlTab as any));\r\n    if (urlTab && valid) {\r\n      setActiveTab(urlTab as SellerTabId);\r\n      localStorage.setItem(\"sellerActiveTab\", urlTab);\r\n      return;\r\n    }\r\n    const stored = localStorage.getItem(\"sellerActiveTab\");\r\n    const validStored = SELLER_TABS.some((t) => t.id === (stored as any));\r\n    if (stored && validStored) setActiveTab(stored as SellerTabId);\r\n  }, [sp]);\r\n\r\n  function changeTab(tab: SellerTabId) {\r\n    setActiveTab(tab);\r\n    localStorage.setItem(\"sellerActiveTab\", tab);\r\n    router.push(`/seller?tab=${tab}`);\r\n  }\r\n\r\n  // fetch\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    void fetchAll(user.id);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id]);\r\n\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    const onFocus = () => void fetchAll(user.id);\r\n    window.addEventListener(\"focus\", onFocus);\r\n    return () => window.removeEventListener(\"focus\", onFocus);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id]);\r\n\r\n  async function fetchAll(sellerId: string) {\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          seller_id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          chosen_driver_id,\r\n          seller_marked_paid,\r\n          driver_confirmed_payment,\r\n          closed_at,\r\n          dispute_reason,\r\n          dispute_opened_at,\r\n          seller_hidden\r\n        `\r\n        )\r\n        .eq(\"seller_id\", sellerId)\r\n        .eq(\"seller_hidden\", false)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (e1) throw e1;\r\n\r\n      const base: DeliveryRow[] = (data || []).map((d: any) => ({\r\n        id: d.id,\r\n        seller_id: d.seller_id,\r\n        from_address: d.from_address,\r\n        to_address: d.to_address,\r\n        note: d.note,\r\n        status: d.status,\r\n        created_at: d.created_at,\r\n        price_mnt: d.price_mnt,\r\n        delivery_type: d.delivery_type,\r\n        chosen_driver_id: d.chosen_driver_id,\r\n        seller_marked_paid: !!d.seller_marked_paid,\r\n        driver_confirmed_payment: !!d.driver_confirmed_payment,\r\n        closed_at: d.closed_at,\r\n        dispute_reason: d.dispute_reason,\r\n        dispute_opened_at: d.dispute_opened_at,\r\n        seller_hidden: !!d.seller_hidden,\r\n      }));\r\n\r\n      // OPEN –¥—ç—ç—Ä bid_count –Ω—ç–º–Ω—ç (driver_bids)\r\n      const openIds = base.filter((x) => x.status === \"OPEN\").map((x) => x.id);\r\n\r\n      let bidMap: Record<string, number> = {};\r\n      if (openIds.length) {\r\n        const { data: bids, error: e2 } = await supabase\r\n          .from(\"driver_bids\")\r\n          .select(\"delivery_id\")\r\n          .in(\"delivery_id\", openIds);\r\n\r\n        if (!e2 && bids) {\r\n          bidMap = bids.reduce((acc: any, r: any) => {\r\n            const k = r.delivery_id as string;\r\n            acc[k] = (acc[k] || 0) + 1;\r\n            return acc;\r\n          }, {});\r\n        }\r\n      }\r\n\r\n      const merged = base.map((d) => ({\r\n        ...d,\r\n        bid_count: d.status === \"OPEN\" ? bidMap[d.id] || 0 : undefined,\r\n      }));\r\n\r\n      setItems(merged);\r\n      setMsg(null);\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"”®–≥”©–≥–¥”©–ª —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function markOnRouteFromAssigned(deliveryId: string) {\r\n    if (!user) return;\r\n    setActLoading((p) => ({ ...p, [deliveryId]: true }));\r\n    setMsg(null);\r\n    setError(null);\r\n\r\n    try {\r\n      const { error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"ON_ROUTE\" })\r\n        .eq(\"id\", deliveryId)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (e1) throw e1;\r\n\r\n      await fetchAll(user.id);\r\n      changeTab(\"ON_ROUTE\");\r\n      setMsg(\"–•“Ø—Ä–≥—ç–ª—Ç –∑–∞–º–¥ –≥–∞—Ä–ª–∞–∞.\");\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–®–∏–Ω—ç—á–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n    } finally {\r\n      setActLoading((p) => ({ ...p, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  async function hideFromClosed(deliveryId: string) {\r\n    if (!user) return;\r\n    setActLoading((p) => ({ ...p, [deliveryId]: true }));\r\n    setMsg(null);\r\n    setError(null);\r\n\r\n    try {\r\n      const { error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ seller_hidden: true })\r\n        .eq(\"id\", deliveryId)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (e1) throw e1;\r\n\r\n      await fetchAll(user.id);\r\n      setMsg(\"–•–∞–∞–≥–¥—Å–∞–Ω–∞–∞—Å —É—Å—Ç–≥–∞–ª–∞–∞.\");\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–£—Å—Ç–≥–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n    } finally {\r\n      setActLoading((p) => ({ ...p, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  const filtered = useMemo(() => filterByTab(activeTab, items), [activeTab, items]);\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <div className=\"mx-auto max-w-5xl px-4 pb-12 pt-6\">\r\n        {/* Header */}\r\n        <div className=\"mb-4 flex items-start justify-between gap-3\">\r\n          <div>\r\n            <div className=\"text-xs text-slate-500\">–•—É–¥–∞–ª–¥–∞–≥—á</div>\r\n          </div>\r\n\r\n          <button\r\n            onClick={() => router.push(\"/seller/new-delivery\")}\r\n            className=\"shrink-0 rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99]\"\r\n          >\r\n            Ôºã –•“Ø—Ä–≥—ç–ª—Ç –Ω—ç–º—ç—Ö\r\n          </button>\r\n        </div>\r\n\r\n        {/* Tabs */}\r\n        <div className=\"mb-5 flex flex-wrap gap-2\">\r\n          {SELLER_TABS.map((t) => {\r\n            const isActive = t.id === activeTab;\r\n            return (\r\n              <button\r\n                key={t.id}\r\n                onClick={() => changeTab(t.id)}\r\n                className={`rounded-xl border px-3 py-2 text-sm font-semibold transition ${\r\n                  isActive\r\n                    ? \"border-slate-900 bg-white text-slate-900 shadow-sm\"\r\n                    : \"border-slate-200 bg-white text-slate-600 hover:border-slate-300\"\r\n                }`}\r\n              >\r\n                {t.label}\r\n              </button>\r\n            );\r\n          })}\r\n        </div>\r\n\r\n        {/* Alerts */}\r\n        {error && (\r\n          <div className=\"mb-4 rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800\">\r\n            {error}\r\n          </div>\r\n        )}\r\n        {msg && (\r\n          <div className=\"mb-4 rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800\">\r\n            {msg}\r\n          </div>\r\n        )}\r\n\r\n        {/* Body */}\r\n        {loading ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-slate-600\">\r\n            –ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\r\n          </div>\r\n        ) : filtered.length === 0 ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-slate-600\">\r\n            –≠–Ω—ç —Ç–∞–± –¥—ç—ç—Ä –æ–¥–æ–æ–≥–æ–æ—Ä —Ö“Ø—Ä–≥—ç–ª—Ç –∞–ª–≥–∞.\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid gap-4\">\r\n            {filtered.map((d) => {\r\n              const b = badge(d.status);\r\n              const t = typeLabel(d.delivery_type);\r\n\r\n              const from = shorten(d.from_address, 48);\r\n              const to = shorten(d.to_address, 48);\r\n              const what = shorten(d.note, 80);\r\n\r\n              const bidCount = d.status === \"OPEN\" ? Number(d.bid_count || 0) : 0;\r\n\r\n              return (\r\n                <div\r\n                  key={d.id}\r\n                  className=\"rounded-3xl border border-slate-200 bg-white p-4 shadow-sm\"\r\n                >\r\n                  {/* Top row */}\r\n                  <div className=\"flex flex-wrap items-center justify-between gap-3\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span className=\"text-lg\">{t.icon}</span>\r\n                      <span className=\"text-sm font-semibold text-slate-900\">{t.label}</span>\r\n                      <span className={`rounded-full border px-2.5 py-1 text-xs font-semibold ${b.cls}`}>\r\n                        {b.text}\r\n                      </span>\r\n\r\n                      {d.status === \"OPEN\" && (\r\n                        <span className=\"rounded-full border border-slate-200 bg-slate-50 px-2.5 py-1 text-xs font-semibold text-slate-700\">\r\n                          –°–∞–Ω–∞–ª: {bidCount}\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n\r\n                    <div className=\"text-xs text-slate-500\">{fmtDT(d.created_at)}</div>\r\n                  </div>\r\n\r\n                  {/* Main tiles (OPEN/UI clarity) */}\r\n                  <div className=\"mt-4 grid gap-3 md:grid-cols-3\">\r\n                    <Pill label=\"–•–∞–∞–Ω–∞–∞—Å\" value={from} accent=\"emerald\" />\r\n                    <Pill label=\"–•–∞–∞—à–∞–∞\" value={to} accent=\"rose\" />\r\n                    <Pill label=\"–Æ—É —Ö“Ø—Ä–≥—ç—Ö\" value={what} accent=\"sky\" />\r\n                  </div>\r\n\r\n                  {/* Bottom row */}\r\n                  <div className=\"mt-4 flex flex-wrap items-center justify-between gap-3\">\r\n                    <div className=\"flex flex-wrap items-center gap-2\">\r\n                      <span className=\"rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900\">\r\n                        {fmtPrice(d.price_mnt)}\r\n                      </span>\r\n\r\n                      {d.status === \"DISPUTE\" && d.dispute_opened_at && (\r\n                        <span className=\"rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-800\">\r\n                          –ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Å—ç–Ω: {fmtDT(d.dispute_opened_at)}\r\n                        </span>\r\n                      )}\r\n\r\n                      {d.status === \"CLOSED\" && d.closed_at && (\r\n                        <span className=\"rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs font-semibold text-slate-700\">\r\n                          –•–∞–∞–≥–¥—Å–∞–Ω: {fmtDT(d.closed_at)}\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n\r\n                    <div className=\"flex flex-wrap gap-2\">\r\n                      {/* ASSIGNED –¥—ç—ç—Ä \"–•“Ø—Ä–≥—ç–ª—Ç –≥–∞—Ä—Å–∞–Ω\" */}\r\n                      {activeTab === \"ASSIGNED\" && d.status === \"ASSIGNED\" && (\r\n                        <button\r\n                          onClick={() => markOnRouteFromAssigned(d.id)}\r\n                          disabled={!!actLoading[d.id]}\r\n                          className=\"rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60\"\r\n                        >\r\n                          {actLoading[d.id] ? \"–¢“Ø—Ä —Ö“Ø–ª—ç—ç–Ω—ç “Ø“Ø‚Ä¶\" : \"–•“Ø—Ä–≥—ç–ª—Ç –≥–∞—Ä—Å–∞–Ω\"}\r\n                        </button>\r\n                      )}\r\n\r\n                      {/* CLOSED –¥—ç—ç—Ä —É—Å—Ç–≥–∞—Ö (seller_hidden=true) */}\r\n                      {activeTab === \"CLOSED\" && (d.status === \"CLOSED\" || d.status === \"CANCELLED\") && (\r\n                        <button\r\n                          onClick={() => hideFromClosed(d.id)}\r\n                          disabled={!!actLoading[d.id]}\r\n                          className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:border-slate-300 disabled:opacity-60\"\r\n                        >\r\n                          {actLoading[d.id] ? \"–£—Å—Ç–≥–∞–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•–∞–∞–≥–¥—Å–∞–Ω–∞–∞—Å —É—Å—Ç–≥–∞—Ö\"}\r\n                        </button>\r\n                      )}\r\n\r\n                      <button\r\n                        onClick={() => router.push(`/seller/delivery/${d.id}?tab=${activeTab}`)}\r\n                        className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300\"\r\n                      >\r\n                        –î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        )}\r\n\r\n        {/* Footer quick */}\r\n        <div className=\"mt-10 flex items-center justify-between gap-3 text-xs text-slate-500\">\r\n          <span>INCOME ¬∑ Seller</span>\r\n          <button\r\n            onClick={() => {\r\n              try {\r\n                localStorage.removeItem(\"incomeUser\");\r\n              } catch {}\r\n              router.push(\"/\");\r\n            }}\r\n            className=\"rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:border-slate-300\"\r\n          >\r\n            –ì–∞—Ä–∞—Ö\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "lib/deliveryLogic.ts",
        "summary": "",
        "content": "// ===================== lib/deliveryLogic.ts (FINAL v2) =====================\r\n// –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Å—Ç–∞—Ç—É—Å, —Ç–∞–±—É—É–¥—ã–Ω —Ç”©–≤–ª”©—Ä—Å”©–Ω –ª–æ–≥–∏–∫\r\n// - PAID —Å—Ç–∞—Ç—É—Å / —Ç–∞–± –∞—à–∏–≥–ª–∞—Ö–≥“Ø–π\r\n// - –¢”©–ª–±”©—Ä–∏–π–Ω —Ç–æ—Ö–∏—Ä–æ–æ: DELIVERED –¥—ç—ç—Ä seller_marked_paid + driver_confirmed_payment —Ö–æ—ë—É–ª–∞–∞ true –±–æ–ª CLOSED –±–æ–ª–Ω–æ.\r\n// - Driver —Ç–∞–ª–¥ \"REQUESTS\" —Ç–∞–± = status –±–∏—à, UI –¥—ç—ç—Ä \"myBid –±–∞–π–≥–∞–∞ OPEN\" –≥—ç–∂ —Å–∞–ª–≥–∞–∂ “Ø–∑“Ø“Ø–ª–Ω—ç.\r\n\r\nexport type DeliveryStatus =\r\n  | \"OPEN\"\r\n  | \"ASSIGNED\"\r\n  | \"ON_ROUTE\"\r\n  | \"DELIVERED\"\r\n  | \"DISPUTE\"\r\n  | \"CLOSED\"\r\n  | \"CANCELLED\";\r\n\r\n// ---------- SELLER TABS ----------\r\n\r\nexport type SellerTabId =\r\n  | \"OPEN\"\r\n  | \"ASSIGNED\"\r\n  | \"ON_ROUTE\"\r\n  | \"DELIVERED\"\r\n  | \"DISPUTE\"\r\n  | \"CLOSED\";\r\n\r\nexport const SELLER_TABS: { id: SellerTabId; label: string }[] = [\r\n  { id: \"OPEN\", label: \"–ù—ç—ç–ª—Ç—Ç—ç–π\" },\r\n  { id: \"ASSIGNED\", label: \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\" },\r\n  { id: \"ON_ROUTE\", label: \"–ó–∞–º–¥\" },\r\n  { id: \"DELIVERED\", label: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\" },\r\n  { id: \"CLOSED\", label: \"–•–∞–∞–≥–¥—Å–∞–Ω\" },\r\n  { id: \"DISPUTE\", label: \"–ú–∞—Ä–≥–∞–∞–Ω\" }, // ‚úÖ —Ö–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–¥\r\n];\r\n\r\n// ---------- DRIVER TABS ----------\r\n\r\nexport type DriverTabId =\r\n  | \"OPEN\"\r\n  | \"REQUESTS\" // ‚úÖ —à–∏–Ω—ç —Ç–∞–± (–º–∏–Ω–∏–π —Ö“Ø—Å—ç–ª—Ç“Ø“Ø–¥)\r\n  | \"ASSIGNED\"\r\n  | \"ON_ROUTE\"\r\n  | \"DELIVERED\"\r\n  | \"CLOSED\"\r\n  | \"DISPUTE\";\r\n\r\nexport const DRIVER_TABS: { id: DriverTabId; label: string }[] = [\r\n  { id: \"OPEN\", label: \"–ù—ç—ç–ª—Ç—Ç—ç–π\" },\r\n  { id: \"REQUESTS\", label: \"–•“Ø—Å—ç–ª—Ç\" }, // ‚úÖ OPEN –¥—ç—ç—Ä—Ö \"–º–∏–Ω–∏–π —Ö“Ø—Å—ç–ª—Ç—Ç—ç–π\" —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥\r\n  { id: \"ASSIGNED\", label: \"–ù–∞–º–∞–π–≥ —Å–æ–Ω–≥–æ—Å–æ–Ω\" },\r\n  { id: \"ON_ROUTE\", label: \"–ó–∞–º–¥\" },\r\n  { id: \"DELIVERED\", label: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\" },\r\n  { id: \"CLOSED\", label: \"–•–∞–∞–≥–¥—Å–∞–Ω\" },\r\n  { id: \"DISPUTE\", label: \"–ú–∞—Ä–≥–∞–∞–Ω\" }, // ‚úÖ —Ö–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–¥\r\n];\r\n\r\n// ---------- –¢–£–°–õ–ê–• ----------\r\n\r\n// –°—Ç–∞—Ç—É—Å—ã–≥ –º–æ–Ω–≥–æ–ª–æ–æ—Ä\r\nexport function statusLabel(status: DeliveryStatus): string {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return \"–ù—ç—ç–ª—Ç—Ç—ç–π\";\r\n    case \"ASSIGNED\":\r\n      return \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\";\r\n    case \"ON_ROUTE\":\r\n      return \"–ó–∞–º–¥\";\r\n    case \"DELIVERED\":\r\n      return \"–•“Ø—Ä–≥—ç—Å—ç–Ω\";\r\n    case \"DISPUTE\":\r\n      return \"–ú–∞—Ä–≥–∞–∞–Ω\";\r\n    case \"CLOSED\":\r\n      return \"–•–∞–∞–≥–¥—Å–∞–Ω\";\r\n    case \"CANCELLED\":\r\n      return \"–¶—É—Ü–∞–ª—Å–∞–Ω\";\r\n    default:\r\n      return status;\r\n  }\r\n}\r\n\r\n// –•–∞–∞–ª—Ç—Ç–∞–π –∞–Ω–≥–∏–ª–∞–ª\r\nexport function isClosedStatus(status: DeliveryStatus): boolean {\r\n  return status === \"CLOSED\" || status === \"CANCELLED\";\r\n}\r\n\r\n// Status ‚Üí SellerTab\r\nexport function getSellerTabForStatus(status: DeliveryStatus): SellerTabId {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return \"OPEN\";\r\n    case \"ASSIGNED\":\r\n      return \"ASSIGNED\";\r\n    case \"ON_ROUTE\":\r\n      return \"ON_ROUTE\";\r\n    case \"DELIVERED\":\r\n      return \"DELIVERED\";\r\n    case \"DISPUTE\":\r\n      return \"DISPUTE\";\r\n    case \"CLOSED\":\r\n    case \"CANCELLED\":\r\n      return \"CLOSED\";\r\n  }\r\n}\r\n\r\n// Status ‚Üí DriverTab (‚ö†Ô∏è REQUESTS —ç–Ω–¥ –æ—Ä–æ—Ö–≥“Ø–π. REQUESTS –±–æ–ª UI –¥—ç—ç—Ä myBid-—Ç—ç–π OPEN-–æ–æ—Ä —Å–∞–ª–≥–∞–Ω–∞)\r\nexport function getDriverTabForStatus(status: DeliveryStatus): Exclude<DriverTabId, \"REQUESTS\"> {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return \"OPEN\";\r\n    case \"ASSIGNED\":\r\n      return \"ASSIGNED\";\r\n    case \"ON_ROUTE\":\r\n      return \"ON_ROUTE\";\r\n    case \"DELIVERED\":\r\n      return \"DELIVERED\";\r\n    case \"CLOSED\":\r\n    case \"CANCELLED\":\r\n      return \"CLOSED\";\r\n    case \"DISPUTE\":\r\n      return \"DISPUTE\";\r\n  }\r\n}\r\n\r\n// CLOSED –±–æ–ª–æ—Ö —ë—Å—Ç–æ–π —ç—Å—ç—Ö (—Ç–æ–≤—á –Ω—ç–≥ –≥–∞–∑–∞—Ä)\r\n// ‚úÖ –∑”©–≤—Ö”©–Ω DELIVERED –¥—ç—ç—Ä 2 —Ç–∞–ª—ã–Ω —Ç”©–ª–±”©—Ä –±–∞—Ç–ª–∞–≥–¥–≤–∞–ª —Ö–∞–∞–≥–¥–∞–Ω–∞\r\nexport function shouldCloseDelivery(input: {\r\n  status: DeliveryStatus;\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n}): boolean {\r\n  return (\r\n    input.status === \"DELIVERED\" &&\r\n    !!input.seller_marked_paid &&\r\n    !!input.driver_confirmed_payment\r\n  );\r\n}\r\n\r\n// ---------- –ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö –±–æ–ª–æ–º–∂ ----------\r\n// ‚úÖ –ñ–æ–ª–æ–æ—á —Ç–∞–ª: ON_ROUTE —ç—Å–≤—ç–ª DELIVERED “Ø–µ–¥\r\nexport function canOpenDisputeForDriver(status: DeliveryStatus): boolean {\r\n  return status === \"ON_ROUTE\" || status === \"DELIVERED\";\r\n}\r\n\r\n// ‚úÖ –•—É–¥–∞–ª–¥–∞–≥—á —Ç–∞–ª: ON_ROUTE —ç—Å–≤—ç–ª DELIVERED “Ø–µ–¥ (—à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π –±–æ–ª –∞—à–∏–≥–ª–∞–Ω–∞)\r\nexport function canOpenDisputeForSeller(status: DeliveryStatus): boolean {\r\n  return status === \"ON_ROUTE\" || status === \"DELIVERED\";\r\n}\r\n"
      },
      {
        "path": "lib/supabase.ts",
        "summary": "",
        "content": "// lib/supabase.ts\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nexport const supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n);\r\n"
      },
      {
        "path": "lib/types.ts",
        "summary": "",
        "content": "// lib/types.ts\r\n// –ê–ø–ø –¥–∞—è–∞—Ä –∞—à–∏–≥–ª–∞—Ö “Ø–Ω–¥—Å—ç–Ω —Ç”©—Ä–ª“Ø“Ø–¥\r\n\r\nexport type Role = \"seller\" | \"driver\";\r\n\r\nexport type IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n"
      }
    ]
  }
}