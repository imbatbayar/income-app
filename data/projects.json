{
  "income-app": {
    "files": [
      {
        "path": "app/components/Map/DeliveryRouteMap.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport \"leaflet/dist/leaflet.css\";\r\n\r\nimport L from \"leaflet\";\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport {\r\n  MapContainer,\r\n  TileLayer,\r\n  Polyline,\r\n  Marker,\r\n  Tooltip,\r\n  useMap,\r\n} from \"react-leaflet\";\r\n\r\ntype LatLng = { lat: number; lng: number };\r\n\r\nfunction isValid(p: LatLng | null | undefined) {\r\n  return !!p && Number.isFinite(p.lat) && Number.isFinite(p.lng);\r\n}\r\n\r\nfunction emojiIcon(emoji: string) {\r\n  return L.divIcon({\r\n    className: \"\",\r\n    html: `<div style=\"\r\n      font-size:28px;\r\n      line-height:28px;\r\n      transform: translate(-50%, -50%);\r\n      filter: drop-shadow(0 2px 8px rgba(0,0,0,.22));\r\n    \">${emoji}</div>`,\r\n    iconSize: [28, 28],\r\n    iconAnchor: [14, 14],\r\n  });\r\n}\r\n\r\n// ‚úÖ OSRM route (–∂–∏–Ω—Ö—ç–Ω—ç –∑–∞–º)\r\nasync function fetchOsrmRoute(pickup: LatLng, dropoff: LatLng) {\r\n  const url =\r\n    `https://router.project-osrm.org/route/v1/driving/` +\r\n    `${pickup.lng},${pickup.lat};${dropoff.lng},${dropoff.lat}` +\r\n    `?overview=full&geometries=geojson`;\r\n\r\n  const res = await fetch(url, { headers: { Accept: \"application/json\" } });\r\n  if (!res.ok) return null;\r\n\r\n  const data = await res.json();\r\n  const coords = data?.routes?.[0]?.geometry?.coordinates as\r\n    | [number, number][]\r\n    | undefined;\r\n\r\n  if (!coords?.length) return null;\r\n\r\n  // geojson: [lng, lat] -> leaflet: [lat, lng]\r\n  return coords.map(([lng, lat]) => [lat, lng] as [number, number]);\r\n}\r\n\r\n// ‚úÖ Route/Points –¥—ç—ç—Ä fit —Ö–∏–π—Ö layer\r\nfunction FitToPath({\r\n  pickup,\r\n  dropoff,\r\n  path,\r\n}: {\r\n  pickup: LatLng | null;\r\n  dropoff: LatLng | null;\r\n  path: [number, number][] | null;\r\n}) {\r\n  const map = useMap();\r\n  const hasPickup = isValid(pickup);\r\n  const hasDropoff = isValid(dropoff);\r\n\r\n  useEffect(() => {\r\n    // 1) Route –±–∞–π–≤–∞–ª route-–∞–∞ –¥“Ø“Ø—Ä–≥—ç–∂ fit\r\n    if (path && path.length >= 2) {\r\n      const b = L.latLngBounds(path.map((p) => L.latLng(p[0], p[1])));\r\n      map.fitBounds(b.pad(0.18), {\r\n        padding: [36, 36], // 1:1 –¥—ç—ç—Ä –∏—Ö padding —Ö—ç—Ä—ç–≥–≥“Ø–π\r\n        animate: true,\r\n        duration: 0.35,\r\n        maxZoom: 16,\r\n      });\r\n      return;\r\n    }\r\n\r\n    // 2) Route –±–∞–π—Ö–≥“Ø–π “Ø–µ–¥ endpoints –¥—ç—ç—Ä fit (fallback)\r\n    if (hasPickup && hasDropoff) {\r\n      const p = pickup as LatLng;\r\n      const d = dropoff as LatLng;\r\n      const b = L.latLngBounds([p.lat, p.lng], [d.lat, d.lng]);\r\n      map.fitBounds(b.pad(0.35), {\r\n        padding: [48, 48],\r\n        animate: true,\r\n        duration: 0.35,\r\n        maxZoom: 16,\r\n      });\r\n      return;\r\n    }\r\n\r\n    // 3) 1 —Ü—ç–≥—Ç—ç–π “Ø–µ–¥ —Ç–æ–º—Ä—É—É–ª–∂ —Ç”©–≤–ª”©—Ä“Ø“Ø–ª–Ω—ç\r\n    if (hasPickup || hasDropoff) {\r\n      const one = (hasPickup ? pickup : dropoff) as LatLng;\r\n      map.setView([one.lat, one.lng], 14, { animate: true, duration: 0.3 });\r\n    }\r\n  }, [map, hasPickup, hasDropoff, pickup, dropoff, path]);\r\n\r\n  return null;\r\n}\r\n\r\nexport default function DeliveryRouteMap({\r\n  pickup,\r\n  dropoff,\r\n}: {\r\n  pickup: LatLng | null;\r\n  dropoff: LatLng | null;\r\n}) {\r\n  const hasPickup = isValid(pickup);\r\n  const hasDropoff = isValid(dropoff);\r\n\r\n  const [routePath, setRoutePath] = useState<[number, number][] | null>(null);\r\n\r\n  // ‚úÖ 2 —Ü—ç–≥ –±–∞–π–≤–∞–ª OSRM route —Ç–∞—Ç–Ω–∞\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n\r\n    async function run() {\r\n      setRoutePath(null);\r\n      if (!hasPickup || !hasDropoff) return;\r\n\r\n      const p = pickup as LatLng;\r\n      const d = dropoff as LatLng;\r\n\r\n      try {\r\n        const path = await fetchOsrmRoute(p, d);\r\n        if (!cancelled) setRoutePath(path);\r\n      } catch {\r\n        if (!cancelled) setRoutePath(null);\r\n      }\r\n    }\r\n\r\n    run();\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n  }, [hasPickup, hasDropoff, pickup, dropoff]);\r\n\r\n  const center: [number, number] = useMemo(() => {\r\n    if (hasPickup && hasDropoff) {\r\n      return [\r\n        ((pickup as LatLng).lat + (dropoff as LatLng).lat) / 2,\r\n        ((pickup as LatLng).lng + (dropoff as LatLng).lng) / 2,\r\n      ];\r\n    }\r\n    if (hasPickup) return [(pickup as LatLng).lat, (pickup as LatLng).lng];\r\n    if (hasDropoff) return [(dropoff as LatLng).lat, (dropoff as LatLng).lng];\r\n    return [47.918, 106.917];\r\n  }, [hasPickup, hasDropoff, pickup, dropoff]);\r\n\r\n  return (\r\n    // ‚úÖ 1:1 (square)\r\n    <div style={{ width: \"100%\", aspectRatio: \"4 / 3\" }}>\r\n      <MapContainer\r\n        center={center}\r\n        zoom={12}\r\n        scrollWheelZoom={false}\r\n        minZoom={9}\r\n        maxZoom={17}\r\n        style={{ height: \"100%\", width: \"100%\" }}\r\n      >\r\n        {/* ‚úÖ –ß–∏ —Ö“Ø—Å—Å—ç–Ω ‚Äú–≥–æ—ë ”©–Ω–≥”©‚Äù */}\r\n        <TileLayer\r\n          attribution=\"&copy; OpenStreetMap contributors &copy; CARTO\"\r\n          url=\"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png\"\r\n        />\r\n\r\n        <FitToPath pickup={pickup} dropoff={dropoff} path={routePath} />\r\n\r\n        {/* ‚úÖ –ñ–∏–Ω—Ö—ç–Ω—ç –∑–∞–º (route) */}\r\n        {routePath && routePath.length >= 2 && (\r\n          <Polyline\r\n            positions={routePath}\r\n            pathOptions={{\r\n              color: \"#111827\",\r\n              weight: 5,\r\n              opacity: 0.95,\r\n              lineCap: \"round\",\r\n              lineJoin: \"round\",\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {/* üì¶ –ê–í–ê–• */}\r\n        {hasPickup && (\r\n          <Marker\r\n            position={[(pickup as LatLng).lat, (pickup as LatLng).lng]}\r\n            icon={emojiIcon(\"üì¶\")}\r\n          >\r\n            <Tooltip direction=\"top\" offset={[0, -18]} opacity={1}>\r\n              –ê–≤–∞—Ö\r\n            </Tooltip>\r\n          </Marker>\r\n        )}\r\n\r\n        {/* üëã –•“Æ–†–ì–≠–• */}\r\n        {hasDropoff && (\r\n          <Marker\r\n            position={[(dropoff as LatLng).lat, (dropoff as LatLng).lng]}\r\n            icon={emojiIcon(\"üëã\")}\r\n          >\r\n            <Tooltip direction=\"top\" offset={[0, -18]} opacity={1}>\r\n              –•“Ø—Ä–≥—ç—Ö\r\n            </Tooltip>\r\n          </Marker>\r\n        )}\r\n      </MapContainer>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/components/Map/useCurvedLine.ts",
        "summary": "",
        "content": "// app/components/Map/useCurvedLine.ts\r\n// 2 —Ü—ç–≥–∏–π–Ω —Ö–æ–æ—Ä–æ–Ω–¥ \"–∑–∞–º —à–∏–≥\" —Ö–∞—Ä–∞–≥–¥–∞—Ö –Ω—É–º (curved polyline) “Ø“Ø—Å–≥—ç–Ω—ç.\r\n// ‚ö†Ô∏è Routing –ë–ò–® ‚Äî –∑”©–≤—Ö”©–Ω —á–∏–≥–ª—ç–ª–∏–π–Ω preview –¥“Ø—Ä—Å–ª—ç–ª.\r\n\r\ntype LatLng = { lat: number; lng: number };\r\n\r\nexport function makeCurvedLinePoints(a: LatLng, b: LatLng, segments = 24): [number, number][] {\r\n  // Midpoint\r\n  const mid = { lat: (a.lat + b.lat) / 2, lng: (a.lng + b.lng) / 2 };\r\n\r\n  // Vector from a -> b\r\n  const dx = b.lng - a.lng;\r\n  const dy = b.lat - a.lat;\r\n\r\n  // Distance (rough)\r\n  const dist = Math.sqrt(dx * dx + dy * dy);\r\n\r\n  // Perpendicular offset (tunable)\r\n  // dist –∏—Ö—Å—ç—Ö —Ç—É—Å–∞–º –±–∞–≥–∞ –∑—ç—Ä—ç–≥ –∏–ª“Ø“Ø –Ω—É–º –≥–∞—Ä–Ω–∞, –≥—ç—Ö–¥—ç—ç —Ö—ç—Ç \"—Å—ç—Ä–≤–∏–π—Ö–≥“Ø–π\"\r\n  const k = Math.min(0.25, Math.max(0.08, dist * 0.35));\r\n\r\n  // Perpendicular vector (-dx, dy)\r\n  const ctrl = {\r\n    lat: mid.lat + -dx * k,\r\n    lng: mid.lng + dy * k,\r\n  };\r\n\r\n  const pts: [number, number][] = [];\r\n  const n = Math.max(8, Math.min(80, segments));\r\n\r\n  for (let i = 0; i <= n; i++) {\r\n    const t = i / n;\r\n\r\n    // Quadratic Bezier:\r\n    // P(t) = (1-t)^2 A + 2(1-t)t C + t^2 B\r\n    const one = 1 - t;\r\n\r\n    const lat = one * one * a.lat + 2 * one * t * ctrl.lat + t * t * b.lat;\r\n    const lng = one * one * a.lng + 2 * one * t * ctrl.lng + t * t * b.lng;\r\n\r\n    pts.push([lat, lng]);\r\n  }\r\n\r\n  return pts;\r\n}\r\n"
      },
      {
        "path": "app/driver/delivery/[id]/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n/* ===========================\r\n * app/driver/delivery/[id]/page.tsx (FINAL v7.3)\r\n *\r\n * ‚úÖ ADD:\r\n * - –°–æ–Ω–≥–æ–≥–¥—Å–æ–Ω –∂–æ–ª–æ–æ—á –±–∞–π–≤–∞–ª –•—É–¥–∞–ª–¥–∞–≥—á–∏–π–Ω –Ω—ç—Ä/—É—Ç–∞—Å —Ö–∞—Ä—É—É–ª–Ω–∞ + tel: –∑–∞–ª–≥–∞—Ö\r\n * ‚úÖ Privacy unchanged:\r\n * - Buyer private info –∑”©–≤—Ö”©–Ω ON_ROUTE+ “Ø–µ–¥ + chosen driver-—Ç\r\n * =========================== */\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useParams, useRouter, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { DeliveryStatus, getDriverTabForStatus } from \"@/lib/deliveryLogic\";\r\n\r\n// ‚úÖ Alias import (—Ç–æ–≥—Ç–≤–æ—Ä—Ç–æ–π)\r\nimport DeliveryRouteMap from \"@/app/components/Map/DeliveryRouteMap\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryDetail = {\r\n  id: string;\r\n  seller_id: string;\r\n\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n\r\n  pickup_lat: number | null;\r\n  pickup_lng: number | null;\r\n  dropoff_lat: number | null;\r\n  dropoff_lng: number | null;\r\n\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n\r\n  chosen_driver_id: string | null;\r\n\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n  closed_at: string | null;\r\n\r\n  dispute_reason: string | null;\r\n  dispute_opened_at: string | null;\r\n\r\n  seller_hidden: boolean;\r\n};\r\n\r\ntype BidLite = {\r\n  id: string;\r\n  driver_id: string;\r\n  delivery_id: string;\r\n  created_at: string;\r\n};\r\n\r\ntype DeliveryPrivate = {\r\n  delivery_id: string;\r\n  to_detail: string | null;\r\n  buyer_phone: string | null;\r\n};\r\n\r\ntype SellerLite = {\r\n  id: string;\r\n  name: string | null;\r\n  phone: string | null;\r\n};\r\n\r\n// ---------------- helpers ----------------\r\n\r\nfunction fmtPrice(n: number | null | undefined) {\r\n  const v = Number(n || 0);\r\n  return v ? `${v.toLocaleString(\"mn-MN\")}‚ÇÆ` : \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n}\r\n\r\nfunction fmtDT(iso: string | null | undefined) {\r\n  if (!iso) return \"\";\r\n  try {\r\n    return new Date(iso).toLocaleString(\"mn-MN\", { hour12: false });\r\n  } catch {\r\n    return iso || \"\";\r\n  }\r\n}\r\n\r\nfunction typeLabel(deliveryType: string | null): { icon: string; label: string } {\r\n  switch (deliveryType) {\r\n    case \"apartment\":\r\n      return { icon: \"üèô\", label: \"–ë–∞–π—Ä\" };\r\n    case \"ger\":\r\n      return { icon: \"üè†\", label: \"–ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª\" };\r\n    case \"camp\":\r\n      return { icon: \"üèï\", label: \"–õ–∞–≥–µ—Ä\" };\r\n    case \"countryside\":\r\n      return { icon: \"üöå\", label: \"–û—Ä–æ–Ω –Ω—É—Ç–∞–≥\" };\r\n    default:\r\n      return { icon: \"üì¶\", label: \"–•“Ø—Ä–≥—ç–ª—Ç\" };\r\n  }\r\n}\r\n\r\nfunction badge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return { text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\", cls: \"bg-emerald-50 text-emerald-700 border-emerald-100\" };\r\n    case \"ASSIGNED\":\r\n      return { text: \"–¢–∞–Ω–¥ –æ–Ω–æ–æ—Å–æ–Ω\", cls: \"bg-sky-50 text-sky-700 border-sky-100\" };\r\n    case \"ON_ROUTE\":\r\n      return { text: \"–ó–∞–º–¥\", cls: \"bg-indigo-50 text-indigo-700 border-indigo-100\" };\r\n    case \"DELIVERED\":\r\n      return { text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\", cls: \"bg-amber-50 text-amber-700 border-amber-100\" };\r\n    case \"PAID\":\r\n      return { text: \"–¢”©–ª—Å”©–Ω\", cls: \"bg-emerald-50 text-emerald-800 border-emerald-100\" };\r\n    case \"DISPUTE\":\r\n      return { text: \"–ú–∞—Ä–≥–∞–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    case \"CLOSED\":\r\n      return { text: \"–•–∞–∞–≥–¥—Å–∞–Ω\", cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n    case \"CANCELLED\":\r\n      return { text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    default:\r\n      return { text: status, cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n  }\r\n}\r\n\r\nfunction pickErr(e: any, fallback: string) {\r\n  const msg = e?.message || e?.error_description || e?.details;\r\n  return msg ? `${fallback} (${String(msg)})` : fallback;\r\n}\r\n\r\nasync function copyText(text: string) {\r\n  if (!text) return false;\r\n  try {\r\n    await navigator.clipboard.writeText(text);\r\n    return true;\r\n  } catch {\r\n    try {\r\n      const ta = document.createElement(\"textarea\");\r\n      ta.value = text;\r\n      ta.style.position = \"fixed\";\r\n      ta.style.left = \"-9999px\";\r\n      document.body.appendChild(ta);\r\n      ta.select();\r\n      document.execCommand(\"copy\");\r\n      document.body.removeChild(ta);\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n}\r\n\r\n// ---------------- page ----------------\r\n\r\nexport default function DriverDeliveryDetailPage() {\r\n  const router = useRouter();\r\n  const params = useParams<{ id: string }>();\r\n  const sp = useSearchParams();\r\n\r\n  const id = params?.id;\r\n  const backTab = sp.get(\"tab\");\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [delivery, setDelivery] = useState<DeliveryDetail | null>(null);\r\n\r\n  const [seller, setSeller] = useState<SellerLite | null>(null);\r\n  const [sellerLoading, setSellerLoading] = useState(false);\r\n\r\n  const [myBid, setMyBid] = useState<BidLite | null>(null);\r\n\r\n  // ‚úÖ private info state\r\n  const [priv, setPriv] = useState<DeliveryPrivate | null>(null);\r\n  const [privLoading, setPrivLoading] = useState(false);\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [msg, setMsg] = useState<string | null>(null);\r\n\r\n  const [bidLoading, setBidLoading] = useState(false);\r\n  const [cancelBidLoading, setCancelBidLoading] = useState(false);\r\n\r\n  const [markDeliveredLoading, setMarkDeliveredLoading] = useState(false);\r\n  const [confirmPayLoading, setConfirmPayLoading] = useState(false);\r\n\r\n  // dispute\r\n  const [showDispute, setShowDispute] = useState(false);\r\n  const [disputeReason, setDisputeReason] = useState(\"\");\r\n  const [disputeLoading, setDisputeLoading] = useState(false);\r\n  const [resolveLoading, setResolveLoading] = useState(false);\r\n\r\n  // ‚úÖ alerts auto-dismiss (8s)\r\n  useEffect(() => {\r\n    if (!error) return;\r\n    const t = setTimeout(() => setError(null), 8000);\r\n    return () => clearTimeout(t);\r\n  }, [error]);\r\n\r\n  useEffect(() => {\r\n    if (!msg) return;\r\n    const t = setTimeout(() => setMsg(null), 8000);\r\n    return () => clearTimeout(t);\r\n  }, [msg]);\r\n\r\n  // ---------------- auth ----------------\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) return router.replace(\"/\");\r\n      const u: IncomeUser = JSON.parse(raw);\r\n      if (u.role !== \"driver\") return router.replace(\"/\");\r\n      setUser(u);\r\n    } catch {\r\n      router.replace(\"/\");\r\n    }\r\n  }, [router]);\r\n\r\n  // ---------------- fetch ----------------\r\n  useEffect(() => {\r\n    if (!user || !id) return;\r\n    void fetchAll();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user, id]);\r\n\r\n  async function fetchSeller(sellerId: string) {\r\n    setSellerLoading(true);\r\n    try {\r\n      const { data, error } = await supabase.from(\"users\").select(\"id,name,phone\").eq(\"id\", sellerId).maybeSingle();\r\n      if (error) {\r\n        console.warn(error);\r\n        setSeller(null);\r\n        return;\r\n      }\r\n      setSeller((data as any) || null);\r\n    } finally {\r\n      setSellerLoading(false);\r\n    }\r\n  }\r\n\r\n  async function fetchAll() {\r\n    setLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          seller_id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          pickup_lat,\r\n          pickup_lng,\r\n          dropoff_lat,\r\n          dropoff_lng,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          chosen_driver_id,\r\n          seller_marked_paid,\r\n          driver_confirmed_payment,\r\n          closed_at,\r\n          dispute_reason,\r\n          dispute_opened_at,\r\n          seller_hidden\r\n        `\r\n        )\r\n        .eq(\"id\", id)\r\n        .maybeSingle();\r\n\r\n      if (e1 || !data) {\r\n        setDelivery(null);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\");\r\n        return;\r\n      }\r\n\r\n      const d: DeliveryDetail = {\r\n        id: data.id,\r\n        seller_id: data.seller_id,\r\n        from_address: data.from_address,\r\n        to_address: data.to_address,\r\n        note: data.note,\r\n\r\n        pickup_lat: (data as any).pickup_lat ?? null,\r\n        pickup_lng: (data as any).pickup_lng ?? null,\r\n        dropoff_lat: (data as any).dropoff_lat ?? null,\r\n        dropoff_lng: (data as any).dropoff_lng ?? null,\r\n\r\n        status: data.status as DeliveryStatus,\r\n        created_at: data.created_at,\r\n        price_mnt: data.price_mnt,\r\n        delivery_type: data.delivery_type,\r\n        chosen_driver_id: data.chosen_driver_id,\r\n\r\n        seller_marked_paid: !!data.seller_marked_paid,\r\n        driver_confirmed_payment: !!data.driver_confirmed_payment,\r\n        closed_at: data.closed_at,\r\n\r\n        dispute_reason: (data as any).dispute_reason ?? null,\r\n        dispute_opened_at: (data as any).dispute_opened_at ?? null,\r\n\r\n        seller_hidden: !!(data as any).seller_hidden,\r\n      };\r\n\r\n      setDelivery(d);\r\n\r\n      // ‚úÖ seller info load (for chosen driver, or just show name/phone if needed)\r\n      void fetchSeller(d.seller_id);\r\n\r\n      // my bid\r\n      const { data: b, error: e2 } = await supabase\r\n        .from(\"driver_bids\")\r\n        .select(\"id, driver_id, delivery_id, created_at\")\r\n        .eq(\"delivery_id\", d.id)\r\n        .eq(\"driver_id\", user!.id)\r\n        .maybeSingle();\r\n\r\n      if (e2) setMyBid(null);\r\n      else setMyBid((b as any) || null);\r\n\r\n      // ‚úÖ private info load (if allowed)\r\n      await maybeLoadPrivate(d);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  // ---------------- navigation ----------------\r\n  function goBack() {\r\n    if (backTab) return router.push(`/driver?tab=${encodeURIComponent(backTab)}`);\r\n    if (!delivery) return router.push(\"/driver?tab=OPEN\");\r\n    return router.push(`/driver?tab=${getDriverTabForStatus(delivery.status)}`);\r\n  }\r\n\r\n  // ---------------- derived ----------------\r\n  const isChosenDriver = useMemo(() => {\r\n    if (!delivery || !user) return false;\r\n    return !!delivery.chosen_driver_id && delivery.chosen_driver_id === user.id;\r\n  }, [delivery, user]);\r\n\r\n  const canBid = useMemo(() => {\r\n    if (!delivery) return false;\r\n    return delivery.status === \"OPEN\";\r\n  }, [delivery]);\r\n\r\n  const canMarkDelivered = useMemo(() => {\r\n    if (!delivery) return false;\r\n    return delivery.status === \"ON_ROUTE\" && isChosenDriver;\r\n  }, [delivery, isChosenDriver]);\r\n\r\n  const canOpenDispute = useMemo(() => {\r\n    if (!delivery) return false;\r\n    if (delivery.status === \"DISPUTE\" || delivery.status === \"CLOSED\" || delivery.status === \"CANCELLED\") return false;\r\n    return delivery.status === \"ON_ROUTE\" || delivery.status === \"DELIVERED\" || delivery.status === \"PAID\";\r\n  }, [delivery]);\r\n\r\n  const hasMap =\r\n    !!delivery &&\r\n    delivery.pickup_lat != null &&\r\n    delivery.pickup_lng != null &&\r\n    delivery.dropoff_lat != null &&\r\n    delivery.dropoff_lng != null;\r\n\r\n  const privateAllowed = useMemo(() => {\r\n    if (!delivery || !user) return false;\r\n    if (!isChosenDriver) return false;\r\n    return (\r\n      delivery.status === \"ON_ROUTE\" ||\r\n      delivery.status === \"DELIVERED\" ||\r\n      delivery.status === \"PAID\" ||\r\n      delivery.status === \"DISPUTE\" ||\r\n      delivery.status === \"CLOSED\"\r\n    );\r\n  }, [delivery, user, isChosenDriver]);\r\n\r\n  // ‚úÖ Hook order fix: privateText isMemo MUST be above any early returns\r\n  const privateText = useMemo(() => {\r\n    if (!priv) return \"\";\r\n    const lines = [\r\n      priv.buyer_phone ? `–£—Ç–∞—Å: ${priv.buyer_phone}` : null,\r\n      priv.to_detail ? `–ù–∞—Ä–∏–π–Ω —Ö–∞—è–≥: ${priv.to_detail}` : null,\r\n    ].filter(Boolean) as string[];\r\n    return lines.join(\"\\n\");\r\n  }, [priv]);\r\n\r\n  // ‚úÖ fetch private only when allowed\r\n  async function maybeLoadPrivate(d: DeliveryDetail) {\r\n    if (!user) return;\r\n\r\n    const isMine = !!d.chosen_driver_id && d.chosen_driver_id === user.id;\r\n    const allowed =\r\n      d.status === \"ON_ROUTE\" ||\r\n      d.status === \"DELIVERED\" ||\r\n      d.status === \"PAID\" ||\r\n      d.status === \"DISPUTE\" ||\r\n      d.status === \"CLOSED\";\r\n\r\n    if (!isMine || !allowed) {\r\n      setPriv(null);\r\n      return;\r\n    }\r\n\r\n    setPrivLoading(true);\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"delivery_private\")\r\n        .select(\"delivery_id,to_detail,buyer_phone\")\r\n        .eq(\"delivery_id\", d.id)\r\n        .maybeSingle();\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setPriv(null);\r\n        return;\r\n      }\r\n\r\n      setPriv((data as any) || null);\r\n    } finally {\r\n      setPrivLoading(false);\r\n    }\r\n  }\r\n\r\n  // ---------------- actions ----------------\r\n\r\n  async function placeBid() {\r\n    if (!delivery || !user) return;\r\n    if (!canBid) return setError(\"–ó”©–≤—Ö”©–Ω –ù—ç—ç–ª—Ç—Ç—ç–π “Ø–µ–¥ —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–Ω—ç.\");\r\n    if (myBid) return setError(\"–¢–∞ –∞–ª—å —Ö—ç–¥–∏–π–Ω —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Å—ç–Ω –±–∞–π–Ω–∞.\");\r\n    if (bidLoading) return;\r\n\r\n    setBidLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"driver_bids\")\r\n        .insert({ delivery_id: delivery.id, driver_id: user.id })\r\n        .select(\"id, driver_id, delivery_id, created_at\")\r\n        .maybeSingle();\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(pickErr(error, \"–•“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\"));\r\n        return;\r\n      }\r\n\r\n      setMyBid((data as any) || null);\r\n      setMsg(\"–•“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–ª—ç—ç.\");\r\n    } finally {\r\n      setBidLoading(false);\r\n    }\r\n  }\r\n\r\n  // ‚úÖ OPEN: cancel bid\r\n  // ‚úÖ ASSIGNED + chosen driver: decline => OPEN + chosen_driver_id=null\r\n  async function cancelBid() {\r\n    if (!delivery || !user) return;\r\n    if (cancelBidLoading) return;\r\n\r\n    setCancelBidLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      if (delivery.status === \"OPEN\") {\r\n        if (!myBid) return setError(\"–¢–∞ —ç–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç—ç–¥ —Ö“Ø—Å—ç–ª—Ç –≥–∞—Ä–≥–∞–∞–≥“Ø–π –±–∞–π–Ω–∞.\");\r\n\r\n        const { error } = await supabase.from(\"driver_bids\").delete().eq(\"id\", myBid.id).eq(\"driver_id\", user.id);\r\n\r\n        if (error) {\r\n          console.error(error);\r\n          setError(pickErr(error, \"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\"));\r\n          return;\r\n        }\r\n\r\n        setMyBid(null);\r\n        setMsg(\"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞–≥–¥–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      if (delivery.status === \"ASSIGNED\" && delivery.chosen_driver_id === user.id) {\r\n        if (myBid) {\r\n          await supabase.from(\"driver_bids\").delete().eq(\"id\", myBid.id).eq(\"driver_id\", user.id);\r\n          setMyBid(null);\r\n        }\r\n\r\n        const { data, error } = await supabase\r\n          .from(\"deliveries\")\r\n          .update({ status: \"OPEN\", chosen_driver_id: null })\r\n          .eq(\"id\", delivery.id)\r\n          .eq(\"chosen_driver_id\", user.id)\r\n          .select(\"id,status,chosen_driver_id\")\r\n          .maybeSingle();\r\n\r\n        if (error || !data) {\r\n          console.error(error);\r\n          setError(pickErr(error, \"–¢–∞—Ç–≥–∞–ª–∑–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\"));\r\n          return;\r\n        }\r\n\r\n        setDelivery((d) => (d ? { ...d, status: \"OPEN\", chosen_driver_id: null } : d));\r\n        setPriv(null);\r\n\r\n        setMsg(\"–¢–∞—Ç–≥–∞–ª–∑–ª–∞–∞. –•“Ø—Ä–≥—ç–ª—Ç –¥–∞—Ö–∏–Ω –Ω—ç—ç–ª—Ç—Ç—ç–π –±–æ–ª–ª–æ–æ.\");\r\n        router.push(\"/driver?tab=OPEN\");\r\n        router.refresh();\r\n        return;\r\n      }\r\n\r\n      setError(\"–≠–Ω—ç —Ç”©–ª”©–≤ –¥—ç—ç—Ä —Ü—É—Ü–ª–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π.\");\r\n    } finally {\r\n      setCancelBidLoading(false);\r\n    }\r\n  }\r\n\r\n  // ‚úÖ ON_ROUTE -> DELIVERED\r\n  async function markDelivered() {\r\n    if (!delivery || !user) return;\r\n    if (!canMarkDelivered) return setError(\"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ç–∞–Ω–¥ –æ–Ω–æ–æ–≥–¥–æ–æ–≥“Ø–π —ç—Å–≤—ç–ª —Ç”©–ª”©–≤ –±—É—Ä—É—É –±–∞–π–Ω–∞.\");\r\n    if (markDeliveredLoading) return;\r\n\r\n    setMarkDeliveredLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"DELIVERED\" })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"status\", \"ON_ROUTE\")\r\n        .eq(\"chosen_driver_id\", user.id)\r\n        .select(\"id,status,chosen_driver_id\")\r\n        .maybeSingle();\r\n\r\n      if (error || !data) {\r\n        console.error(error);\r\n        setError(pickErr(error, \"–•“Ø—Ä–≥—ç—Å—ç–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\"));\r\n        return;\r\n      }\r\n\r\n      if ((data.status as DeliveryStatus) !== \"DELIVERED\") {\r\n        setError(\"–®–∏–Ω—ç —Ç”©–ª”©–≤ –±–∞—Ç–∞–ª–≥–∞–∞–∂—Å–∞–Ω–≥“Ø–π. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n        return;\r\n      }\r\n\r\n      const nd: DeliveryDetail = { ...delivery, status: \"DELIVERED\", chosen_driver_id: (data as any).chosen_driver_id };\r\n\r\n      setDelivery(nd);\r\n      void maybeLoadPrivate(nd);\r\n\r\n      setMsg(\"–•“Ø—Ä–≥—ç—Å—ç–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\");\r\n      router.push(\"/driver?tab=DELIVERED\");\r\n      router.refresh();\r\n    } finally {\r\n      setMarkDeliveredLoading(false);\r\n    }\r\n  }\r\n\r\n  // ---- legacy functions kept as-is (PAID/DISPUTE/CLOSED) ----\r\n  async function confirmPaymentReceived() {\r\n    if (!delivery || !user) return;\r\n    if (confirmPayLoading) return;\r\n\r\n    if (delivery.status !== \"PAID\") return setError(\"–ó”©–≤—Ö”©–Ω '–¢”©–ª—Å”©–Ω' “Ø–µ–¥ —Ç”©–ª–±”©—Ä —Ö“Ø–ª—ç—ç–Ω –∞–≤—Å–Ω–∞–∞ –±–∞—Ç–∞–ª–Ω–∞.\");\r\n    if (!isChosenDriver) return setError(\"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ç–∞–Ω–¥ –æ–Ω–æ–æ–≥–¥–æ–æ–≥“Ø–π –±–∞–π–Ω–∞.\");\r\n    if (delivery.driver_confirmed_payment) return setError(\"–¢”©–ª–±”©—Ä –∞–ª—å —Ö—ç–¥–∏–π–Ω –±–∞—Ç–∞–ª–≥–∞–∞–∂—Å–∞–Ω –±–∞–π–Ω–∞.\");\r\n\r\n    setConfirmPayLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const closedAt = new Date().toISOString();\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ driver_confirmed_payment: true, status: \"CLOSED\", closed_at: closedAt })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"chosen_driver_id\", user.id)\r\n        .eq(\"status\", \"PAID\")\r\n        .eq(\"driver_confirmed_payment\", false)\r\n        .select(\"id,status,driver_confirmed_payment,closed_at,seller_marked_paid,chosen_driver_id\")\r\n        .maybeSingle();\r\n\r\n      if (error || !data) {\r\n        console.error(error);\r\n        setError(pickErr(error, \"–¢”©–ª–±”©—Ä –±–∞—Ç–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\"));\r\n        return;\r\n      }\r\n\r\n      if ((data.status as DeliveryStatus) !== \"CLOSED\") {\r\n        setError(\"–•–∞–∞–≥–¥—Å–∞–Ω —Ç”©–ª”©–≤ –±–∞—Ç–∞–ª–≥–∞–∞–∂—Å–∞–Ω–≥“Ø–π. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n        return;\r\n      }\r\n\r\n      const nd: DeliveryDetail = {\r\n        ...delivery,\r\n        driver_confirmed_payment: true,\r\n        status: \"CLOSED\",\r\n        closed_at: (data as any).closed_at ?? closedAt,\r\n        seller_marked_paid: !!(data as any).seller_marked_paid,\r\n        chosen_driver_id: (data as any).chosen_driver_id ?? delivery.chosen_driver_id,\r\n      };\r\n\r\n      setDelivery(nd);\r\n      void maybeLoadPrivate(nd);\r\n\r\n      setMsg(\"–¢”©–ª–±”©—Ä —Ö“Ø–ª—ç—ç–Ω –∞–≤—Å–Ω–∞–∞ –±–∞—Ç–∞–ª–ª–∞–∞.\");\r\n      router.push(\"/driver?tab=CLOSED\");\r\n      router.refresh();\r\n    } finally {\r\n      setConfirmPayLoading(false);\r\n    }\r\n  }\r\n\r\n  async function openDispute() {\r\n    if (!delivery) return;\r\n\r\n    const reason = disputeReason.trim();\r\n    if (!reason) return setError(\"–ú–∞—Ä–≥–∞–∞–Ω—ã —à–∞–ª—Ç–≥–∞–∞–Ω–∞–∞ –±–∏—á–Ω—ç “Ø“Ø.\");\r\n    if (!canOpenDispute) return setError(\"–≠–Ω—ç —Ç”©–ª”©–≤ –¥—ç—ç—Ä –º–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö –±–æ–ª–æ–º–∂–≥“Ø–π.\");\r\n    if (disputeLoading) return;\r\n\r\n    setDisputeLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const openedAt = new Date().toISOString();\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"DISPUTE\", dispute_reason: reason, dispute_opened_at: openedAt })\r\n        .eq(\"id\", delivery.id)\r\n        .in(\"status\", [\"ON_ROUTE\", \"DELIVERED\", \"PAID\"] as any)\r\n        .select(\"id,status,dispute_reason,dispute_opened_at,chosen_driver_id\")\r\n        .maybeSingle();\r\n\r\n      if (error || !data) {\r\n        console.error(error);\r\n        setError(pickErr(error, \"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\"));\r\n        return;\r\n      }\r\n\r\n      if ((data.status as DeliveryStatus) !== \"DISPUTE\") {\r\n        setError(\"–ú–∞—Ä–≥–∞–∞–Ω —Ç”©–ª”©–≤ –±–∞—Ç–∞–ª–≥–∞–∞–∂—Å–∞–Ω–≥“Ø–π. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n        return;\r\n      }\r\n\r\n      const nd: DeliveryDetail = {\r\n        ...delivery,\r\n        status: \"DISPUTE\",\r\n        dispute_reason: (data as any).dispute_reason ?? reason,\r\n        dispute_opened_at: (data as any).dispute_opened_at ?? openedAt,\r\n        chosen_driver_id: (data as any).chosen_driver_id ?? delivery.chosen_driver_id,\r\n      };\r\n\r\n      setDelivery(nd);\r\n      void maybeLoadPrivate(nd);\r\n\r\n      setShowDispute(false);\r\n      setDisputeReason(\"\");\r\n      setMsg(\"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç–≥–¥–ª—ç—ç.\");\r\n      router.push(\"/driver?tab=DISPUTE\");\r\n      router.refresh();\r\n    } finally {\r\n      setDisputeLoading(false);\r\n    }\r\n  }\r\n\r\n  async function resolveDispute() {\r\n    if (!delivery) return;\r\n    if (delivery.status !== \"DISPUTE\") return;\r\n    if (resolveLoading) return;\r\n\r\n    setResolveLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const closedAt = new Date().toISOString();\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"CLOSED\", closed_at: closedAt })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"status\", \"DISPUTE\")\r\n        .select(\"id,status,closed_at,chosen_driver_id\")\r\n        .maybeSingle();\r\n\r\n      if (error || !data) {\r\n        console.error(error);\r\n        setError(pickErr(error, \"–ú–∞—Ä–≥–∞–∞–Ω—ã–≥ —à–∏–π–¥—ç–≥–¥—Å—ç–Ω –±–æ–ª–≥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\"));\r\n        return;\r\n      }\r\n\r\n      if ((data.status as DeliveryStatus) !== \"CLOSED\") {\r\n        setError(\"–•–∞–∞–≥–¥—Å–∞–Ω —Ç”©–ª”©–≤ –±–∞—Ç–∞–ª–≥–∞–∞–∂—Å–∞–Ω–≥“Ø–π. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n        return;\r\n      }\r\n\r\n      const nd: DeliveryDetail = {\r\n        ...delivery,\r\n        status: \"CLOSED\",\r\n        closed_at: (data as any).closed_at ?? closedAt,\r\n        chosen_driver_id: (data as any).chosen_driver_id ?? delivery.chosen_driver_id,\r\n      };\r\n\r\n      setDelivery(nd);\r\n      void maybeLoadPrivate(nd);\r\n\r\n      setMsg(\"–ú–∞—Ä–≥–∞–∞–Ω —à–∏–π–¥—ç–≥–¥–ª—ç—ç. –•“Ø—Ä–≥—ç–ª—Ç —Ö–∞–∞–≥–¥–ª–∞–∞.\");\r\n      router.push(\"/driver?tab=CLOSED\");\r\n      router.refresh();\r\n    } finally {\r\n      setResolveLoading(false);\r\n    }\r\n  }\r\n\r\n  // ---------------- UI ----------------\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50\">\r\n        <div className=\"max-w-3xl mx-auto px-4 py-6 space-y-4\">\r\n          <div className=\"h-10 w-32 bg-slate-200 rounded-xl animate-pulse\" />\r\n          <div className=\"h-28 bg-white border border-slate-200 rounded-2xl animate-pulse\" />\r\n          <div className=\"h-44 bg-white border border-slate-200 rounded-2xl animate-pulse\" />\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) return null;\r\n\r\n  const t = typeLabel(delivery?.delivery_type ?? null);\r\n  const b = delivery ? badge(delivery.status) : null;\r\n\r\n  const showSellerCard =\r\n    !!delivery &&\r\n    isChosenDriver &&\r\n    (delivery.status === \"ASSIGNED\" ||\r\n      delivery.status === \"ON_ROUTE\" ||\r\n      delivery.status === \"DELIVERED\" ||\r\n      delivery.status === \"PAID\" ||\r\n      delivery.status === \"DISPUTE\" ||\r\n      delivery.status === \"CLOSED\");\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <main className=\"max-w-3xl mx-auto px-4 py-6 space-y-4\">\r\n        {/* header */}\r\n        <div className=\"flex items-center justify-between gap-3\">\r\n          <button\r\n            onClick={goBack}\r\n            className=\"inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50\"\r\n          >\r\n            ‚Üê –ë—É—Ü–∞—Ö\r\n          </button>\r\n\r\n          {delivery && b && (\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"text-xs text-slate-500\">{t.icon}</span>\r\n              <span className={`text-[11px] px-3 py-1.5 rounded-full border ${b.cls}`}>{b.text}</span>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* alerts */}\r\n        {error && (\r\n          <div className=\"rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700\">{error}</div>\r\n        )}\r\n        {msg && (\r\n          <div className=\"rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800\">\r\n            {msg}\r\n          </div>\r\n        )}\r\n\r\n        {!delivery ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white px-4 py-6\">\r\n            <p className=\"text-sm text-slate-700\">–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.</p>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* main card */}\r\n            <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n              <div className=\"flex items-start justify-between gap-4\">\r\n                <div className=\"space-y-1\">\r\n                  <h1 className=\"text-lg font-semibold text-slate-900\">\r\n                    {t.label} #{delivery.id.slice(0, 6)}\r\n                  </h1>\r\n                  <p className=\"text-xs text-slate-500\">“Æ“Ø—Å–≥—ç—Å—ç–Ω: {fmtDT(delivery.created_at)}</p>\r\n                </div>\r\n\r\n                <div className=\"text-right\">\r\n                  <div className=\"text-xs text-slate-500\">“Æ–Ω—ç</div>\r\n                  <div className=\"text-base font-semibold text-slate-900\">{fmtPrice(delivery.price_mnt)}</div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3\">\r\n                  <div className=\"text-[11px] text-slate-500\">–ê–í–ê–•</div>\r\n                  <div className=\"text-sm text-slate-900 mt-1\">{delivery.from_address || \"‚Äî\"}</div>\r\n                </div>\r\n\r\n                <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3\">\r\n                  <div className=\"text-[11px] text-slate-500\">–•“Æ–†–ì–≠–•</div>\r\n                  <div className=\"text-sm text-slate-900 mt-1\">{delivery.to_address || \"‚Äî\"}</div>\r\n                </div>\r\n              </div>\r\n\r\n              {delivery.note && (\r\n                <div className=\"rounded-xl border border-slate-200 bg-white p-3\">\r\n                  <div className=\"text-[11px] text-slate-500\">–¢–∞–π–ª–±–∞—Ä</div>\r\n                  <div className=\"text-sm text-slate-900 mt-1 whitespace-pre-wrap\">{delivery.note}</div>\r\n                </div>\r\n              )}\r\n            </section>\r\n\r\n            {/* ‚úÖ Seller card (only when chosen driver) */}\r\n            {showSellerCard && (\r\n              <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n                <div className=\"flex items-center justify-between gap-3\">\r\n                  <h2 className=\"text-sm font-semibold text-slate-900\">–•—É–¥–∞–ª–¥–∞–≥—á</h2>\r\n                  {seller?.phone ? (\r\n                    <a\r\n                      href={`tel:${seller.phone}`}\r\n                      className=\"rounded-xl bg-slate-900 px-4 py-2 text-xs font-semibold text-white hover:bg-slate-800\"\r\n                    >\r\n                      –ó–∞–ª–≥–∞—Ö\r\n                    </a>\r\n                  ) : null}\r\n                </div>\r\n\r\n                {sellerLoading ? (\r\n                  <div className=\"text-xs text-slate-500\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n                ) : (\r\n                  <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3 space-y-1\">\r\n                    <div className=\"text-xs text-slate-700\">\r\n                      –ù—ç—Ä: <span className=\"font-semibold\">{seller?.name || \"‚Äî\"}</span>\r\n                    </div>\r\n                    <div className=\"text-xs text-slate-700\">\r\n                      –£—Ç–∞—Å: <span className=\"font-semibold\">{seller?.phone || \"‚Äî\"}</span>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </section>\r\n            )}\r\n\r\n            {/* ‚úÖ private info card (only allowed) */}\r\n            <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n              <div className=\"flex items-center justify-between gap-3\">\r\n                <h2 className=\"text-sm font-semibold text-slate-900\">–•“Ø–ª—ç—ç–Ω –∞–≤–∞–≥—á</h2>\r\n\r\n                {privateAllowed && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={async () => {\r\n                      const ok = await copyText(privateText);\r\n                      setMsg(ok ? \"–•—É—É–ª–ª–∞–∞.\" : \"–•—É—É–ª–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π –±–∞–π–Ω–∞.\");\r\n                    }}\r\n                    disabled={privLoading || !priv}\r\n                    className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-60\"\r\n                  >\r\n                    –•—É—É–ª–∞—Ö\r\n                  </button>\r\n                )}\r\n              </div>\r\n\r\n              {!privateAllowed ? (\r\n                <div className=\"text-xs text-slate-600\">\r\n                  –ù–∞—Ä–∏–π–Ω —Ö–∞—è–≥/—É—Ç–∞—Å –Ω—å –∑”©–≤—Ö”©–Ω <span className=\"font-semibold\">‚Äú–ó–∞–º–¥‚Äù</span> (—ç—Å–≤—ç–ª —Ç“Ø“Ø–Ω—ç—ç—Å —Ö–æ–π—à) “Ø–µ–¥, –º”©–Ω\r\n                  –∑”©–≤—Ö”©–Ω <span className=\"font-semibold\">–æ–Ω–æ–æ–≥–¥—Å–æ–Ω –∂–æ–ª–æ–æ—á–∏–¥</span> —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞.\r\n                </div>\r\n              ) : privLoading ? (\r\n                <div className=\"text-xs text-slate-500\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n              ) : !priv ? (\r\n                <div className=\"text-xs text-slate-500\">–ù–∞—Ä–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.</div>\r\n              ) : (\r\n                <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3 space-y-1\">\r\n                  <div className=\"text-xs text-slate-700\">{priv.buyer_phone ? `üìû ${priv.buyer_phone}` : \"üìû ‚Äî\"}</div>\r\n                  {priv.to_detail && <div className=\"text-xs text-slate-700 whitespace-pre-wrap\">{priv.to_detail}</div>}\r\n                </div>\r\n              )}\r\n            </section>\r\n\r\n            {/* map preview */}\r\n            {hasMap && (\r\n              <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n                <h2 className=\"text-sm font-semibold text-slate-900\">–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —á–∏–≥–ª—ç–ª</h2>\r\n                <div className=\"overflow-hidden rounded-xl border border-slate-200\">\r\n                  <DeliveryRouteMap\r\n                    pickup={{ lat: delivery.pickup_lat!, lng: delivery.pickup_lng! }}\r\n                    dropoff={{ lat: delivery.dropoff_lat!, lng: delivery.dropoff_lng! }}\r\n                    height={260}\r\n                  />\r\n                </div>\r\n              </section>\r\n            )}\r\n\r\n            {/* actions */}\r\n            <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n              <h2 className=\"text-sm font-semibold text-slate-900\">“Æ–π–ª–¥—ç–ª</h2>\r\n\r\n              <div className=\"flex flex-wrap items-center gap-2\">\r\n                {delivery.status === \"OPEN\" && (\r\n                  <>\r\n                    {!myBid ? (\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => void placeBid()}\r\n                        disabled={bidLoading}\r\n                        className=\"text-xs px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                      >\r\n                        {bidLoading ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Ö\"}\r\n                      </button>\r\n                    ) : (\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => void cancelBid()}\r\n                        disabled={cancelBidLoading}\r\n                        className=\"text-xs px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-60\"\r\n                      >\r\n                        {cancelBidLoading ? \"–¶—É—Ü–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö\"}\r\n                      </button>\r\n                    )}\r\n                  </>\r\n                )}\r\n\r\n                {delivery.status === \"ASSIGNED\" && (\r\n                  <>\r\n                    <div className=\"text-xs text-slate-600 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2\">\r\n                      –•—É–¥–∞–ª–¥–∞–≥—á ‚Äú–ñ–æ–ª–æ–æ—á –±–∞—Ä–∞–∞–≥ –∞–≤—á —è–≤–ª–∞–∞‚Äù –¥–∞—Ä—Å–Ω—ã –¥–∞—Ä–∞–∞ ‚Äú–ó–∞–º–¥‚Äù —Ä—É—É —à–∏–ª–∂–∏–Ω—ç.\r\n                    </div>\r\n\r\n                    {isChosenDriver && (\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => void cancelBid()}\r\n                        disabled={cancelBidLoading}\r\n                        className=\"text-xs px-4 py-2 rounded-xl border border-rose-300 bg-rose-50 text-rose-700 hover:bg-rose-100 disabled:opacity-60\"\r\n                      >\r\n                        {cancelBidLoading ? \"–¢–∞—Ç–≥–∞–ª–∑–∞–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–¢–∞—Ç–≥–∞–ª–∑–∞—Ö\"}\r\n                      </button>\r\n                    )}\r\n                  </>\r\n                )}\r\n\r\n                {delivery.status === \"ON_ROUTE\" && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void markDelivered()}\r\n                    disabled={!canMarkDelivered || markDeliveredLoading}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {markDeliveredLoading ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Ä–≥—ç–ª—Å—ç–Ω\"}\r\n                  </button>\r\n                )}\r\n\r\n                {(delivery.status === \"ON_ROUTE\" || delivery.status === \"DELIVERED\" || delivery.status === \"PAID\") && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setShowDispute(true)}\r\n                    className=\"text-xs px-4 py-2 rounded-xl border border-rose-300 bg-rose-50 text-rose-700 hover:bg-rose-100\"\r\n                  >\r\n                    –ú–∞—Ä–≥–∞–∞–Ω\r\n                  </button>\r\n                )}\r\n\r\n                {delivery.status === \"PAID\" && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void confirmPaymentReceived()}\r\n                    disabled={confirmPayLoading || !isChosenDriver || delivery.driver_confirmed_payment}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {confirmPayLoading ? \"–ë–∞—Ç–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–¢”©–ª–±”©—Ä —Ö“Ø–ª—ç—ç–Ω –∞–≤—Å–∞–Ω\"}\r\n                  </button>\r\n                )}\r\n\r\n                {delivery.status === \"DISPUTE\" && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => void resolveDispute()}\r\n                    disabled={resolveLoading}\r\n                    className=\"text-xs px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                  >\r\n                    {resolveLoading ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–®–∏–π–¥—ç–≥–¥—Å—ç–Ω\"}\r\n                  </button>\r\n                )}\r\n              </div>\r\n            </section>\r\n\r\n            {/* dispute modal */}\r\n            {showDispute && (\r\n              <div className=\"fixed inset-0 z-20 flex items-center justify-center bg-black/30 px-4\">\r\n                <div className=\"max-w-md w-full rounded-2xl bg-white shadow-lg border border-slate-200 px-4 py-4 space-y-3\">\r\n                  <h3 className=\"text-sm font-semibold text-slate-900\">–ú–∞—Ä–≥–∞–∞–Ω “Ø“Ø—Å–≥—ç—Ö (driver)</h3>\r\n                  <p className=\"text-xs text-slate-600\">–¢–æ–≤—á, —Ç–æ–¥–æ—Ä—Ö–æ–π —à–∞–ª—Ç–≥–∞–∞–Ω–∞–∞ –±–∏—á–Ω—ç “Ø“Ø.</p>\r\n\r\n                  <textarea\r\n                    value={disputeReason}\r\n                    onChange={(e) => setDisputeReason(e.target.value)}\r\n                    rows={4}\r\n                    className=\"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-800 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-rose-500\"\r\n                    placeholder=\"–Æ—É –±–æ–ª—Å–æ–Ω —Ç–∞–ª–∞–∞—Ä‚Ä¶\"\r\n                  />\r\n\r\n                  <div className=\"flex items-center justify-end gap-2 pt-1\">\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setShowDispute(false)}\r\n                      disabled={disputeLoading}\r\n                      className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n                    >\r\n                      –ë–æ–ª–∏—Ö\r\n                    </button>\r\n\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => void openDispute()}\r\n                      disabled={disputeLoading}\r\n                      className=\"text-[11px] px-3 py-1.5 rounded-full bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-60\"\r\n                    >\r\n                      {disputeLoading ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö\"}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </>\r\n        )}\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/driver/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n/* ===========================\r\n * app/driver/page.tsx (FINAL v7.2)\r\n *\r\n * ‚úÖ FIX: Driver list –¥—ç—ç—Ä pickup/dropoff –î“Ø“Ø—Ä—ç–≥/–•–æ—Ä–æ–æ (4 —Ç–∞–ª–±–∞—Ä) —Ö–∞—Ä—É—É–ª–Ω–∞\r\n * ‚úÖ UI: OPEN card-–≥ ‚Äú3 —Ç—É—Å–¥–∞–∞ –±–ª–æ–∫‚Äù –±–æ–ª–≥–æ–∂ –∑”©”©–ª”©–Ω ”©–Ω–≥”©”©—Ä —è–ª–≥–∞–≤\r\n *\r\n * ‚úÖ Flow:\r\n * OPEN -> ASSIGNED -> ON_ROUTE -> DELIVERED\r\n *\r\n * ‚úÖ Seller action:\r\n * - ASSIGNED -> ON_ROUTE : SELLER —Ç–∞–ª \"–ñ–æ–ª–æ–æ—á –±–∞—Ä–∞–∞–≥ –∞–≤—á —è–≤–ª–∞–∞\"\r\n *\r\n * ‚úÖ Driver actions:\r\n * - OPEN: \"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç\"\r\n * - REQUESTS: \"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö\"\r\n * - ON_ROUTE: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\"\r\n * - DELIVERED: \"–£—Å—Ç–≥–∞—Ö\" (driver_hidden=true)\r\n *\r\n * ‚ö† Privacy:\r\n * - List –¥—ç—ç—Ä buyer-–Ω —É—Ç–∞—Å –∑—ç—Ä—ç–≥ private info —Ö–∞—Ä—É—É–ª–∞—Ö–≥“Ø–π.\r\n * - Seller info –∑”©–≤—Ö”©–Ω ”©”©—Ä—Ç –æ–Ω–æ–æ–≥–¥—Å–æ–Ω “Ø–µ–¥ (OPEN –±–∏—à —Ç”©–ª–≤“Ø“Ø–¥ –¥—ç—ç—Ä) –≥–∞—Ä–Ω–∞.\r\n * =========================== */\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport {\r\n  DeliveryStatus,\r\n  DRIVER_TABS,\r\n  DriverTabId,\r\n  getDriverTabForStatus,\r\n} from \"@/lib/deliveryLogic\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryRow = {\r\n  id: string;\r\n  seller_id: string;\r\n\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n\r\n  // ‚úÖ UB admin fields (—à–∏–Ω—ç)\r\n  pickup_district: string | null;\r\n  pickup_khoroo: string | null;\r\n  dropoff_district: string | null;\r\n  dropoff_khoroo: string | null;\r\n\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n\r\n  chosen_driver_id: string | null;\r\n\r\n  // legacy (query-–¥ –±–∞–π–∂ –±–æ–ª–æ—Ö —á UI —Ç–∞–±/—Ç–æ–≤—á –±–∞–π—Ö–≥“Ø–π)\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n\r\n  dispute_opened_at: string | null;\r\n  closed_at: string | null;\r\n\r\n  driver_hidden: boolean;\r\n};\r\n\r\ntype BidLite = {\r\n  id: string;\r\n  driver_id: string;\r\n  delivery_id: string;\r\n  created_at: string;\r\n};\r\n\r\ntype SellerLite = {\r\n  id: string;\r\n  name: string | null;\r\n  phone: string | null;\r\n};\r\n\r\nfunction fmtPrice(n: number | null | undefined) {\r\n  const v = Number(n || 0);\r\n  return v ? `${v.toLocaleString(\"mn-MN\")}‚ÇÆ` : \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n}\r\n\r\nfunction fmtDT(iso: string | null | undefined) {\r\n  if (!iso) return \"\";\r\n  try {\r\n    return new Date(iso).toLocaleString(\"mn-MN\", { hour12: false });\r\n  } catch {\r\n    return String(iso);\r\n  }\r\n}\r\n\r\nfunction shorten(s: string | null, n = 60) {\r\n  const t = String(s || \"\").trim();\r\n  if (!t) return \"‚Äî\";\r\n  if (t.length <= n) return t;\r\n  return t.slice(0, n).replace(/\\s+$/, \"\") + \"‚Ä¶\";\r\n}\r\n\r\nfunction areaLine(district?: string | null, khoroo?: string | null) {\r\n  const dist = String(district || \"\").trim();\r\n  const kh = String(khoroo || \"\").trim();\r\n  if (!dist && !kh) return \"\";\r\n  if (dist && kh) return `${dist} ¬∑ ${kh}-—Ä —Ö–æ—Ä–æ–æ`;\r\n  return dist || (kh ? `${kh}-—Ä —Ö–æ—Ä–æ–æ` : \"\");\r\n}\r\n\r\nfunction badge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return { text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\", cls: \"bg-emerald-50 text-emerald-700 border-emerald-100\" };\r\n    case \"ASSIGNED\":\r\n      return { text: \"–¢–∞–Ω–¥ –æ–Ω–æ–æ—Å–æ–Ω\", cls: \"bg-sky-50 text-sky-700 border-sky-100\" };\r\n    case \"ON_ROUTE\":\r\n      return { text: \"–ó–∞–º–¥\", cls: \"bg-indigo-50 text-indigo-700 border-indigo-100\" };\r\n    case \"DELIVERED\":\r\n      return { text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\", cls: \"bg-amber-50 text-amber-700 border-amber-100\" };\r\n\r\n    // legacy badge (—Ç–∞–±—É—É–¥ –±–∞–π—Ö–≥“Ø–π —á —Ö–∞—Ä–∞–≥–¥–∞–∂ –±–æ–ª–Ω–æ)\r\n    case \"PAID\":\r\n      return { text: \"–¢”©–ª—Å”©–Ω\", cls: \"bg-emerald-50 text-emerald-800 border-emerald-100\" };\r\n    case \"DISPUTE\":\r\n      return { text: \"–ú–∞—Ä–≥–∞–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    case \"CLOSED\":\r\n      return { text: \"–•–∞–∞–≥–¥—Å–∞–Ω\", cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n    case \"CANCELLED\":\r\n      return { text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\", cls: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    default:\r\n      return { text: status, cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n  }\r\n}\r\n\r\nexport default function DriverPage() {\r\n  const router = useRouter();\r\n  const sp = useSearchParams();\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [activeTab, setActiveTab] = useState<DriverTabId>(\"OPEN\");\r\n\r\n  const [items, setItems] = useState<DeliveryRow[]>([]);\r\n  const [myBids, setMyBids] = useState<BidLite[]>([]);\r\n\r\n  const [sellerMap, setSellerMap] = useState<Record<string, SellerLite>>({});\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [msg, setMsg] = useState<string | null>(null);\r\n\r\n  // action lock per deliveryId\r\n  const [actLoading, setActLoading] = useState<Record<string, boolean>>({});\r\n\r\n  // ---------------- auth ----------------\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) return router.replace(\"/\");\r\n      const u: IncomeUser = JSON.parse(raw);\r\n      if (u.role !== \"driver\") return router.replace(\"/\");\r\n      setUser(u);\r\n    } catch {\r\n      router.replace(\"/\");\r\n    }\r\n  }, [router]);\r\n\r\n  // ---------------- tab init ----------------\r\n  useEffect(() => {\r\n    const q = sp.get(\"tab\") as DriverTabId | null;\r\n    if (q && DRIVER_TABS.find((t) => t.id === q)) setActiveTab(q);\r\n  }, [sp]);\r\n\r\n  // ---------------- data load ----------------\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    void fetchAll(user.id);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id]);\r\n\r\n  async function fetchSellersForMine(deliveries: DeliveryRow[], driverId: string) {\r\n    // –ó”©–≤—Ö”©–Ω ”©”©—Ä—Ç –æ–Ω–æ–æ–≥–¥—Å–æ–Ω, OPEN –±–∏—à —Ç”©–ª–≤“Ø“Ø–¥–∏–π–Ω seller_id-–≥ —Ç–∞—Ç–Ω–∞\r\n    const sellerIds = Array.from(\r\n      new Set(\r\n        deliveries\r\n          .filter((d) => d.chosen_driver_id === driverId && d.status !== \"OPEN\")\r\n          .map((d) => d.seller_id)\r\n          .filter(Boolean)\r\n      )\r\n    );\r\n\r\n    if (!sellerIds.length) {\r\n      setSellerMap({});\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { data, error } = await supabase.from(\"users\").select(\"id,name,phone\").in(\"id\", sellerIds);\r\n\r\n      if (error) {\r\n        console.warn(error);\r\n        return;\r\n      }\r\n\r\n      const map: Record<string, SellerLite> = {};\r\n      for (const u of (data || []) as any[]) {\r\n        map[u.id] = { id: u.id, name: u.name ?? null, phone: u.phone ?? null };\r\n      }\r\n      setSellerMap(map);\r\n    } catch (e) {\r\n      console.warn(e);\r\n    }\r\n  }\r\n\r\n  async function fetchAll(driverId: string) {\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // 1) deliveries (exclude hidden)\r\n      const { data: d1, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          [\r\n            \"id\",\r\n            \"seller_id\",\r\n            \"from_address\",\r\n            \"to_address\",\r\n            \"note\",\r\n            \"pickup_district\",\r\n            \"pickup_khoroo\",\r\n            \"dropoff_district\",\r\n            \"dropoff_khoroo\",\r\n            \"status\",\r\n            \"created_at\",\r\n            \"price_mnt\",\r\n            \"delivery_type\",\r\n            \"chosen_driver_id\",\r\n            \"seller_marked_paid\",\r\n            \"driver_confirmed_payment\",\r\n            \"dispute_opened_at\",\r\n            \"closed_at\",\r\n            \"driver_hidden\",\r\n          ].join(\",\")\r\n        )\r\n        .eq(\"driver_hidden\", false)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (e1) throw e1;\r\n\r\n      // 2) my bids (OPEN/REQUESTS section)\r\n      const { data: b1, error: e2 } = await supabase\r\n        .from(\"driver_bids\")\r\n        .select(\"id,driver_id,delivery_id,created_at\")\r\n        .eq(\"driver_id\", driverId)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (e2) throw e2;\r\n\r\n      const deliveries = (d1 || []) as any as DeliveryRow[];\r\n\r\n      // ‚öôÔ∏è –•—ç—Ä—ç–≤ DB –¥—ç—ç—Ä —Ç–∞–ª–±–∞—Ä –¥—É—Ç—É—É –±–∞–π–≤–∞–ª null –±–æ–ª–≥–æ–∂ ‚Äú—É–Ω–∞–ª—Ç–≥“Ø–π‚Äù –±–æ–ª–≥–æ–Ω–æ\r\n      const safeDeliveries = deliveries.map((x) => ({\r\n        ...x,\r\n        pickup_district: (x as any).pickup_district ?? null,\r\n        pickup_khoroo: (x as any).pickup_khoroo ?? null,\r\n        dropoff_district: (x as any).dropoff_district ?? null,\r\n        dropoff_khoroo: (x as any).dropoff_khoroo ?? null,\r\n      })) as DeliveryRow[];\r\n\r\n      setItems(safeDeliveries);\r\n      setMyBids((b1 || []) as BidLite[]);\r\n\r\n      // ‚úÖ seller info preload\r\n      void fetchSellersForMine(safeDeliveries, driverId);\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–ú—ç–¥—ç—ç–ª—ç–ª –∞—á–∞–∞–ª–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  // ---------------- computed ----------------\r\n  const myBidSet = useMemo(() => {\r\n    const s = new Set<string>();\r\n    for (const b of myBids) s.add(b.delivery_id);\r\n    return s;\r\n  }, [myBids]);\r\n\r\n  const filtered = useMemo(() => {\r\n    if (!user) return [];\r\n\r\n    return items.filter((d) => {\r\n      // OPEN/REQUESTS: only OPEN deliveries\r\n      if (activeTab === \"OPEN\") return d.status === \"OPEN\" && !myBidSet.has(d.id);\r\n      if (activeTab === \"REQUESTS\") return d.status === \"OPEN\" && myBidSet.has(d.id);\r\n\r\n      // Only my assigned flows\r\n      if (activeTab === \"ASSIGNED\") return d.status === \"ASSIGNED\" && d.chosen_driver_id === user.id;\r\n      if (activeTab === \"ON_ROUTE\") return d.status === \"ON_ROUTE\" && d.chosen_driver_id === user.id;\r\n\r\n      // DELIVERED tab: status DELIVERED + legacy statuses (UI –Ω—ç–≥—Ç–≥—ç–ª)\r\n      if (activeTab === \"DELIVERED\") {\r\n        const tab = getDriverTabForStatus(d.status);\r\n        return tab === \"DELIVERED\" && d.chosen_driver_id === user.id;\r\n      }\r\n\r\n      return false;\r\n    });\r\n  }, [items, activeTab, myBidSet, user]);\r\n\r\n  function changeTab(tab: DriverTabId) {\r\n    setActiveTab(tab);\r\n    router.push(`/driver?tab=${tab}`);\r\n  }\r\n\r\n  // ---------------- actions ----------------\r\n  async function requestDelivery(deliveryId: string) {\r\n    if (!user) return;\r\n    if (actLoading[deliveryId]) return;\r\n\r\n    setActLoading((p) => ({ ...p, [deliveryId]: true }));\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"driver_bids\")\r\n        .insert({ driver_id: user.id, delivery_id: deliveryId })\r\n        .select(\"id,driver_id,delivery_id,created_at\")\r\n        .maybeSingle();\r\n\r\n      if (error) {\r\n        console.warn(error);\r\n      } else if (data) {\r\n        setMyBids((prev) => [{ ...(data as any) }, ...prev]);\r\n      }\r\n\r\n      changeTab(\"REQUESTS\");\r\n      setMsg(\"–•“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–ª—ç—ç.\");\r\n      void fetchAll(user.id);\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–•“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setActLoading((p) => ({ ...p, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  async function cancelRequest(deliveryId: string) {\r\n    if (!user) return;\r\n    if (actLoading[deliveryId]) return;\r\n\r\n    setActLoading((p) => ({ ...p, [deliveryId]: true }));\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const my = myBids.find((b) => b.delivery_id === deliveryId);\r\n      if (my) {\r\n        const { error } = await supabase.from(\"driver_bids\").delete().eq(\"id\", my.id).eq(\"driver_id\", user.id);\r\n\r\n        if (error) throw error;\r\n\r\n        // ‚úÖ local state sync\r\n        setMyBids((prev) => prev.filter((x) => x.id !== my.id));\r\n      }\r\n\r\n      setMsg(\"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–∞–ª–ª–∞–∞.\");\r\n      changeTab(\"OPEN\");\r\n      void fetchAll(user.id);\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setActLoading((p) => ({ ...p, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  // ‚úÖ ON_ROUTE ‚Üí DELIVERED\r\n  async function markDelivered(deliveryId: string) {\r\n    if (!user) return;\r\n    if (actLoading[deliveryId]) return;\r\n\r\n    setActLoading((p) => ({ ...p, [deliveryId]: true }));\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"DELIVERED\" })\r\n        .eq(\"id\", deliveryId)\r\n        .eq(\"chosen_driver_id\", user.id)\r\n        .eq(\"status\", \"ON_ROUTE\")\r\n        .select(\"id,status\")\r\n        .maybeSingle();\r\n\r\n      if (e1) throw e1;\r\n\r\n      if (!data || (data as any).status !== \"DELIVERED\") {\r\n        setError(\"–®–∏–ª–∂–∏–ª—Ç –∞–º–∂–∏–ª—Ç–≥“Ø–π. (ON_ROUTE‚ÜíDELIVERED) –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n        return;\r\n      }\r\n\r\n      setItems((prev) => prev.map((x) => (x.id === deliveryId ? { ...x, status: \"DELIVERED\" as any } : x)));\r\n\r\n      changeTab(\"DELIVERED\");\r\n      setMsg(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ —Ö“Ø—Ä–≥—ç—Å—ç–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\");\r\n      void fetchAll(user.id);\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–®–∏–Ω—ç—á–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n    } finally {\r\n      setActLoading((p) => ({ ...p, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  // ‚úÖ DELIVERED –¥—ç—ç—Ä —É—Å—Ç–≥–∞—Ö (driver_hidden=true)\r\n  async function hideDelivered(deliveryId: string) {\r\n    if (!user) return;\r\n    if (actLoading[deliveryId]) return;\r\n\r\n    setActLoading((p) => ({ ...p, [deliveryId]: true }));\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ driver_hidden: true })\r\n        .eq(\"id\", deliveryId)\r\n        .eq(\"chosen_driver_id\", user.id)\r\n        .select(\"id,driver_hidden\")\r\n        .maybeSingle();\r\n\r\n      if (e1) throw e1;\r\n      if (!data || !(data as any).driver_hidden) {\r\n        setError(\"–£—Å—Ç–≥–∞—Ö “Ø–π–ª–¥—ç–ª –∞–º–∂–∏–ª—Ç–≥“Ø–π. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n        return;\r\n      }\r\n\r\n      setItems((prev) => prev.filter((x) => x.id !== deliveryId));\r\n\r\n      setMsg(\"–•“Ø—Ä–≥—ç—Å—ç–Ω —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ —É—Å—Ç–≥–∞–ª–∞–∞.\");\r\n      void fetchAll(user.id);\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–£—Å—Ç–≥–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setActLoading((p) => ({ ...p, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  // ---------------- UI ----------------\r\n  if (!user) return null;\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <div className=\"mx-auto max-w-5xl px-4 py-6\">\r\n        {/* header */}\r\n        <div className=\"flex items-center justify-between gap-3\">\r\n          <div>\r\n            <div className=\"text-sm text-slate-500\">INCOME</div>\r\n            <h1 className=\"text-xl font-bold text-slate-900\">–ñ–æ–ª–æ–æ—á</h1>\r\n            <div className=\"mt-1 text-xs text-slate-500\">\r\n              {user.name} ¬∑ {user.phone}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <button\r\n              onClick={() => router.push(\"/driver/profile\")}\r\n              className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300\"\r\n            >\r\n              –ü—Ä–æ—Ñ–∞–π–ª\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* tabs */}\r\n        <div className=\"mt-5 flex flex-wrap gap-2\">\r\n          {DRIVER_TABS.map((t) => {\r\n            const active = activeTab === t.id;\r\n            return (\r\n              <button\r\n                key={t.id}\r\n                onClick={() => changeTab(t.id)}\r\n                className={\r\n                  active\r\n                    ? \"rounded-full bg-slate-900 text-white px-4 py-2 text-sm font-semibold\"\r\n                    : \"rounded-full border border-slate-200 bg-white text-slate-700 px-4 py-2 text-sm font-semibold hover:border-slate-300\"\r\n                }\r\n              >\r\n                {t.label}\r\n              </button>\r\n            );\r\n          })}\r\n        </div>\r\n\r\n        {/* status line */}\r\n        <div className=\"mt-4 space-y-2\">\r\n          {error && (\r\n            <div className=\"rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700\">\r\n              {error}\r\n            </div>\r\n          )}\r\n          {msg && (\r\n            <div className=\"rounded-xl border border-emerald-200 bg-emerald-50 p-3 text-sm text-emerald-700\">\r\n              {msg}\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === \"ASSIGNED\" && (\r\n            <div className=\"rounded-xl border border-slate-200 bg-white p-3 text-xs text-slate-600\">\r\n              –≠–Ω—ç —Ç–∞–± –¥—ç—ç—Ä—Ö —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥–∏–π–≥ <span className=\"font-semibold\">—Ö—É–¥–∞–ª–¥–∞–≥—á</span> ‚Äú–ñ–æ–ª–æ–æ—á –±–∞—Ä–∞–∞–≥ –∞–≤—á —è–≤–ª–∞–∞‚Äù\r\n              –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Å–Ω–∏–π –¥–∞—Ä–∞–∞ –ª ‚Äú–ó–∞–º–¥‚Äù —Ç–∞–± —Ä—É—É —à–∏–ª–∂–∏–Ω—ç.\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === \"DELIVERED\" && (\r\n            <div className=\"rounded-xl border border-slate-200 bg-white p-3 text-xs text-slate-600\">\r\n              ‚Äú–•“Ø—Ä–≥—ç—Å—ç–Ω‚Äù —Ç–∞–± –¥—ç—ç—Ä—Ö —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥–∏–π–≥ —É—Å—Ç–≥–∞–∂ –±–æ–ª–Ω–æ. (–ó”©–≤—Ö”©–Ω —Ç–∞–Ω–¥ —Ö–∞—Ä–∞–≥–¥–∞—Ö–≥“Ø–π –±–æ–ª–≥–æ–Ω–æ.)\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* list */}\r\n        <div className=\"mt-4\">\r\n          {loading ? (\r\n            <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-sm text-slate-600\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n          ) : filtered.length === 0 ? (\r\n            <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-sm text-slate-600\">\r\n              –≠–Ω—ç —Ç–∞–± –¥—ç—ç—Ä —Ö“Ø—Ä–≥—ç–ª—Ç –∞–ª–≥–∞.\r\n            </div>\r\n          ) : (\r\n            <div className=\"grid grid-cols-1 gap-3\">\r\n              {filtered.map((d) => {\r\n                const b = badge(d.status);\r\n                const isMine = d.chosen_driver_id === user.id;\r\n                const seller = isMine ? sellerMap[d.seller_id] : undefined;\r\n\r\n                const fromArea = areaLine(d.pickup_district, d.pickup_khoroo);\r\n                const toArea = areaLine(d.dropoff_district, d.dropoff_khoroo);\r\n\r\n                return (\r\n                  <div key={d.id} className=\"rounded-2xl border border-slate-200 bg-white p-4\">\r\n                    <div className=\"flex items-start justify-between gap-3\">\r\n                      <div className=\"min-w-0 w-full\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <span className={`inline-flex items-center rounded-full border px-2 py-0.5 text-xs ${b.cls}`}>\r\n                            {b.text}\r\n                          </span>\r\n                          <span className=\"text-xs text-slate-500\">{fmtDT(d.created_at)}</span>\r\n                        </div>\r\n\r\n                        {/* ‚úÖ NEW: –∑”©”©–ª”©–Ω ”©–Ω–≥–∏–π–Ω 3 –±–ª–æ–∫ */}\r\n                        <div className=\"mt-3 grid gap-2\">\r\n                          <div className=\"rounded-xl border border-emerald-100 bg-emerald-50 p-3\">\r\n                            <div className=\"text-[11px] text-emerald-900/70\">–ê–≤–∞—Ö (—Ö–∞–∞–Ω–∞–∞—Å)</div>\r\n                            <div className=\"mt-1 text-xs font-semibold text-slate-900\">\r\n                              {fromArea ? <span className=\"text-slate-700\">{fromArea} ¬∑ </span> : null}\r\n                              {shorten(d.from_address, 90)}\r\n                            </div>\r\n                          </div>\r\n\r\n                          <div className=\"rounded-xl border border-amber-100 bg-amber-50 p-3\">\r\n                            <div className=\"text-[11px] text-amber-900/70\">–•“Ø—Ä–≥—ç—Ö (—Ö–∞–∞—à–∞–∞)</div>\r\n                            <div className=\"mt-1 text-xs font-semibold text-slate-900\">\r\n                              {toArea ? <span className=\"text-slate-700\">{toArea} ¬∑ </span> : null}\r\n                              {shorten(d.to_address, 90)}\r\n                            </div>\r\n                          </div>\r\n\r\n                          <div className=\"rounded-xl border border-slate-200 bg-slate-50 p-3\">\r\n                            <div className=\"flex items-start justify-between gap-3\">\r\n                              <div className=\"min-w-0\">\r\n                                <div className=\"text-[11px] text-slate-500\">–Æ—É —Ö“Ø—Ä–≥—ç—Ö</div>\r\n                                <div className=\"mt-1 text-xs font-semibold text-slate-900\">\r\n                                  {d.note ? shorten(d.note, 120) : \"‚Äî\"}\r\n                                </div>\r\n                              </div>\r\n                              <div className=\"shrink-0 text-right\">\r\n                                <div className=\"text-[11px] text-slate-500\">–°–∞–Ω–∞–ª “Ø–Ω—ç</div>\r\n                                <div className=\"mt-1 text-sm font-extrabold text-slate-900\">{fmtPrice(d.price_mnt)}</div>\r\n                              </div>\r\n                            </div>\r\n\r\n                            {d.delivery_type ? (\r\n                              <div className=\"mt-2\">\r\n                                <span className=\"inline-flex rounded-full border border-slate-200 bg-white px-2 py-0.5 text-[11px] font-semibold text-slate-700\">\r\n                                  {d.delivery_type}\r\n                                </span>\r\n                              </div>\r\n                            ) : null}\r\n                          </div>\r\n\r\n                          {/* ‚úÖ Seller info: –∑”©–≤—Ö”©–Ω ”©”©—Ä—Ç –æ–Ω–æ–æ–≥–¥—Å–æ–Ω “Ø–µ–¥ */}\r\n                          {isMine && d.status !== \"OPEN\" && (\r\n                            <div className=\"rounded-xl border border-slate-200 bg-white p-3\">\r\n                              <div className=\"text-[11px] text-slate-500\">–•—É–¥–∞–ª–¥–∞–≥—á</div>\r\n                              <div className=\"mt-1 flex flex-wrap items-center gap-2\">\r\n                                <div className=\"text-xs font-semibold text-slate-800\">{seller?.name || \"‚Äî\"}</div>\r\n                                {seller?.phone ? (\r\n                                  <>\r\n                                    <div className=\"text-xs text-slate-600\">{seller.phone}</div>\r\n                                    <a\r\n                                      href={`tel:${seller.phone}`}\r\n                                      className=\"ml-auto rounded-lg bg-slate-900 px-3 py-1.5 text-xs font-semibold text-white hover:bg-slate-800\"\r\n                                    >\r\n                                      –ó–∞–ª–≥–∞—Ö\r\n                                    </a>\r\n                                  </>\r\n                                ) : (\r\n                                  <div className=\"text-xs text-slate-500\">–£—Ç–∞—Å: ‚Äî</div>\r\n                                )}\r\n                              </div>\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n\r\n                      <div className=\"shrink-0\">\r\n                        <div className=\"text-xs text-slate-500 text-right\">ID</div>\r\n                        <div className=\"text-xs font-mono text-slate-600\">{d.id.slice(0, 8)}‚Ä¶</div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* actions */}\r\n                    <div className=\"mt-4 flex flex-wrap items-center gap-2\">\r\n                      {activeTab === \"OPEN\" && d.status === \"OPEN\" && (\r\n                        <button\r\n                          onClick={() => requestDelivery(d.id)}\r\n                          disabled={!!actLoading[d.id]}\r\n                          className=\"rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60\"\r\n                        >\r\n                          {actLoading[d.id] ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç\"}\r\n                        </button>\r\n                      )}\r\n\r\n                      {activeTab === \"REQUESTS\" && d.status === \"OPEN\" && (\r\n                        <button\r\n                          onClick={() => cancelRequest(d.id)}\r\n                          disabled={!!actLoading[d.id]}\r\n                          className=\"rounded-xl border border-rose-200 bg-rose-50 px-4 py-2 text-sm font-semibold text-rose-700 hover:bg-rose-100 disabled:opacity-60\"\r\n                        >\r\n                          {actLoading[d.id] ? \"–¢“Ø—Ä —Ö“Ø–ª—ç—ç–Ω—ç “Ø“Ø‚Ä¶\" : \"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö\"}\r\n                        </button>\r\n                      )}\r\n\r\n                      {activeTab === \"ON_ROUTE\" && d.status === \"ON_ROUTE\" && isMine && (\r\n                        <button\r\n                          onClick={() => markDelivered(d.id)}\r\n                          disabled={!!actLoading[d.id]}\r\n                          className=\"rounded-xl bg-amber-600 px-4 py-2 text-sm font-semibold text-white hover:bg-amber-700 disabled:opacity-60\"\r\n                        >\r\n                          {actLoading[d.id] ? \"–¢“Ø—Ä —Ö“Ø–ª—ç—ç–Ω—ç “Ø“Ø‚Ä¶\" : \"–•“Ø—Ä–≥—ç—Å—ç–Ω\"}\r\n                        </button>\r\n                      )}\r\n\r\n                      {activeTab === \"DELIVERED\" && isMine && (\r\n                        <button\r\n                          onClick={() => hideDelivered(d.id)}\r\n                          disabled={!!actLoading[d.id]}\r\n                          className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300 disabled:opacity-60\"\r\n                        >\r\n                          {actLoading[d.id] ? \"–¢“Ø—Ä —Ö“Ø–ª—ç—ç–Ω—ç “Ø“Ø‚Ä¶\" : \"–£—Å—Ç–≥–∞—Ö\"}\r\n                        </button>\r\n                      )}\r\n\r\n                      <button\r\n                        onClick={() => router.push(`/driver/delivery/${d.id}?tab=${activeTab}`)}\r\n                        className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300\"\r\n                      >\r\n                        –î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"mt-10 flex items-center justify-between gap-3 text-xs text-slate-500\">\r\n          <span>INCOME ¬∑ Driver</span>\r\n          <button\r\n            onClick={() => {\r\n              try {\r\n                localStorage.removeItem(\"incomeUser\");\r\n              } catch {}\r\n              router.push(\"/\");\r\n            }}\r\n            className=\"rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:border-slate-300\"\r\n          >\r\n            –ì–∞—Ä–∞—Ö\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/driver/profile/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n/* ===========================\r\n * app/driver/profile/page.tsx (FINAL v2)\r\n * ‚úÖ –ñ–æ–ª–æ–æ—á:\r\n *  - –ü—Ä–æ—Ñ–∞–π–ª –∑—É—Ä–∞–≥ (users.avatar_url + Storage: avatars bucket)\r\n *  - –ë–∞–Ω–∫/IBAN –º—ç–¥—ç—ç–ª—ç–ª (driver_profiles)\r\n * ‚úÖ Alerts: 8 —Å–µ–∫—É–Ω–¥—ç–¥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –∞–ª–≥–∞ –±–æ–ª–Ω–æ\r\n * =========================== */\r\n\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\ntype IncomeUser = { id: string; role: Role; name: string; phone: string; email: string };\r\n\r\ntype DriverProfile = {\r\n  driver_id: string;\r\n  bank_name: string | null;\r\n  iban: string | null;\r\n  account_number: string | null;\r\n  account_holder: string | null;\r\n  updated_at: string | null;\r\n};\r\n\r\nexport default function DriverProfilePage() {\r\n  const router = useRouter();\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [saving, setSaving] = useState(false);\r\n\r\n  // bank fields\r\n  const [bankName, setBankName] = useState(\"\");\r\n  const [iban, setIban] = useState(\"\");\r\n  const [accountNumber, setAccountNumber] = useState(\"\");\r\n  const [accountHolder, setAccountHolder] = useState(\"\");\r\n\r\n  // avatar\r\n  const fileRef = useRef<HTMLInputElement | null>(null);\r\n  const [avatarUrl, setAvatarUrl] = useState<string>(\"\");\r\n  const [avatarUploading, setAvatarUploading] = useState(false);\r\n\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [msg, setMsg] = useState<string | null>(null);\r\n\r\n  // ‚úÖ 8s auto-dismiss\r\n  useEffect(() => {\r\n    if (!error) return;\r\n    const t = setTimeout(() => setError(null), 8000);\r\n    return () => clearTimeout(t);\r\n  }, [error]);\r\n\r\n  useEffect(() => {\r\n    if (!msg) return;\r\n    const t = setTimeout(() => setMsg(null), 8000);\r\n    return () => clearTimeout(t);\r\n  }, [msg]);\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) return router.replace(\"/\");\r\n      const u: IncomeUser = JSON.parse(raw);\r\n      if (u.role !== \"driver\") return router.replace(\"/\");\r\n      setUser(u);\r\n    } catch {\r\n      router.replace(\"/\");\r\n    }\r\n  }, [router]);\r\n\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    void loadAll(user.id);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id]);\r\n\r\n  const avatarFallback = useMemo(() => {\r\n    const n = (user?.name || \"\").trim();\r\n    return n ? n.slice(0, 1).toUpperCase() : \"D\";\r\n  }, [user?.name]);\r\n\r\n  async function loadAll(driverId: string) {\r\n    setLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      // 1) bank profile\r\n      const { data: pData, error: pErr } = await supabase\r\n        .from(\"driver_profiles\")\r\n        .select(\"driver_id, bank_name, iban, account_number, account_holder, updated_at\")\r\n        .eq(\"driver_id\", driverId)\r\n        .maybeSingle();\r\n\r\n      if (pErr) throw pErr;\r\n\r\n      const p = (pData as DriverProfile | null) || null;\r\n      setBankName(p?.bank_name || \"\");\r\n      setIban(p?.iban || \"\");\r\n      setAccountNumber(p?.account_number || \"\");\r\n      setAccountHolder(p?.account_holder || \"\");\r\n\r\n      // 2) avatar_url from users\r\n      const { data: uData, error: uErr } = await supabase\r\n        .from(\"users\")\r\n        .select(\"avatar_url\")\r\n        .eq(\"id\", driverId)\r\n        .maybeSingle();\r\n\r\n      if (uErr) {\r\n        // users table –±–∞–π—Ö–≥“Ø–π/column –±–∞–π—Ö–≥“Ø–π “Ø–µ–¥ app —É–Ω–∞–≥–∞—Ö–≥“Ø–π\r\n        console.warn(\"users.avatar_url load failed:\", uErr);\r\n      } else {\r\n        setAvatarUrl((uData as any)?.avatar_url || \"\");\r\n      }\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–ü—Ä–æ—Ñ–∞–π–ª —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function saveBankProfile() {\r\n    if (!user) return;\r\n    if (saving) return;\r\n\r\n    setSaving(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const payload = {\r\n        driver_id: user.id,\r\n        bank_name: bankName.trim() || null,\r\n        iban: iban.trim() || null,\r\n        account_number: accountNumber.trim() || null,\r\n        account_holder: accountHolder.trim() || null,\r\n      };\r\n\r\n      const { error } = await supabase.from(\"driver_profiles\").upsert(payload, { onConflict: \"driver_id\" });\r\n      if (error) throw error;\r\n\r\n      setMsg(\"–•–∞–¥–≥–∞–ª–ª–∞–∞.\");\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–•–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  }\r\n\r\n  function openFilePicker() {\r\n    fileRef.current?.click();\r\n  }\r\n\r\n  async function onPickAvatar(file: File | null) {\r\n    if (!user) return;\r\n    if (!file) return;\r\n\r\n    // basic checks\r\n    if (!file.type.startsWith(\"image/\")) {\r\n      setError(\"–ó”©–≤—Ö”©–Ω –∑—É—Ä–∞–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É.\");\r\n      return;\r\n    }\r\n    const maxMB = 5;\r\n    if (file.size > maxMB * 1024 * 1024) {\r\n      setError(`–ó—É—Ä–∞–≥ ${maxMB}MB-—Å –±–∞–≥–∞ –±–∞–π—Ö —ë—Å—Ç–æ–π.`);\r\n      return;\r\n    }\r\n\r\n    setAvatarUploading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      // ‚úÖ storage path\r\n      const ext = (file.name.split(\".\").pop() || \"jpg\").toLowerCase();\r\n      const safeExt = [\"jpg\", \"jpeg\", \"png\", \"webp\"].includes(ext) ? ext : \"jpg\";\r\n      const path = `drivers/${user.id}/${Date.now()}.${safeExt}`;\r\n\r\n      const { error: upErr } = await supabase.storage.from(\"avatars\").upload(path, file, {\r\n        cacheControl: \"3600\",\r\n        upsert: true,\r\n      });\r\n\r\n      if (upErr) {\r\n        console.error(upErr);\r\n        setError(\"–ó—É—Ä–∞–≥ upload —Ö–∏–π—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      // ‚úÖ public url\r\n      const { data } = supabase.storage.from(\"avatars\").getPublicUrl(path);\r\n      const publicUrl = data?.publicUrl || \"\";\r\n\r\n      if (!publicUrl) {\r\n        setError(\"–ó—É—Ä–≥–∏–π–Ω —Ö–æ–ª–±–æ–æ—Å “Ø“Ø—Å–≥—ç–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π.\");\r\n        return;\r\n      }\r\n\r\n      // ‚úÖ save to users.avatar_url\r\n      const { error: uErr } = await supabase.from(\"users\").update({ avatar_url: publicUrl }).eq(\"id\", user.id);\r\n      if (uErr) {\r\n        console.error(uErr);\r\n        setError(\"–ó—É—Ä–≥–∏–π–Ω —Ö–æ–ª–±–æ–æ—Å —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. (users.avatar_url)\");\r\n        return;\r\n      }\r\n\r\n      setAvatarUrl(publicUrl);\r\n      setMsg(\"–ü—Ä–æ—Ñ–∞–π–ª –∑—É—Ä–∞–≥ —à–∏–Ω—ç—á–ª—ç–≥–¥–ª—ç—ç.\");\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–ó—É—Ä–∞–≥ —à–∏–Ω—ç—á–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setAvatarUploading(false);\r\n      // reset input to allow re-select same file\r\n      if (fileRef.current) fileRef.current.value = \"\";\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <main className=\"max-w-2xl mx-auto px-4 py-6 space-y-4\">\r\n        <div className=\"flex items-center justify-between gap-3\">\r\n          <button\r\n            onClick={() => router.push(\"/driver\")}\r\n            className=\"inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50\"\r\n          >\r\n            ‚Üê –ë—É—Ü–∞—Ö\r\n          </button>\r\n          <div className=\"text-xs text-slate-500\">–ñ–æ–ª–æ–æ—á ¬∑ –ü—Ä–æ—Ñ–∞–π–ª</div>\r\n        </div>\r\n\r\n        {error && (\r\n          <div className=\"rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700\">{error}</div>\r\n        )}\r\n        {msg && (\r\n          <div className=\"rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800\">\r\n            {msg}\r\n          </div>\r\n        )}\r\n\r\n        {loading ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-slate-600\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n        ) : (\r\n          <>\r\n            {/* Avatar card */}\r\n            <section className=\"rounded-2xl border border-slate-200 bg-white p-4\">\r\n              <div className=\"flex items-center justify-between gap-4\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"h-14 w-14 rounded-2xl border border-slate-200 bg-slate-50 overflow-hidden flex items-center justify-center\">\r\n                    {avatarUrl ? (\r\n                      // eslint-disable-next-line @next/next/no-img-element\r\n                      <img src={avatarUrl} alt=\"avatar\" className=\"h-full w-full object-cover\" />\r\n                    ) : (\r\n                      <div className=\"text-lg font-semibold text-slate-700\">{avatarFallback}</div>\r\n                    )}\r\n                  </div>\r\n\r\n                  <div>\r\n                    <div className=\"text-sm font-semibold text-slate-900\">{user?.name || \"–ñ–æ–ª–æ–æ—á\"}</div>\r\n                    <div className=\"text-xs text-slate-500\">{user?.phone || \"\"}</div>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-2\">\r\n                  <input\r\n                    ref={fileRef}\r\n                    type=\"file\"\r\n                    accept=\"image/*\"\r\n                    className=\"hidden\"\r\n                    onChange={(e) => void onPickAvatar(e.target.files?.[0] || null)}\r\n                  />\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={openFilePicker}\r\n                    disabled={avatarUploading}\r\n                    className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 disabled:opacity-60\"\r\n                  >\r\n                    {avatarUploading ? \"Upload‚Ä¶\" : \"–ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∞—Ö\"}\r\n                  </button>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"mt-3 text-[11px] text-slate-500\">\r\n                –≠–Ω—ç –∑—É—Ä–∞–≥ –Ω—å —Ö—É–¥–∞–ª–¥–∞–≥—á–∏–π–Ω ‚Äú–°–∞–Ω–∞–ª –∏—Ä—Å—ç–Ω –∂–æ–ª–æ–æ—á‚Äù –∂–∏–∂–∏–≥ –∫–∞—Ä—Ç –¥—ç—ç—Ä —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞.\r\n              </div>\r\n            </section>\r\n\r\n            {/* Bank profile card */}\r\n            <section className=\"rounded-2xl border border-slate-200 bg-white p-4 space-y-3\">\r\n              <h1 className=\"text-lg font-semibold text-slate-900\">–¢”©–ª–±”©—Ä —Ö“Ø–ª—ç—ç–∂ –∞–≤–∞—Ö –¥–∞–Ω—Å</h1>\r\n              <p className=\"text-xs text-slate-500\">\r\n                –•—É–¥–∞–ª–¥–∞–≥—á–∏–¥ –∑”©–≤—Ö”©–Ω ‚Äú–•“Ø—Ä–≥—ç—Å—ç–Ω/–¢”©–ª—Å”©–Ω/–ú–∞—Ä–≥–∞–∞–Ω/–•–∞–∞–≥–¥—Å–∞–Ω‚Äù “Ø–µ–¥ —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞.\r\n              </p>\r\n\r\n              <div className=\"grid gap-3\">\r\n                <div>\r\n                  <div className=\"text-[11px] text-slate-600 mb-1\">–ë–∞–Ω–∫</div>\r\n                  <input\r\n                    value={bankName}\r\n                    onChange={(e) => setBankName(e.target.value)}\r\n                    className=\"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/10\"\r\n                    placeholder=\"–ñ: –•–ê–ê–ù –ë–ê–ù–ö\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <div className=\"text-[11px] text-slate-600 mb-1\">IBAN</div>\r\n                  <input\r\n                    value={iban}\r\n                    onChange={(e) => setIban(e.target.value)}\r\n                    className=\"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/10\"\r\n                    placeholder=\"MN..\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <div className=\"text-[11px] text-slate-600 mb-1\">–î–∞–Ω—Å–Ω—ã –¥—É–≥–∞–∞—Ä</div>\r\n                  <input\r\n                    value={accountNumber}\r\n                    onChange={(e) => setAccountNumber(e.target.value)}\r\n                    className=\"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/10\"\r\n                    placeholder=\"5700...\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <div className=\"text-[11px] text-slate-600 mb-1\">–î–∞–Ω—Å —ç–∑—ç–º—à–∏–≥—á</div>\r\n                  <input\r\n                    value={accountHolder}\r\n                    onChange={(e) => setAccountHolder(e.target.value)}\r\n                    className=\"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/10\"\r\n                    placeholder=\"–û–≤–æ–≥ –ù—ç—Ä\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"pt-2\">\r\n                <button\r\n                  onClick={() => void saveBankProfile()}\r\n                  disabled={saving}\r\n                  className=\"rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60\"\r\n                >\r\n                  {saving ? \"–•–∞–¥–≥–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•–∞–¥–≥–∞–ª–∞—Ö\"}\r\n                </button>\r\n              </div>\r\n            </section>\r\n          </>\r\n        )}\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/layout.tsx",
        "summary": "",
        "content": "import type { Metadata } from \"next\";\nimport { Geist, Geist_Mono } from \"next/font/google\";\nimport \"./globals.css\";\n\nconst geistSans = Geist({\n  variable: \"--font-geist-sans\",\n  subsets: [\"latin\"],\n});\n\nconst geistMono = Geist_Mono({\n  variable: \"--font-geist-mono\",\n  subsets: [\"latin\"],\n});\n\nexport const metadata: Metadata = {\n  title: \"Create Next App\",\n  description: \"Generated by create next app\",\n};\n\nexport default function RootLayout({\n  children,\n}: Readonly<{\n  children: React.ReactNode;\n}>) {\n  return (\n    <html lang=\"en\">\n      <body\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n      >\n        {children}\n      </body>\n    </html>\n  );\n}\n"
      },
      {
        "path": "app/page.tsx",
        "summary": "",
        "content": "\"use client\";\n\nimport { FormEvent, useState } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { supabase } from \"@/lib/supabase\";\n\nexport default function LoginPage() {\n  const router = useRouter();\n\n  const [identifier, setIdentifier] = useState(\"\"); // –∏–º—ç–π–ª —ç—Å–≤—ç–ª —É—Ç–∞—Å\n  const [password, setPassword] = useState(\"\"); // 4 –æ—Ä–æ–Ω—Ç–æ–π PIN\n  const [showPassword, setShowPassword] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [error, setError] = useState(\"\");\n\n  async function handleSubmit(e: FormEvent<HTMLFormElement>) {\n    e.preventDefault();\n    setError(\"\");\n\n    if (!identifier.trim() || !password.trim()) {\n      setError(\"–ò–º—ç–π–ª/—É—Ç–∞—Å –±–æ–ª–æ–Ω –Ω—É—É—Ü “Ø–≥—ç—ç –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\n      return;\n    }\n\n    setIsSubmitting(true);\n\n    const { data, error: selectError } = await supabase\n      .from(\"users\")\n      .select(\"*\")\n      .or(`email.eq.${identifier},phone.eq.${identifier}`)\n      .maybeSingle();\n\n    if (selectError) {\n      console.error(selectError);\n      setIsSubmitting(false);\n      setError(\"–°–µ—Ä–≤–µ—Ä–∏–π–Ω –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\n      return;\n    }\n\n    if (!data) {\n      setIsSubmitting(false);\n      setError(\"–ò–π–º —Ö—ç—Ä—ç–≥–ª—ç–≥—á –±“Ø—Ä—Ç–≥—ç–ª–≥“Ø–π –±–∞–π–Ω–∞.\");\n      return;\n    }\n\n    if (data.pin !== password) {\n      setIsSubmitting(false);\n      setError(\"–ù—É—É—Ü “Ø–≥ –±—É—Ä—É—É –±–∞–π–Ω–∞.\");\n      return;\n    }\n\n    // ‚úÖ –ê–º–∂–∏–ª—Ç—Ç–∞–π –Ω—ç–≤—Ç—ç—Ä–≤—ç–ª localStorage-–¥ —Ö–∞–¥–≥–∞–ª–∞–∞–¥ role-–æ–æ—Ä –Ω—å —á–∏–≥–ª“Ø“Ø–ª–Ω—ç\n    const user = {\n      id: data.id,\n      role: data.role,\n      name: data.name,\n      phone: data.phone,\n      email: data.email,\n    };\n\n    if (typeof window !== \"undefined\") {\n      localStorage.setItem(\"incomeUser\", JSON.stringify(user));\n    }\n\n    setIsSubmitting(false);\n\n    if (data.role === \"seller\") {\n      router.push(\"/seller\");\n    } else {\n      router.push(\"/driver\");\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen bg-slate-50 flex items-center justify-center px-4\">\n      <div className=\"w-full max-w-md\">\n        {/* Top logo / title */}\n        <div className=\"mb-8 text-center\">\n          <div className=\"inline-flex items-center justify-center rounded-full bg-emerald-50 px-4 py-2 mb-3\">\n            <span className=\"text-sm font-semibold text-emerald-700\">\n              INCOME\n            </span>\n          </div>\n          <h1 className=\"text-2xl font-semibold text-slate-900\">\n            –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω marketplace\n          </h1>\n          <p className=\"mt-2 text-sm text-slate-500\">\n            –£—Ç–∞—Å —ç—Å–≤—ç–ª –∏–º—ç–π–ª—ç—ç—Ä—ç—ç –Ω—ç–≤—Ç—ç—Ä—á, —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Å–∏—Å—Ç–µ–º—ç—ç –∞—à–∏–≥–ª–∞.\n          </p>\n        </div>\n\n        {/* Card */}\n        <div className=\"bg-white rounded-2xl shadow-sm border border-slate-100 p-6\">\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-1\">\n            –ù—ç–≤—Ç—Ä—ç—Ö\n          </h2>\n          <p className=\"text-sm text-slate-500 mb-6\">\n            ”®–º–Ω”© –±“Ø—Ä—Ç–≥“Ø“Ø–ª—Å—ç–Ω –∏–º—ç–π–ª —ç—Å–≤—ç–ª —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞—Ä –Ω—ç–≤—Ç—ç—Ä–Ω—ç.\n          </p>\n\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            {/* Email / Phone */}\n            <div>\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\n                –ò–º—ç–π–ª —ç—Å–≤—ç–ª —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä\n              </label>\n              <input\n                type=\"text\"\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\n                placeholder=\"example@mail.com —ç—Å–≤—ç–ª 88xxxxxx\"\n                value={identifier}\n                onChange={(e) => setIdentifier(e.target.value)}\n              />\n            </div>\n\n            {/* Password */}\n            <div>\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\n                –ù—É—É—Ü “Ø–≥ (4 –æ—Ä–æ–Ω—Ç–æ–π PIN)\n              </label>\n              <div className=\"relative\">\n                <input\n                  type={showPassword ? \"text\" : \"password\"}\n                  className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50 pr-10 tracking-[0.3em]\"\n                  placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                />\n                <button\n                  type=\"button\"\n                  className=\"absolute inset-y-0 right-0 px-3 text-xs text-slate-500 hover:text-slate-700\"\n                  onClick={() => setShowPassword((v) => !v)}\n                >\n                  {showPassword ? \"–ù—É—É—Ö\" : \"–•–∞—Ä–∞—Ö\"}\n                </button>\n              </div>\n            </div>\n\n            {/* Error */}\n            {error && (\n              <div className=\"rounded-xl bg-red-50 text-red-700 text-sm px-3 py-2\">\n                {error}\n              </div>\n            )}\n\n            {/* Submit */}\n            <button\n              type=\"submit\"\n              disabled={isSubmitting}\n              className=\"w-full inline-flex items-center justify-center rounded-xl bg-emerald-600 text-white text-sm font-semibold py-2.5 mt-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-emerald-700 transition-colors\"\n            >\n              {isSubmitting ? \"–ù—ç–≤—Ç—Ä—ç–∂ –±–∞–π–Ω–∞...\" : \"–ù—ç–≤—Ç—Ä—ç—Ö\"}\n            </button>\n          </form>\n\n          {/* Divider */}\n          <div className=\"flex items-center mt-6 mb-4\">\n            <div className=\"flex-1 h-px bg-slate-200\" />\n            <span className=\"mx-3 text-xs text-slate-400\">—ç—Å–≤—ç–ª</span>\n            <div className=\"flex-1 h-px bg-slate-200\" />\n          </div>\n\n          {/* Register link */}\n          <p className=\"text-sm text-slate-600 text-center\">\n            –®–∏–Ω—ç —Ö—ç—Ä—ç–≥–ª—ç–≥—á “Ø“Ø?{\" \"}\n            <Link\n              href=\"/register\"\n              className=\"font-semibold text-emerald-600 hover:text-emerald-700\"\n            >\n              –ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö\n            </Link>\n          </p>\n        </div>\n\n        {/* Footer */}\n        <p className=\"mt-6 text-xs text-slate-400 text-center\">\n          INCOME v1.0 ¬∑ BABA &amp; Hypatia ¬∑ 2025\n        </p>\n      </div>\n    </div>\n  );\n}\n"
      },
      {
        "path": "app/register/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport { FormEvent, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { supabase } from \"@/lib/supabase\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\nexport default function RegisterPage() {\r\n  const router = useRouter();\r\n\r\n  const [role, setRole] = useState<Role>(\"seller\");\r\n  const [name, setName] = useState(\"\");\r\n  const [phone, setPhone] = useState(\"\");\r\n  const [email, setEmail] = useState(\"\");\r\n  const [pin, setPin] = useState(\"\");\r\n  const [pin2, setPin2] = useState(\"\");\r\n  const [showPin, setShowPin] = useState(false);\r\n  const [agree, setAgree] = useState(false);\r\n\r\n  const [error, setError] = useState(\"\");\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n  const roleLabel = role === \"seller\" ? \"–•—É–¥–∞–ª–¥–∞–≥—á\" : \"–ñ–æ–ª–æ–æ—á\";\r\n\r\n  async function handleSubmit(e: FormEvent<HTMLFormElement>) {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n\r\n    // --- –§—Ä–æ–Ω—Ç —Ç–∞–ª—ã–Ω —à–∞–ª–≥–∞–ª—Ç ---\r\n    if (!name.trim()) {\r\n      setError(\"–ù—ç—Ä—ç—ç –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!phone.trim()) {\r\n      setError(\"–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞ –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!email.trim()) {\r\n      setError(\"–ò–º—ç–π–ª —Ö–∞—è–≥–∞–∞ –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!email.includes(\"@\") || !email.includes(\".\")) {\r\n      setError(\"–ò–º—ç–π–ª —Ö–∞—è–≥–∞–∞ –∑”©–≤ —Ñ–æ—Ä–º–∞—Ç—Ç–∞–π –æ—Ä—É—É–ª–Ω–∞ —É—É.\");\r\n      return;\r\n    }\r\n    if (!/^\\d{4}$/.test(pin)) {\r\n      setError(\"–ù—É—É—Ü “Ø–≥ 4 –æ—Ä–æ–Ω—Ç–æ–π —Ç–æ–æ –±–∞–π—Ö —ë—Å—Ç–æ–π.\");\r\n      return;\r\n    }\r\n    if (pin !== pin2) {\r\n      setError(\"–ù—É—É—Ü “Ø–≥ —Ö–æ—ë—Ä —Ç–∞–∞—Ä–∞—Ö–≥“Ø–π –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n    if (!agree) {\r\n      setError(\"–ê—à–∏–≥–ª–∞—Ö –Ω”©—Ö—Ü”©–ª—Ç—ç–π —Ç–∞–Ω–∏–ª—Ü–∞–∂ –∑”©–≤—à”©”©—Ä”©—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π.\");\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    // --- –£—Ç–∞—Å / –∏–º—ç–π–ª –¥–∞–≤—Ç–∞–≥–¥–∞–∂ –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞ ---\r\n    const { data: existing, error: existsError } = await supabase\r\n      .from(\"users\")\r\n      .select(\"id\")\r\n      .or(`phone.eq.${phone},email.eq.${email}`)\r\n      .maybeSingle();\r\n\r\n    if (existsError) {\r\n      console.error(existsError);\r\n      setIsSubmitting(false);\r\n      setError(\"–°–µ—Ä–≤–µ—Ä–∏–π–Ω –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ä–∞–∞ –¥–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n      return;\r\n    }\r\n\r\n    if (existing) {\r\n      setIsSubmitting(false);\r\n      setError(\"–≠–Ω—ç —É—Ç–∞—Å —ç—Å–≤—ç–ª –∏–º—ç–π–ª—ç—ç—Ä –∞–ª—å —Ö—ç–¥–∏–π–Ω –±“Ø—Ä—Ç–≥“Ø“Ø–ª—Å—ç–Ω –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    // --- –ñ–∏–Ω—Ö—ç–Ω—ç insert ---\r\n    const { error: insertError } = await supabase.from(\"users\").insert({\r\n      role,\r\n      name,\r\n      phone,\r\n      email,\r\n      pin, // v2 –¥—ç—ç—Ä PIN-–≥ hash —Ö–∏–π–Ω—ç\r\n    });\r\n\r\n    if (insertError) {\r\n      console.error(insertError);\r\n      setIsSubmitting(false);\r\n      setError(\"–ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      return;\r\n    }\r\n\r\n    // –ê–º–∂–∏–ª—Ç—Ç–∞–π ‚Üí Login —Ä—É—É\r\n    setIsSubmitting(false);\r\n    router.push(\"/\");\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50 flex items-center justify-center px-4\">\r\n      <div className=\"w-full max-w-md\">\r\n        {/* Top logo / title */}\r\n        <div className=\"mb-8 text-center\">\r\n          <div className=\"inline-flex items-center justify-center rounded-full bg-emerald-50 px-4 py-2 mb-3\">\r\n            <span className=\"text-sm font-semibold text-emerald-700\">\r\n              INCOME\r\n            </span>\r\n          </div>\r\n          <h1 className=\"text-2xl font-semibold text-slate-900\">\r\n            –ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö\r\n          </h1>\r\n          <p className=\"mt-2 text-sm text-slate-500\">\r\n            –ñ–æ–ª–æ–æ—á —ç—Å–≤—ç–ª –•—É–¥–∞–ª–¥–∞–≥—á —Ö—ç–ª–±—ç—Ä—ç—ç—Ä –Ω—ç–≥ —É–¥–∞–∞ –±“Ø—Ä—Ç–≥“Ø“Ø–ª–∂ –∞—à–∏–≥–ª–∞–Ω–∞.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Card */}\r\n        <div className=\"bg-white rounded-2xl shadow-sm border border-slate-100 p-6\">\r\n          {/* Role toggle */}\r\n          <div className=\"flex mb-6 rounded-xl bg-slate-50 p-1\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setRole(\"seller\")}\r\n              className={`flex-1 text-sm font-medium py-2 rounded-lg transition ${\r\n                role === \"seller\"\r\n                  ? \"bg-white shadow-sm text-emerald-700\"\r\n                  : \"text-slate-500\"\r\n              }`}\r\n            >\r\n              –•—É–¥–∞–ª–¥–∞–≥—á\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setRole(\"driver\")}\r\n              className={`flex-1 text-sm font-medium py-2 rounded-lg transition ${\r\n                role === \"driver\"\r\n                  ? \"bg-white shadow-sm text-emerald-700\"\r\n                  : \"text-slate-500\"\r\n              }`}\r\n            >\r\n              –ñ–æ–ª–æ–æ—á\r\n            </button>\r\n          </div>\r\n\r\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n            {/* Name */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ù—ç—Ä\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\r\n                placeholder=\"–ñ–∏—à—ç—ç: –ë–∞—Ç–±–∞—è—Ä\"\r\n                value={name}\r\n                onChange={(e) => setName(e.target.value)}\r\n              />\r\n            </div>\r\n\r\n            {/* Phone */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä\r\n              </label>\r\n              <input\r\n                type=\"tel\"\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\r\n                placeholder=\"–ñ–∏—à—ç—ç: 88112233\"\r\n                value={phone}\r\n                onChange={(e) => setPhone(e.target.value)}\r\n              />\r\n              <p className=\"mt-1 text-xs text-slate-400\">\r\n                –ù—ç–≥ —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞—Ä –∑”©–≤—Ö”©–Ω –Ω—ç–≥ –ª —É–¥–∞–∞ –±“Ø—Ä—Ç–≥“Ø“Ø–ª–Ω—ç.\r\n              </p>\r\n            </div>\r\n\r\n            {/* Email */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ò–º—ç–π–ª —Ö–∞—è–≥\r\n              </label>\r\n              <input\r\n                type=\"email\"\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\r\n                placeholder=\"example@mail.com\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n              />\r\n              <p className=\"mt-1 text-xs text-slate-400\">\r\n                –ò–º—ç–π–ª—ç—ç—Ä –Ω—É—É—Ü “Ø–≥ —Å—ç—Ä–≥—ç—ç—Ö, –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö –º—ç–¥—ç—ç–ª—ç–ª –æ—á–Ω–æ.\r\n              </p>\r\n            </div>\r\n\r\n            {/* PIN */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ù—É—É—Ü “Ø–≥ (4 –æ—Ä–æ–Ω—Ç–æ–π PIN)\r\n              </label>\r\n              <div className=\"relative\">\r\n                <input\r\n                  type={showPin ? \"text\" : \"password\"}\r\n                  inputMode=\"numeric\"\r\n                  maxLength={4}\r\n                  className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50 pr-10 tracking-[0.3em]\"\r\n                  placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                  value={pin}\r\n                  onChange={(e) => {\r\n                    const v = e.target.value.replace(/\\D/g, \"\");\r\n                    setPin(v);\r\n                  }}\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"absolute inset-y-0 right-0 px-3 text-xs text-slate-500 hover:text-slate-700\"\r\n                  onClick={() => setShowPin((v) => !v)}\r\n                >\r\n                  {showPin ? \"–ù—É—É—Ö\" : \"–•–∞—Ä–∞—Ö\"}\r\n                </button>\r\n              </div>\r\n              <p className=\"mt-1 text-xs text-slate-400\">\r\n                –ó”©–≤—Ö”©–Ω 4 –æ—Ä–æ–Ω—Ç–æ–π —Ç–æ–æ –±–∞–π—Ö–∞–∞—Ä —Ç–æ—Ö–∏—Ä—É—É–ª–Ω–∞ (–∂–∏—à—ç—ç: 1234).\r\n              </p>\r\n            </div>\r\n\r\n            {/* PIN confirm */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ù—É—É—Ü “Ø–≥ –¥–∞–≤—Ç–∞—Ö\r\n              </label>\r\n              <input\r\n                type={showPin ? \"text\" : \"password\"}\r\n                inputMode=\"numeric\"\r\n                maxLength={4}\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50 tracking-[0.3em]\"\r\n                placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                value={pin2}\r\n                onChange={(e) => {\r\n                  const v = e.target.value.replace(/\\D/g, \"\");\r\n                  setPin2(v);\r\n                }}\r\n              />\r\n            </div>\r\n\r\n            {/* Terms */}\r\n            <div className=\"flex items-start gap-2 pt-1\">\r\n              <input\r\n                id=\"agree\"\r\n                type=\"checkbox\"\r\n                checked={agree}\r\n                onChange={(e) => setAgree(e.target.checked)}\r\n                className=\"mt-1 h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500\"\r\n              />\r\n              <label\r\n                htmlFor=\"agree\"\r\n                className=\"text-xs text-slate-600 leading-relaxed\"\r\n              >\r\n                –ë–∏ INCOME —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω marketplace-–∏–π–Ω –∞—à–∏–≥–ª–∞—Ö –Ω”©—Ö—Ü”©–ª, —Ö—É–≤–∏–π–Ω\r\n                –º—ç–¥—ç—ç–ª—ç–ª –∞—à–∏–≥–ª–∞—Ö –∂—É—Ä–º—ã–≥ —É–Ω—à–∏–∂ —Ç–∞–Ω–∏–ª—Ü—Å–∞–Ω –±”©–≥”©”©–¥{\" \"}\r\n                <span className=\"font-semibold\">–∑”©–≤—à”©”©—Ä—á –±–∞–π–Ω–∞.</span>\r\n              </label>\r\n            </div>\r\n\r\n            {/* Error */}\r\n            {error && (\r\n              <div className=\"rounded-xl bg-red-50 text-red-700 text-sm px-3 py-2\">\r\n                {error}\r\n              </div>\r\n            )}\r\n\r\n            {/* Submit */}\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isSubmitting}\r\n              className=\"w-full inline-flex items-center justify-center rounded-xl bg-emerald-600 text-white text-sm font-semibold py-2.5 mt-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-emerald-700 transition-colors\"\r\n            >\r\n              {isSubmitting\r\n                ? \"–ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç–∂ –±–∞–π–Ω–∞...\"\r\n                : `${roleLabel} –±“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö`}\r\n            </button>\r\n          </form>\r\n\r\n          {/* Divider */}\r\n          <div className=\"flex items-center mt-6 mb-4\">\r\n            <div className=\"flex-1 h-px bg-slate-200\" />\r\n            <span className=\"mx-3 text-xs text-slate-400\">—ç—Å–≤—ç–ª</span>\r\n            <div className=\"flex-1 h-px bg-slate-200\" />\r\n          </div>\r\n\r\n          {/* Back to login */}\r\n          <p className=\"text-sm text-slate-600 text-center\">\r\n            –ê–ª—å —Ö—ç–¥–∏–π–Ω –±“Ø—Ä—Ç–≥—ç–ª—Ç—ç–π —é—É?{\" \"}\r\n            <Link\r\n              href=\"/\"\r\n              className=\"font-semibold text-emerald-600 hover:text-emerald-700\"\r\n            >\r\n              –ù—ç–≤—Ç—Ä—ç—Ö\r\n            </Link>\r\n          </p>\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <p className=\"mt-6 text-xs text-slate-400 text-center\">\r\n          INCOME v1.0 ¬∑ {roleLabel} –±“Ø—Ä—Ç–≥—ç–ª ¬∑ –ú–æ–Ω–≥–æ–ª\r\n        </p>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/seller/delivery/[id]/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useParams, useRouter, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport DeliveryRouteMap from \"@/app/components/Map/DeliveryRouteMap\";\r\nimport { DeliveryStatus, getSellerTabForStatus } from \"@/lib/deliveryLogic\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryDetail = {\r\n  id: string;\r\n  seller_id: string;\r\n\r\n  // full address (kept for share/edit, but NOT shown in top line now)\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n\r\n  // ‚úÖ district/khoroo (used for top line)\r\n  pickup_district: string | null;\r\n  pickup_khoroo: string | null;\r\n  dropoff_district: string | null;\r\n  dropoff_khoroo: string | null;\r\n\r\n  pickup_lat: number | null;\r\n  pickup_lng: number | null;\r\n  dropoff_lat: number | null;\r\n  dropoff_lng: number | null;\r\n\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n\r\n  chosen_driver_id: string | null;\r\n\r\n  pickup_contact_phone?: string | null;\r\n  dropoff_contact_phone?: string | null;\r\n};\r\n\r\ntype DriverPublic = {\r\n  id: string;\r\n  name: string | null;\r\n  phone: string | null;\r\n  avatar_url?: string | null;\r\n\r\n  // ‚úÖ optional bank fields (if your DB has them)\r\n  bank_iban?: string | null;\r\n  bank_account?: string | null;\r\n  bank_holder?: string | null;\r\n};\r\n\r\ntype BidRow = {\r\n  id: string;\r\n  driver_id: string;\r\n  created_at: string;\r\n  driver: DriverPublic | null;\r\n};\r\n\r\nfunction fmtPrice(n: number | null | undefined) {\r\n  const v = Number(n || 0);\r\n  return v ? `${v.toLocaleString(\"mn-MN\")}‚ÇÆ` : \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n}\r\n\r\nfunction fmtDT(iso: string | null | undefined) {\r\n  if (!iso) return \"\";\r\n  try {\r\n    return new Date(iso).toLocaleString(\"mn-MN\", { hour12: false });\r\n  } catch {\r\n    return iso || \"\";\r\n  }\r\n}\r\n\r\nfunction shorten(s: string | null, max = 90) {\r\n  if (!s) return \"‚Äî\";\r\n  const t = s.trim();\r\n  if (t.length <= max) return t;\r\n  return t.slice(0, max).replace(/\\s+$/, \"\") + \"‚Ä¶\";\r\n}\r\n\r\n// ‚úÖ ‚Äú1 —Ö–æ—Ä–æ–æ‚Äù –≥—ç–∂ —Ç–æ–≤—á–∏–ª–∂ –Ω—ç–≥ –º”©—Ä”©–Ω–¥ –≥–∞—Ä–≥–∞–Ω–∞ (UI —ç–≤–¥—ç—Ö–≥“Ø–π)\r\nfunction areaLine(district?: string | null, khoroo?: string | null) {\r\n  const d = (district || \"\").trim();\r\n  const k = (khoroo || \"\").trim();\r\n  if (d && k) return `${d} ${k} —Ö–æ—Ä–æ–æ`;\r\n  if (d) return d;\r\n  if (k) return `${k} —Ö–æ—Ä–æ–æ`;\r\n  return \"‚Äî\";\r\n}\r\n\r\nfunction badge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return {\r\n        text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\",\r\n        cls: \"bg-emerald-50 text-emerald-700 border-emerald-100\",\r\n      };\r\n    case \"ASSIGNED\":\r\n      return {\r\n        text: \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\",\r\n        cls: \"bg-sky-50 text-sky-700 border-sky-100\",\r\n      };\r\n    case \"ON_ROUTE\":\r\n      return {\r\n        text: \"–ó–∞–º–¥\",\r\n        cls: \"bg-indigo-50 text-indigo-700 border-indigo-100\",\r\n      };\r\n    case \"DELIVERED\":\r\n      return {\r\n        text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\",\r\n        cls: \"bg-amber-50 text-amber-700 border-amber-100\",\r\n      };\r\n    case \"CANCELLED\":\r\n      return {\r\n        text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\",\r\n        cls: \"bg-rose-50 text-rose-700 border-rose-100\",\r\n      };\r\n    default:\r\n      return { text: status, cls: \"bg-slate-50 text-slate-700 border-slate-200\" };\r\n  }\r\n}\r\n\r\nasync function copyText(text: string) {\r\n  try {\r\n    await navigator.clipboard.writeText(text);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport default function SellerDeliveryDetailPage() {\r\n  const router = useRouter();\r\n  const sp = useSearchParams();\r\n  const { id } = useParams<{ id: string }>();\r\n\r\n  const backTab = sp.get(\"tab\") || \"\";\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [loadingBids, setLoadingBids] = useState(true);\r\n\r\n  const [delivery, setDelivery] = useState<DeliveryDetail | null>(null);\r\n  const [bids, setBids] = useState<BidRow[]>([]);\r\n  const [chosenDriver, setChosenDriver] = useState<DriverPublic | null>(null);\r\n\r\n  const [msg, setMsg] = useState<string | null>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const [chooseLoading, setChooseLoading] = useState<string | null>(null);\r\n  const [cancelLoading, setCancelLoading] = useState(false);\r\n\r\n  const [editOpen, setEditOpen] = useState(false);\r\n  const [editSaving, setEditSaving] = useState(false);\r\n  const [editFrom, setEditFrom] = useState(\"\");\r\n  const [editTo, setEditTo] = useState(\"\");\r\n  const [editNote, setEditNote] = useState(\"\");\r\n  const [editPrice, setEditPrice] = useState<string>(\"\");\r\n\r\n  // ‚úÖ –Ω–∞–π–¥–≤–∞—Ä–≥“Ø–π –∂–æ–ª–æ–æ—á (loading)\r\n  const [unreliableLoading, setUnreliableLoading] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (!msg && !error) return;\r\n    const t = setTimeout(() => {\r\n      setMsg(null);\r\n      setError(null);\r\n    }, 8000);\r\n    return () => clearTimeout(t);\r\n  }, [msg, error]);\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) return router.replace(\"/\");\r\n      const u: IncomeUser = JSON.parse(raw);\r\n      if (u.role !== \"seller\") return router.replace(\"/\");\r\n      setUser(u);\r\n    } catch {\r\n      router.replace(\"/\");\r\n    }\r\n  }, [router]);\r\n\r\n  useEffect(() => {\r\n    if (!user || !id) return;\r\n    void loadAll();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id, id]);\r\n\r\n  async function loadAll() {\r\n    if (!user) return;\r\n    setLoading(true);\r\n    setLoadingBids(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          seller_id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n\r\n          pickup_district,\r\n          pickup_khoroo,\r\n          dropoff_district,\r\n          dropoff_khoroo,\r\n\r\n          pickup_lat,\r\n          pickup_lng,\r\n          dropoff_lat,\r\n          dropoff_lng,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          chosen_driver_id,\r\n          pickup_contact_phone,\r\n          dropoff_contact_phone\r\n        `\r\n        )\r\n        .eq(\"id\", id)\r\n        .maybeSingle();\r\n\r\n      if (e1) throw e1;\r\n      if (!data) {\r\n        setDelivery(null);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\");\r\n        setLoading(false);\r\n        setLoadingBids(false);\r\n        return;\r\n      }\r\n\r\n      if ((data as any).seller_id !== user.id) {\r\n        setDelivery(null);\r\n        setError(\"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ —Ö–∞—Ä–∞—Ö —ç—Ä—Ö–≥“Ø–π –±–∞–π–Ω–∞.\");\r\n        setLoading(false);\r\n        setLoadingBids(false);\r\n        return;\r\n      }\r\n\r\n      const d: DeliveryDetail = {\r\n        id: (data as any).id,\r\n        seller_id: (data as any).seller_id,\r\n\r\n        from_address: (data as any).from_address ?? null,\r\n        to_address: (data as any).to_address ?? null,\r\n        note: (data as any).note ?? null,\r\n\r\n        pickup_district: (data as any).pickup_district ?? null,\r\n        pickup_khoroo: (data as any).pickup_khoroo ?? null,\r\n        dropoff_district: (data as any).dropoff_district ?? null,\r\n        dropoff_khoroo: (data as any).dropoff_khoroo ?? null,\r\n\r\n        pickup_lat: (data as any).pickup_lat ?? null,\r\n        pickup_lng: (data as any).pickup_lng ?? null,\r\n        dropoff_lat: (data as any).dropoff_lat ?? null,\r\n        dropoff_lng: (data as any).dropoff_lng ?? null,\r\n\r\n        status: (data as any).status as DeliveryStatus,\r\n        created_at: (data as any).created_at,\r\n        price_mnt: (data as any).price_mnt ?? null,\r\n        delivery_type: (data as any).delivery_type ?? null,\r\n        chosen_driver_id: (data as any).chosen_driver_id ?? null,\r\n\r\n        pickup_contact_phone: (data as any).pickup_contact_phone ?? null,\r\n        dropoff_contact_phone: (data as any).dropoff_contact_phone ?? null,\r\n      };\r\n\r\n      setDelivery(d);\r\n\r\n      // Edit uses full address (kept)\r\n      setEditFrom(d.from_address || \"\");\r\n      setEditTo(d.to_address || \"\");\r\n      setEditNote(d.note || \"\");\r\n      setEditPrice(d.price_mnt != null ? String(d.price_mnt) : \"\");\r\n\r\n      const { data: bidRows, error: e2 } = await supabase\r\n        .from(\"driver_bids\")\r\n        .select(\r\n          `\r\n          id,\r\n          driver_id,\r\n          created_at,\r\n          driver:driver_id (\r\n            id,\r\n            name,\r\n            phone,\r\n            avatar_url\r\n          )\r\n        `\r\n        )\r\n        .eq(\"delivery_id\", id)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (e2) setBids([]);\r\n      else setBids((bidRows as any) || []);\r\n\r\n      if (d.chosen_driver_id) {\r\n        // ‚úÖ Try bank fields first (if columns exist). If not, fallback to minimal select.\r\n        const { data: du1, error: duErr1 } = await supabase\r\n          .from(\"users\")\r\n          .select(\"id,name,phone,avatar_url,bank_iban,bank_account,bank_holder\")\r\n          .eq(\"id\", d.chosen_driver_id)\r\n          .maybeSingle();\r\n\r\n        if (!duErr1 && du1) {\r\n          setChosenDriver((du1 as any) || null);\r\n        } else {\r\n          const { data: du2 } = await supabase\r\n            .from(\"users\")\r\n            .select(\"id,name,phone,avatar_url\")\r\n            .eq(\"id\", d.chosen_driver_id)\r\n            .maybeSingle();\r\n\r\n          setChosenDriver((du2 as any) || null);\r\n        }\r\n      } else {\r\n        setChosenDriver(null);\r\n      }\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–ú—ç–¥—ç—ç–ª—ç–ª –∞—á–∞–∞–ª–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      setDelivery(null);\r\n      setBids([]);\r\n      setChosenDriver(null);\r\n    } finally {\r\n      setLoading(false);\r\n      setLoadingBids(false);\r\n    }\r\n  }\r\n\r\n  function goBack() {\r\n    if (backTab) return router.push(`/seller?tab=${encodeURIComponent(backTab)}`);\r\n    if (!delivery) return router.push(\"/seller?tab=OPEN\");\r\n    return router.push(`/seller?tab=${getSellerTabForStatus(delivery.status)}`);\r\n  }\r\n\r\n  const canEditOrCancel = useMemo(() => delivery?.status === \"OPEN\", [delivery]);\r\n  const canChooseDriver = useMemo(\r\n    () => !!delivery && delivery.status === \"OPEN\" && !delivery.chosen_driver_id,\r\n    [delivery]\r\n  );\r\n\r\n  const pickup = useMemo(() => {\r\n    if (!delivery) return null;\r\n    if (delivery.pickup_lat == null || delivery.pickup_lng == null) return null;\r\n    return { lat: Number(delivery.pickup_lat), lng: Number(delivery.pickup_lng) };\r\n  }, [delivery]);\r\n\r\n  const dropoff = useMemo(() => {\r\n    if (!delivery) return null;\r\n    if (delivery.dropoff_lat == null || delivery.dropoff_lng == null) return null;\r\n    return { lat: Number(delivery.dropoff_lat), lng: Number(delivery.dropoff_lng) };\r\n  }, [delivery]);\r\n\r\n  async function chooseDriver(driverId: string) {\r\n    if (!delivery || !user) return;\r\n    if (!canChooseDriver) return;\r\n    if (chooseLoading) return;\r\n\r\n    setChooseLoading(driverId);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ chosen_driver_id: driverId, status: \"ASSIGNED\" })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id)\r\n        .eq(\"status\", \"OPEN\")\r\n        .is(\"chosen_driver_id\", null)\r\n        .select(\"id,status,chosen_driver_id\")\r\n        .maybeSingle();\r\n\r\n      if (e1) throw e1;\r\n      if (!data || (data as any).status !== \"ASSIGNED\") {\r\n        setError(\"–°–æ–Ω–≥–æ–ª—Ç –∞–º–∂–∏–ª—Ç–≥“Ø–π. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({\r\n        ...delivery,\r\n        status: \"ASSIGNED\",\r\n        chosen_driver_id: (data as any).chosen_driver_id,\r\n      });\r\n\r\n      const target = bids.find((b) => b.driver_id === driverId)?.driver || null;\r\n      setChosenDriver(target);\r\n\r\n      setMsg(\"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ–≥–¥–ª–æ–æ.\");\r\n      setTimeout(() => router.push(\"/seller?tab=ASSIGNED\"), 350);\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setChooseLoading(null);\r\n    }\r\n  }\r\n\r\n  async function cancelDelivery() {\r\n    if (!delivery || !user) return;\r\n    if (!canEditOrCancel) return;\r\n    if (cancelLoading) return;\r\n\r\n    setCancelLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"CANCELLED\" })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id)\r\n        .eq(\"status\", \"OPEN\")\r\n        .select(\"id,status\")\r\n        .maybeSingle();\r\n\r\n      if (e1) throw e1;\r\n      if (!data || (data as any).status !== \"CANCELLED\") {\r\n        setError(\"–¶—É—Ü–ª–∞—Ö –∞–º–∂–∏–ª—Ç–≥“Ø–π. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"CANCELLED\" });\r\n      setMsg(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ —Ü—É—Ü–∞–ª–ª–∞–∞.\");\r\n      setTimeout(() => router.push(\"/seller?tab=OPEN\"), 450);\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–¶—É—Ü–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setCancelLoading(false);\r\n    }\r\n  }\r\n\r\n  async function saveEdit() {\r\n    if (!delivery || !user) return;\r\n    if (!canEditOrCancel) return;\r\n    if (editSaving) return;\r\n\r\n    const from = editFrom.trim();\r\n    const to = editTo.trim();\r\n    const note = editNote.trim();\r\n    const priceNum = editPrice.trim() ? Number(editPrice.trim()) : null;\r\n\r\n    if (editPrice.trim() && (!Number.isFinite(priceNum as any) || Number(priceNum) < 0)) {\r\n      setError(\"“Æ–Ω—ç –±—É—Ä—É—É –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n    if (!from || !to) {\r\n      setError(\"–ê–≤–∞—Ö/–•“Ø—Ä–≥—ç—Ö —Ö–∞—è–≥–∞–∞ –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\r\n      return;\r\n    }\r\n\r\n    setEditSaving(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          from_address: from,\r\n          to_address: to,\r\n          note: note || null,\r\n          price_mnt: priceNum,\r\n        })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id)\r\n        .eq(\"status\", \"OPEN\")\r\n        .select(\"id,from_address,to_address,note,price_mnt\")\r\n        .maybeSingle();\r\n\r\n      if (e1) throw e1;\r\n\r\n      if (data) {\r\n        setDelivery({\r\n          ...delivery,\r\n          from_address: (data as any).from_address ?? from,\r\n          to_address: (data as any).to_address ?? to,\r\n          note: (data as any).note ?? null,\r\n          price_mnt: (data as any).price_mnt ?? priceNum,\r\n        });\r\n      }\r\n\r\n      setEditOpen(false);\r\n      setMsg(\"–®–∏–Ω—ç—á–ª—ç–≥–¥–ª—ç—ç.\");\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–®–∏–Ω—ç—á–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setEditSaving(false);\r\n    }\r\n  }\r\n\r\n  // ‚úÖ –ù–∞–π–¥–≤–∞—Ä–≥“Ø–π –∂–æ–ª–æ–æ—á (Seller side)\r\n  async function markDriverUnreliable() {\r\n    if (!delivery || !user) return;\r\n    if (unreliableLoading) return;\r\n    if (delivery.status !== \"ON_ROUTE\") return;\r\n    if (!delivery.chosen_driver_id) return;\r\n\r\n    const ok = window.confirm(\r\n      \"–ñ–æ–ª–æ–æ—á–∏–π–≥ '–ù–∞–π–¥–≤–∞—Ä–≥“Ø–π' –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Ö “Ø“Ø?\\n\\n\" +\r\n        \"- –≠–Ω—ç –∂–æ–ª–æ–æ—á–∏–¥ –¥–∞—Ö–∏–∂ —Ç–∞–Ω—ã —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥ —Ö–∞—Ä–∞–≥–¥–∞—Ö–≥“Ø–π.\\n\" +\r\n        \"- –≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –¥–∞—Ö–∏–Ω –ù–≠–≠–õ–¢–¢–≠–ô –±–æ–ª–∂, —Ç–∞ —à–∏–Ω—ç –∂–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ–Ω–æ.\"\r\n    );\r\n    if (!ok) return;\r\n\r\n    setUnreliableLoading(true);\r\n    setError(null);\r\n    setMsg(null);\r\n\r\n    try {\r\n      // 1) block driver for this seller\r\n      await supabase.from(\"seller_blocked_drivers\").insert({\r\n        seller_id: user.id,\r\n        driver_id: delivery.chosen_driver_id,\r\n      });\r\n\r\n      // 2) reopen delivery (remove chosen driver)\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          status: \"OPEN\",\r\n          chosen_driver_id: null,\r\n          // on_route_at: null, // (–±–∞–π—Ö–≥“Ø–π –±–∞–π–∂ –º–∞–≥–∞–¥–≥“Ø–π —Ç—É–ª update —Ö–∏–π—Ö–≥“Ø–π)\r\n        })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id)\r\n        .eq(\"status\", \"ON_ROUTE\")\r\n        .select(\"id,status,chosen_driver_id\")\r\n        .maybeSingle();\r\n\r\n      if (e1) throw e1;\r\n\r\n      setMsg(\"–ù–∞–π–¥–≤–∞—Ä–≥“Ø–π –∂–æ–ª–æ–æ—á–æ–æ—Ä —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç. –•“Ø—Ä–≥—ç–ª—Ç –¥–∞—Ö–∏–Ω –Ω—ç—ç–ª—Ç—Ç—ç–π –±–æ–ª–ª–æ–æ.\");\r\n      setTimeout(() => router.push(\"/seller?tab=OPEN\"), 450);\r\n    } catch (e: any) {\r\n      console.error(e);\r\n      setError(\"–ù–∞–π–¥–≤–∞—Ä–≥“Ø–π –∂–æ–ª–æ–æ—á —Ç—ç–º–¥—ç–≥–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setUnreliableLoading(false);\r\n    }\r\n  }\r\n\r\n  function buildShareText(d: DeliveryDetail) {\r\n    const from = d.from_address || \"‚Äî\";\r\n    const to = d.to_address || \"‚Äî\";\r\n    const price = fmtPrice(d.price_mnt);\r\n    const what = d.note ? d.note.trim() : \"\";\r\n    return (\r\n      `üöö –•“Ø—Ä–≥—ç–ª—Ç —Ö—ç—Ä—ç–≥—Ç—ç–π –±–∞–π–Ω–∞\\n` +\r\n      `üìç ${from} ‚Üí ${to}\\n` +\r\n      `üí∞ ${price}\\n` +\r\n      (what ? `üì¶ ${what}\\n` : \"\") +\r\n      `#INCOME`\r\n    );\r\n  }\r\n\r\n  async function shareFacebookOnly() {\r\n    if (!delivery) return;\r\n\r\n    const text = buildShareText(delivery);\r\n\r\n    const ok = await copyText(text);\r\n    if (ok) setMsg(\"üì§ –ü–æ—Å—Ç —Ç–µ–∫—Å—Ç —Ö—É—É–ª–ª–∞–∞. Facebook –¥—ç—ç—Ä paste —Ö–∏–π–≥—ç—ç—Ä—ç–π.\");\r\n    else setError(\"Clipboard –∑”©–≤—à”©”©—Ä”©–ª–≥“Ø–π –±–∞–π–Ω–∞. (–•—É—É–ª–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π)\");\r\n\r\n    try {\r\n      const u = encodeURIComponent(\"https://income.mn\");\r\n      const quote = encodeURIComponent(text);\r\n      window.open(\r\n        `https://www.facebook.com/sharer/sharer.php?u=${u}&quote=${quote}`,\r\n        \"_blank\"\r\n      );\r\n    } catch {}\r\n  }\r\n\r\n  // ‚úÖ Payment helpers (DELIVERED –¥—ç—ç—Ä map-–∏–π–Ω –î–≠–≠–† –≥–∞—Ä–Ω–∞)\r\n  const payIban = (chosenDriver?.bank_iban || \"\").trim();\r\n  const payAccount = (chosenDriver?.bank_account || \"\").trim();\r\n  const payHolder = (chosenDriver?.bank_holder || chosenDriver?.name || \"\").trim();\r\n  const payPurpose = delivery ? `INCOME-${delivery.id}` : \"\";\r\n\r\n  async function copyField(label: string, value: string) {\r\n    if (!value) {\r\n      setError(`${label} —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.`);\r\n      return;\r\n    }\r\n    const ok = await copyText(value);\r\n    if (ok) setMsg(`${label} —Ö—É—É–ª–ª–∞–∞.`);\r\n    else setError(\"Clipboard –∑”©–≤—à”©”©—Ä”©–ª–≥“Ø–π –±–∞–π–Ω–∞. (–•—É—É–ª–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π)\");\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50\">\r\n        <div className=\"mx-auto max-w-3xl space-y-4 px-4 py-6\">\r\n          <div className=\"h-10 w-28 animate-pulse rounded-xl bg-slate-200\" />\r\n          <div className=\"h-28 animate-pulse rounded-2xl border border-slate-200 bg-white\" />\r\n          <div className=\"h-44 animate-pulse rounded-2xl border border-slate-200 bg-white\" />\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) return null;\r\n\r\n  const b = delivery ? badge(delivery.status) : null;\r\n\r\n  // ‚úÖ top route uses district/khoroo ONLY (now formatted as ‚Äú1 —Ö–æ—Ä–æ–æ‚Äù)\r\n  const topFrom = delivery ? areaLine(delivery.pickup_district, delivery.pickup_khoroo) : \"‚Äî\";\r\n  const topTo = delivery ? areaLine(delivery.dropoff_district, delivery.dropoff_khoroo) : \"‚Äî\";\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <main className=\"mx-auto max-w-3xl space-y-4 px-4 py-6\">\r\n        <div className=\"flex items-center justify-between gap-3\">\r\n          <button\r\n            onClick={goBack}\r\n            className=\"inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-800 hover:border-slate-300\"\r\n          >\r\n            ‚Üê –ë—É—Ü–∞—Ö\r\n          </button>\r\n        </div>\r\n\r\n        {error && (\r\n          <div className=\"rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700\">\r\n            {error}\r\n          </div>\r\n        )}\r\n        {msg && (\r\n          <div className=\"rounded-xl border border-emerald-200 bg-emerald-50 p-3 text-sm text-emerald-700\">\r\n            {msg}\r\n          </div>\r\n        )}\r\n\r\n        {!delivery ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-sm text-slate-600\">\r\n            –•“Ø—Ä–≥—ç–ª—Ç –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* TOP CARD */}\r\n            <div className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n              <div className=\"flex items-start justify-between gap-3\">\r\n                <div className=\"min-w-0\">\r\n                  <div className=\"flex flex-wrap items-center gap-2\">\r\n                    {/* ‚úÖ Price badge: same size as status badge, placed before it */}\r\n                    <span className=\"inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-2 py-0.5 text-xs font-extrabold tracking-tight text-emerald-700\">\r\n                      {fmtPrice(delivery.price_mnt)}\r\n                    </span>\r\n\r\n                    <span\r\n                      className={`inline-flex items-center rounded-full border px-2 py-0.5 text-xs ${\r\n                        b?.cls || \"\"\r\n                      }`}\r\n                    >\r\n                      {b?.text || delivery.status}\r\n                    </span>\r\n\r\n                    <span className=\"text-xs text-slate-500\">{fmtDT(delivery.created_at)}</span>\r\n                  </div>\r\n\r\n                  {/* ‚úÖ Only district/khoroo route */}\r\n                  <div className=\"mt-2 text-sm font-semibold leading-snug text-slate-900\">\r\n                    {topFrom} <span className=\"mx-1 text-slate-400\">‚Üí</span> {topTo}\r\n                  </div>\r\n\r\n                  {/* NOTE as a clean pill */}\r\n                  {delivery.note && (\r\n                    <div className=\"mt-3\">\r\n                      <div className=\"inline-flex w-full items-center gap-2 rounded-2xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-sm font-semibold text-emerald-900\">\r\n                        <span className=\"text-emerald-700\">üì¶</span>\r\n                        <span className=\"min-w-0 truncate\">{shorten(delivery.note, 140)}</span>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* ‚úÖ ASSIGNED/ON_ROUTE “Ø–µ–¥ ‚Äî –∑”©–≤—Ö”©–Ω —ç–Ω—ç –∞–Ω—Ö–∞–∞—Ä—É—É–ª–≥–∞ */}\r\n                  {delivery.status === \"ON_ROUTE\" && (\r\n                    <div className=\"mt-3 rounded-2xl border border-amber-200 bg-amber-50/70 px-3 py-2\">\r\n                      <div className=\"text-xs leading-relaxed text-amber-900\">\r\n                        <span className=\"font-extrabold\">–ê–Ω—Ö–∞–∞—Ä:</span> –û–¥–æ–æ —Ö—É–¥–∞–ª–¥–∞–Ω –∞–≤–∞–≥—á–∏–π–Ω{\" \"}\r\n                        <span className=\"font-semibold\">—Ö–∞—è–≥, —É—Ç–∞—Å</span> –∂–æ–ª–æ–æ—á–∏–¥ –∏–ª –±–æ–ª—Å–æ–Ω. –¢–∞ —Ö“Ø—Ä–≥—ç–ª—Ç—ç—ç{\" \"}\r\n                        <span className=\"font-semibold\">–∞–Ω—Ö–∞–∞—Ä–∞–ª—Ç–∞–π —Ö—è–Ω–∞–∞—Ä–∞–π</span>.\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* ‚úÖ DELIVERED “Ø–µ–¥ ‚Äî –≥–∞–Ω—Ü –ª –∞–Ω—Ö–∞–∞—Ä—É—É–ª–≥–∞ */}\r\n                  {delivery.status === \"DELIVERED\" && (\r\n                    <div className=\"mt-3 rounded-2xl border border-emerald-200 bg-emerald-50/70 px-3 py-2\">\r\n                      <div className=\"text-xs leading-relaxed text-emerald-900\">\r\n                        <span className=\"font-extrabold\">–ú—ç–¥—ç–≥–¥—ç–ª:</span> –ñ–æ–ª–æ–æ—á —Ç–∞–Ω—ã –±–∞—Ä–∞–∞–≥ –∞–º–∂–∏–ª—Ç—Ç–∞–π\r\n                        —Ö“Ø—Ä–≥—ç—Å—ç–Ω –±–∞–π–Ω–∞.\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* ‚úÖ INFO / WARNING ‚Äî –∑”©–≤—Ö”©–Ω OPEN –¥—ç—ç—Ä */}\r\n                  {delivery.status === \"OPEN\" && (\r\n                    <div className=\"mt-3 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2\">\r\n                      <div className=\"text-xs leading-relaxed text-slate-700\">\r\n                        <span className=\"font-semibold\">‚ÑπÔ∏è –ê–Ω—Ö–∞–∞—Ä:</span> –û–¥–æ–æ–≥–æ–æ—Ä —ç–Ω—ç —Ö—ç—Å—ç–≥—Ç{\" \"}\r\n                        <span className=\"font-semibold\">–¥“Ø“Ø—Ä—ç–≥/—Ö–æ—Ä–æ–æ</span> –ª —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞.\r\n                        <br />\r\n                        –ñ–æ–ª–æ–æ—á <span className=\"font-semibold\">—Å–æ–Ω–≥–æ–≥–¥–≤–æ–ª</span> —Ç–∞–Ω—ã (—Ö—É–¥–∞–ª–¥–∞–≥—á–∏–π–Ω){\" \"}\r\n                        <span className=\"font-semibold\">—Ö–∞—è–≥, —É—Ç–∞—Å</span> –∂–æ–ª–æ–æ—á–∏–¥ –∏–ª –±–æ–ª–Ω–æ.\r\n                        <br />\r\n                        –ñ–æ–ª–æ–æ—á <span className=\"font-semibold\">–±–∞—Ä–∞–∞–≥ –∞–≤–∞–∞–¥ ‚Äú–ó–∞–º–¥‚Äù</span> –æ—Ä—Å–æ–Ω “Ø–µ–¥{\" \"}\r\n                        <span className=\"font-semibold\">—Ö“Ø–ª—ç—ç–Ω –∞–≤–∞–≥—á–∏–π–Ω</span> (—Ö“Ø—Ä–≥—ç—Ö){\" \"}\r\n                        <span className=\"font-semibold\">–¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π —Ö–∞—è–≥, —É—Ç–∞—Å</span> –º”©–Ω –∏–ª –±–æ–ª–Ω–æ.\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {/* ACTIONS ‚Äî below (no overlap) */}\r\n              {canEditOrCancel && (\r\n                <div className=\"mt-4 flex flex-wrap gap-2\">\r\n                  <button\r\n                    onClick={() => setEditOpen((v) => !v)}\r\n                    className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300\"\r\n                  >\r\n                    {editOpen ? \"–ó–∞—Å–∞—Ö —Ö–∞–∞—Ö\" : \"–ó–∞—Å–∞—Ö\"}\r\n                  </button>\r\n\r\n                  <button\r\n                    onClick={() => void shareFacebookOnly()}\r\n                    className=\"rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700\"\r\n                    title=\"Copy + Facebook open\"\r\n                  >\r\n                    üì§ Facebook-–¥ —à—ç—Ä\r\n                  </button>\r\n\r\n                  <button\r\n                    onClick={() => void cancelDelivery()}\r\n                    disabled={cancelLoading}\r\n                    className=\"rounded-xl bg-rose-600 px-4 py-2 text-sm font-semibold text-white hover:bg-rose-700 disabled:opacity-60\"\r\n                  >\r\n                    {cancelLoading ? \"–¶—É—Ü–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–¶—É—Ü–ª–∞—Ö\"}\r\n                  </button>\r\n                </div>\r\n              )}\r\n\r\n              {/* EDIT PANEL */}\r\n              {canEditOrCancel && editOpen && (\r\n                <div className=\"mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4\">\r\n                  <div className=\"grid grid-cols-1 gap-3\">\r\n                    <div>\r\n                      <label className=\"text-xs font-semibold text-slate-700\">–ê–≤–∞—Ö —Ö–∞—è–≥</label>\r\n                      <input\r\n                        value={editFrom}\r\n                        onChange={(e) => setEditFrom(e.target.value)}\r\n                        className=\"mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400\"\r\n                      />\r\n                    </div>\r\n\r\n                    <div>\r\n                      <label className=\"text-xs font-semibold text-slate-700\">–•“Ø—Ä–≥—ç—Ö —Ö–∞—è–≥</label>\r\n                      <input\r\n                        value={editTo}\r\n                        onChange={(e) => setEditTo(e.target.value)}\r\n                        className=\"mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400\"\r\n                      />\r\n                    </div>\r\n\r\n                    <div>\r\n                      <label className=\"text-xs font-semibold text-slate-700\">–¢–∞–π–ª–±–∞—Ä</label>\r\n                      <textarea\r\n                        value={editNote}\r\n                        onChange={(e) => setEditNote(e.target.value)}\r\n                        className=\"mt-1 w-full min-h-[80px] rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400\"\r\n                      />\r\n                    </div>\r\n\r\n                    <div>\r\n                      <label className=\"text-xs font-semibold text-slate-700\">“Æ–Ω—ç (‚ÇÆ)</label>\r\n                      <input\r\n                        value={editPrice}\r\n                        onChange={(e) => setEditPrice(e.target.value.replace(/[^\\d]/g, \"\"))}\r\n                        className=\"mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400\"\r\n                        inputMode=\"numeric\"\r\n                      />\r\n                    </div>\r\n\r\n                    <div className=\"flex gap-2\">\r\n                      <button\r\n                        onClick={() => void saveEdit()}\r\n                        disabled={editSaving}\r\n                        className=\"rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60\"\r\n                      >\r\n                        {editSaving ? \"–•–∞–¥–≥–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•–∞–¥–≥–∞–ª–∞—Ö\"}\r\n                      </button>\r\n\r\n                      <button\r\n                        onClick={() => setEditOpen(false)}\r\n                        className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300\"\r\n                      >\r\n                        –ë–æ–ª–∏—Ö\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* ‚úÖ DELIVERED “Ø–µ–¥: –ñ–æ–ª–æ–æ—á–∏–π–Ω —Ç”©–ª–±”©—Ä (MAP-–∏–π–Ω –î–≠–≠–†) */}\r\n            {delivery.status === \"DELIVERED\" && (\r\n              <div className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n                <div className=\"text-sm font-semibold text-slate-900\">\r\n                  –•“Ø—Ä–≥—ç–ª—Ç —Ö–∏–π—Å—ç–Ω “Ø–Ω—ç–Ω –±–æ–ª —Ç–∞ –¥–æ–æ—Ä—Ö –¥–∞–Ω—Å —Ä—É—É –∂–æ–ª–æ–æ—á–∏–π–Ω —Ç”©–ª–±”©—Ä–∏–π–≥ —à–∏–ª–∂“Ø“Ø–ª—ç—ç—Ä—ç–π.\r\n                </div>\r\n                <div className=\"mt-1 text-xs text-slate-500\">\r\n                  –ì“Ø–π–ª–≥—ç—ç–Ω–∏–π —É—Ç–≥–∞ –¥—ç—ç—Ä <span className=\"font-semibold\">INCOME-{delivery.id}</span> –≥—ç–∂ –±–∏—á–≤—ç–ª\r\n                  –∞–º–∞—Ä.\r\n                </div>\r\n\r\n                <div className=\"mt-3 rounded-2xl border border-slate-200 bg-slate-50 p-3\">\r\n                  <div className=\"grid gap-2\">\r\n                    <div className=\"flex items-center justify-between gap-2\">\r\n                      <div className=\"min-w-0\">\r\n                        <div className=\"text-[11px] font-semibold text-slate-600\">IBAN</div>\r\n                        <div className=\"truncate text-sm font-extrabold text-slate-900\">\r\n                          {payIban || \"‚Äî\"}\r\n                        </div>\r\n                      </div>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => void copyField(\"IBAN\", payIban)}\r\n                        className=\"shrink-0 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300 disabled:opacity-60\"\r\n                        disabled={!payIban}\r\n                        title=\"–•—É—É–ª–∞—Ö\"\r\n                      >\r\n                        üíæ\r\n                      </button>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center justify-between gap-2\">\r\n                      <div className=\"min-w-0\">\r\n                        <div className=\"text-[11px] font-semibold text-slate-600\">–î–∞–Ω—Å</div>\r\n                        <div className=\"truncate text-sm font-extrabold text-slate-900\">\r\n                          {payAccount || \"‚Äî\"}\r\n                        </div>\r\n                      </div>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => void copyField(\"–î–∞–Ω—Å\", payAccount)}\r\n                        className=\"shrink-0 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300 disabled:opacity-60\"\r\n                        disabled={!payAccount}\r\n                        title=\"–•—É—É–ª–∞—Ö\"\r\n                      >\r\n                        üíæ\r\n                      </button>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center justify-between gap-2\">\r\n                      <div className=\"min-w-0\">\r\n                        <div className=\"text-[11px] font-semibold text-slate-600\">–£—Ç–≥–∞</div>\r\n                        <div className=\"truncate text-sm font-extrabold text-slate-900\">\r\n                          {payPurpose}\r\n                        </div>\r\n                      </div>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => void copyField(\"–£—Ç–≥–∞\", payPurpose)}\r\n                        className=\"shrink-0 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300 disabled:opacity-60\"\r\n                        title=\"–•—É—É–ª–∞—Ö\"\r\n                      >\r\n                        üíæ\r\n                      </button>\r\n                    </div>\r\n\r\n                    <div className=\"pt-1 text-xs text-slate-600\">\r\n                      <span className=\"font-semibold\">–•“Ø–ª—ç—ç–Ω –∞–≤–∞–≥—á:</span> {payHolder || \"‚Äî\"}\r\n                    </div>\r\n\r\n                    {!payIban && !payAccount && (\r\n                      <div className=\"pt-1 text-xs text-amber-700\">\r\n                        –ñ–æ–ª–æ–æ—á –¥–∞–Ω—Å–Ω—ã –º—ç–¥—ç—ç–ª–ª—ç—ç –æ—Ä—É—É–ª–∞–∞–≥“Ø–π –±–∞–π–Ω–∞. (–î–∞–Ω—Å/IBAN –±–∞–π—Ö–≥“Ø–π)\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* MAP */}\r\n            <div className=\"overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm\">\r\n              <div className=\"border-b border-slate-200 px-4 py-3\">\r\n                <div className=\"text-sm font-semibold text-slate-900\">–ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥</div>\r\n                <div className=\"mt-0.5 text-xs text-slate-500\">–ê–≤–∞—Ö (—Ü—ç–Ω—Ö—ç—Ä) ¬∑ –•“Ø—Ä–≥—ç—Ö (–Ω–æ–≥–æ–æ–Ω)</div>\r\n              </div>\r\n              <DeliveryRouteMap pickup={pickup} dropoff={dropoff} />\r\n            </div>\r\n\r\n            {/* CHOSEN DRIVER */}\r\n            {delivery.chosen_driver_id && (\r\n              <div className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n                <div className=\"text-sm font-semibold text-slate-900\">–°–æ–Ω–≥–æ—Å–æ–Ω –∂–æ–ª–æ–æ—á</div>\r\n\r\n                <div className=\"mt-3 flex items-center gap-3\">\r\n                  <div className=\"h-10 w-10 shrink-0 overflow-hidden rounded-full bg-slate-100\">\r\n                    {chosenDriver?.avatar_url ? (\r\n                      // eslint-disable-next-line @next/next/no-img-element\r\n                      <img\r\n                        src={chosenDriver.avatar_url}\r\n                        alt=\"\"\r\n                        className=\"h-full w-full object-cover\"\r\n                      />\r\n                    ) : (\r\n                      <div className=\"flex h-full w-full items-center justify-center text-xs text-slate-500\">\r\n                        ‚Äî\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  <div className=\"min-w-0\">\r\n                    <div className=\"text-sm font-semibold text-slate-900\">\r\n                      {chosenDriver?.name || \"–ñ–æ–ª–æ–æ—á\"}\r\n                    </div>\r\n                    <div className=\"text-xs text-slate-600\">{chosenDriver?.phone || \"‚Äî\"}</div>\r\n                  </div>\r\n\r\n                  <div className=\"ml-auto flex flex-wrap gap-2\">\r\n                    {chosenDriver?.phone && (\r\n                      <a\r\n                        href={`tel:${chosenDriver.phone}`}\r\n                        className=\"rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800\"\r\n                      >\r\n                        –ó–∞–ª–≥–∞—Ö\r\n                      </a>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n\r\n                {/* ‚úÖ ON_ROUTE “Ø–µ–¥: –∂–æ–ª–æ–æ—á–∏–π–Ω –¥–æ–æ—Ä –Ω–∞–π–¥–≤–∞—Ä–≥“Ø–π —Ç–æ–≤—á + –∞–Ω—Ö–∞–∞—Ä—É—É–ª–≥–∞ */}\r\n                {delivery.status === \"ON_ROUTE\" && (\r\n                  <div className=\"mt-3 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2\">\r\n                    <div className=\"text-xs leading-relaxed text-slate-700\">\r\n                      –ñ–æ–ª–æ–æ—á <span className=\"font-semibold\">—Ö—ç—Ç —É–¥—Å–∞–Ω</span>, –±–∞—Ä–∞–∞–≥{\" \"}\r\n                      <span className=\"font-semibold\">—Ö“Ø—Ä–≥—ç—ç–≥“Ø–π</span> —ç—Å–≤—ç–ª —Ö–æ–ª–±–æ–≥–¥–æ—Ö–≥“Ø–π –±–æ–ª —Ç–∞ —ç–Ω—ç\r\n                      —Ç–æ–≤—á–∏–π–≥ –∞—à–∏–≥–ª–∞–∂ –±–æ–ª–Ω–æ. –ò–Ω–≥—ç—Å–Ω—ç—ç—Ä{\" \"}\r\n                      <span className=\"font-semibold\">\r\n                        —ç–Ω—ç –∂–æ–ª–æ–æ—á–∏–¥ –¥–∞—Ö–∏–∂ —Ç–∞–Ω—ã —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥ —Ö–∞—Ä–∞–≥–¥–∞—Ö–≥“Ø–π\r\n                      </span>\r\n                      .\r\n                    </div>\r\n\r\n                    <div className=\"mt-2\">\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => void markDriverUnreliable()}\r\n                        disabled={unreliableLoading}\r\n                        className={[\r\n                          \"rounded-xl px-4 py-2 text-sm font-semibold\",\r\n                          \"border border-slate-200 bg-white\",\r\n                          \"text-rose-700 hover:bg-rose-50 hover:border-rose-200\",\r\n                          \"disabled:opacity-60\",\r\n                        ].join(\" \")}\r\n                        title=\"–ñ–æ–ª–æ–æ—á –∞–ª–≥–∞ –±–æ–ª—Å–æ–Ω/—Ö—ç—Ç —É–¥–∞–∞—à–∏—Ä—Å–∞–Ω “Ø–µ–¥\"\r\n                      >\r\n                        {unreliableLoading ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ù–∞–π–¥–≤–∞—Ä–≥“Ø–π –∂–æ–ª–æ–æ—á\"}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            )}\r\n\r\n            {/* BIDS (OPEN only) */}\r\n            {delivery.status === \"OPEN\" && (\r\n              <div className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n                <div className=\"flex items-center justify-between gap-2\">\r\n                  <div className=\"text-sm font-semibold text-slate-900\">–ñ–æ–ª–æ–æ—á–∏–π–Ω —Ö“Ø—Å—ç–ª—Ç“Ø“Ø–¥</div>\r\n                  <div className=\"text-xs text-slate-500\">\r\n                    {loadingBids ? \"–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : `${bids.length} —Ö“Ø—Å—ç–ª—Ç`}\r\n                  </div>\r\n                </div>\r\n\r\n                {loadingBids ? (\r\n                  <div className=\"mt-3 text-sm text-slate-600\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n                ) : bids.length === 0 ? (\r\n                  <div className=\"mt-3 text-sm text-slate-600\">–û–¥–æ–æ–≥–æ–æ—Ä —Ö“Ø—Å—ç–ª—Ç –∏—Ä—ç—ç–≥“Ø–π –±–∞–π–Ω–∞.</div>\r\n                ) : (\r\n                  <div className=\"mt-3 space-y-2\">\r\n                    {bids.map((bid) => (\r\n                      <div key={bid.id} className=\"rounded-2xl border border-slate-200 p-3\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                          <div className=\"min-w-0\">\r\n                            <div className=\"text-sm font-semibold text-slate-900\">\r\n                              {bid.driver?.name || \"–ñ–æ–ª–æ–æ—á\"}\r\n                            </div>\r\n                            <div className=\"text-xs text-slate-600\">{bid.driver?.phone || \"‚Äî\"}</div>\r\n                          </div>\r\n\r\n                          <div className=\"ml-auto flex items-center gap-2\">\r\n                            {bid.driver?.phone && (\r\n                              <a\r\n                                href={`tel:${bid.driver.phone}`}\r\n                                className=\"rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300\"\r\n                              >\r\n                                –ó–∞–ª–≥–∞—Ö\r\n                              </a>\r\n                            )}\r\n\r\n                            <button\r\n                              onClick={() => void chooseDriver(bid.driver_id)}\r\n                              disabled={!!chooseLoading}\r\n                              className=\"rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                            >\r\n                              {chooseLoading === bid.driver_id ? \"–°–æ–Ω–≥–æ–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–°–æ–Ω–≥–æ—Ö\"}\r\n                            </button>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            )}\r\n          </>\r\n        )}\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/seller/new-delivery/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport \"leaflet/dist/leaflet.css\";\r\n\r\nimport dynamic from \"next/dynamic\";\r\nimport L from \"leaflet\";\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { getDistrictOptions, getKhorooOptions } from \"@/lib/ub_admin\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype LatLng = { lat: number; lng: number };\r\n\r\nfunction numOrNull(v: number | null | undefined) {\r\n  if (typeof v !== \"number\" || Number.isNaN(v)) return null;\r\n  return v;\r\n}\r\n\r\nfunction isValidLatLng(p: LatLng | null) {\r\n  if (!p) return false;\r\n  return (\r\n    typeof p.lat === \"number\" &&\r\n    typeof p.lng === \"number\" &&\r\n    !Number.isNaN(p.lat) &&\r\n    !Number.isNaN(p.lng) &&\r\n    Math.abs(p.lat) <= 90 &&\r\n    Math.abs(p.lng) <= 180\r\n  );\r\n}\r\n\r\n/**\r\n * ‚úÖ –î“Ø“Ø—Ä–≥—ç—ç—Ä fallback —Ö–∏–π—Ö centroid —Ü—ç–≥“Ø“Ø–¥\r\n */\r\nconst UB_DISTRICT_CENTROIDS: Record<string, LatLng> = {\r\n  –ë–∞–≥–∞–Ω—É—É—Ä: { lat: 47.78, lng: 108.37 },\r\n  –ë–∞–≥–∞—Ö–∞–Ω–≥–∞–π: { lat: 47.45, lng: 107.25 },\r\n  –ë–∞—è–Ω–≥–æ–ª: { lat: 47.92, lng: 106.86 },\r\n  –ë–∞—è–Ω–∑“Ø—Ä—Ö: { lat: 47.94, lng: 106.98 },\r\n  –°“Ø—Ö–±–∞–∞—Ç–∞—Ä: { lat: 47.92, lng: 106.92 },\r\n  –°–æ–Ω–≥–∏–Ω–æ—Ö–∞–π—Ä—Ö–∞–Ω: { lat: 47.93, lng: 106.8 },\r\n  \"–•–∞–Ω-–£—É–ª\": { lat: 47.88, lng: 106.92 },\r\n  –ß–∏–Ω–≥—ç–ª—Ç—ç–π: { lat: 47.93, lng: 106.92 },\r\n  –ù–∞–ª–∞–π—Ö: { lat: 47.77, lng: 107.5 },\r\n};\r\n\r\nasync function geocodeOne(query: string): Promise<LatLng | null> {\r\n  const q = String(query || \"\").trim();\r\n  if (!q) return null;\r\n\r\n  const url =\r\n    \"https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=0&q=\" +\r\n    encodeURIComponent(q);\r\n\r\n  const res = await fetch(url, { headers: { Accept: \"application/json\" } });\r\n  if (!res.ok) return null;\r\n\r\n  const data = (await res.json()) as any[];\r\n  if (!data || !data.length) return null;\r\n\r\n  const lat = Number(data[0].lat);\r\n  const lng = Number(data[0].lon);\r\n  if (Number.isNaN(lat) || Number.isNaN(lng)) return null;\r\n\r\n  return { lat, lng };\r\n}\r\n\r\nasync function geocodeTryMany(queries: string[]) {\r\n  for (const q of queries) {\r\n    const hit = await geocodeOne(q);\r\n    if (hit) return hit;\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction normalizeKhorooLabel(k: string) {\r\n  const s = String(k || \"\").trim();\r\n  if (!s) return \"\";\r\n  if (/^\\d+$/.test(s)) return `${s}-—Ä —Ö–æ—Ä–æ–æ`;\r\n  if (s.includes(\"—Ö–æ—Ä–æ–æ\")) return s;\r\n  return `${s}-—Ä —Ö–æ—Ä–æ–æ`;\r\n}\r\n\r\n/**\r\n * ‚úÖ –Ø–≥ –∞–ø–ø —à–∏–≥ icon-—É—É–¥\r\n * - –ê–í–ê–•: üì¶ (LOCK “Ø–µ–¥ –Ω–æ–≥–æ–æ–Ω, EDIT “Ø–µ–¥ —É–ª–∞–∞–Ω)\r\n * - –•“Æ–†–ì–≠–•: üëã\r\n */\r\nfunction mapEmojiIcon(kind: \"pickupLocked\" | \"pickupEdit\" | \"dropoff\") {\r\n  const html =\r\n    kind === \"dropoff\"\r\n      ? `<div style=\"\r\n          width:34px;height:34px;border-radius:12px;\r\n          background:#111827;color:#fff;\r\n          display:flex;align-items:center;justify-content:center;\r\n          font-size:18px;\r\n          border:2px solid rgba(255,255,255,.75);\r\n          box-shadow:0 6px 18px rgba(0,0,0,.22);\r\n        \">üëã</div>`\r\n      : kind === \"pickupEdit\"\r\n      ? `<div style=\"\r\n          width:34px;height:34px;border-radius:12px;\r\n          background:#ef4444;color:#fff;\r\n          display:flex;align-items:center;justify-content:center;\r\n          font-size:18px;\r\n          border:2px solid rgba(255,255,255,.75);\r\n          box-shadow:0 6px 18px rgba(0,0,0,.22);\r\n        \">üì¶</div>`\r\n      : `<div style=\"\r\n          width:34px;height:34px;border-radius:12px;\r\n          background:#10b981;color:#052e1b;\r\n          display:flex;align-items:center;justify-content:center;\r\n          font-size:18px;\r\n          border:2px solid rgba(255,255,255,.75);\r\n          box-shadow:0 6px 18px rgba(0,0,0,.22);\r\n        \">üì¶</div>`;\r\n\r\n  return L.divIcon({\r\n    className: \"\",\r\n    html,\r\n    iconSize: [34, 34],\r\n    iconAnchor: [17, 17],\r\n  });\r\n}\r\n\r\nconst LeafletMap = dynamic(\r\n  async () => {\r\n    const RL = await import(\"react-leaflet\");\r\n    const { MapContainer, TileLayer, Marker, Polyline } = RL;\r\n\r\n    type Props = {\r\n      center: LatLng;\r\n      pickup: LatLng | null;\r\n      dropoff: LatLng | null;\r\n      pickupLocked: boolean;\r\n      onPickupChange: (p: LatLng) => void;\r\n      onDropoffChange: (p: LatLng) => void;\r\n    };\r\n\r\n    function Inner({\r\n      center,\r\n      pickup,\r\n      dropoff,\r\n      pickupLocked,\r\n      onPickupChange,\r\n      onDropoffChange,\r\n    }: Props) {\r\n      const mapRef = useRef<L.Map | null>(null);\r\n\r\n      const polyline = useMemo(() => {\r\n        if (!isValidLatLng(pickup) || !isValidLatLng(dropoff)) return null;\r\n        return [\r\n          [pickup!.lat, pickup!.lng],\r\n          [dropoff!.lat, dropoff!.lng],\r\n        ] as [number, number][];\r\n      }, [pickup, dropoff]);\r\n\r\n      useEffect(() => {\r\n        if (!mapRef.current) return;\r\n        if (!isValidLatLng(pickup) || !isValidLatLng(dropoff)) return;\r\n\r\n        const bounds = L.latLngBounds(\r\n          [pickup!.lat, pickup!.lng],\r\n          [dropoff!.lat, dropoff!.lng]\r\n        );\r\n        mapRef.current.fitBounds(bounds.pad(0.25), { animate: true });\r\n      }, [pickup, dropoff]);\r\n\r\n      return (\r\n        <MapContainer\r\n          ref={(map) => {\r\n            mapRef.current = (map as unknown as L.Map) || null;\r\n          }}\r\n          center={[center.lat, center.lng]}\r\n          zoom={12}\r\n          scrollWheelZoom\r\n          style={{ height: \"100%\", width: \"100%\" }}\r\n        >\r\n          <TileLayer\r\n            attribution=\"&copy; OpenStreetMap contributors &copy; CARTO\"\r\n            url=\"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png\"\r\n          />\r\n\r\n          {isValidLatLng(pickup) && (\r\n            <Marker\r\n              position={[pickup!.lat, pickup!.lng]}\r\n              draggable={!pickupLocked}\r\n              icon={mapEmojiIcon(pickupLocked ? \"pickupLocked\" : \"pickupEdit\")}\r\n              eventHandlers={{\r\n                dragend: (e: any) => {\r\n                  const ll = e.target.getLatLng();\r\n                  onPickupChange({ lat: ll.lat, lng: ll.lng });\r\n                },\r\n              }}\r\n            />\r\n          )}\r\n\r\n          {isValidLatLng(dropoff) && (\r\n            <Marker\r\n              position={[dropoff!.lat, dropoff!.lng]}\r\n              draggable\r\n              icon={mapEmojiIcon(\"dropoff\")}\r\n              eventHandlers={{\r\n                dragend: (e: any) => {\r\n                  const ll = e.target.getLatLng();\r\n                  onDropoffChange({ lat: ll.lat, lng: ll.lng });\r\n                },\r\n              }}\r\n            />\r\n          )}\r\n\r\n          {polyline && (\r\n            <Polyline\r\n              positions={polyline}\r\n              pathOptions={{\r\n                color: \"#111827\",\r\n                weight: 6,\r\n                opacity: 0.85,\r\n                dashArray: \"10 12\",\r\n                lineCap: \"round\",\r\n                lineJoin: \"round\",\r\n              }}\r\n            />\r\n          )}\r\n        </MapContainer>\r\n      );\r\n    }\r\n\r\n    return Inner;\r\n  },\r\n  { ssr: false }\r\n);\r\n\r\nfunction SoftInput(props: React.InputHTMLAttributes<HTMLInputElement>) {\r\n  return (\r\n    <input\r\n      {...props}\r\n      className={[\r\n        \"w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm\",\r\n        \"placeholder:text-slate-400\",\r\n        \"focus:outline-none focus:ring-2 focus:ring-emerald-200/70 focus:border-emerald-300\",\r\n        props.className || \"\",\r\n      ].join(\" \")}\r\n    />\r\n  );\r\n}\r\n\r\nfunction SoftTextArea(\r\n  props: React.TextareaHTMLAttributes<HTMLTextAreaElement>\r\n) {\r\n  return (\r\n    <textarea\r\n      {...props}\r\n      className={[\r\n        \"w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm\",\r\n        \"placeholder:text-slate-400\",\r\n        \"focus:outline-none focus:ring-2 focus:ring-emerald-200/70 focus:border-emerald-300\",\r\n        props.className || \"\",\r\n      ].join(\" \")}\r\n    />\r\n  );\r\n}\r\n\r\nfunction SoftSelect(props: React.SelectHTMLAttributes<HTMLSelectElement>) {\r\n  return (\r\n    <select\r\n      {...props}\r\n      className={[\r\n        \"w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm\",\r\n        \"focus:outline-none focus:ring-2 focus:ring-emerald-200/70 focus:border-emerald-300\",\r\n        \"disabled:opacity-60\",\r\n        props.className || \"\",\r\n      ].join(\" \")}\r\n    />\r\n  );\r\n}\r\n\r\nexport default function NewDeliveryPage() {\r\n  const router = useRouter();\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n\r\n  // ‚úÖ –ê–í–ê–•\r\n  const [pickupDistrict, setPickupDistrict] = useState(\"\");\r\n  const [pickupKhoroo, setPickupKhoroo] = useState(\"\");\r\n  const [pickupPhone, setPickupPhone] = useState(\"\");\r\n  const [fromAddress, setFromAddress] = useState(\"\");\r\n  const [pickupLocked, setPickupLocked] = useState(true);\r\n\r\n  // ‚úÖ –•“Æ–†–ì–≠–•\r\n  const [dropoffDistrict, setDropoffDistrict] = useState(\"\");\r\n  const [dropoffKhoroo, setDropoffKhoroo] = useState(\"\");\r\n  const [dropoffPhone, setDropoffPhone] = useState(\"\");\r\n  const [toAddress, setToAddress] = useState(\"\");\r\n\r\n  // ‚úÖ –ï—Ä”©–Ω—Ö–∏–π\r\n  const [deliveryType, setDeliveryType] = useState(\"apartment\");\r\n  const [note, setNote] = useState(\"\");\r\n  const [price, setPrice] = useState(\"\");\r\n\r\n  // Map\r\n  const [pickup, setPickup] = useState<LatLng | null>(null);\r\n  const [dropoff, setDropoff] = useState<LatLng | null>(null);\r\n\r\n  const [geoLoadingFrom, setGeoLoadingFrom] = useState(false);\r\n  const [geoLoadingTo, setGeoLoadingTo] = useState(false);\r\n\r\n  const [loadingUser, setLoadingUser] = useState(true);\r\n  const [sending, setSending] = useState(false);\r\n\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [success, setSuccess] = useState(false);\r\n\r\n  const ubCenter: LatLng = useMemo(() => ({ lat: 47.9186, lng: 106.917 }), []);\r\n\r\n  const districtOptions = useMemo(() => getDistrictOptions(), []);\r\n  const pickupKhorooOptions = useMemo(\r\n    () => getKhorooOptions(pickupDistrict),\r\n    [pickupDistrict]\r\n  );\r\n  const dropoffKhorooOptions = useMemo(\r\n    () => getKhorooOptions(dropoffDistrict),\r\n    [dropoffDistrict]\r\n  );\r\n\r\n  const readyForSubmit = Boolean(\r\n    pickupDistrict &&\r\n      pickupKhoroo &&\r\n      dropoffDistrict &&\r\n      dropoffKhoroo &&\r\n      pickupPhone.trim() &&\r\n      dropoffPhone.trim() &&\r\n      price.trim() &&\r\n      !isNaN(Number(price))\r\n  );\r\n\r\n  function buildPickupQueries() {\r\n    const kh = normalizeKhorooLabel(pickupKhoroo);\r\n    const extra = fromAddress.trim();\r\n\r\n    const baseMn = `${pickupDistrict} –¥“Ø“Ø—Ä—ç–≥, ${kh}, –£–ª–∞–∞–Ω–±–∞–∞—Ç–∞—Ä, –ú–æ–Ω–≥–æ–ª`;\r\n    const baseEn = `Ulaanbaatar, ${pickupDistrict} district, ${kh}, Mongolia`;\r\n\r\n    const q1 = extra ? `${baseMn}, ${extra}` : baseMn;\r\n    const q2 = extra ? `${baseEn}, ${extra}` : baseEn;\r\n\r\n    const q3 = `${pickupDistrict} –¥“Ø“Ø—Ä—ç–≥, –£–ª–∞–∞–Ω–±–∞–∞—Ç–∞—Ä, –ú–æ–Ω–≥–æ–ª`;\r\n    const q4 = `Ulaanbaatar, ${pickupDistrict} district, Mongolia`;\r\n\r\n    return [q1, q2, q3, q4];\r\n  }\r\n\r\n  function buildDropoffQueries() {\r\n    const kh = normalizeKhorooLabel(dropoffKhoroo);\r\n    const extra = toAddress.trim();\r\n\r\n    const baseMn = `${dropoffDistrict} –¥“Ø“Ø—Ä—ç–≥, ${kh}, –£–ª–∞–∞–Ω–±–∞–∞—Ç–∞—Ä, –ú–æ–Ω–≥–æ–ª`;\r\n    const baseEn = `Ulaanbaatar, ${dropoffDistrict} district, ${kh}, Mongolia`;\r\n\r\n    const q1 = extra ? `${baseMn}, ${extra}` : baseMn;\r\n    const q2 = extra ? `${baseEn}, ${extra}` : baseEn;\r\n\r\n    const q3 = `${dropoffDistrict} –¥“Ø“Ø—Ä—ç–≥, –£–ª–∞–∞–Ω–±–∞–∞—Ç–∞—Ä, –ú–æ–Ω–≥–æ–ª`;\r\n    const q4 = `Ulaanbaatar, ${dropoffDistrict} district, Mongolia`;\r\n\r\n    return [q1, q2, q3, q4];\r\n  }\r\n\r\n  // ‚úÖ LOCK/EDIT —Ç–æ–≤—á:\r\n  // - LOCK –¥—ç—ç—Ä ‚Äú–ó–∞—Å–∞—Ö‚Äù\r\n  // - EDIT –¥—ç—ç—Ä ‚Äú–•–∞–¥–≥–∞–ª–∞—Ö‚Äù\r\n  function togglePickupEdit() {\r\n    setPickupLocked((locked) => {\r\n      const nextLocked = !locked;\r\n\r\n      // –•–∞–¥–≥–∞–ª–∞—Ö (edit -> lock) “Ø–µ–¥: pickup –±–∞–π—Ö–≥“Ø–π –±–æ–ª centroid —Ç–∞–≤–∏–Ω–∞\r\n      if (nextLocked) {\r\n        let p = pickup;\r\n\r\n        if (!isValidLatLng(p)) {\r\n          const fb = UB_DISTRICT_CENTROIDS[pickupDistrict];\r\n          if (fb) {\r\n            p = fb;\r\n            setPickup(fb);\r\n          }\r\n        }\r\n\r\n        if (isValidLatLng(p)) {\r\n          window.localStorage.setItem(\"incomeLastPickupLat\", String(p!.lat));\r\n          window.localStorage.setItem(\"incomeLastPickupLng\", String(p!.lng));\r\n        }\r\n      }\r\n\r\n      return nextLocked;\r\n    });\r\n  }\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) {\r\n        router.replace(\"/\");\r\n        return;\r\n      }\r\n\r\n      const parsed: IncomeUser = JSON.parse(raw);\r\n\r\n      if (parsed.role !== \"seller\") {\r\n        router.replace(\"/driver\");\r\n        return;\r\n      }\r\n\r\n      setUser(parsed);\r\n\r\n      const sPD = window.localStorage.getItem(\"incomeLastPickupDistrict\");\r\n      const sPK = window.localStorage.getItem(\"incomeLastPickupKhoroo\");\r\n      const sFrom = window.localStorage.getItem(\"incomeLastFromAddress\");\r\n      const sPickPhone = window.localStorage.getItem(\"incomeLastPickupPhone\");\r\n\r\n      if (sPD) setPickupDistrict(sPD);\r\n      if (sPK) setPickupKhoroo(sPK);\r\n      if (sFrom) setFromAddress(sFrom);\r\n      if (sPickPhone) setPickupPhone(sPickPhone);\r\n\r\n      const sLat = window.localStorage.getItem(\"incomeLastPickupLat\");\r\n      const sLng = window.localStorage.getItem(\"incomeLastPickupLng\");\r\n      if (sLat && sLng) {\r\n        const lat = Number(sLat);\r\n        const lng = Number(sLng);\r\n        if (!Number.isNaN(lat) && !Number.isNaN(lng)) setPickup({ lat, lng });\r\n      }\r\n\r\n      setLoadingUser(false);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —É–Ω—à–∏—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      setLoadingUser(false);\r\n    }\r\n  }, [router]);\r\n\r\n  // ‚úÖ Pickup –∑–∞—Å–∞–∂ –±—É–π “Ø–µ–¥ –¥“Ø“Ø—Ä—ç–≥ —Å–æ–ª–∏–≥–¥–≤–æ–ª —Ö–æ—Ä–æ–æ/—Ü—ç–≥–∏–π–≥ —Ü—ç–≤—ç—Ä–ª—ç–Ω—ç\r\n  useEffect(() => {\r\n    if (pickupLocked) return;\r\n    setPickupKhoroo(\"\");\r\n    setPickup(null);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [pickupDistrict, pickupLocked]);\r\n\r\n  useEffect(() => {\r\n    setDropoffKhoroo(\"\");\r\n    setDropoff(null);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [dropoffDistrict]);\r\n\r\n  // ‚úÖ –ê–≤—Ç–æ–º–∞—Ç geocode (pickup –∑”©–≤—Ö”©–Ω EDIT “Ø–µ–¥)\r\n  useEffect(() => {\r\n    let canceled = false;\r\n    const run = async () => {\r\n      if (!pickupDistrict || !pickupKhoroo) return;\r\n      if (pickupLocked) return;\r\n\r\n      const p = await geocodeTryMany(buildPickupQueries());\r\n\r\n      if (!canceled && p) setPickup(p);\r\n      if (!canceled && !p) {\r\n        const fb = UB_DISTRICT_CENTROIDS[pickupDistrict];\r\n        if (fb) setPickup(fb);\r\n      }\r\n    };\r\n    run();\r\n    return () => {\r\n      canceled = true;\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [pickupDistrict, pickupKhoroo, pickupLocked]);\r\n\r\n  useEffect(() => {\r\n    let canceled = false;\r\n    const run = async () => {\r\n      if (!dropoffDistrict || !dropoffKhoroo) return;\r\n\r\n      const p = await geocodeTryMany(buildDropoffQueries());\r\n\r\n      if (!canceled && p) setDropoff(p);\r\n      if (!canceled && !p) {\r\n        const fb = UB_DISTRICT_CENTROIDS[dropoffDistrict];\r\n        if (fb) setDropoff(fb);\r\n      }\r\n    };\r\n    run();\r\n    return () => {\r\n      canceled = true;\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [dropoffDistrict, dropoffKhoroo]);\r\n\r\n  async function handleGeocodeFrom() {\r\n    setError(null);\r\n\r\n    if (!pickupDistrict || !pickupKhoroo) {\r\n      return setError(\"–ê–í–ê–• –¥“Ø“Ø—Ä—ç–≥/—Ö–æ—Ä–æ–æ —Å–æ–Ω–≥–æ–Ω–æ —É—É.\");\r\n    }\r\n\r\n    try {\r\n      setGeoLoadingFrom(true);\r\n      const p = await geocodeTryMany(buildPickupQueries());\r\n\r\n      if (!p) {\r\n        const fb = UB_DISTRICT_CENTROIDS[pickupDistrict];\r\n        if (fb) {\r\n          setPickup(fb);\r\n          return setError(\"–ê–í–ê–• —Ö–∞—è–≥ –æ–ª–¥—Å–æ–Ω–≥“Ø–π. –¶—ç–≥–∏–π–≥ —á–∏—Ä–∂ —Ç–∞–∞—Ä—É—É–ª–Ω–∞ —É—É.\");\r\n        }\r\n        return setError(\"–ê–í–ê–• –±–∞–π—Ä–ª–∞–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\");\r\n      }\r\n\r\n      setPickup(p);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–ê–í–ê–• –±–∞–π—Ä–ª–∞–ª —Ö–∞–π—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setGeoLoadingFrom(false);\r\n    }\r\n  }\r\n\r\n  async function handleGeocodeTo() {\r\n    setError(null);\r\n\r\n    if (!dropoffDistrict || !dropoffKhoroo) {\r\n      return setError(\"–•“Æ–†–ì–≠–• –¥“Ø“Ø—Ä—ç–≥/—Ö–æ—Ä–æ–æ —Å–æ–Ω–≥–æ–Ω–æ —É—É.\");\r\n    }\r\n\r\n    try {\r\n      setGeoLoadingTo(true);\r\n      const p = await geocodeTryMany(buildDropoffQueries());\r\n\r\n      if (!p) {\r\n        const fb = UB_DISTRICT_CENTROIDS[dropoffDistrict];\r\n        if (fb) {\r\n          setDropoff(fb);\r\n          return setError(\"–•“Æ–†–ì–≠–• —Ö–∞—è–≥ –æ–ª–¥—Å–æ–Ω–≥“Ø–π. –¶—ç–≥–∏–π–≥ —á–∏—Ä–∂ —Ç–∞–∞—Ä—É—É–ª–Ω–∞ —É—É.\");\r\n        }\r\n        return setError(\"–•“Æ–†–ì–≠–• –±–∞–π—Ä–ª–∞–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\");\r\n      }\r\n\r\n      setDropoff(p);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–•“Æ–†–ì–≠–• –±–∞–π—Ä–ª–∞–ª —Ö–∞–π—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setGeoLoadingTo(false);\r\n    }\r\n  }\r\n\r\n  async function ensureCoordsBeforeSubmit() {\r\n    if (!isValidLatLng(pickup) && pickupDistrict && pickupKhoroo) {\r\n      const p = await geocodeTryMany(buildPickupQueries());\r\n      if (p) setPickup(p);\r\n      else {\r\n        const fb = UB_DISTRICT_CENTROIDS[pickupDistrict];\r\n        if (fb) setPickup(fb);\r\n      }\r\n    }\r\n\r\n    if (!isValidLatLng(dropoff) && dropoffDistrict && dropoffKhoroo) {\r\n      const p = await geocodeTryMany(buildDropoffQueries());\r\n      if (p) setDropoff(p);\r\n      else {\r\n        const fb = UB_DISTRICT_CENTROIDS[dropoffDistrict];\r\n        if (fb) setDropoff(fb);\r\n      }\r\n    }\r\n  }\r\n\r\n  async function handleSubmit(e: React.FormEvent) {\r\n    e.preventDefault();\r\n    if (!user) return;\r\n\r\n    setError(null);\r\n    setSuccess(false);\r\n\r\n    if (!pickupDistrict || !pickupKhoroo)\r\n      return setError(\"–ê–í–ê–• –¥“Ø“Ø—Ä—ç–≥/—Ö–æ—Ä–æ–æ –∑–∞–∞–≤–∞–ª.\");\r\n    if (!dropoffDistrict || !dropoffKhoroo)\r\n      return setError(\"–•“Æ–†–ì–≠–• –¥“Ø“Ø—Ä—ç–≥/—Ö–æ—Ä–æ–æ –∑–∞–∞–≤–∞–ª.\");\r\n\r\n    if (!pickupPhone.trim()) return setError(\"–ê–í–ê–• —É—Ç–∞—Å –∑–∞–∞–≤–∞–ª.\");\r\n    if (!dropoffPhone.trim()) return setError(\"–•“Æ–†–ì–≠–• —É—Ç–∞—Å –∑–∞–∞–≤–∞–ª.\");\r\n\r\n    if (!price.trim() || isNaN(Number(price)))\r\n      return setError(\"“Æ–Ω—ç (‚ÇÆ) –∑”©–≤ –æ—Ä—É—É–ª–Ω–∞ —É—É.\");\r\n\r\n    try {\r\n      setSending(true);\r\n\r\n      await ensureCoordsBeforeSubmit();\r\n\r\n      const hasPick = isValidLatLng(pickup);\r\n      const hasDrop = isValidLatLng(dropoff);\r\n\r\n      if (!hasPick || !hasDrop) {\r\n        setSending(false);\r\n        setError(\"Map –¥—ç—ç—Ä —Ü—ç–≥“Ø“Ø–¥—ç—ç –±–∞–π—Ä–ª—É—É–ª–∞–∞–¥ –¥–∞—Ö–∏–Ω –∏–ª–≥—ç—ç–Ω—ç “Ø“Ø.\");\r\n        return;\r\n      }\r\n\r\n      const { error: insertError } = await supabase.from(\"deliveries\").insert({\r\n        seller_id: user.id,\r\n\r\n        delivery_type: deliveryType,\r\n\r\n        pickup_district: pickupDistrict,\r\n        pickup_khoroo: pickupKhoroo,\r\n        dropoff_district: dropoffDistrict,\r\n        dropoff_khoroo: dropoffKhoroo,\r\n\r\n        from_address: fromAddress,\r\n        to_address: toAddress,\r\n\r\n        pickup_contact_phone: pickupPhone,\r\n        dropoff_contact_phone: dropoffPhone,\r\n\r\n        note,\r\n        price_mnt: Number(price),\r\n        status: \"OPEN\",\r\n\r\n        pickup_lat: numOrNull(pickup?.lat),\r\n        pickup_lng: numOrNull(pickup?.lng),\r\n        dropoff_lat: numOrNull(dropoff?.lat),\r\n        dropoff_lng: numOrNull(dropoff?.lng),\r\n      });\r\n\r\n      if (insertError) {\r\n        console.error(insertError);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        setSending(false);\r\n        return;\r\n      }\r\n\r\n      window.localStorage.setItem(\"incomeLastPickupDistrict\", pickupDistrict);\r\n      window.localStorage.setItem(\"incomeLastPickupKhoroo\", pickupKhoroo);\r\n      window.localStorage.setItem(\"incomeLastFromAddress\", fromAddress);\r\n      window.localStorage.setItem(\"incomeLastPickupPhone\", pickupPhone);\r\n\r\n      if (pickup) {\r\n        window.localStorage.setItem(\"incomeLastPickupLat\", String(pickup.lat));\r\n        window.localStorage.setItem(\"incomeLastPickupLng\", String(pickup.lng));\r\n      }\r\n\r\n      setSuccess(true);\r\n      setTimeout(() => router.push(\"/seller\"), 900);\r\n    } catch (err) {\r\n      console.error(err);\r\n      setError(\"–°–µ—Ä–≤–µ—Ä—Ç—ç–π —Ö–æ–ª–±–æ–≥–¥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setSending(false);\r\n    }\r\n  }\r\n\r\n  const mapCenter = useMemo(() => {\r\n    if (isValidLatLng(pickup)) return pickup!;\r\n    if (isValidLatLng(dropoff)) return dropoff!;\r\n    return ubCenter;\r\n  }, [pickup, dropoff, ubCenter]);\r\n\r\n  // ‚úÖ pickup card disabled style\r\n  const pickupCardDisabled = pickupLocked;\r\n\r\n  if (loadingUser) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-slate-500 text-sm\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-slate-500 text-sm\">–ù—ç–≤—Ç—Ä—ç—ç–≥“Ø–π –±–∞–π–Ω–∞.</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      {/* Header */}\r\n      <header className=\"border-b border-slate-200 bg-white\">\r\n        <div className=\"max-w-3xl mx-auto px-4 py-5\">\r\n          <div className=\"flex items-start justify-between gap-3\">\r\n            <div>\r\n              <div className=\"text-xs font-semibold text-slate-500\">\r\n                INCOME ¬∑ Seller\r\n              </div>\r\n              <div className=\"text-2xl font-extrabold tracking-tight text-slate-900\">\r\n                + –®–∏–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç\r\n              </div>\r\n              <div className=\"mt-1 text-xs text-slate-500\">\r\n                –¢–æ–≤—á –±”©–≥–ª”©”©–¥ —à—É—É–¥ “Ø“Ø—Å–≥—ç–Ω—ç.\r\n              </div>\r\n            </div>\r\n\r\n            <button\r\n              onClick={() => router.push(\"/seller\")}\r\n              className=\"shrink-0 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:border-slate-300\"\r\n            >\r\n              ‚Üê –ë—É—Ü–∞—Ö\r\n            </button>\r\n          </div>\r\n\r\n          {error && (\r\n            <div className=\"mt-4 rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700\">\r\n              {error}\r\n            </div>\r\n          )}\r\n          {success && (\r\n            <div className=\"mt-4 rounded-2xl border border-emerald-200 bg-emerald-50/70 px-4 py-3 text-sm text-emerald-700\">\r\n              –•“Ø—Ä–≥—ç–ª—Ç –∞–º–∂–∏–ª—Ç—Ç–∞–π “Ø“Ø—Å–≥—ç–≥–¥–ª—ç—ç!\r\n            </div>\r\n          )}\r\n        </div>\r\n      </header>\r\n\r\n      <main className=\"max-w-3xl mx-auto px-4 py-6 space-y-4\">\r\n        {/* Map */}\r\n        <div className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n          <div className=\"flex items-start justify-between gap-3\">\r\n            <div>\r\n              <div className=\"text-sm font-semibold text-slate-900\">\r\n                –ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥\r\n              </div>\r\n            </div>\r\n\r\n            <button\r\n              type=\"button\"\r\n              onClick={togglePickupEdit}\r\n              className={[\r\n                \"rounded-xl border px-3 py-2 text-xs font-semibold\",\r\n                pickupLocked\r\n                  ? \"border-slate-200 bg-white text-slate-800 hover:border-slate-300\"\r\n                  : \"border-red-200 bg-red-50 text-red-900 hover:bg-red-100/70\",\r\n              ].join(\" \")}\r\n              title={pickupLocked ? \"–ê–í–ê–•-—ã–≥ –∑–∞—Å–∞—Ö\" : \"–ê–í–ê–•-—ã–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö\"}\r\n            >\r\n              {pickupLocked ? \"–ó–∞—Å–∞—Ö\" : \"–•–∞–¥–≥–∞–ª–∞—Ö\"}\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"mt-3 h-[300px] w-full overflow-hidden rounded-2xl border border-slate-200\">\r\n            <LeafletMap\r\n              center={mapCenter}\r\n              pickup={pickup}\r\n              dropoff={dropoff}\r\n              pickupLocked={pickupLocked}\r\n              onPickupChange={setPickup}\r\n              onDropoffChange={setDropoff}\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n          {/* Pickup (disabled when locked) */}\r\n          <div\r\n            className={[\r\n              \"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\",\r\n              pickupCardDisabled ? \"opacity-60\" : \"\",\r\n            ].join(\" \")}\r\n          >\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"text-sm font-semibold text-slate-900\">–ê–í–ê–•</div>\r\n\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => void handleGeocodeFrom()}\r\n                disabled={geoLoadingFrom || pickupLocked}\r\n                className={[\r\n                  \"rounded-xl border px-3 py-2 text-xs font-semibold\",\r\n                  geoLoadingFrom || pickupLocked\r\n                    ? \"border-slate-200 bg-slate-100 text-slate-500\"\r\n                    : \"border-emerald-200 bg-emerald-50/70 text-emerald-900 hover:bg-emerald-100/70\",\r\n                ].join(\" \")}\r\n                title=\"–ê–í–ê–• —Ö–∞—è–≥–∞–∞—Ä –æ–π—Ä–æ–ª—Ü–æ–æ —Ü—ç–≥ —Ö–∞–π—Ö\"\r\n              >\r\n                {geoLoadingFrom ? \"–•–∞–π–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•–∞—è–≥–∞–∞—Ä —Ö–∞–π—Ö\"}\r\n              </button>\r\n            </div>\r\n\r\n            <div\r\n              className={pickupLocked ? \"pointer-events-none select-none\" : \"\"}\r\n            >\r\n              <div className=\"mt-3 grid gap-3 sm:grid-cols-2\">\r\n                <div>\r\n                  <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                    –î“Ø“Ø—Ä—ç–≥ (–∑–∞–∞–≤–∞–ª)\r\n                  </div>\r\n                  <SoftSelect\r\n                    value={pickupDistrict}\r\n                    onChange={(e) => setPickupDistrict(e.target.value)}\r\n                    disabled={pickupLocked}\r\n                  >\r\n                    <option value=\"\">–°–æ–Ω–≥–æ—Ö</option>\r\n                    {districtOptions.map((o) => (\r\n                      <option key={o.value} value={o.value}>\r\n                        {o.label}\r\n                      </option>\r\n                    ))}\r\n                  </SoftSelect>\r\n                </div>\r\n\r\n                <div>\r\n                  <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                    –•–æ—Ä–æ–æ (–∑–∞–∞–≤–∞–ª)\r\n                  </div>\r\n                  <SoftSelect\r\n                    value={pickupKhoroo}\r\n                    onChange={(e) => setPickupKhoroo(e.target.value)}\r\n                    disabled={pickupLocked || !pickupDistrict}\r\n                  >\r\n                    <option value=\"\">–°–æ–Ω–≥–æ—Ö</option>\r\n                    {pickupKhorooOptions.map((o) => (\r\n                      <option key={o.value} value={o.value}>\r\n                        {o.label}\r\n                      </option>\r\n                    ))}\r\n                  </SoftSelect>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"mt-3 grid gap-3 sm:grid-cols-2\">\r\n                <div>\r\n                  <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                    –£—Ç–∞—Å (–∑–∞–∞–≤–∞–ª)\r\n                  </div>\r\n                  <SoftInput\r\n                    placeholder=\"–ñ: 9911XXXX\"\r\n                    value={pickupPhone}\r\n                    onChange={(e) => setPickupPhone(e.target.value)}\r\n                    disabled={pickupLocked}\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                    –î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π —Ö–∞—è–≥ (—Å–æ–Ω–≥–æ–ª—Ç)\r\n                  </div>\r\n                  <SoftInput\r\n                    placeholder=\"–ì—É–¥–∞–º–∂, –±–∞–π—Ä, —Ç–æ–æ—Ç‚Ä¶\"\r\n                    value={fromAddress}\r\n                    onChange={(e) => setFromAddress(e.target.value)}\r\n                    disabled={pickupLocked}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Dropoff */}\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"text-sm font-semibold text-slate-900\">–•“Æ–†–ì–≠–•</div>\r\n\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => void handleGeocodeTo()}\r\n                disabled={geoLoadingTo}\r\n                className={[\r\n                  \"rounded-xl border px-3 py-2 text-xs font-semibold\",\r\n                  geoLoadingTo\r\n                    ? \"border-slate-200 bg-slate-100 text-slate-500\"\r\n                    : \"border-emerald-200 bg-emerald-50/70 text-emerald-900 hover:bg-emerald-100/70\",\r\n                ].join(\" \")}\r\n                title=\"–•“Æ–†–ì–≠–• —Ö–∞—è–≥–∞–∞—Ä –æ–π—Ä–æ–ª—Ü–æ–æ —Ü—ç–≥ —Ö–∞–π—Ö\"\r\n              >\r\n                {geoLoadingTo ? \"–•–∞–π–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•–∞—è–≥–∞–∞—Ä —Ö–∞–π—Ö\"}\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"mt-3 grid gap-3 sm:grid-cols-2\">\r\n              <div>\r\n                <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                  –î“Ø“Ø—Ä—ç–≥ (–∑–∞–∞–≤–∞–ª)\r\n                </div>\r\n                <SoftSelect\r\n                  value={dropoffDistrict}\r\n                  onChange={(e) => setDropoffDistrict(e.target.value)}\r\n                >\r\n                  <option value=\"\">–°–æ–Ω–≥–æ—Ö</option>\r\n                  {districtOptions.map((o) => (\r\n                    <option key={o.value} value={o.value}>\r\n                      {o.label}\r\n                    </option>\r\n                  ))}\r\n                </SoftSelect>\r\n              </div>\r\n\r\n              <div>\r\n                <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                  –•–æ—Ä–æ–æ (–∑–∞–∞–≤–∞–ª)\r\n                </div>\r\n                <SoftSelect\r\n                  value={dropoffKhoroo}\r\n                  onChange={(e) => setDropoffKhoroo(e.target.value)}\r\n                  disabled={!dropoffDistrict}\r\n                >\r\n                  <option value=\"\">–°–æ–Ω–≥–æ—Ö</option>\r\n                  {dropoffKhorooOptions.map((o) => (\r\n                    <option key={o.value} value={o.value}>\r\n                      {o.label}\r\n                    </option>\r\n                  ))}\r\n                </SoftSelect>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"mt-3 grid gap-3 sm:grid-cols-2\">\r\n              <div>\r\n                <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                  –£—Ç–∞—Å (–∑–∞–∞–≤–∞–ª)\r\n                </div>\r\n                <SoftInput\r\n                  placeholder=\"–ñ: 9911XXXX\"\r\n                  value={dropoffPhone}\r\n                  onChange={(e) => setDropoffPhone(e.target.value)}\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                  –î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π —Ö–∞—è–≥ (—Å–æ–Ω–≥–æ–ª—Ç)\r\n                </div>\r\n                <SoftInput\r\n                  placeholder=\"–ì—É–¥–∞–º–∂, –±–∞–π—Ä, —Ç–æ–æ—Ç‚Ä¶\"\r\n                  value={toAddress}\r\n                  onChange={(e) => setToAddress(e.target.value)}\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Compact details */}\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n            <div className=\"text-sm font-semibold text-slate-900\">\r\n              –Æ—É —Ö“Ø—Ä–≥—ç—Ö ¬∑ “Æ–Ω—ç\r\n            </div>\r\n\r\n            <div className=\"mt-3 grid gap-3 sm:grid-cols-2\">\r\n              <div>\r\n                <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                  “Æ–Ω—ç (‚ÇÆ) ‚Äî –∑–∞–∞–≤–∞–ª\r\n                </div>\r\n                <SoftInput\r\n                  inputMode=\"numeric\"\r\n                  placeholder=\"–ñ: 15000\"\r\n                  value={price}\r\n                  onChange={(e) => setPrice(e.target.value)}\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                  –¢”©—Ä”©–ª (—Ç–æ–≤—á)\r\n                </div>\r\n                <div className=\"grid grid-cols-3 gap-2\">\r\n                  {[\r\n                    { id: \"apartment\", label: \"–û—Ä–æ–Ω —Å—É—É—Ü\" },\r\n                    { id: \"ger\", label: \"–ì—ç—Ä\" },\r\n                    { id: \"camp\", label: \"Camp\" },\r\n                  ].map((x) => {\r\n                    const active = deliveryType === x.id;\r\n                    return (\r\n                      <button\r\n                        key={x.id}\r\n                        type=\"button\"\r\n                        onClick={() => setDeliveryType(x.id)}\r\n                        className={[\r\n                          \"rounded-xl border px-3 py-2 text-xs font-semibold transition-colors\",\r\n                          active\r\n                            ? \"border-emerald-200 bg-emerald-50/70 text-emerald-900\"\r\n                            : \"border-slate-200 bg-white text-slate-700 hover:bg-slate-50\",\r\n                        ].join(\" \")}\r\n                      >\r\n                        {x.label}\r\n                      </button>\r\n                    );\r\n                  })}\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"mt-3\">\r\n              <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                –¢–∞–π–ª–±–∞—Ä (—Å–æ–Ω–≥–æ–ª—Ç)\r\n              </div>\r\n              <SoftTextArea\r\n                rows={3}\r\n                placeholder=\"–ñ: 2 —Ö–∞–π—Ä—Ü–∞–≥, —ç–º–∑—ç–≥, —Ç“Ø—Ä–≥—ç–Ω‚Ä¶\"\r\n                value={note}\r\n                onChange={(e) => setNote(e.target.value)}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Submit */}\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n            <button\r\n              type=\"submit\"\r\n              disabled={!readyForSubmit || sending}\r\n              className={[\r\n                \"w-full rounded-2xl px-4 py-3 text-sm font-extrabold tracking-tight text-white\",\r\n                sending || !readyForSubmit\r\n                  ? \"bg-emerald-300\"\r\n                  : \"bg-emerald-600 hover:bg-emerald-700\",\r\n              ].join(\" \")}\r\n            >\r\n              {sending ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Ä–≥—ç–ª—Ç “Ø“Ø—Å–≥—ç—Ö\"}\r\n            </button>\r\n\r\n            <div className=\"mt-2 text-[11px] text-slate-500 text-center\">\r\n              –î“Ø“Ø—Ä—ç–≥/—Ö–æ—Ä–æ–æ ¬∑ 2 —É—Ç–∞—Å ¬∑ “Ø–Ω—ç ‚Äî –±“Ø—Ä—ç–Ω –±–∞–π–≤–∞–ª –∏–ª–≥—ç—ç–Ω—ç.\r\n            </div>\r\n          </div>\r\n        </form>\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/seller/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport {\r\n  DeliveryStatus,\r\n  SELLER_TABS,\r\n  SellerTabId,\r\n  getSellerTabForStatus,\r\n} from \"@/lib/deliveryLogic\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryRow = {\r\n  id: string;\r\n  seller_id: string;\r\n\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n\r\n  pickup_district: string | null;\r\n  pickup_khoroo: string | null;\r\n  dropoff_district: string | null;\r\n  dropoff_khoroo: string | null;\r\n\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n  chosen_driver_id: string | null;\r\n\r\n  seller_hidden: boolean;\r\n  bid_count?: number;\r\n\r\n  // ‚úÖ –∑–∞–º–¥ –≥–∞—Ä—Å–∞–Ω –º”©—á\r\n  on_route_at?: string | null;\r\n};\r\n\r\nfunction fmtPrice(n: number | null | undefined) {\r\n  const v = Number(n || 0);\r\n  return v ? `${v.toLocaleString(\"mn-MN\")}‚ÇÆ` : \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n}\r\n\r\nfunction shorten(s: string | null, max = 72) {\r\n  if (!s) return \"‚Äî\";\r\n  const t = s.trim();\r\n  if (t.length <= max) return t;\r\n  return t.slice(0, max).replace(/\\s+$/, \"\") + \"‚Ä¶\";\r\n}\r\n\r\nfunction areaLine(district?: string | null, khoroo?: string | null) {\r\n  const d = (district || \"\").trim();\r\n  const k = (khoroo || \"\").trim();\r\n\r\n  if (d && k) return `${d} ¬∑ ${k}`;\r\n  if (d) return d;\r\n  if (k) return k;\r\n  return \"‚Äî\";\r\n}\r\n\r\nfunction badge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return {\r\n        text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\",\r\n        cls: \"border-emerald-200 bg-emerald-50/70 text-emerald-700\",\r\n      };\r\n    case \"ASSIGNED\":\r\n      return {\r\n        text: \"–°–æ–Ω–≥–æ—Å–æ–Ω\",\r\n        cls: \"border-indigo-200 bg-indigo-50 text-indigo-700\",\r\n      };\r\n    case \"ON_ROUTE\":\r\n      return {\r\n        text: \"–ó–∞–º–¥ –≥–∞—Ä–ª–∞–∞\",\r\n        cls: \"border-amber-200 bg-amber-50 text-amber-700\",\r\n      };\r\n    case \"DELIVERED\":\r\n    default:\r\n      return {\r\n        text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\",\r\n        cls: \"border-slate-200 bg-slate-50 text-slate-700\",\r\n      };\r\n  }\r\n}\r\n\r\n// ‚úÖ hh:mm (–∞–º—å–¥ —Ç–æ–æ–ª–æ–≥–¥–æ–Ω–æ)\r\nfunction routeHHMM(onRouteAt?: string | null) {\r\n  if (!onRouteAt) return \"00:00\";\r\n  const t = new Date(onRouteAt).getTime();\r\n  if (!Number.isFinite(t)) return \"00:00\";\r\n  const ms = Date.now() - t;\r\n  if (ms <= 0) return \"00:00\";\r\n\r\n  const totalMin = Math.floor(ms / 60000);\r\n  const hh = String(Math.floor(totalMin / 60)).padStart(2, \"0\");\r\n  const mm = String(totalMin % 60).padStart(2, \"0\");\r\n  return `${hh}:${mm}`;\r\n}\r\n\r\n// ‚úÖ late —à–∞–ª–≥–∞—Ö—ã–Ω —Ç—É–ª–¥ (3+ —Ü–∞–≥ –≥—ç—Ö –º—ç—Ç)\r\nfunction routeTotalHours(onRouteAt?: string | null) {\r\n  if (!onRouteAt) return 0;\r\n  const t = new Date(onRouteAt).getTime();\r\n  if (!Number.isFinite(t)) return 0;\r\n  const ms = Date.now() - t;\r\n  if (ms <= 0) return 0;\r\n  return ms / 3600000;\r\n}\r\n\r\nfunction Pill({\r\n  label,\r\n  value,\r\n  active,\r\n  onClick,\r\n}: {\r\n  label: string;\r\n  value: string;\r\n  active?: boolean;\r\n  onClick?: () => void;\r\n}) {\r\n  const base = \"w-full rounded-xl border px-3 py-2 text-left transition-colors\";\r\n  const cls = active\r\n    ? \"border-emerald-200 bg-emerald-50/70\"\r\n    : \"border-slate-200 bg-white hover:bg-slate-50\";\r\n\r\n  const Comp: any = onClick ? \"button\" : \"div\";\r\n\r\n  return (\r\n    <Comp onClick={onClick} className={`${base} ${cls}`}>\r\n      <div className=\"text-[11px] text-slate-500\">{label}</div>\r\n      <div className=\"text-sm font-extrabold tracking-tight text-slate-900\">\r\n        {value}\r\n      </div>\r\n    </Comp>\r\n  );\r\n}\r\n\r\nasync function copyText(text: string) {\r\n  try {\r\n    await navigator.clipboard.writeText(text);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction buildSharePostSimple(d: DeliveryRow) {\r\n  const fromArea = areaLine(d.pickup_district, d.pickup_khoroo);\r\n  const toArea = areaLine(d.dropoff_district, d.dropoff_khoroo);\r\n  const price = fmtPrice(d.price_mnt);\r\n  const what = d.note ? d.note.trim() : \"\";\r\n  return (\r\n    `üöö Delivery\\n` +\r\n    `üìç ${fromArea} ‚Üí ${toArea}\\n` +\r\n    `üí∞ ${price}\\n` +\r\n    (what ? `üì¶ ${what}\\n` : \"\") +\r\n    `#INCOME`\r\n  );\r\n}\r\n\r\nexport default function SellerDashboardPage() {\r\n  const router = useRouter();\r\n  const sp = useSearchParams();\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [activeTab, setActiveTab] = useState<SellerTabId>(\"OPEN\");\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [items, setItems] = useState<DeliveryRow[]>([]);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [msg, setMsg] = useState<string | null>(null);\r\n\r\n  const [actLoading, setActLoading] = useState<Record<string, boolean>>({});\r\n\r\n  // ‚úÖ ON_ROUTE “Ø–µ–¥ –∞–º—å–¥ —Ç–æ–æ–ª—É—É—Ä —à–∏–Ω—ç—á–ª“Ø“Ø–ª—ç—Ö tick\r\n  const [tick, setTick] = useState(0);\r\n\r\n  // ‚úÖ –¢–∞–± –Ω—ç—Ä–∏–π–≥ —è–≥ —Ö“Ø—Å—Å—ç–Ω—ç—ç—Ä —Å–æ–ª–∏—Ö (UI —ç–≤–¥—ç—Ö–≥“Ø–π–≥—ç—ç—Ä)\r\n  const SELLER_TABS_UI = useMemo(() => {\r\n    return SELLER_TABS.map((t) =>\r\n      t.id === \"ON_ROUTE\" ? { ...t, label: \"–ó–∞–º–¥ –≥–∞—Ä–ª–∞–∞\" } : t\r\n    );\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) return router.replace(\"/\");\r\n      const u: IncomeUser = JSON.parse(raw);\r\n      if (u.role !== \"seller\") return router.replace(\"/\");\r\n      setUser(u);\r\n    } catch {\r\n      router.replace(\"/\");\r\n    }\r\n  }, [router]);\r\n\r\n  useEffect(() => {\r\n    const urlTab = sp.get(\"tab\");\r\n    const valid = SELLER_TABS_UI.some((t) => t.id === (urlTab as any));\r\n    if (urlTab && valid) {\r\n      setActiveTab(urlTab as SellerTabId);\r\n      localStorage.setItem(\"sellerActiveTab\", urlTab);\r\n      return;\r\n    }\r\n    const stored = localStorage.getItem(\"sellerActiveTab\");\r\n    const validStored = SELLER_TABS_UI.some((t) => t.id === (stored as any));\r\n    if (stored && validStored) setActiveTab(stored as SellerTabId);\r\n  }, [sp, SELLER_TABS_UI]);\r\n\r\n  function changeTab(tab: SellerTabId) {\r\n    setActiveTab(tab);\r\n    localStorage.setItem(\"sellerActiveTab\", tab);\r\n    router.replace(`/seller?tab=${tab}`);\r\n  }\r\n\r\n  // ‚úÖ –∑”©–≤—Ö”©–Ω ON_ROUTE —Ç–∞–± –¥—ç—ç—Ä 30 —Å–µ–∫ —Ç—É—Ç–∞–º –∞–º—å–¥ —Ç–æ–æ–ª–æ–≥–¥–æ—Ö re-render\r\n  useEffect(() => {\r\n    if (activeTab !== \"ON_ROUTE\") return;\r\n    const t = setInterval(() => setTick((v) => v + 1), 30 * 1000);\r\n    return () => clearInterval(t);\r\n  }, [activeTab]);\r\n\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    void fetchAll(user.id);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id]);\r\n\r\n  async function fetchAll(sellerId: string) {\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const { data, error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          seller_id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          pickup_district,\r\n          pickup_khoroo,\r\n          dropoff_district,\r\n          dropoff_khoroo,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          chosen_driver_id,\r\n          seller_hidden,\r\n          on_route_at\r\n        `\r\n        )\r\n        .eq(\"seller_id\", sellerId)\r\n        .eq(\"seller_hidden\", false)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (e1) throw e1;\r\n\r\n      const rows = (data || []) as DeliveryRow[];\r\n\r\n      const openIds = rows.filter((r) => r.status === \"OPEN\").map((r) => r.id);\r\n      const bidMap: Record<string, number> = {};\r\n\r\n      if (openIds.length) {\r\n        const { data: bidRows, error: e2 } = await supabase\r\n          .from(\"driver_bids\")\r\n          .select(\"delivery_id\")\r\n          .in(\"delivery_id\", openIds);\r\n\r\n        if (!e2) {\r\n          for (const r of bidRows || []) {\r\n            const k = (r as any).delivery_id as string;\r\n            bidMap[k] = (bidMap[k] || 0) + 1;\r\n          }\r\n        }\r\n      }\r\n\r\n      setItems(\r\n        rows.map((r) =>\r\n          r.status === \"OPEN\" ? { ...r, bid_count: bidMap[r.id] || 0 } : r\r\n        )\r\n      );\r\n    } catch (e: any) {\r\n      setError(e?.message || \"–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  const filtered = useMemo(() => {\r\n    return items.filter((d) => getSellerTabForStatus(d.status) === activeTab);\r\n  }, [items, activeTab]);\r\n\r\n  // ‚úÖ ON_ROUTE “Ø–µ–¥: —Ö–∞–º–≥–∏–π–Ω —É–¥–∞–∂ –±–∞–π–≥–∞–∞ –Ω—å –¥—ç—ç—Ä (on_route_at —Ö–∞–º–≥–∏–π–Ω —ç—Ä—Ç)\r\n  const sorted = useMemo(() => {\r\n    // tick –∞—à–∏–≥–ª–∞—Å–Ω–∞–∞—Ä ON_ROUTE –¥—ç—ç—Ä —Ö—É–≥–∞—Ü–∞–∞ –∞–º—å–¥ —à–∏–Ω—ç—á–ª—ç–≥–¥—ç–Ω—ç\r\n    if (activeTab !== \"ON_ROUTE\") return filtered;\r\n\r\n    const copy = [...filtered];\r\n    copy.sort((a, b) => {\r\n      const ta = a.on_route_at ? new Date(a.on_route_at).getTime() : 0;\r\n      const tb = b.on_route_at ? new Date(b.on_route_at).getTime() : 0;\r\n\r\n      if (!ta && tb) return 1;\r\n      if (ta && !tb) return -1;\r\n\r\n      return ta - tb;\r\n    });\r\n    return copy;\r\n  }, [filtered, activeTab, tick]);\r\n\r\n  const tabCounts = useMemo(() => {\r\n    const m: Record<SellerTabId, number> = {\r\n      OPEN: 0,\r\n      ASSIGNED: 0,\r\n      ON_ROUTE: 0,\r\n      DELIVERED: 0,\r\n    };\r\n    for (const d of items) {\r\n      const tab = getSellerTabForStatus(d.status);\r\n      m[tab] = (m[tab] || 0) + 1;\r\n    }\r\n    return m;\r\n  }, [items]);\r\n\r\n  function logout() {\r\n    localStorage.removeItem(\"incomeUser\");\r\n    router.replace(\"/\");\r\n  }\r\n\r\n  function lock(deliveryId: string, v: boolean) {\r\n    setActLoading((prev) => ({ ...prev, [deliveryId]: v }));\r\n  }\r\n\r\n  function openDetail(d: DeliveryRow) {\r\n    router.push(`/seller/delivery/${d.id}`);\r\n  }\r\n\r\n  async function markPickedUp(deliveryId: string) {\r\n    if (!user) return;\r\n    if (actLoading[deliveryId]) return;\r\n\r\n    lock(deliveryId, true);\r\n    setMsg(null);\r\n    setError(null);\r\n\r\n    try {\r\n      const now = new Date().toISOString();\r\n\r\n      // ‚úÖ 1) —Å—Ç–∞—Ç—É—Å + on_route_at –Ω—ç–≥ –¥–æ—Ä\r\n      const { error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"ON_ROUTE\", on_route_at: now } as any)\r\n        .eq(\"id\", deliveryId)\r\n        .eq(\"seller_id\", user.id)\r\n        .eq(\"status\", \"ASSIGNED\");\r\n\r\n      if (e1) throw e1;\r\n\r\n      // ‚úÖ optional: picked_up_at –±–∞–π—Ö–≥“Ø–π –±–∞–π—Å–∞–Ω —á —Å—Ç–∞—Ç—É—Å —É–Ω–∞—Ö–≥“Ø–π\r\n      try {\r\n        await supabase\r\n          .from(\"deliveries\")\r\n          .update({ picked_up_at: now } as any)\r\n          .eq(\"id\", deliveryId)\r\n          .eq(\"seller_id\", user.id);\r\n      } catch {\r\n        // ignore\r\n      }\r\n\r\n      setItems((prev) =>\r\n        prev.map((x) =>\r\n          x.id === deliveryId\r\n            ? ({\r\n                ...x,\r\n                status: \"ON_ROUTE\",\r\n                on_route_at: now,\r\n              } as DeliveryRow)\r\n            : x\r\n        )\r\n      );\r\n\r\n      setMsg(\"–ñ–æ–ª–æ–æ—á –±–∞—Ä–∞–∞–≥ –∞–≤—Å–∞–Ω ‚Üí –ó–∞–º–¥ –≥–∞—Ä–ª–∞–∞ —Ä—É—É —à–∏–ª–∂–ª—ç—ç.\");\r\n      changeTab(\"ON_ROUTE\");\r\n\r\n      await fetchAll(user.id);\r\n    } catch (e: any) {\r\n      setError(e?.message || \"–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞\");\r\n    } finally {\r\n      lock(deliveryId, false);\r\n    }\r\n  }\r\n\r\n  async function deleteDelivered(deliveryId: string) {\r\n    if (!user) return;\r\n    if (actLoading[deliveryId]) return;\r\n\r\n    lock(deliveryId, true);\r\n    setMsg(null);\r\n    setError(null);\r\n\r\n    try {\r\n      const { error: e1 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ seller_hidden: true })\r\n        .eq(\"id\", deliveryId)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (e1) throw e1;\r\n\r\n      setMsg(\"–•“Ø—Ä–≥—ç—Å—ç–Ω —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ —É—Å—Ç–≥–∞–ª–∞–∞.\");\r\n      await fetchAll(user.id);\r\n    } catch (e: any) {\r\n      setError(e?.message || \"–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞\");\r\n    } finally {\r\n      lock(deliveryId, false);\r\n    }\r\n  }\r\n\r\n  async function shareFacebookOpenOnly(d: DeliveryRow) {\r\n    try {\r\n      setMsg(null);\r\n      setError(null);\r\n\r\n      const text = buildSharePostSimple(d);\r\n      const ok = await copyText(text);\r\n\r\n      if (ok)\r\n        setMsg(\"üì§ SHARE —Ç–µ–∫—Å—Ç–∏–π–≥ —Ö—É—É–ª–ª–∞–∞. Facebook –¥—ç—ç—Ä paste —Ö–∏–π–≥—ç—ç–¥ post —Ö–∏–π–≥—ç—ç—Ä—ç–π.\");\r\n      else setMsg(text);\r\n\r\n      window.open(\r\n        \"https://www.facebook.com/sharer/sharer.php?u=https://income.mn\",\r\n        \"_blank\"\r\n      );\r\n    } catch (e: any) {\r\n      setError(e?.message || \"–®—ç—Ä —Ö–∏–π—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞\");\r\n    }\r\n  }\r\n\r\n  // ‚úÖ –ù–∞–π–¥–≤–∞—Ä–≥“Ø–π –∂–æ–ª–æ–æ—á\r\n  async function markDriverUnreliable(deliveryId: string, driverId: string | null) {\r\n    if (!user) return;\r\n    if (!driverId) return;\r\n    if (actLoading[deliveryId]) return;\r\n\r\n    lock(deliveryId, true);\r\n    setMsg(null);\r\n    setError(null);\r\n\r\n    try {\r\n      // 1) block\r\n      const { error: e1 } = await supabase.from(\"seller_blocked_drivers\").insert({\r\n        seller_id: user.id,\r\n        driver_id: driverId,\r\n        reason: \"–ù–∞–π–¥–≤–∞—Ä–≥“Ø–π\",\r\n      } as any);\r\n\r\n      if (e1) throw e1;\r\n\r\n      // 2) delivery-–≥ –±—É—Ü–∞–∞–∂ OPEN –±–æ–ª–≥–æ–Ω–æ (–¥–∞—Ö–∏–Ω driver —Å–æ–Ω–≥–æ–Ω–æ)\r\n      const { error: e2 } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          status: \"OPEN\",\r\n          chosen_driver_id: null,\r\n          on_route_at: null,\r\n        } as any)\r\n        .eq(\"id\", deliveryId)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (e2) throw e2;\r\n\r\n      setMsg(\"–ñ–æ–ª–æ–æ—á–∏–π–≥ –Ω–∞–π–¥–≤–∞—Ä–≥“Ø–π –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—ç–¥ —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ –¥–∞—Ö–∏–Ω –Ω—ç—ç–ª—Ç—Ç—ç–π –±–æ–ª–≥–æ–ª–æ–æ.\");\r\n      await fetchAll(user.id);\r\n      changeTab(\"OPEN\");\r\n    } catch (e: any) {\r\n      setError(e?.message || \"–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞\");\r\n    } finally {\r\n      lock(deliveryId, false);\r\n    }\r\n  }\r\n\r\n  // ‚úÖ OPEN card\r\n  function OpenCard({ d }: { d: DeliveryRow }) {\r\n    const b = badge(d.status);\r\n    const fromArea = areaLine(d.pickup_district, d.pickup_khoroo);\r\n    const toArea = areaLine(d.dropoff_district, d.dropoff_khoroo);\r\n\r\n    return (\r\n      <div className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm\">\r\n        <div className=\"flex items-start justify-between gap-3\">\r\n          <div className=\"min-w-0\">\r\n            <div className=\"flex flex-wrap items-center gap-2\">\r\n              <span\r\n                className={`inline-flex items-center rounded-full border px-2 py-0.5 text-xs ${b.cls}`}\r\n              >\r\n                {b.text}\r\n              </span>\r\n\r\n              {typeof d.bid_count === \"number\" && (\r\n                <span className=\"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-xs font-semibold text-slate-700\">\r\n                  –°–∞–Ω–∞–ª: {d.bid_count}\r\n                </span>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"mt-2 text-sm font-semibold leading-snug\">\r\n              <span className=\"text-emerald-700\">{fromArea}</span>\r\n              <span className=\"mx-2 text-slate-400\">‚Üí</span>\r\n              <span className=\"text-emerald-900\">{toArea}</span>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"shrink-0\">\r\n            <div className=\"inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50/70 px-3 py-1 text-sm font-extrabold tracking-tight text-emerald-700\">\r\n              {fmtPrice(d.price_mnt)}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-3\">\r\n          <button\r\n            onClick={() => openDetail(d)}\r\n            className=\"inline-flex w-full items-center gap-2 rounded-2xl border border-emerald-200 bg-emerald-50/70 px-3 py-2 text-sm font-semibold text-emerald-900 hover:bg-emerald-100/70\"\r\n            title=\"–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π\"\r\n          >\r\n            <span className=\"text-emerald-700\">üì¶</span>\r\n            <span className=\"min-w-0 truncate text-emerald-900\">\r\n              {d.note ? shorten(d.note, 90) : \"‚Äî\"}\r\n            </span>\r\n          </button>\r\n        </div>\r\n\r\n        <div className=\"mt-3 flex items-center justify-end gap-2\">\r\n          <button\r\n            onClick={() => openDetail(d)}\r\n            className=\"rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-900 hover:border-slate-300\"\r\n            title=\"OPEN\"\r\n          >\r\n            üìÇ OPEN\r\n          </button>\r\n\r\n          <button\r\n            onClick={() => void shareFacebookOpenOnly(d)}\r\n            className=\"rounded-xl bg-emerald-600 px-3 py-2 text-xs font-semibold text-white hover:bg-emerald-700\"\r\n            title=\"SHARE\"\r\n          >\r\n            üì§ SHARE\r\n          </button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  function DeliveryCardNormal({ d }: { d: DeliveryRow }) {\r\n    const b = badge(d.status);\r\n    const fromArea = areaLine(d.pickup_district, d.pickup_khoroo);\r\n    const toArea = areaLine(d.dropoff_district, d.dropoff_khoroo);\r\n\r\n    const hhmm = d.status === \"ON_ROUTE\" ? routeHHMM(d.on_route_at) : \"00:00\";\r\n    const hours = d.status === \"ON_ROUTE\" ? routeTotalHours(d.on_route_at) : 0;\r\n    const isLate = d.status === \"ON_ROUTE\" && hours >= 3;\r\n\r\n    return (\r\n      <div className=\"rounded-2xl border border-slate-200 bg-white p-4\">\r\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\">\r\n          <div className=\"min-w-0\">\r\n            <div className=\"flex flex-wrap items-center gap-2\">\r\n              <span\r\n                className={`inline-flex items-center rounded-full border px-2 py-0.5 text-xs ${b.cls}`}\r\n              >\r\n                {b.text}\r\n              </span>\r\n\r\n              {/* ‚úÖ ON_ROUTE –¥—ç—ç—Ä —Ü–∞–≥:–º–∏–Ω—É—Ç */}\r\n              {d.status === \"ON_ROUTE\" && (\r\n                <span\r\n                  className={[\r\n                    \"inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-xs font-extrabold\",\r\n                    isLate\r\n                      ? \"border-red-200 bg-red-50 text-red-700\"\r\n                      : \"border-emerald-200 bg-emerald-50/70 text-emerald-700\",\r\n                  ].join(\" \")}\r\n                  title=\"–ó–∞–º–¥ –≥–∞—Ä—Å–Ω–∞–∞—Å —Ö–æ–π—à\"\r\n                >\r\n                  ‚è± {hhmm}\r\n                </span>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"mt-2 text-sm font-semibold\">\r\n              <span className=\"text-emerald-700\">{fromArea}</span>\r\n              <span className=\"mx-2 text-slate-400\">‚Üí</span>\r\n              <span className=\"text-emerald-900\">{toArea}</span>\r\n            </div>\r\n\r\n            <div className=\"mt-2 text-sm font-bold text-emerald-700\">\r\n              {fmtPrice(d.price_mnt)}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex shrink-0 flex-col gap-2 sm:items-end\">\r\n            <button\r\n              onClick={() => openDetail(d)}\r\n              className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-300\"\r\n            >\r\n              –î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π\r\n            </button>\r\n\r\n            {d.status === \"ASSIGNED\" && (\r\n              <button\r\n                onClick={() => void markPickedUp(d.id)}\r\n                disabled={!!actLoading[d.id]}\r\n                className={[\r\n                  \"rounded-xl px-4 py-2 text-sm font-semibold text-white\",\r\n                  actLoading[d.id]\r\n                    ? \"bg-emerald-400\"\r\n                    : \"bg-emerald-600 hover:bg-emerald-700\",\r\n                ].join(\" \")}\r\n              >\r\n                –ñ–æ–ª–æ–æ—á –±–∞—Ä–∞–∞–≥ –∞–≤—á —è–≤–ª–∞–∞\r\n              </button>\r\n            )}\r\n\r\n            {d.status === \"DELIVERED\" && (\r\n              <button\r\n                onClick={() => void deleteDelivered(d.id)}\r\n                disabled={!!actLoading[d.id]}\r\n                className={[\r\n                  \"rounded-xl px-4 py-2 text-sm font-semibold text-white\",\r\n                  actLoading[d.id]\r\n                    ? \"bg-slate-400\"\r\n                    : \"bg-slate-900 hover:bg-slate-800\",\r\n                ].join(\" \")}\r\n              >\r\n                delüóëÔ∏è\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <header className=\"border-b border-slate-200 bg-white\">\r\n        <div className=\"max-w-3xl mx-auto px-4 py-4\">\r\n          <div className=\"flex items-center justify-between gap-3\">\r\n            <div>\r\n              <div className=\"text-xs font-semibold text-slate-500\">\r\n                INCOME ¬∑ Seller\r\n              </div>\r\n              <div className=\"text-2xl font-extrabold tracking-tight text-slate-900\">\r\n                {user?.name || \"‚Äî\"}\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-center gap-2\">\r\n              <button\r\n                onClick={() => router.push(\"/seller/new-delivery\")}\r\n                className=\"rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700\"\r\n              >\r\n                + –®–∏–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç\r\n              </button>\r\n\r\n              <button\r\n                onClick={logout}\r\n                className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:border-slate-300\"\r\n              >\r\n                –ì–∞—Ä–∞—Ö\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {error && (\r\n            <div className=\"mt-4 rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700\">\r\n              {error}\r\n            </div>\r\n          )}\r\n          {msg && (\r\n            <div className=\"mt-4 rounded-2xl border border-emerald-200 bg-emerald-50/70 px-4 py-3 text-sm text-emerald-700\">\r\n              {msg}\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"mt-5 grid grid-cols-2 gap-3 sm:grid-cols-4\">\r\n            <Pill\r\n              label=\"–ù—ç—ç–ª—Ç—Ç—ç–π\"\r\n              value={String(tabCounts.OPEN)}\r\n              active={activeTab === \"OPEN\"}\r\n              onClick={() => changeTab(\"OPEN\")}\r\n            />\r\n            <Pill\r\n              label=\"–°–æ–Ω–≥–æ—Å–æ–Ω\"\r\n              value={String(tabCounts.ASSIGNED)}\r\n              active={activeTab === \"ASSIGNED\"}\r\n              onClick={() => changeTab(\"ASSIGNED\")}\r\n            />\r\n            <Pill\r\n              label=\"–ó–∞–º–¥ –≥–∞—Ä–ª–∞–∞\"\r\n              value={String(tabCounts.ON_ROUTE)}\r\n              active={activeTab === \"ON_ROUTE\"}\r\n              onClick={() => changeTab(\"ON_ROUTE\")}\r\n            />\r\n            <Pill\r\n              label=\"–•“Ø—Ä–≥—ç—Å—ç–Ω\"\r\n              value={String(tabCounts.DELIVERED)}\r\n              active={activeTab === \"DELIVERED\"}\r\n              onClick={() => changeTab(\"DELIVERED\")}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"mt-3 text-xs text-slate-500\">\r\n            –û–¥–æ–æ:{\" \"}\r\n            <span className=\"font-semibold text-slate-700\">\r\n              {SELLER_TABS_UI.find((t) => t.id === activeTab)?.label || \"‚Äî\"}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      <main className=\"max-w-3xl mx-auto px-4 py-6\">\r\n        {loading ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-slate-600\">\r\n            –ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\r\n          </div>\r\n        ) : sorted.length === 0 ? (\r\n          <div className=\"rounded-2xl border border-slate-200 bg-white p-6 text-slate-600\">\r\n            –≠–Ω—ç —Ç–∞–± –¥—ç—ç—Ä —Ö“Ø—Ä–≥—ç–ª—Ç –∞–ª–≥–∞.\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid gap-3\">\r\n            {sorted.map((d) => {\r\n              if (activeTab === \"OPEN\") return <OpenCard key={d.id} d={d} />;\r\n              return <DeliveryCardNormal key={d.id} d={d} />;\r\n            })}\r\n          </div>\r\n        )}\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "lib/deliveryLogic.ts",
        "summary": "",
        "content": "// ===================== lib/deliveryLogic.ts (FINAL v5.0) =====================\r\n// –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Å—Ç–∞—Ç—É—Å, —Ç–∞–±—É—É–¥—ã–Ω —Ç”©–≤–ª”©—Ä—Å”©–Ω –ª–æ–≥–∏–∫ (single source of truth)\r\n//\r\n// ‚úÖ BABA UI rule:\r\n// - Seller/Driver —Ç–∞–ª–¥: –¢”©–ª—Å”©–Ω / –•–∞–∞–≥–¥—Å–∞–Ω / –ú–∞—Ä–≥–∞–∞–Ω —Ç–∞–± –±–∞–π—Ö–≥“Ø–π.\r\n// - Legacy —Å—Ç–∞—Ç—É—Å—É—É–¥ (PAID/CLOSED/DISPUTE/CANCELLED) –±–∞–π–≤–∞–ª UI –¥—ç—ç—Ä \"–•“Ø—Ä–≥—ç—Å—ç–Ω\" —Ç–∞–± —Ä—É—É –ù–≠–ì–¢–ì–≠–ù–≠.\r\n//\r\n// ‚úÖ Core flow (one-way, rollback –±–∞–π—Ö–≥“Ø–π):\r\n// OPEN -> ASSIGNED -> ON_ROUTE -> DELIVERED\r\n//\r\n// ‚úÖ Compatibility (legacy —Ç–∞–ª–±–∞—Ä—É—É–¥):\r\n// - boolean —Ç–∞–ª–±–∞—Ä—É—É–¥: seller_marked_paid, driver_confirmed_payment\r\n// - timestamp —Ç–∞–ª–±–∞—Ä—É—É–¥: delivered_at, seller_paid_at, driver_paid_confirmed_at\r\n// ‚Üí 2-–≥ –Ω—å –∑—ç—Ä—ç–≥ –¥—ç–º–∂–∏–Ω—ç (—Ö—É—É—á–∏–Ω ”©–≥”©–≥ —É—Å—Ç–∞—Ö–≥“Ø–π)\r\n\r\n// ---------- STATUS ----------\r\nexport type DeliveryStatus =\r\n  | \"OPEN\"\r\n  | \"ASSIGNED\"\r\n  | \"ON_ROUTE\"\r\n  | \"DELIVERED\"\r\n  | \"PAID\" // legacy/status-level only (UI —Ç–∞–± –±–∞–π—Ö–≥“Ø–π)\r\n  | \"DISPUTE\" // legacy/status-level only (UI —Ç–∞–± –±–∞–π—Ö–≥“Ø–π)\r\n  | \"CLOSED\" // legacy/status-level only (UI —Ç–∞–± –±–∞–π—Ö–≥“Ø–π)\r\n  | \"CANCELLED\"; // legacy only\r\n\r\n// ---------- SELLER TABS (UI) ----------\r\nexport type SellerTabId = \"OPEN\" | \"ASSIGNED\" | \"ON_ROUTE\" | \"DELIVERED\";\r\n\r\nexport const SELLER_TABS: { id: SellerTabId; label: string }[] = [\r\n  { id: \"OPEN\", label: \"–ù—ç—ç–ª—Ç—Ç—ç–π\" },\r\n  { id: \"ASSIGNED\", label: \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\" },\r\n  { id: \"ON_ROUTE\", label: \"–ó–∞–º–¥\" },\r\n  { id: \"DELIVERED\", label: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\" },\r\n];\r\n\r\n// ---------- DRIVER TABS (UI) ----------\r\nexport type DriverTabId =\r\n  | \"OPEN\"\r\n  | \"REQUESTS\" // OPEN + myBid\r\n  | \"ASSIGNED\"\r\n  | \"ON_ROUTE\"\r\n  | \"DELIVERED\";\r\n\r\nexport const DRIVER_TABS: { id: DriverTabId; label: string }[] = [\r\n  { id: \"OPEN\", label: \"–ù—ç—ç–ª—Ç—Ç—ç–π\" },\r\n  { id: \"REQUESTS\", label: \"–•“Ø—Å—ç–ª—Ç\" },\r\n  { id: \"ASSIGNED\", label: \"–ù–∞–º–∞–π–≥ —Å–æ–Ω–≥–æ—Å–æ–Ω\" },\r\n  { id: \"ON_ROUTE\", label: \"–ó–∞–º–¥\" },\r\n  { id: \"DELIVERED\", label: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\" },\r\n];\r\n\r\n// ---------- LABELS ----------\r\nexport function statusLabel(status: DeliveryStatus): string {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return \"–ù—ç—ç–ª—Ç—Ç—ç–π\";\r\n    case \"ASSIGNED\":\r\n      return \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\";\r\n    case \"ON_ROUTE\":\r\n      return \"–ó–∞–º–¥\";\r\n    case \"DELIVERED\":\r\n      return \"–•“Ø—Ä–≥—ç—Å—ç–Ω\";\r\n    case \"PAID\":\r\n      return \"–¢”©–ª—Å”©–Ω\";\r\n    case \"DISPUTE\":\r\n      return \"–ú–∞—Ä–≥–∞–∞–Ω\";\r\n    case \"CLOSED\":\r\n      return \"–•–∞–∞–≥–¥—Å–∞–Ω\";\r\n    case \"CANCELLED\":\r\n      return \"–¶—É—Ü–∞–ª—Å–∞–Ω\";\r\n    default:\r\n      return status;\r\n  }\r\n}\r\n\r\n// ---------- CLOSED ----------\r\nexport function isClosedStatus(status: DeliveryStatus): boolean {\r\n  // ‚ùó –ñ–∏–Ω—Ö—ç–Ω—ç —Ö–∞–∞–ª—Ç –±–æ–ª CLOSED. CANCELLED –±–æ–ª legacy.\r\n  return status === \"CLOSED\" || status === \"CANCELLED\";\r\n}\r\n\r\n// ---------- STATUS -> TAB (UI MAPPING) ----------\r\nexport function getSellerTabForStatus(status: DeliveryStatus): SellerTabId {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return \"OPEN\";\r\n    case \"ASSIGNED\":\r\n      return \"ASSIGNED\";\r\n    case \"ON_ROUTE\":\r\n      return \"ON_ROUTE\";\r\n    case \"DELIVERED\":\r\n    case \"PAID\":\r\n    case \"DISPUTE\":\r\n    case \"CLOSED\":\r\n    case \"CANCELLED\":\r\n    default:\r\n      // ‚úÖ –ë“Æ–• legacy —Å—Ç–∞—Ç—É—Å—É—É–¥—ã–≥ DELIVERED —Ç–∞–± –¥—ç—ç—Ä –Ω—ç–≥—Ç–≥—ç–Ω—ç\r\n      return \"DELIVERED\";\r\n  }\r\n}\r\n\r\n// REQUESTS —ç–Ω–¥ –æ—Ä–æ—Ö–≥“Ø–π (UI –¥—ç—ç—Ä OPEN + myBid-–∞–∞—Ä —Å–∞–ª–≥–∞–Ω–∞)\r\nexport function getDriverTabForStatus(\r\n  status: DeliveryStatus\r\n): Exclude<DriverTabId, \"REQUESTS\"> {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return \"OPEN\";\r\n    case \"ASSIGNED\":\r\n      return \"ASSIGNED\";\r\n    case \"ON_ROUTE\":\r\n      return \"ON_ROUTE\";\r\n    case \"DELIVERED\":\r\n    case \"PAID\":\r\n    case \"DISPUTE\":\r\n    case \"CLOSED\":\r\n    case \"CANCELLED\":\r\n    default:\r\n      // ‚úÖ –ë“Æ–• legacy —Å—Ç–∞—Ç—É—Å—É—É–¥—ã–≥ DELIVERED —Ç–∞–± –¥—ç—ç—Ä –Ω—ç–≥—Ç–≥—ç–Ω—ç\r\n      return \"DELIVERED\";\r\n  }\r\n}\r\n\r\n// ---------- HELPERS ----------\r\nfunction hasTs(v: any): boolean {\r\n  return !!v;\r\n}\r\nfunction bool(v: any): boolean {\r\n  return !!v;\r\n}\r\n\r\n// ---------- PERMISSIONS ----------\r\n\r\n// ASSIGNED ‚Üí ON_ROUTE\r\nexport function canDriverMarkOnRoute(input: {\r\n  status: DeliveryStatus;\r\n  picked_up_at?: string | null;\r\n  chosen_driver_id?: string | null;\r\n  me_driver_id?: string;\r\n}): boolean {\r\n  if (isClosedStatus(input.status)) return false;\r\n\r\n  const isMine =\r\n    !input.me_driver_id || !input.chosen_driver_id\r\n      ? true\r\n      : input.chosen_driver_id === input.me_driver_id;\r\n\r\n  if (!isMine) return false;\r\n  if (input.status !== \"ASSIGNED\") return false;\r\n  if (hasTs(input.picked_up_at)) return false;\r\n\r\n  return true;\r\n}\r\n\r\n// ON_ROUTE ‚Üí DELIVERED\r\nexport function canDriverMarkDelivered(input: {\r\n  status: DeliveryStatus;\r\n  delivered_at?: string | null;\r\n  chosen_driver_id?: string | null;\r\n  me_driver_id?: string;\r\n}): boolean {\r\n  if (isClosedStatus(input.status)) return false;\r\n\r\n  const isMine =\r\n    !input.me_driver_id || !input.chosen_driver_id\r\n      ? true\r\n      : input.chosen_driver_id === input.me_driver_id;\r\n\r\n  if (!isMine) return false;\r\n  if (input.status !== \"ON_ROUTE\") return false;\r\n  if (hasTs(input.delivered_at)) return false;\r\n\r\n  return true;\r\n}\r\n\r\n// DELIVERED ‚Üí PAID (Seller) ‚Äî legacy —Ö—ç–≤—ç—ç—Ä “Ø–ª–¥—ç—ç–Ω—ç (UI —Ç–æ–≤—á –±–∞–π—Ö–≥“Ø–π –±–∞–π–∂ –±–æ–ª–Ω–æ)\r\nexport function canSellerMarkPaid(input: {\r\n  status: DeliveryStatus;\r\n  seller_paid_at?: string | null;\r\n  seller_marked_paid?: boolean;\r\n}): boolean {\r\n  if (isClosedStatus(input.status)) return false;\r\n  if (input.status !== \"DELIVERED\") return false;\r\n\r\n  if (input.seller_paid_at !== undefined) {\r\n    return !hasTs(input.seller_paid_at);\r\n  }\r\n  return !bool(input.seller_marked_paid);\r\n}\r\n\r\n// PAID ‚Üí CLOSED (Driver) ‚Äî legacy —Ö—ç–≤—ç—ç—Ä “Ø–ª–¥—ç—ç–Ω—ç (UI —Ç–æ–≤—á –±–∞–π—Ö–≥“Ø–π –±–∞–π–∂ –±–æ–ª–Ω–æ)\r\nexport function canDriverConfirmPaymentReceived(input: {\r\n  status: DeliveryStatus;\r\n  driver_paid_confirmed_at?: string | null;\r\n  driver_confirmed_payment?: boolean;\r\n}): boolean {\r\n  if (isClosedStatus(input.status)) return false;\r\n  if (input.status !== \"PAID\") return false;\r\n\r\n  if (input.driver_paid_confirmed_at !== undefined) {\r\n    return !hasTs(input.driver_paid_confirmed_at);\r\n  }\r\n  return !bool(input.driver_confirmed_payment);\r\n}\r\n\r\n// üîß ALIAS (IMPORT ERROR-–ò–ô–ì –ë“Æ–†–≠–ù –®–ò–ô–î–ù–≠)\r\n// app/driver/page.tsx –¥—ç—ç—Ä `canDriverConfirmPayment` –≥—ç–∂ –∞—à–∏–≥–ª–∞–∂ –±–∞–π–≥–∞–∞ —Ç—É–ª\r\n// —è–≥ —ç–Ω—ç –Ω—ç—Ä—Ç—ç–π export-—ã–≥ –∑–æ—Ä–∏—É–¥–∞–∞—Ä –≥–∞—Ä–≥–∞–∂ ”©–≥–Ω”©.\r\nexport function canDriverConfirmPayment(input: {\r\n  status: DeliveryStatus;\r\n  driver_confirmed_payment?: boolean;\r\n}): boolean {\r\n  return canDriverConfirmPaymentReceived({\r\n    status: input.status,\r\n    driver_confirmed_payment: input.driver_confirmed_payment,\r\n  });\r\n}\r\n\r\n// ---------- DISPUTE (legacy —Ö—ç–≤—ç—ç—Ä “Ø–ª–¥—ç—ç–Ω—ç) ----------\r\nexport function canOpenDispute(status: DeliveryStatus): boolean {\r\n  if (isClosedStatus(status)) return false;\r\n  return status === \"ON_ROUTE\" || status === \"DELIVERED\" || status === \"PAID\";\r\n}\r\n\r\nexport function canResolveDispute(input: {\r\n  status: DeliveryStatus;\r\n  dispute_status?: \"none\" | \"open\" | \"resolved\" | string | null;\r\n}): boolean {\r\n  if (isClosedStatus(input.status)) return false;\r\n  if (input.status !== \"DISPUTE\") return false;\r\n\r\n  if (input.dispute_status !== undefined && input.dispute_status !== null) {\r\n    return String(input.dispute_status) === \"open\";\r\n  }\r\n  return true;\r\n}\r\n\r\n// PAID –¥—ç—ç—Ä 2 —Ç–∞–ª –±–∞—Ç–∞–ª–≥–∞–∞–∂–≤–∞–ª —Ö–∞–∞—Ö —ç—Å—ç—Ö (legacy)\r\nexport function shouldCloseDelivery(input: {\r\n  status: DeliveryStatus;\r\n  seller_marked_paid?: boolean;\r\n  driver_confirmed_payment?: boolean;\r\n  seller_paid_at?: string | null;\r\n  driver_paid_confirmed_at?: string | null;\r\n}): boolean {\r\n  if (input.status !== \"PAID\") return false;\r\n\r\n  if (\r\n    input.seller_paid_at !== undefined &&\r\n    input.driver_paid_confirmed_at !== undefined\r\n  ) {\r\n    return hasTs(input.seller_paid_at) && hasTs(input.driver_paid_confirmed_at);\r\n  }\r\n  return bool(input.seller_marked_paid) && bool(input.driver_confirmed_payment);\r\n}\r\n"
      },
      {
        "path": "lib/supabase.ts",
        "summary": "",
        "content": "// lib/supabase.ts\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nexport const supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n);\r\n"
      },
      {
        "path": "lib/types.ts",
        "summary": "",
        "content": "// lib/types.ts\r\n// –ê–ø–ø –¥–∞—è–∞—Ä –∞—à–∏–≥–ª–∞—Ö “Ø–Ω–¥—Å—ç–Ω —Ç”©—Ä–ª“Ø“Ø–¥\r\n\r\nexport type Role = \"seller\" | \"driver\";\r\n\r\nexport type IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n"
      },
      {
        "path": "lib/ub_admin.ts",
        "summary": "",
        "content": "// src/lib/ub_admin.ts\r\nexport type UBDistrictKey =\r\n  | \"–ë–∞–≥–∞—Ö–∞–Ω–≥–∞–π\"\r\n  | \"–ë–∞–≥–∞–Ω—É—É—Ä\"\r\n  | \"–ë–∞—è–Ω–≥–æ–ª\"\r\n  | \"–ë–∞—è–Ω–∑“Ø—Ä—Ö\"\r\n  | \"–ß–∏–Ω–≥—ç–ª—Ç—ç–π\"\r\n  | \"–•–∞–Ω-–£—É–ª\"\r\n  | \"–ù–∞–ª–∞–π—Ö\"\r\n  | \"–°–æ–Ω–≥–∏–Ω–æ—Ö–∞–π—Ä—Ö–∞–Ω\"\r\n  | \"–°“Ø—Ö–±–∞–∞—Ç–∞—Ä\";\r\n\r\nexport const UB_DISTRICTS: { key: UBDistrictKey; khorooCount: number }[] = [\r\n  { key: \"–ë–∞–≥–∞—Ö–∞–Ω–≥–∞–π\", khorooCount: 2 },\r\n  { key: \"–ë–∞–≥–∞–Ω—É—É—Ä\", khorooCount: 5 },\r\n  { key: \"–ë–∞—è–Ω–≥–æ–ª\", khorooCount: 34 },\r\n  { key: \"–ë–∞—è–Ω–∑“Ø—Ä—Ö\", khorooCount: 43 },\r\n  { key: \"–ß–∏–Ω–≥—ç–ª—Ç—ç–π\", khorooCount: 24 },\r\n  { key: \"–•–∞–Ω-–£—É–ª\", khorooCount: 25 },\r\n  { key: \"–ù–∞–ª–∞–π—Ö\", khorooCount: 8 },\r\n  { key: \"–°–æ–Ω–≥–∏–Ω–æ—Ö–∞–π—Ä—Ö–∞–Ω\", khorooCount: 43 },\r\n  { key: \"–°“Ø—Ö–±–∞–∞—Ç–∞—Ä\", khorooCount: 20 },\r\n];\r\n\r\nexport function getDistrictOptions() {\r\n  return UB_DISTRICTS.map((d) => ({ value: d.key, label: d.key }));\r\n}\r\n\r\nexport function getKhorooOptions(district?: string) {\r\n  const d = UB_DISTRICTS.find((x) => x.key === district);\r\n  if (!d) return [];\r\n  return Array.from({ length: d.khorooCount }, (_, i) => {\r\n    const n = i + 1;\r\n    return { value: String(n), label: `${n}-—Ä —Ö–æ—Ä–æ–æ` };\r\n  });\r\n}\r\n"
      }
    ]
  }
}