{
  "income-app": {
    "files": [
      {
        "path": "app/api/dev-review/route.ts",
        "summary": "",
        "content": "// app/api/dev-review/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport OpenAI from \"openai\";\r\n\r\nexport const runtime = \"nodejs\"; // OpenAI SDK-—Ç –∏–ª“Ø“Ø –Ω–∞–π–¥–≤–∞—Ä—Ç–∞–π\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n    const { code, instruction } = body || {};\r\n\r\n    if (!code || !instruction) {\r\n      return NextResponse.json(\r\n        { error: \"code –±–æ–ª–æ–Ω instruction —Ö–æ—ë—É–ª –∑–∞–∞–≤–∞–ª —Ö—ç—Ä—ç–≥—Ç—ç–π.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // API key –±–∞–π—Ö–≥“Ø–π “Ø–µ–¥ —à—É—É–¥ –æ–π–ª–≥–æ–º–∂—Ç–æ–π —Ö–∞—Ä–∏—É ”©–≥”©—Ö (–∞–ª–¥–∞–∞ —Ü–∞—Ü–∞—Ö–≥“Ø–π)\r\n    if (!process.env.OPENAI_API_KEY) {\r\n      return NextResponse.json(\r\n        {\r\n          result:\r\n            \"OPENAI_API_KEY —Ç–æ—Ö–∏—Ä—É—É–ª–∞–≥–¥–∞–∞–≥“Ø–π –±–∞–π–Ω–∞. .env.local –¥–æ—Ç–æ—Ä OPENAI_API_KEY=... –≥—ç–∂ –Ω—ç–º—ç—ç–¥ dev —Å–µ—Ä–≤–µ—Ä—ç—ç –¥–∞—Ö–∏–Ω –∞—Å–∞–∞–Ω–∞ —É—É.\",\r\n        },\r\n        { status: 200 }\r\n      );\r\n    }\r\n\r\n    const client = new OpenAI({\r\n      apiKey: process.env.OPENAI_API_KEY!,\r\n    });\r\n\r\n    const response = await client.chat.completions.create({\r\n      model: \"gpt-4.1-mini\",\r\n      temperature: 0.2,\r\n      messages: [\r\n        {\r\n          role: \"system\",\r\n          content:\r\n            \"–¢–∞ —Ç—É—Ä—à–ª–∞–≥–∞—Ç–∞–π full-stack –∏–Ω–∂–µ–Ω–µ—Ä. ”®–≥”©–≥–¥—Å”©–Ω –∫–æ–¥—ã–≥ —ç–≤–¥—ç–ª–≥“Ø–π–≥—ç—ç—Ä –∞–ª–¥–∞–∞, —Å–∞–π–∂—Ä—É—É–ª–∞–ª—Ç, —Ä–µ—Ñ–∞–∫—Ç–æ—Ä, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã–Ω –∑”©–≤–ª”©–≥”©”© ”©–≥–Ω”©.\",\r\n        },\r\n        {\r\n          role: \"user\",\r\n          content: `\r\n=== –ê–°–£–£–õ–¢ / –ó–ê–ê–í–ê–† ===\r\n${instruction}\r\n\r\n=== –ö–û–î ===\r\n${code}\r\n          `,\r\n        },\r\n      ],\r\n    });\r\n\r\n    const result = response.choices?.[0]?.message?.content || \"No response\";\r\n\r\n    return NextResponse.json({ result }, { status: 200 });\r\n  } catch (err) {\r\n    console.error(\"DEV-REVIEW ERROR:\", err);\r\n    return NextResponse.json(\r\n      { error: \"–°–µ—Ä–≤–µ—Ä–∏–π–Ω –∞–ª–¥–∞–∞ (dev-review route).\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"
      },
      {
        "path": "app/dev-console/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport projectsData from \"@/data/projects.json\";\r\n\r\n// projects.json –¥–æ—Ç–æ—Ä—Ö –Ω—ç–≥ —Ñ–∞–π–ª—ã–Ω –±“Ø—Ç—ç—Ü\r\ntype ProjectFile = {\r\n  path: string;\r\n  content: string;\r\n  summary?: string;\r\n};\r\n\r\n// projects.json –±“Ø—Ö—ç–ª–¥—ç—ç\r\ntype ProjectsMap = {\r\n  [project: string]: {\r\n    files: ProjectFile[];\r\n  };\r\n};\r\n\r\n// JSON-—ã–≥ type-—Ç–∞–π –±–æ–ª–≥–æ—Ö\r\nconst projects = projectsData as ProjectsMap;\r\n\r\nexport default function DevConsolePage() {\r\n  // –û–¥–æ–æ–≥–æ–æ—Ä –∑”©–≤—Ö”©–Ω \"income-app\" —Ç”©—Å–ª–∏–π–≥ —É–Ω—à–∏–Ω–∞\r\n  const files: ProjectFile[] = projects[\"income-app\"]?.files ?? [];\r\n\r\n  const [selectedPath, setSelectedPath] = useState(\"\");\r\n  const [code, setCode] = useState(\"\");\r\n  const [instruction, setInstruction] = useState(\"\");\r\n  const [result, setResult] = useState(\"\");\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  // –§–∞–π–ª —Å–æ–Ω–≥–æ—Ö–æ–¥ –∫–æ–¥—ã–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä —Ö–∞—Ä—É—É–ª–∞—Ö\r\n  function handleSelect(path: string) {\r\n    setSelectedPath(path);\r\n\r\n    const f = files.find((x) => x.path === path);\r\n    if (f) {\r\n      setCode(f.content);\r\n    } else {\r\n      setCode(\"\");\r\n    }\r\n  }\r\n\r\n  // Review API —Ä—É—É –∏–ª–≥—ç—ç—Ö\r\n  async function runReview() {\r\n    if (!instruction.trim()) {\r\n      alert(\"Instruction —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞!\");\r\n      return;\r\n    }\r\n\r\n    if (!code.trim()) {\r\n      alert(\"–ö–æ–¥ —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞!\");\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setResult(\"\");\r\n\r\n    try {\r\n      const res = await fetch(\"/api/dev-review\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({\r\n          code,\r\n          instruction,\r\n        }),\r\n      });\r\n\r\n      const json = await res.json();\r\n      setResult(json.result || json.error || \"No response\");\r\n    } catch (err: any) {\r\n      setResult(\"–•–æ–ª–±–æ–ª—Ç—ã–Ω –∞–ª–¥–∞–∞: \" + (err?.message ?? \"unknown\"));\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 space-y-6 max-w-5xl mx-auto\">\r\n      <h1 className=\"text-2xl font-bold\">AI Dev Console V1</h1>\r\n      <p className=\"text-sm text-gray-600\">\r\n        income-app —Ç”©—Å–ª–∏–π–Ω —Ñ–∞–π–ª–∞–∞ —Å–æ–Ω–≥–æ–æ–¥, AI-–∞–∞—Å –∫–æ–¥—ã–Ω –∞–Ω–∞–ª–∏–∑, —Å–∞–π–∂—Ä—É—É–ª–∞–ª—Ç—ã–Ω\r\n        —Å–∞–Ω–∞–ª –∞–≤–Ω–∞.\r\n      </p>\r\n\r\n      {/* –§–ê–ô–õ –°–û–ù–ì–û–ì–ß */}\r\n      <div>\r\n        <label className=\"font-semibold\">–§–∞–π–ª —Å–æ–Ω–≥–æ—Ö</label>\r\n        <select\r\n          className=\"border p-2 rounded w-full mt-1\"\r\n          value={selectedPath}\r\n          onChange={(e) => handleSelect(e.target.value)}\r\n        >\r\n          <option value=\"\">-- –§–∞–π–ª —Å–æ–Ω–≥–æ --</option>\r\n          {files.map((f) => (\r\n            <option key={f.path} value={f.path}>\r\n              {f.path}\r\n            </option>\r\n          ))}\r\n        </select>\r\n      </div>\r\n\r\n      {/* INSTRUCTION */}\r\n      <div>\r\n        <label className=\"font-semibold\">Instruction</label>\r\n        <textarea\r\n          className=\"border p-2 rounded w-full h-24 mt-1\"\r\n          placeholder='–ñ: \"–ú–∞—Ä–≥–∞–∞–Ω—ã —Ç–∞–± –¥—ç—ç—Ä notification badge –Ω—ç–º, –ª–æ–≥–∏–∫–∏–π–≥ —Ç–∞–π–ª–±–∞—Ä–ª–∞\"'\r\n          value={instruction}\r\n          onChange={(e) => setInstruction(e.target.value)}\r\n        />\r\n      </div>\r\n\r\n      {/* CODE VIEW */}\r\n      <div>\r\n        <label className=\"font-semibold\">–ö–æ–¥ (—É–Ω—à–∏—Ö —Ö—ç—Å—ç–≥)</label>\r\n        <textarea\r\n          className=\"border p-2 rounded w-full h-64 mt-1 font-mono text-sm\"\r\n          value={code}\r\n          onChange={(e) => setCode(e.target.value)}\r\n        />\r\n      </div>\r\n\r\n      {/* RUN BUTTON */}\r\n      <button\r\n        onClick={runReview}\r\n        disabled={loading}\r\n        className=\"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-60\"\r\n      >\r\n        {loading ? \"–ê–Ω–∞–ª–∏–∑ —Ö–∏–π–∂ –±–∞–π–Ω–∞...\" : \"AI Review –∞–∂–∏–ª–ª—É—É–ª–∞—Ö\"}\r\n      </button>\r\n\r\n      {/* RESULT */}\r\n      <div>\r\n        <label className=\"font-semibold\">“Æ—Ä –¥“Ø–Ω</label>\r\n        <textarea\r\n          className=\"border p-2 rounded w-full h-64 mt-1 bg-gray-50 text-sm\"\r\n          value={result}\r\n          readOnly\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/driver/delivery/[id]/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n// =================== 1. –ò–º–ø–æ—Ä—Ç, —Ç”©—Ä–ª“Ø“Ø–¥ ===================\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useRouter, useParams, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { DeliveryStatus } from \"@/lib/deliveryLogic\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryDetail = {\r\n  id: string;\r\n  seller_id: string;\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n  chosen_driver_id: string | null;\r\n\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n  closed_at: string | null;\r\n\r\n  // üîπ –ú–∞—Ä–≥–∞–∞–Ω—ã —Ç–∞–ª–±–∞—Ä—É—É–¥\r\n  dispute_reason?: string | null;\r\n  dispute_opened_at?: string | null;\r\n\r\n  // seller info\r\n  seller_name?: string | null;\r\n  seller_phone?: string | null;\r\n};\r\n\r\ntype DriverBidRow = {\r\n  id: string;\r\n  delivery_id: string;\r\n  driver_id: string;\r\n  created_at: string;\r\n};\r\n\r\ntype DriverOwnBid = DriverBidRow | null;\r\n\r\n// =================== 2. –¢—É—Å–ª–∞—Ö —Ñ—É–Ω–∫—Ü—É—É–¥ ===================\r\n\r\nfunction typeLabel(\r\n  deliveryType: string | null\r\n): { icon: string; label: string } {\r\n  switch (deliveryType) {\r\n    case \"apartment\":\r\n      return { icon: \"üèô\", label: \"–ë–∞–π—Ä\" };\r\n    case \"ger\":\r\n      return { icon: \"üè†\", label: \"–ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª\" };\r\n    case \"camp\":\r\n      return { icon: \"üèï\", label: \"–õ–∞–≥–µ—Ä\" };\r\n    case \"countryside\":\r\n      return { icon: \"üöå\", label: \"–û—Ä–æ–Ω –Ω—É—Ç–∞–≥\" };\r\n    default:\r\n      return { icon: \"üì¶\", label: \"–•“Ø—Ä–≥—ç–ª—Ç\" };\r\n  }\r\n}\r\n\r\nfunction statusBadge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return {\r\n        text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\",\r\n        className: \"bg-emerald-50 text-emerald-700 border-emerald-100\",\r\n      };\r\n    case \"ASSIGNED\":\r\n      return {\r\n        text: \"–¢–∞–Ω–¥ –æ–Ω–æ–æ—Å–æ–Ω\",\r\n        className: \"bg-sky-50 text-sky-700 border-sky-100\",\r\n      };\r\n    case \"ON_ROUTE\":\r\n      return {\r\n        text: \"–ó–∞–º–¥\",\r\n        className: \"bg-indigo-50 text-indigo-700 border-indigo-100\",\r\n      };\r\n    case \"DELIVERED\":\r\n      return {\r\n        text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\",\r\n        className: \"bg-slate-900 text-white border-slate-900\",\r\n      };\r\n    case \"CLOSED\":\r\n      return {\r\n        text: \"–•–∞–∞–≥–¥—Å–∞–Ω\",\r\n        className: \"bg-slate-800 text-slate-50 border-slate-800\",\r\n      };\r\n    case \"CANCELLED\":\r\n      return {\r\n        text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\",\r\n        className: \"bg-rose-50 text-rose-700 border-rose-100\",\r\n      };\r\n    case \"DISPUTE\":\r\n      return {\r\n        text: \"–ú–∞—Ä–≥–∞–∞–Ω\",\r\n        className: \"bg-rose-50 text-rose-700 border-rose-100\",\r\n      };\r\n    default:\r\n      return {\r\n        text: status,\r\n        className: \"bg-slate-50 text-slate-600 border-slate-100\",\r\n      };\r\n  }\r\n}\r\n\r\nfunction shorten(s: string | null, max = 120) {\r\n  if (!s) return \"\";\r\n  const t = s.trim();\r\n  if (t.length <= max) return t;\r\n  return t.slice(0, max).replace(/\\s+$/, \"\") + \"‚Ä¶\";\r\n}\r\n\r\nfunction formatPrice(n: number | null) {\r\n  if (!n) return \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n  return n.toLocaleString(\"mn-MN\") + \"‚ÇÆ\";\r\n}\r\n\r\nfunction formatDateTime(iso: string | null | undefined) {\r\n  if (!iso) return \"\";\r\n  const d = new Date(iso);\r\n  return (\r\n    d.toLocaleDateString(\"mn-MN\", { month: \"2-digit\", day: \"2-digit\" }) +\r\n    \" \" +\r\n    d.toLocaleTimeString(\"mn-MN\", { hour: \"2-digit\", minute: \"2-digit\" })\r\n  );\r\n}\r\n\r\nfunction mapsUrl(addr: string | null) {\r\n  if (!addr) return \"\";\r\n  const q = encodeURIComponent(addr);\r\n  return `https://maps.google.com/?q=${q}`;\r\n}\r\n\r\n// =================== 3. –ì–æ–ª –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ===================\r\n\r\nexport default function DriverDeliveryDetailPage() {\r\n  const router = useRouter();\r\n  const params = useParams();\r\n  const searchParams = useSearchParams();\r\n\r\n  const idParam = (params as any)?.id;\r\n  const deliveryId =\r\n    typeof idParam === \"string\"\r\n      ? idParam\r\n      : Array.isArray(idParam)\r\n      ? idParam[0]\r\n      : \"\";\r\n\r\n  const fromTab = searchParams.get(\"tab\");\r\n  const backUrl = fromTab ? `/driver?tab=${fromTab}` : \"/driver\";\r\n\r\n  // ---- —Ç”©–ª”©–≤“Ø“Ø–¥ ----\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [loadingUser, setLoadingUser] = useState(true);\r\n\r\n  const [delivery, setDelivery] = useState<DeliveryDetail | null>(null);\r\n  const [loadingDetail, setLoadingDetail] = useState(true);\r\n\r\n  const [ownBid, setOwnBid] = useState<DriverOwnBid>(null);\r\n  const [loadingBid, setLoadingBid] = useState(true);\r\n\r\n  // action-—É—É–¥—ã–Ω loading\r\n  const [requesting, setRequesting] = useState(false);\r\n  const [cancelingBid, setCancelingBid] = useState(false); // ‚úÖ –®–∏–Ω—ç: —Ö“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö loading\r\n  const [markingOnRoute, setMarkingOnRoute] = useState(false);\r\n  const [markingDelivered, setMarkingDelivered] = useState(false);\r\n  const [confirmPayLoading, setConfirmPayLoading] = useState(false);\r\n\r\n  // –ú–∞—Ä–≥–∞–∞–Ω\r\n  const [showDisputeModal, setShowDisputeModal] = useState(false);\r\n  const [disputeReason, setDisputeReason] = useState(\"\");\r\n  const [openingDispute, setOpeningDispute] = useState(false);\r\n\r\n  const [message, setMessage] = useState<string | null>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // =================== 4. Login guard ===================\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) {\r\n        router.replace(\"/\");\r\n        return;\r\n      }\r\n      const parsed: IncomeUser = JSON.parse(raw);\r\n      if (parsed.role !== \"driver\") {\r\n        router.replace(\"/\");\r\n        return;\r\n      }\r\n      setUser(parsed);\r\n      setLoadingUser(false);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —É–Ω—à–∏—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      setLoadingUser(false);\r\n    }\r\n  }, [router]);\r\n\r\n  // =================== 5. –•“Ø—Ä–≥—ç–ª—Ç + ”©”©—Ä–∏–π–Ω bid —Ç–∞—Ç–∞—Ö ===================\r\n\r\n  useEffect(() => {\r\n    if (!user || !deliveryId) return;\r\n    void fetchDetailAndBid(user.id, deliveryId);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user, deliveryId]);\r\n\r\n  async function fetchDetailAndBid(driverId: string, id: string) {\r\n    try {\r\n      setLoadingDetail(true);\r\n      setLoadingBid(true);\r\n      setError(null);\r\n      setMessage(null);\r\n\r\n      // 5.1 –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π\r\n      const { data, error } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          seller_id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          chosen_driver_id,\r\n          seller_marked_paid,\r\n          driver_confirmed_payment,\r\n          closed_at,\r\n          dispute_reason,\r\n          dispute_opened_at,\r\n          seller:seller_id (\r\n            name,\r\n            phone\r\n          )\r\n        `\r\n        )\r\n        .eq(\"id\", id)\r\n        .maybeSingle();\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        setDelivery(null);\r\n      } else if (!data) {\r\n        setError(\"–ò–π–º —Ö“Ø—Ä–≥—ç–ª—Ç –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\");\r\n        setDelivery(null);\r\n      } else {\r\n        const d = data as any;\r\n        const detail: DeliveryDetail = {\r\n          id: d.id,\r\n          seller_id: d.seller_id,\r\n          from_address: d.from_address,\r\n          to_address: d.to_address,\r\n          note: d.note,\r\n          status: d.status as DeliveryStatus,\r\n          created_at: d.created_at,\r\n          price_mnt: d.price_mnt,\r\n          delivery_type: d.delivery_type,\r\n          chosen_driver_id: d.chosen_driver_id,\r\n          seller_marked_paid: !!d.seller_marked_paid,\r\n          driver_confirmed_payment: !!d.driver_confirmed_payment,\r\n          closed_at: d.closed_at,\r\n          dispute_reason: d.dispute_reason ?? null,\r\n          dispute_opened_at: d.dispute_opened_at ?? null,\r\n          seller_name: d.seller?.name ?? null,\r\n          seller_phone: d.seller?.phone ?? null,\r\n        };\r\n        setDelivery(detail);\r\n      }\r\n\r\n      setLoadingDetail(false);\r\n\r\n      // 5.2 –≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä—Ö ”©”©—Ä–∏–π–Ω bid –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö\r\n      const { data: bidData, error: bidError } = await supabase\r\n        .from(\"driver_bids\")\r\n        .select(\"id, delivery_id, driver_id, created_at\")\r\n        .eq(\"delivery_id\", id)\r\n        .eq(\"driver_id\", driverId)\r\n        .maybeSingle();\r\n\r\n      if (bidError && bidError.code !== \"PGRST116\") {\r\n        console.error(\"BID LOAD ERROR:\", bidError);\r\n      }\r\n\r\n      if (!bidError && bidData) {\r\n        setOwnBid(bidData as DriverBidRow);\r\n      } else {\r\n        setOwnBid(null);\r\n      }\r\n\r\n      setLoadingBid(false);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–ú—ç–¥—ç—ç–ª—ç–ª —Ç–∞—Ç–∞—Ö —è–≤—Ü–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      setLoadingDetail(false);\r\n      setLoadingBid(false);\r\n    }\r\n  }\r\n\r\n  // =================== 6. –ì–∞—Ä–∞—Ö ===================\r\n\r\n  function handleLogout() {\r\n    if (typeof window !== \"undefined\") {\r\n      window.localStorage.removeItem(\"incomeUser\");\r\n    }\r\n    router.push(\"/\");\r\n  }\r\n\r\n  // =================== 7. –ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Ö (OPEN “Ø–µ–¥) ===================\r\n\r\n  async function handleRequestDelivery() {\r\n    if (!user || !delivery) return;\r\n\r\n    if (delivery.status !== \"OPEN\") {\r\n      setMessage(\"–ó”©–≤—Ö”©–Ω –Ω—ç—ç–ª—Ç—Ç—ç–π —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä –∞–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –≥–∞—Ä–≥–∞–∂ –±–æ–ª–Ω–æ.\");\r\n      return;\r\n    }\r\n\r\n    if (ownBid) {\r\n      setMessage(\"–¢–∞ –∞–ª—å —Ö—ç–¥–∏–π–Ω —ç–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä –∞–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Å—ç–Ω –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    setRequesting(true);\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"driver_bids\")\r\n        .insert({\r\n          delivery_id: delivery.id,\r\n          driver_id: user.id,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setOwnBid(data as DriverBidRow);\r\n      setMessage(\"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –∞–º–∂–∏–ª—Ç—Ç–∞–π –∏–ª–≥—ç—ç–≥–¥–ª—ç—ç.\");\r\n    } finally {\r\n      setRequesting(false);\r\n    }\r\n  }\r\n\r\n  // ‚úÖ –®–∏–Ω—ç: ”©”©—Ä–∏–π–Ω —Ö“Ø—Å—ç–ª—Ç (bid)-—ç—ç —Ü—É—Ü–ª–∞—Ö\r\n  async function handleCancelMyBid() {\r\n    if (!user || !delivery || !ownBid) return;\r\n\r\n    if (delivery.status !== \"OPEN\") {\r\n      setError(\"–ó”©–≤—Ö”©–Ω –Ω—ç—ç–ª—Ç—Ç—ç–π —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä —Ö“Ø—Å—ç–ª—Ç—ç—ç —Ü—É—Ü–∞–ª–∂ –±–æ–ª–Ω–æ.\");\r\n      return;\r\n    }\r\n\r\n    setCancelingBid(true);\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"driver_bids\")\r\n        .delete()\r\n        .eq(\"id\", ownBid.id)\r\n        .eq(\"driver_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setOwnBid(null);\r\n      setMessage(\"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞–≥–¥–ª–∞–∞.\");\r\n\r\n      // ‚úÖ –ù—ç—ç–ª—Ç—Ç—ç–π —Ö“Ø—Ä–≥—ç–ª—Ç —Ç–∞–± —Ä—É—É –±—É—Ü–∞–∞–Ω–∞\r\n      router.push(\"/driver?tab=OPEN\");\r\n    } finally {\r\n      setCancelingBid(false);\r\n    }\r\n  }\r\n\r\n  // =================== 8. –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —è–≤—Ü—ã–Ω —Å—Ç–∞—Ç—É—Å ”©”©—Ä—á–ª”©—Ö ===================\r\n\r\n  async function updateStatus(newStatus: DeliveryStatus) {\r\n    if (!user || !delivery) return;\r\n\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    let setter: (v: boolean) => void = () => {};\r\n    if (newStatus === \"ON_ROUTE\") setter = setMarkingOnRoute;\r\n    if (newStatus === \"DELIVERED\") setter = setMarkingDelivered;\r\n\r\n    setter(true);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: newStatus })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"chosen_driver_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–°—Ç–∞—Ç—É—Å ”©”©—Ä—á–ª”©—Ö”©–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: newStatus });\r\n\r\n      if (newStatus === \"ON_ROUTE\") {\r\n        setMessage(\"–ë–∞—Ä–∞–∞–≥ –∞–≤—á, —Ö“Ø—Ä–≥—ç–ª—Ç—ç–¥ –≥–∞—Ä–ª–∞–∞ –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\");\r\n      } else if (newStatus === \"DELIVERED\") {\r\n        setMessage(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ –∞–º–∂–∏–ª—Ç—Ç–∞–π –¥—É—É—Å—Å–∞–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\");\r\n      }\r\n    } finally {\r\n      setter(false);\r\n    }\r\n  }\r\n\r\n  async function handleMarkOnRoute() {\r\n    if (!delivery || !user) return;\r\n    if (\r\n      delivery.status !== \"ASSIGNED\" ||\r\n      delivery.chosen_driver_id !== user.id\r\n    ) {\r\n      setMessage(\"–≠—Ö–ª—ç—ç–¥ —ç–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ç–∞–Ω–¥ –æ–Ω–æ–æ–≥–¥—Å–æ–Ω –±–∞–π—Ö —ë—Å—Ç–æ–π.\");\r\n      return;\r\n    }\r\n    await updateStatus(\"ON_ROUTE\");\r\n  }\r\n\r\n  async function handleMarkDelivered() {\r\n    if (!delivery || !user) return;\r\n    if (\r\n      delivery.status !== \"ON_ROUTE\" ||\r\n      delivery.chosen_driver_id !== user.id\r\n    ) {\r\n      setMessage(\"–ó”©–≤—Ö”©–Ω –∑–∞–º–¥ –±–∞–π–≥–∞–∞ —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ —Ö“Ø—Ä–≥—ç—Å—ç–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–Ω—ç.\");\r\n      return;\r\n    }\r\n    await updateStatus(\"DELIVERED\");\r\n  }\r\n\r\n  // =================== 9. –¢”©–ª–±”©—Ä –∞–≤—Å–Ω–∞–∞ –±–∞—Ç–ª–∞—Ö ===================\r\n\r\n  async function handleConfirmPayment() {\r\n    if (!delivery || !user) return;\r\n\r\n    if (delivery.chosen_driver_id !== user.id) {\r\n      setError(\"–ó”©–≤—Ö”©–Ω ”©”©—Ä—Ç –æ–Ω–æ–æ—Å–æ–Ω —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä —Ç”©–ª–±”©—Ä –±–∞—Ç–∞–ª–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    if (!delivery.seller_marked_paid) {\r\n      setError(\"–•—É–¥–∞–ª–¥–∞–≥—á —Ç”©–ª–±”©—Ä —à–∏–ª–∂“Ø“Ø–ª—Å—ç–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Å–Ω–∏–π –¥–∞—Ä–∞–∞ –±–∞—Ç–∞–ª–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    setConfirmPayLoading(true);\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const newDriverConfirmed = !delivery.driver_confirmed_payment;\r\n      const willBeClosed =\r\n        newDriverConfirmed &&\r\n        delivery.seller_marked_paid &&\r\n        delivery.status === \"DELIVERED\";\r\n\r\n      const closedAtNow = willBeClosed ? new Date().toISOString() : delivery.closed_at;\r\n\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          driver_confirmed_payment: newDriverConfirmed,\r\n          status: willBeClosed ? \"CLOSED\" : delivery.status,\r\n          closed_at: closedAtNow,\r\n        })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"chosen_driver_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–¢”©–ª–±”©—Ä –∞–≤—Å–Ω–∞–∞ –±–∞—Ç–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({\r\n        ...delivery,\r\n        driver_confirmed_payment: newDriverConfirmed,\r\n        status: willBeClosed ? \"CLOSED\" : delivery.status,\r\n        closed_at: closedAtNow,\r\n      });\r\n\r\n      setMessage(\r\n        newDriverConfirmed\r\n          ? \"–¢”©–ª–±”©—Ä”©”© –±“Ø—Ä—ç–Ω –∞–≤—Å–∞–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\"\r\n          : \"–¢”©–ª–±”©—Ä”©”© –±–∞—Ç–∞–ª–≥–∞–∞–∂–∞–∞–≥“Ø–π –≥—ç–∂ –∑–∞—Å–ª–∞–∞.\"\r\n      );\r\n    } finally {\r\n      setConfirmPayLoading(false);\r\n    }\r\n  }\r\n\r\n  // =================== 10. –ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö (driver —Ç–∞–ª) ===================\r\n\r\n  const isThisDriverAssigned =\r\n    !!delivery && !!user && delivery.chosen_driver_id === user.id;\r\n\r\n  const canOpenDispute =\r\n    !!delivery &&\r\n    isThisDriverAssigned &&\r\n    delivery.status !== \"DISPUTE\" &&\r\n    (delivery.status === \"ON_ROUTE\" || delivery.status === \"DELIVERED\");\r\n\r\n  async function handleOpenDisputeConfirm() {\r\n    if (!delivery || !user) return;\r\n\r\n    if (!isThisDriverAssigned) {\r\n      setError(\"–ó”©–≤—Ö”©–Ω ”©”©—Ä—Ç –æ–Ω–æ–æ—Å–æ–Ω —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä –º–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç–Ω—ç.\");\r\n      return;\r\n    }\r\n\r\n    if (!canOpenDispute) {\r\n      setError(\"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä –º–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö –±–æ–ª–æ–º–∂–≥“Ø–π —Ç”©–ª”©–≤ –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    const reason = disputeReason.trim();\r\n    if (!reason) {\r\n      setError(\"–ú–∞—Ä–≥–∞–∞–Ω—ã —à–∞–ª—Ç–≥–∞–∞–Ω–∞–∞ —Ç–æ–≤—á—Ö–æ–Ω –±–∏—á–Ω—ç “Ø“Ø.\");\r\n      return;\r\n    }\r\n\r\n    setOpeningDispute(true);\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({\r\n          status: \"DISPUTE\",\r\n          dispute_reason: reason,\r\n          dispute_opened_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"chosen_driver_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({\r\n        ...delivery,\r\n        status: \"DISPUTE\",\r\n        dispute_reason: reason,\r\n      });\r\n\r\n      setShowDisputeModal(false);\r\n      setDisputeReason(\"\");\r\n      setMessage(\"–ú–∞—Ä–≥–∞–∞–Ω –∞–º–∂–∏–ª—Ç—Ç–∞–π –Ω—ç—ç–≥–¥–ª—ç—ç.\");\r\n    } finally {\r\n      setOpeningDispute(false);\r\n    }\r\n  }\r\n\r\n  // =================== 11. –ê—á–∞–∞–ª–∞–ª—Ç / –∞–ª–¥–∞–∞ ===================\r\n\r\n  if (loadingUser || loadingDetail || loadingBid) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-sm text-slate-500\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user || !delivery) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-sm text-slate-500\">\r\n          –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const t = typeLabel(delivery.delivery_type);\r\n  const sb = statusBadge(delivery.status);\r\n\r\n  const sellerPaid = !!delivery.seller_marked_paid;\r\n  const driverConfirmed = !!delivery.driver_confirmed_payment;\r\n\r\n  const hasOwnBid = !!ownBid;\r\n  const isOpen = delivery.status === \"OPEN\";\r\n  const isAssigned = delivery.status === \"ASSIGNED\" && isThisDriverAssigned;\r\n  const isOnRoute = delivery.status === \"ON_ROUTE\" && isThisDriverAssigned;\r\n  const isDelivered = delivery.status === \"DELIVERED\" && isThisDriverAssigned;\r\n\r\n  // =================== 12. –ì–æ–ª UI ===================\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      {/* –¢–æ–ª–≥–æ–π */}\r\n      <header className=\"border-b border-slate-200 bg-white\">\r\n        <div className=\"max-w-3xl mx-auto px-4 py-4 flex items-center justify-between gap-3\">\r\n          <div className=\"flex items-center gap-3\">\r\n            {/* Mobile back —Ç–æ–≤—á */}\r\n            <button\r\n              onClick={() => router.push(backUrl)}\r\n              className=\"inline-flex sm:hidden items-center justify-center h-8 w-8 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n            >\r\n              ‚Üê\r\n            </button>\r\n\r\n            <div>\r\n              <div className=\"inline-flex items-center gap-1 rounded-full border border-slate-100 bg-slate-50 px-2 py-0.5\">\r\n                <span className=\"text-xs text-slate-600\">\r\n                  –ñ–æ–ª–æ–æ—á–∏–π–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π\r\n                </span>\r\n              </div>\r\n              <div className=\"mt-1 flex items-center gap-2\">\r\n                <span className=\"text-sm font-semibold text-slate-900\">\r\n                  #{delivery.id.slice(0, 6)}\r\n                </span>\r\n                <span\r\n                  className={\r\n                    \"inline-flex items-center rounded-full border px-2 py-0.5 text-[11px] font-medium \" +\r\n                    sb.className\r\n                  }\r\n                >\r\n                  {sb.text}\r\n                </span>\r\n              </div>\r\n              <p className=\"text-xs text-slate-500 mt-0.5\">\r\n                “Æ“Ø—Å–≥—ç—Å—ç–Ω: {formatDateTime(delivery.created_at)}\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            {/* Desktop back —Ç–æ–≤—á */}\r\n            <button\r\n              onClick={() => router.push(backUrl)}\r\n              className=\"hidden sm:inline-flex text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n            >\r\n              ‚Üê –ë—É—Ü–∞—Ö\r\n            </button>\r\n            {/* –ì–∞—Ä–∞—Ö */}\r\n            <button\r\n              onClick={handleLogout}\r\n              className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-700 hover:bg-slate-50\"\r\n            >\r\n              –ì–∞—Ä–∞—Ö\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      {/* –ê–≥—É—É–ª–≥–∞ */}\r\n      <main className=\"max-w-3xl mx-auto px-4 py-5 space-y-4\">\r\n        {/* –°—Ç–∞—Ç—É—Å –±–∞–Ω–Ω–µ—Ä—É—É–¥ */}\r\n        {delivery.status === \"DISPUTE\" && (\r\n          <div className=\"rounded-2xl border border-rose-100 bg-rose-50 px-4 py-3 text-xs text-rose-800\">\r\n            –≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä <span className=\"font-semibold\">–º–∞—Ä–≥–∞–∞–Ω</span>{\" \"}\r\n            –Ω—ç—ç–≥–¥—Å—ç–Ω. –°–∏—Å—Ç–µ–º–∏–π–Ω –∞–¥–º–∏–Ω –∞—Å—É—É–¥–ª—ã–≥ —à–∞–ª–≥–∞–∂ –±–∞–π–≥–∞–∞.\r\n          </div>\r\n        )}\r\n\r\n        {message && (\r\n          <div className=\"rounded-2xl border border-emerald-100 bg-emerald-50 px-4 py-2 text-xs text-emerald-800\">\r\n            {message}\r\n          </div>\r\n        )}\r\n\r\n        {error && (\r\n          <div className=\"rounded-2xl border border-rose-100 bg-rose-50 px-4 py-2 text-xs text-rose-700\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        {/* –ö–∞—Ä—Ç 1 ‚Äì –•–∞—è–≥, —é—É —Ö“Ø—Ä–≥—ç—Ö, Maps –ª–∏–Ω–∫ */}\r\n        <section className=\"rounded-2xl border border-slate-200 bg-white px-4 py-4 space-y-3\">\r\n          <div className=\"flex items-center justify-between gap-2\">\r\n            <div className=\"flex items-center gap-2 text-xs\">\r\n              <span>{t.icon}</span>\r\n              <span className=\"font-medium text-slate-800\">{t.label}</span>\r\n            </div>\r\n            <div className=\"text-sm font-semibold text-slate-900\">\r\n              {formatPrice(delivery.price_mnt)}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 text-xs text-slate-600\">\r\n            <div>\r\n              <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                –ê–í–ê–• –•–ê–Ø–ì\r\n              </div>\r\n              <p className=\"mt-1\">{shorten(delivery.from_address)}</p>\r\n              {delivery.from_address && (\r\n                <a\r\n                  href={mapsUrl(delivery.from_address)}\r\n                  target=\"_blank\"\r\n                  rel=\"noreferrer\"\r\n                  className=\"mt-1 inline-flex text-[11px] text-sky-600 hover:underline\"\r\n                >\r\n                  Google Maps –¥—ç—ç—Ä —Ö–∞—Ä–∞—Ö\r\n                </a>\r\n              )}\r\n            </div>\r\n            <div>\r\n              <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                –•“Æ–†–ì–≠–• –•–ê–Ø–ì\r\n              </div>\r\n              <p className=\"mt-1\">{shorten(delivery.to_address)}</p>\r\n              {delivery.to_address && (\r\n                <a\r\n                  href={mapsUrl(delivery.to_address)}\r\n                  target=\"_blank\"\r\n                  rel=\"noreferrer\"\r\n                  className=\"mt-1 inline-flex text-[11px] text-sky-600 hover:underline\"\r\n                >\r\n                  Google Maps –¥—ç—ç—Ä —Ö–∞—Ä–∞—Ö\r\n                </a>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {delivery.note && (\r\n            <div className=\"pt-2 border-t border-slate-100\">\r\n              <div className=\"text-[11px] font-semibold text-slate-500\">\r\n                –Æ–£ –•“Æ–†–ì–≠–• –í–≠?\r\n              </div>\r\n              <p className=\"mt-1 text-xs text-slate-700\">{delivery.note}</p>\r\n            </div>\r\n          )}\r\n        </section>\r\n\r\n        {/* –ö–∞—Ä—Ç 2 ‚Äì –•—É–¥–∞–ª–¥–∞–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª */}\r\n        <section className=\"rounded-2xl border border-slate-200 bg-white px-4 py-4 space-y-2\">\r\n          <h2 className=\"text-sm font-semibold text-slate-900\">\r\n            –•—É–¥–∞–ª–¥–∞–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª\r\n          </h2>\r\n          <div className=\"space-y-1 text-xs text-slate-700\">\r\n            <p>\r\n              <span className=\"font-semibold\">–ù—ç—Ä:</span>{\" \"}\r\n              {delivery.seller_name || \"–ë“Ø—Ä—Ç–≥—ç–≥–¥—ç—ç–≥“Ø–π\"}\r\n            </p>\r\n            <p>\r\n              <span className=\"font-semibold\">–£—Ç–∞—Å:</span>{\" \"}\r\n              {delivery.seller_phone || \"—É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä –±“Ø—Ä—Ç–≥—ç–≥–¥—ç—ç–≥“Ø–π\"}\r\n            </p>\r\n          </div>\r\n        </section>\r\n\r\n        {/* –ö–∞—Ä—Ç 3 ‚Äì –ñ–æ–ª–æ–æ—á–∏–π–Ω “Ø–π–ª–¥–ª“Ø“Ø–¥ */}\r\n        <section className=\"rounded-2xl border border-slate-200 bg-white px-4 py-4 space-y-3\">\r\n          <h2 className=\"text-sm font-semibold text-slate-900\">\r\n            –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —è–≤—Ü, —à–∏–π–¥–≤—ç—Ä (–∂–æ–ª–æ–æ—á)\r\n          </h2>\r\n\r\n          {/* 3.1 ‚Äì –ù—ç—ç–ª—Ç—Ç—ç–π “Ø–µ–¥: –ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç */}\r\n          {isOpen && (\r\n            <div className=\"border-b border-slate-100 pb-3 mb-2 space-y-2\">\r\n              <p className=\"text-xs text-slate-600\">\r\n                –≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –Ω—ç—ç–ª—Ç—Ç—ç–π –±–∞–π–Ω–∞. –¢–∞ –∞–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–≤—ç–ª —Ö—É–¥–∞–ª–¥–∞–≥—á\r\n                —Ç–∞–Ω—ã–≥ —Å–æ–Ω–≥–æ–∂ –±–æ–ª–Ω–æ.\r\n              </p>\r\n\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                <button\r\n                  onClick={handleRequestDelivery}\r\n                  disabled={requesting || hasOwnBid}\r\n                  className=\"text-[11px] px-4 py-2 rounded-full bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                >\r\n                  {hasOwnBid\r\n                    ? \"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Å—ç–Ω\"\r\n                    : requesting\r\n                    ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\"\r\n                    : \"–ê–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –≥–∞—Ä–≥–∞—Ö\"}\r\n                </button>\r\n\r\n                {/* ‚úÖ –®–∏–Ω—ç: —Ö“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö */}\r\n                {hasOwnBid && (\r\n                  <button\r\n                    onClick={handleCancelMyBid}\r\n                    disabled={cancelingBid}\r\n                    className=\"text-[11px] px-4 py-2 rounded-full border border-slate-200 bg-slate-50 text-slate-700 hover:bg-slate-100 disabled:opacity-60\"\r\n                  >\r\n                    {cancelingBid ? \"–¶—É—Ü–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Å—ç–ª—Ç —Ü—É—Ü–ª–∞—Ö\"}\r\n                  </button>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* 3.2 ‚Äì –¢–∞–Ω–¥ –æ–Ω–æ–æ—Å–æ–Ω / –ó–∞–º–¥ / –•“Ø—Ä–≥—ç—Å—ç–Ω “Ø–µ–∏–π–Ω —Ç–æ–≤—á–Ω—É—É–¥ */}\r\n          {(isAssigned || isOnRoute || isDelivered) && (\r\n            <div className=\"border-b border-slate-100 pb-3 mb-2 space-y-2\">\r\n              {isAssigned && (\r\n                <div className=\"flex flex-wrap items-center justify-between gap-2\">\r\n                  <p className=\"text-xs text-slate-600\">\r\n                    –≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ç–∞–Ω–¥ –æ–Ω–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞. –ë–∞—Ä–∞–∞–≥ –∞–≤—Å–∞–Ω “Ø–µ–¥{\" \"}\r\n                    <span className=\"font-medium\">‚Äú–ë–∞—Ä–∞–∞–≥ –∞–≤–ª–∞–∞‚Äù</span> –≥—ç–∂\r\n                    —Ç—ç–º–¥—ç–≥–ª—ç–Ω—ç.\r\n                  </p>\r\n                  <button\r\n                    onClick={handleMarkOnRoute}\r\n                    disabled={markingOnRoute}\r\n                    className=\"text-[11px] px-4 py-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60\"\r\n                  >\r\n                    {markingOnRoute ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ë–∞—Ä–∞–∞–≥ –∞–≤–ª–∞–∞\"}\r\n                  </button>\r\n                </div>\r\n              )}\r\n\r\n              {isOnRoute && (\r\n                <div className=\"space-y-2\">\r\n                  <p className=\"text-xs text-slate-600\">\r\n                    –¢–∞ –±–∞—Ä–∞–∞–≥ –∞–≤—Å–∞–Ω, –∑–∞–º–¥ —è–≤–∂ –±–∞–π–Ω–∞. –•“Ø—Ä–≥—ç–ª—Ç –∞–º–∂–∏–ª—Ç—Ç–∞–π –¥—É—É—Å—Å–∞–Ω\r\n                    “Ø–µ–¥{\" \"}\r\n                    <span className=\"font-medium\">‚Äú–•“Ø—Ä–≥—ç–ª—Ç —Ö–∏–π—Å—ç–Ω‚Äù</span> –≥—ç–∂\r\n                    —Ç—ç–º–¥—ç–≥–ª—ç–Ω—ç. –•—ç—Ä–≤—ç—ç –∞—Å—É—É–¥–∞–ª –≥–∞—Ä–≤–∞–ª (—Ö–∞—è–≥ –æ–ª–¥–æ—Ö–≥“Ø–π, —Ç”©–ª–±”©—Ä\r\n                    ”©–≥”©—Ö–≥“Ø–π –≥—ç—Ö –º—ç—Ç) –¥–∞—Ä–∞–∞ –Ω—å{\" \"}\r\n                    <span className=\"font-medium\">–º–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö</span>{\" \"}\r\n                    –±–æ–ª–æ–º–∂—Ç–æ–π.\r\n                  </p>\r\n                  <button\r\n                    onClick={handleMarkDelivered}\r\n                    disabled={markingDelivered}\r\n                    className=\"text-[11px] px-4 py-2 rounded-full bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                  >\r\n                    {markingDelivered ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Ä–≥—ç–ª—Ç —Ö–∏–π—Å—ç–Ω\"}\r\n                  </button>\r\n                </div>\r\n              )}\r\n\r\n              {isDelivered && (\r\n                <p className=\"text-xs text-slate-600\">\r\n                  –¢–∞ —ç–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥{\" \"}\r\n                  <span className=\"font-semibold\">—Ö“Ø—Ä–≥—ç—Å—ç–Ω</span> –≥—ç–∂\r\n                  —Ç—ç–º–¥—ç–≥–ª—ç—Å—ç–Ω. –•—É–¥–∞–ª–¥–∞–≥—á —Ç”©–ª–±”©—Ä”©”© —à–∏–ª–∂“Ø“Ø–ª—Å—ç–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Å–Ω–∏–π\r\n                  –¥–∞—Ä–∞–∞ ‚Äú–¢”©–ª–±”©—Ä”©”© –∞–≤—Å–∞–Ω‚Äù –≥—ç–∂ –±–∞—Ç–∞–ª–∂, —Ö“Ø—Ä–≥—ç–ª—Ç —Ö–∞–∞–≥–¥–∞–Ω–∞.\r\n                </p>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* 3.3 ‚Äì –¢”©–ª–±”©—Ä–∏–π–Ω —Ö—ç—Å—ç–≥ */}\r\n          {(isDelivered || delivery.status === \"CLOSED\") && (\r\n            <div className=\"border-b border-slate-100 pb-3 mb-2 space-y-2\">\r\n              <p className=\"text-xs text-slate-600\">\r\n                –•—É–¥–∞–ª–¥–∞–≥—á —Ç”©–ª–±”©—Ä —Ç”©–ª—Å–Ω”©”© —Ç—ç–º–¥—ç–≥–ª—ç—Å—ç–Ω —ç—Å—ç—Ö, —Ç–∞ —Ç”©–ª–±”©—Ä”©”© –±“Ø—Ä—ç–Ω\r\n                –∞–≤—Å–∞–Ω —ç—Å—ç—Ö–∏–π–≥ –¥–æ–æ—Ä —Ö–∞—Ä—É—É–ª–Ω–∞.\r\n              </p>\r\n              <div className=\"space-y-1 text-[11px] text-slate-500\">\r\n                <p>\r\n                  –•—É–¥–∞–ª–¥–∞–≥—á:{\" \"}\r\n                  <span\r\n                    className={\r\n                      sellerPaid\r\n                        ? \"text-emerald-600 font-semibold\"\r\n                        : \"text-slate-700\"\r\n                    }\r\n                  >\r\n                    {sellerPaid\r\n                      ? \"–ñ–æ–ª–æ–æ—á–∏–¥ –º”©–Ω–≥”©”© —à–∏–ª–∂“Ø“Ø–ª—Å—ç–Ω\"\r\n                      : \"–ú”©–Ω–≥”©”© —à–∏–ª–∂“Ø“Ø–ª—Å—ç–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—ç–≥“Ø–π\"}\r\n                  </span>\r\n                </p>\r\n                <p>\r\n                  –ñ–æ–ª–æ–æ—á (—Ç–∞):{\" \"}\r\n                  <span\r\n                    className={\r\n                      driverConfirmed\r\n                        ? \"text-emerald-600 font-semibold\"\r\n                        : \"text-slate-700\"\r\n                    }\r\n                  >\r\n                    {driverConfirmed ? \"–¢”©–ª–±”©—Ä”©”© –±“Ø—Ä—ç–Ω –∞–≤—Å–∞–Ω\" : \"–ë–∞—Ç–∞–ª–≥–∞–∞–∂–∞–∞–≥“Ø–π\"}\r\n                  </span>\r\n                </p>\r\n                {delivery.closed_at && (\r\n                  <p className=\"text-[11px] text-slate-400\">\r\n                    –•–∞–∞–≥–¥—Å–∞–Ω: {formatDateTime(delivery.closed_at)}\r\n                  </p>\r\n                )}\r\n              </div>\r\n\r\n              {isDelivered && (\r\n                <button\r\n                  onClick={handleConfirmPayment}\r\n                  disabled={confirmPayLoading}\r\n                  className=\"mt-1 text-[11px] px-4 py-2 rounded-full bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                >\r\n                  {confirmPayLoading\r\n                    ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\"\r\n                    : driverConfirmed\r\n                    ? \"–¢”©–ª–±”©—Ä –∞–≤—Å–∞–Ω –≥—ç–∂ –∑–∞—Å–∞—Ö\"\r\n                    : \"–¢”©–ª–±”©—Ä”©”© –∞–≤—Å–∞–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Ö\"}\r\n                </button>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* 3.4 ‚Äì –ú–∞—Ä–≥–∞–∞–Ω “Ø“Ø—Å–≥—ç—Ö (–∂–æ–ª–æ–æ—á —Ç–∞–ª) */}\r\n          {canOpenDispute && (\r\n            <div className=\"space-y-2\">\r\n              <p className=\"text-xs text-slate-600\">\r\n                –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —è–≤—Ü–∞–¥{\" \"}\r\n                <span className=\"font-semibold text-rose-700\">–Ω–æ—Ü—Ç–æ–π –∑”©—Ä—á–∏–ª</span>{\" \"}\r\n                –≥–∞—Ä—Å–∞–Ω (—Ö—É–¥–∞–ª–¥–∞–≥—á —Ç”©–ª–±”©—Ä ”©–≥”©—Ö”©”©—Å —Ç–∞—Ç–≥–∞–ª–∑—Å–∞–Ω, —Ç–æ—Ö–∏—Ä—Å–æ–Ω –Ω”©—Ö—Ü”©–ª–∏–π–≥\r\n                –Ω–æ—Ü—Ç–æ–π –∑”©—Ä—á—Å”©–Ω –≥—ç—Ö –º—ç—Ç) “Ø–µ–¥ –ª{\" \"}\r\n                <span className=\"font-semibold\">–º–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç–Ω—ç</span>. –ë–æ–ª—Å–æ–Ω “Ø–π–ª\r\n                —è–≤–¥–ª—ã–≥ —Ç–æ–≤—á, —Ç–æ–¥–æ—Ä—Ö–æ–π –±–∏—á–∏–∂ –∏–ª–≥—ç—ç–Ω—ç “Ø“Ø.\r\n              </p>\r\n              <button\r\n                onClick={() => setShowDisputeModal(true)}\r\n                className=\"text-[11px] px-4 py-2 rounded-full border border-rose-200 bg-rose-50 text-rose-700 hover:bg-rose-100\"\r\n              >\r\n                –ú–∞—Ä–≥–∞–∞–Ω “Ø“Ø—Å–≥—ç—Ö\r\n              </button>\r\n            </div>\r\n          )}\r\n\r\n          {delivery.status === \"CLOSED\" && (\r\n            <div className=\"border-t border-slate-100 pt-3 mt-2\">\r\n              <p className=\"text-xs text-slate-600\">\r\n                –≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç <span className=\"font-semibold\">—Ö–∞–∞–≥–¥—Å–∞–Ω</span>.\r\n                –¢”©–ª–±”©—Ä–∏–π–Ω —Ç–æ–æ—Ü–æ–æ –±“Ø—Ä—ç–Ω –¥—É—É—Å—Å–∞–Ω.\r\n              </p>\r\n            </div>\r\n          )}\r\n        </section>\r\n\r\n        {/* –ú–∞—Ä–≥–∞–∞–Ω modal */}\r\n        {showDisputeModal && (\r\n          <div className=\"fixed inset-0 z-20 flex items-center justify-center bg-black/30 px-4\">\r\n            <div className=\"max-w-md w-full rounded-2xl bg-white shadow-lg border border-slate-200 px-4 py-4 space-y-3\">\r\n              <h3 className=\"text-sm font-semibold text-slate-900\">\r\n                –ú–∞—Ä–≥–∞–∞–Ω “Ø“Ø—Å–≥—ç—Ö (–∂–æ–ª–æ–æ—á)\r\n              </h3>\r\n              <p className=\"text-xs text-slate-600\">\r\n                –•—É–¥–∞–ª–¥–∞–≥—á—Ç–∞–π –Ω–æ—Ü—Ç–æ–π –∞—Å—É—É–¥–∞–ª –≥–∞—Ä—Å–∞–Ω (—Ç”©–ª–±”©—Ä ”©–≥”©—Ö”©”©—Å —Ç–∞—Ç–≥–∞–ª–∑—Å–∞–Ω,\r\n                —Ç–æ—Ö–∏—Ä—Å–æ–Ω –Ω”©—Ö—Ü”©–ª–∏–π–≥ –∑”©—Ä—á—Å”©–Ω –≥—ç—Ö –º—ç—Ç) “Ø–µ–¥ –ª –º–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç–Ω—ç. –ë–æ–ª—Å–æ–Ω\r\n                –Ω”©—Ö—Ü”©–ª –±–∞–π–¥–ª—ã–≥ —Ç–æ–≤—á, —Ç–æ–¥–æ—Ä—Ö–æ–π –±–∏—á–Ω—ç “Ø“Ø.\r\n              </p>\r\n              <textarea\r\n                value={disputeReason}\r\n                onChange={(e) => setDisputeReason(e.target.value)}\r\n                rows={4}\r\n                className=\"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-800 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-rose-500\"\r\n                placeholder=\"–Æ—É –±–æ–ª—Å–æ–Ω —Ç–∞–ª–∞–∞—Ä —Ç–æ–≤—á—Ö–æ–Ω, —Ç–æ–¥–æ—Ä—Ö–æ–π –±–∏—á–Ω—ç “Ø“Ø‚Ä¶\"\r\n              />\r\n              <div className=\"flex items-center justify-end gap-2 pt-1\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowDisputeModal(false)}\r\n                  disabled={openingDispute}\r\n                  className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n                >\r\n                  –ë–æ–ª–∏—Ö\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleOpenDisputeConfirm}\r\n                  disabled={openingDispute}\r\n                  className=\"text-[11px] px-3 py-1.5 rounded-full bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-60\"\r\n                >\r\n                  {openingDispute ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö\"}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/driver/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n// =================== 1. –ò–º–ø–æ—Ä—Ç, —Ç”©—Ä–ª“Ø“Ø–¥ ===================\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { DeliveryStatus } from \"@/lib/deliveryLogic\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\n// ‚úÖ PAID —Ç–∞–± –±–∞–π—Ö–≥“Ø–π. DISPUTE —Ö–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–¥.\r\ntype DriverTabId =\r\n  | \"OPEN\"\r\n  | \"ASSIGNED\"\r\n  | \"ON_ROUTE\"\r\n  | \"DELIVERED\"\r\n  | \"CLOSED\"\r\n  | \"DISPUTE\";\r\n\r\ntype DeliveryRow = {\r\n  id: string;\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n  chosen_driver_id: string | null;\r\n\r\n  // OPEN —Ç–∞–± –¥—ç—ç—Ä –º–∏–Ω–∏–π —Ö“Ø—Å—ç–ª—Ç (bid) –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö\r\n  hasBid: boolean;\r\n};\r\n\r\n// –î—Ä–∞–π–≤–µ—Ä–∏–π–Ω —Ç–∞–±—É—É–¥ (‚úÖ DISPUTE —Ö–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–¥)\r\nconst DRIVER_TABS: { id: DriverTabId; label: string }[] = [\r\n  { id: \"OPEN\", label: \"–ù—ç—ç–ª—Ç—Ç—ç–π\" },\r\n  { id: \"ASSIGNED\", label: \"–ù–∞–º–∞–π–≥ —Å–æ–Ω–≥–æ—Å–æ–Ω\" },\r\n  { id: \"ON_ROUTE\", label: \"–ó–∞–º–¥\" },\r\n  { id: \"DELIVERED\", label: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\" },\r\n  { id: \"CLOSED\", label: \"–•–∞–∞–≥–¥—Å–∞–Ω\" },\r\n  { id: \"DISPUTE\", label: \"–ú–∞—Ä–≥–∞–∞–Ω—Ç–∞–π\" },\r\n];\r\n\r\nconst TAB_IDS: DriverTabId[] = DRIVER_TABS.map((t) => t.id);\r\n\r\n// =================== 2. –¢—É—Å–ª–∞—Ö —Ñ—É–Ω–∫—Ü—É—É–¥ ===================\r\n\r\nfunction typeLabel(\r\n  deliveryType: string | null\r\n): { icon: string; label: string } {\r\n  switch (deliveryType) {\r\n    case \"apartment\":\r\n      return { icon: \"üèô\", label: \"–ë–∞–π—Ä\" };\r\n    case \"ger\":\r\n      return { icon: \"üè†\", label: \"–ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª\" };\r\n    case \"camp\":\r\n      return { icon: \"üèï\", label: \"–õ–∞–≥–µ—Ä\" };\r\n    case \"countryside\":\r\n      return { icon: \"üöå\", label: \"–û—Ä–æ–Ω –Ω—É—Ç–∞–≥\" };\r\n    default:\r\n      return { icon: \"üì¶\", label: \"–•“Ø—Ä–≥—ç–ª—Ç\" };\r\n  }\r\n}\r\n\r\nfunction statusBadge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return {\r\n        text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\",\r\n        className: \"bg-emerald-50 text-emerald-700 border-emerald-100\",\r\n      };\r\n    case \"ASSIGNED\":\r\n      return {\r\n        text: \"–¢–∞–Ω–¥ –æ–Ω–æ–æ—Å–æ–Ω\",\r\n        className: \"bg-sky-50 text-sky-700 border-sky-100\",\r\n      };\r\n    case \"ON_ROUTE\":\r\n      return {\r\n        text: \"–ó–∞–º–¥\",\r\n        className: \"bg-indigo-50 text-indigo-700 border-indigo-100\",\r\n      };\r\n    case \"DELIVERED\":\r\n      return {\r\n        text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\",\r\n        className: \"bg-slate-900 text-white border-slate-900\",\r\n      };\r\n    case \"CLOSED\":\r\n      return {\r\n        text: \"–•–∞–∞–≥–¥—Å–∞–Ω\",\r\n        className: \"bg-slate-800 text-slate-50 border-slate-800\",\r\n      };\r\n    case \"CANCELLED\":\r\n      return {\r\n        text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\",\r\n        className: \"bg-rose-50 text-rose-700 border-rose-100\",\r\n      };\r\n    case \"DISPUTE\":\r\n      return {\r\n        text: \"–ú–∞—Ä–≥–∞–∞–Ω\",\r\n        className: \"bg-rose-50 text-rose-700 border-rose-100\",\r\n      };\r\n    default:\r\n      return {\r\n        text: status,\r\n        className: \"bg-slate-50 text-slate-600 border-slate-100\",\r\n      };\r\n  }\r\n}\r\n\r\nfunction shorten(s: string | null, max = 110) {\r\n  if (!s) return \"\";\r\n  const t = s.trim();\r\n  if (t.length <= max) return t;\r\n  return t.slice(0, max).replace(/\\s+$/, \"\") + \"‚Ä¶\";\r\n}\r\n\r\nfunction formatPrice(n: number | null) {\r\n  if (!n) return \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n  return n.toLocaleString(\"mn-MN\") + \"‚ÇÆ\";\r\n}\r\n\r\nfunction formatDateTime(iso: string) {\r\n  if (!iso) return \"\";\r\n  const d = new Date(iso);\r\n  return (\r\n    d.toLocaleDateString(\"mn-MN\", { month: \"2-digit\", day: \"2-digit\" }) +\r\n    \" \" +\r\n    d.toLocaleTimeString(\"mn-MN\", { hour: \"2-digit\", minute: \"2-digit\" })\r\n  );\r\n}\r\n\r\n// –¢–∞–±—ã–≥–∞–∞—Ä filter —Ö–∏–π—Ö\r\nfunction filterByTab(tab: DriverTabId, items: DeliveryRow[]): DeliveryRow[] {\r\n  return items.filter((d) => {\r\n    switch (tab) {\r\n      case \"OPEN\":\r\n        return d.status === \"OPEN\";\r\n      case \"ASSIGNED\":\r\n        return d.status === \"ASSIGNED\";\r\n      case \"ON_ROUTE\":\r\n        return d.status === \"ON_ROUTE\";\r\n      case \"DELIVERED\":\r\n        return d.status === \"DELIVERED\";\r\n      case \"CLOSED\":\r\n        return d.status === \"CLOSED\";\r\n      case \"DISPUTE\":\r\n        return d.status === \"DISPUTE\";\r\n      default:\r\n        return true;\r\n    }\r\n  });\r\n}\r\n\r\n// =================== 3. –ì–æ–ª –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ===================\r\n\r\nexport default function DriverDashboardPage() {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n\r\n  const urlTab = searchParams.get(\"tab\");\r\n  const urlTabId = useMemo(() => {\r\n    if (urlTab && TAB_IDS.includes(urlTab as DriverTabId)) {\r\n      return urlTab as DriverTabId;\r\n    }\r\n    return null;\r\n  }, [urlTab]);\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [loadingUser, setLoadingUser] = useState(true);\r\n\r\n  const [deliveries, setDeliveries] = useState<DeliveryRow[]>([]);\r\n  const [loadingList, setLoadingList] = useState(true);\r\n\r\n  const [activeTab, setActiveTab] = useState<DriverTabId>(\"OPEN\");\r\n\r\n  const [message, setMessage] = useState<string | null>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // =================== 4. Login guard ===================\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) {\r\n        router.replace(\"/\");\r\n        return;\r\n      }\r\n      const parsed: IncomeUser = JSON.parse(raw);\r\n      if (parsed.role !== \"driver\") {\r\n        router.replace(\"/\");\r\n        return;\r\n      }\r\n      setUser(parsed);\r\n      setLoadingUser(false);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —É–Ω—à–∏—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      setLoadingUser(false);\r\n    }\r\n  }, [router]);\r\n\r\n  // =================== 5. –¢–∞–±—ã–Ω —ç—Ö–Ω–∏–π —É—Ç–≥–∞ (URL / localStorage) ===================\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n\r\n    if (urlTabId) {\r\n      setActiveTab(urlTabId);\r\n      window.localStorage.setItem(\"driverActiveTab\", urlTabId);\r\n      return;\r\n    }\r\n\r\n    const stored = window.localStorage.getItem(\"driverActiveTab\");\r\n    if (stored && TAB_IDS.includes(stored as DriverTabId)) {\r\n      setActiveTab(stored as DriverTabId);\r\n    }\r\n  }, [urlTabId]);\r\n\r\n  function changeTab(tab: DriverTabId) {\r\n    setActiveTab(tab);\r\n    if (typeof window !== \"undefined\") {\r\n      window.localStorage.setItem(\"driverActiveTab\", tab);\r\n    }\r\n    router.push(`/driver?tab=${tab}`);\r\n  }\r\n\r\n  // =================== 6. –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ç–∞—Ç–∞—Ö ===================\r\n\r\n  async function fetchDeliveries(driverId: string) {\r\n    try {\r\n      setLoadingList(true);\r\n      setError(null);\r\n      setMessage(null);\r\n\r\n      // 6.1 –ù—ç—ç–ª—Ç—Ç—ç–π –±“Ø—Ö —Ö“Ø—Ä–≥—ç–ª—Ç\r\n      const { data: openData, error: openError } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          seller_marked_paid,\r\n          driver_confirmed_payment,\r\n          chosen_driver_id\r\n        `\r\n        )\r\n        .eq(\"status\", \"OPEN\")\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (openError) console.error(openError);\r\n\r\n      // 6.2 –≠–Ω—ç –∂–æ–ª–æ–æ—á–∏–¥ –æ–Ω–æ–æ–≥–¥—Å–æ–Ω / ”©–º–Ω”© –Ω—å —Ö–∏–π–∂ –±–∞–π—Å–∞–Ω –±“Ø—Ö —Ö“Ø—Ä–≥—ç–ª—Ç\r\n      const { data: mineData, error: mineError } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          seller_marked_paid,\r\n          driver_confirmed_payment,\r\n          chosen_driver_id\r\n        `\r\n        )\r\n        .eq(\"chosen_driver_id\", driverId)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (mineError) console.error(mineError);\r\n\r\n      const openRows = (openData || []) as any[];\r\n      const mineRows = (mineData || []) as any[];\r\n\r\n      // 6.3 –î—É–±–ª–∏–∫–∞—Ç–≥“Ø–π –Ω—ç–≥—Ç–≥—ç—Ö\r\n      const mergedMap = new Map<string, any>();\r\n      for (const d of [...openRows, ...mineRows]) {\r\n        if (!mergedMap.has(d.id)) mergedMap.set(d.id, d);\r\n      }\r\n      const merged = Array.from(mergedMap.values());\r\n\r\n      // 6.4 –≠–Ω—ç –∂–æ–ª–æ–æ—á–∏–π–Ω –∏–ª–≥—ç—ç—Å—ç–Ω –±“Ø—Ö —Ö“Ø—Å—ç–ª—Ç“Ø“Ø–¥\r\n      const { data: bidData, error: bidError } = await supabase\r\n        .from(\"driver_bids\")\r\n        .select(\"delivery_id\")\r\n        .eq(\"driver_id\", driverId);\r\n\r\n      if (bidError) console.error(bidError);\r\n\r\n      const bidSet = new Set<string>(\r\n        (bidData || []).map((b: any) => b.delivery_id as string)\r\n      );\r\n\r\n      // 6.5 Map (PAID —Ç–∞–∞—Ä–∞—Ö —ë—Å–≥“Ø–π, –≥—ç—Ö–¥—ç—ç —Ö—É—É—á–∏–Ω –¥–∞—Ç–∞ –±–∞–π–≤–∞–ª DELIVERED –±–æ–ª–≥–æ–∂ normalize)\r\n      const rows: DeliveryRow[] = merged.map((d: any) => ({\r\n        id: d.id,\r\n        from_address: d.from_address,\r\n        to_address: d.to_address,\r\n        note: d.note,\r\n        status: (d.status === \"PAID\" ? \"DELIVERED\" : d.status) as DeliveryStatus,\r\n        created_at: d.created_at,\r\n        price_mnt: d.price_mnt,\r\n        delivery_type: d.delivery_type,\r\n        seller_marked_paid: !!d.seller_marked_paid,\r\n        driver_confirmed_payment: !!d.driver_confirmed_payment,\r\n        chosen_driver_id: d.chosen_driver_id,\r\n        hasBid: bidSet.has(d.id),\r\n      }));\r\n\r\n      setDeliveries(rows);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      setDeliveries([]);\r\n    } finally {\r\n      setLoadingList(false);\r\n    }\r\n  }\r\n\r\n  // 6.A: user –æ—Ä–∂ –∏—Ä–º—ç–≥—Ü —Ç–∞—Ç–Ω–∞\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    void fetchDeliveries(user.id);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user]);\r\n\r\n  // ‚úÖ 6.B: URL tab —Å–æ–ª–∏–≥–¥–æ—Ö / detail-—ç—ç—Å –±—É—Ü–∞–∂ –∏—Ä—ç—Ö—ç–¥ refresh\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    void fetchDeliveries(user.id);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id, urlTab]);\r\n\r\n  // ‚úÖ 6.C: Browser focus “Ø–µ–¥ refresh (detail ‚Üí back —Ö–∏–π—Ö—ç–¥ –∏—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π)\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    const onFocus = () => {\r\n      void fetchDeliveries(user.id);\r\n    };\r\n    window.addEventListener(\"focus\", onFocus);\r\n    return () => window.removeEventListener(\"focus\", onFocus);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id]);\r\n\r\n  // =================== 7. –ì–∞—Ä–∞—Ö ===================\r\n\r\n  function handleLogout() {\r\n    if (typeof window !== \"undefined\") {\r\n      window.localStorage.removeItem(\"incomeUser\");\r\n    }\r\n    router.push(\"/\");\r\n  }\r\n\r\n  // =================== 8. –ñ–∞–≥—Å–∞–∞–ª—Ç—ã–Ω UI ===================\r\n\r\n  function renderList(items: DeliveryRow[], currentTab: DriverTabId) {\r\n    // OPEN —Ç–∞–±: –Ω—ç—ç–ª—Ç—Ç—ç–π + –º–∏–Ω–∏–π —Å–∞–Ω–∞–ª—É—É–¥ (—Ü—É—Ü–ª–∞—Ö —Ç–æ–≤—á —ç–Ω–¥ –±–∞–π—Ö–≥“Ø–π)\r\n    if (currentTab === \"OPEN\") {\r\n      const openWithoutBid = items.filter((d) => !d.hasBid);\r\n      const openWithBid = items.filter((d) => d.hasBid);\r\n\r\n      if (openWithoutBid.length === 0 && openWithBid.length === 0) {\r\n        return (\r\n          <div className=\"rounded-2xl border border-dashed border-slate-200 bg-slate-50 px-4 py-6 text-center text-xs text-slate-500\">\r\n            –ù—ç—ç–ª—Ç—Ç—ç–π —Ö“Ø—Ä–≥—ç–ª—Ç –æ–¥–æ–æ–≥–æ–æ—Ä –∞–ª–≥–∞ –±–∞–π–Ω–∞.\r\n          </div>\r\n        );\r\n      }\r\n\r\n      const renderItem = (d: DeliveryRow, opts?: { dim?: boolean }) => {\r\n        const t = typeLabel(d.delivery_type);\r\n        const sb = statusBadge(d.status);\r\n\r\n        const subtitle =\r\n          d.status === \"OPEN\"\r\n            ? d.hasBid\r\n              ? \"–¢–∞ —ç–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä –∞–≤–∞—Ö —Å–∞–Ω–∞–ª –∏–ª–≥—ç—ç—Å—ç–Ω.\"\r\n              : \"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç—ç–¥ –∞–≤–∞—Ö —Å–∞–Ω–∞–ª –∏–ª–≥—ç—ç–≥“Ø–π –±–∞–π–Ω–∞.\"\r\n            : \"\";\r\n\r\n        const dimClass = opts?.dim ? \"opacity-70\" : \"\";\r\n\r\n        return (\r\n          <button\r\n            key={d.id}\r\n            type=\"button\"\r\n            onClick={() =>\r\n              router.push(`/driver/delivery/${d.id}?tab=${activeTab}`)\r\n            }\r\n            className={\r\n              \"w-full text-left rounded-2xl border border-slate-200 bg-white px-4 py-3 hover:border-emerald-300 hover:shadow-sm transition \" +\r\n              dimClass\r\n            }\r\n          >\r\n            <div className=\"flex items-start justify-between gap-3\">\r\n              <div className=\"flex-1 space-y-1\">\r\n                <div className=\"flex flex-wrap items-center gap-2\">\r\n                  <span className=\"text-xs font-semibold text-slate-900\">\r\n                    #{d.id.slice(0, 6)}\r\n                  </span>\r\n                  <span\r\n                    className={\r\n                      \"inline-flex items-center rounded-full border px-2 py-0.5 text-[10px] font-medium \" +\r\n                      sb.className\r\n                    }\r\n                  >\r\n                    {sb.text}\r\n                  </span>\r\n                  {d.status === \"OPEN\" && d.hasBid && (\r\n                    <span className=\"inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-2 py-0.5 text-[10px] font-medium text-emerald-700\">\r\n                      –•“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Å—ç–Ω\r\n                    </span>\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-2 text-[11px] text-slate-600\">\r\n                  <span>{t.icon}</span>\r\n                  <span className=\"font-medium\">{t.label}</span>\r\n                  <span className=\"text-slate-400\">‚Ä¢</span>\r\n                  <span>{formatPrice(d.price_mnt)}</span>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2 text-[11px] text-slate-600 mt-1\">\r\n                  <div>\r\n                    <div className=\"text-[10px] font-semibold text-slate-500\">\r\n                      –ê–í–ê–•\r\n                    </div>\r\n                    <p>{shorten(d.from_address, 60)}</p>\r\n                  </div>\r\n                  <div>\r\n                    <div className=\"text-[10px] font-semibold text-slate-500\">\r\n                      –•“Æ–†–ì–≠–•\r\n                    </div>\r\n                    <p>{shorten(d.to_address, 60)}</p>\r\n                  </div>\r\n                </div>\r\n\r\n                {d.note && (\r\n                  <p className=\"mt-1 text-[11px] text-slate-500\">\r\n                    {shorten(d.note, 80)}\r\n                  </p>\r\n                )}\r\n\r\n                <p className=\"mt-1 text-[10px] text-slate-400\">\r\n                  “Æ“Ø—Å–≥—ç—Å—ç–Ω: {formatDateTime(d.created_at)}\r\n                </p>\r\n\r\n                {subtitle && (\r\n                  <p className=\"mt-1 text-[10px] text-slate-500\">{subtitle}</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </button>\r\n        );\r\n      };\r\n\r\n      return (\r\n        <div className=\"space-y-5\">\r\n          {openWithoutBid.length > 0 && (\r\n            <div className=\"space-y-2\">\r\n              <p className=\"px-1 text-[11px] font-medium text-slate-600\">\r\n                –ù—ç—ç–ª—Ç—Ç—ç–π –∑–∞—Ö–∏–∞–ª–≥—É—É–¥\r\n              </p>\r\n              <div className=\"space-y-3\">\r\n                {openWithoutBid.map((d) => renderItem(d))}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {openWithBid.length > 0 && (\r\n            <div className=\"space-y-2\">\r\n              <p className=\"px-1 text-[11px] font-medium text-slate-600\">\r\n                –ú–∏–Ω–∏–π ”©–≥—Å”©–Ω —Å–∞–Ω–∞–ª—É—É–¥\r\n              </p>\r\n              <div className=\"space-y-3\">\r\n                {openWithBid.map((d) => renderItem(d, { dim: true }))}\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      );\r\n    }\r\n\r\n    // –ë—É—Å–∞–¥ —Ç–∞–±—É—É–¥\r\n    if (items.length === 0) {\r\n      return (\r\n        <div className=\"rounded-2xl border border-dashed border-slate-200 bg-slate-50 px-4 py-6 text-center text-xs text-slate-500\">\r\n          –≠–Ω—ç —Ç–∞–± –¥—ç—ç—Ä –æ–¥–æ–æ–≥–æ–æ—Ä —Ö“Ø—Ä–≥—ç–ª—Ç –∞–ª–≥–∞ –±–∞–π–Ω–∞.\r\n        </div>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <div className=\"space-y-3\">\r\n        {items.map((d) => {\r\n          const t = typeLabel(d.delivery_type);\r\n          const sb = statusBadge(d.status);\r\n\r\n          let subtitle = \"\";\r\n          if (d.status === \"ASSIGNED\") subtitle = \"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ç–∞–Ω–¥ –æ–Ω–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.\";\r\n          else if (d.status === \"ON_ROUTE\") subtitle = \"–¢–∞ –±–∞—Ä–∞–∞–≥ –∞–≤–∞–∞–¥ —Ö“Ø—Ä–≥—ç–ª—Ç—ç–¥ –≥–∞—Ä—Å–∞–Ω.\";\r\n          else if (d.status === \"DELIVERED\") subtitle = \"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ö“Ø—Ä–≥—ç—Å—ç–Ω —Ç”©–ª”©–≤—Ç –±–∞–π–Ω–∞.\";\r\n          else if (d.status === \"CLOSED\") subtitle = \"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –±“Ø—Ä—ç–Ω —Ö–∞–∞–≥–¥—Å–∞–Ω.\";\r\n          else if (d.status === \"DISPUTE\") subtitle = \"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –º–∞—Ä–≥–∞–∞–Ω—Ç–∞–π –±–∞–π–Ω–∞.\";\r\n\r\n          return (\r\n            <button\r\n              key={d.id}\r\n              type=\"button\"\r\n              onClick={() =>\r\n                router.push(`/driver/delivery/${d.id}?tab=${activeTab}`)\r\n              }\r\n              className=\"w-full text-left rounded-2xl border border-slate-200 bg-white px-4 py-3 hover:border-emerald-300 hover:shadow-sm transition\"\r\n            >\r\n              <div className=\"flex items-start justify-between gap-3\">\r\n                <div className=\"flex-1 space-y-1\">\r\n                  <div className=\"flex flex-wrap items-center gap-2\">\r\n                    <span className=\"text-xs font-semibold text-slate-900\">\r\n                      #{d.id.slice(0, 6)}\r\n                    </span>\r\n                    <span\r\n                      className={\r\n                        \"inline-flex items-center rounded-full border px-2 py-0.5 text-[10px] font-medium \" +\r\n                        sb.className\r\n                      }\r\n                    >\r\n                      {sb.text}\r\n                    </span>\r\n                  </div>\r\n\r\n                  <div className=\"flex items-center gap-2 text-[11px] text-slate-600\">\r\n                    <span>{t.icon}</span>\r\n                    <span className=\"font-medium\">{t.label}</span>\r\n                    <span className=\"text-slate-400\">‚Ä¢</span>\r\n                    <span>{formatPrice(d.price_mnt)}</span>\r\n                  </div>\r\n\r\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2 text-[11px] text-slate-600 mt-1\">\r\n                    <div>\r\n                      <div className=\"text-[10px] font-semibold text-slate-500\">\r\n                        –ê–í–ê–•\r\n                      </div>\r\n                      <p>{shorten(d.from_address, 60)}</p>\r\n                    </div>\r\n                    <div>\r\n                      <div className=\"text-[10px] font-semibold text-slate-500\">\r\n                        –•“Æ–†–ì–≠–•\r\n                      </div>\r\n                      <p>{shorten(d.to_address, 60)}</p>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {d.note && (\r\n                    <p className=\"mt-1 text-[11px] text-slate-500\">\r\n                      {shorten(d.note, 80)}\r\n                    </p>\r\n                  )}\r\n\r\n                  <p className=\"mt-1 text-[10px] text-slate-400\">\r\n                    “Æ“Ø—Å–≥—ç—Å—ç–Ω: {formatDateTime(d.created_at)}\r\n                  </p>\r\n\r\n                  {subtitle && (\r\n                    <p className=\"mt-1 text-[10px] text-slate-500\">{subtitle}</p>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </button>\r\n          );\r\n        })}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // =================== 9. –ê—á–∞–∞–ª–∞–ª—Ç / –∞–ª–¥–∞–∞ ===================\r\n\r\n  if (loadingUser || loadingList) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-sm text-slate-500\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-sm text-slate-500\">–•—ç—Ä—ç–≥–ª—ç–≥—á –æ–ª–¥—Å–æ–Ω–≥“Ø–π.</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const filtered = filterByTab(activeTab, deliveries);\r\n\r\n  const tabCounts: Record<DriverTabId, number> = DRIVER_TABS.reduce(\r\n    (acc, t) => {\r\n      acc[t.id] = filterByTab(t.id, deliveries).length;\r\n      return acc;\r\n    },\r\n    {} as Record<DriverTabId, number>\r\n  );\r\n\r\n  // =================== 10. –ì–æ–ª UI ===================\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <header className=\"border-b border-slate-200 bg-white\">\r\n        <div className=\"max-w-3xl mx-auto px-4 py-4 flex items-center justify-between gap-3\">\r\n          <div>\r\n            <h1 className=\"text-sm font-semibold text-slate-900\">\r\n              –ñ–æ–ª–æ–æ—á–∏–π–Ω —Å–∞–º–±–∞—Ä\r\n            </h1>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <button\r\n              onClick={handleLogout}\r\n              className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-700 hover:bg-slate-50\"\r\n            >\r\n              –ì–∞—Ä–∞—Ö\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      <main className=\"max-w-3xl mx-auto px-4 py-5 space-y-4\">\r\n        {message && (\r\n          <div className=\"rounded-2xl border border-emerald-100 bg-emerald-50 px-4 py-2 text-xs text-emerald-800\">\r\n            {message}\r\n          </div>\r\n        )}\r\n        {error && (\r\n          <div className=\"rounded-2xl border border-rose-100 bg-rose-50 px-4 py-2 text-xs text-rose-700\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"rounded-2xl border border-slate-200 bg-white px-2 py-2 flex flex-wrap gap-1\">\r\n          {DRIVER_TABS.map((tab) => {\r\n            const active = tab.id === activeTab;\r\n            const count = tabCounts[tab.id] || 0;\r\n\r\n            return (\r\n              <button\r\n                key={tab.id}\r\n                type=\"button\"\r\n                onClick={() => changeTab(tab.id)}\r\n                className={\r\n                  \"flex items-center gap-1 text-[11px] px-3 py-1.5 rounded-full border transition \" +\r\n                  (active\r\n                    ? \"bg-emerald-600 text-white border-emerald-600\"\r\n                    : \"bg-white text-slate-600 border-slate-200 hover:bg-slate-50\")\r\n                }\r\n              >\r\n                <span>{tab.label}</span>\r\n                {count > 0 && (\r\n                  <span\r\n                    className={\r\n                      \"inline-flex min-w-[18px] justify-center rounded-full px-1.5 py-0.5 text-[10px] \" +\r\n                      (active\r\n                        ? \"bg-white/10 text-emerald-50\"\r\n                        : \"bg-slate-100 text-slate-700\")\r\n                    }\r\n                  >\r\n                    {count}\r\n                  </span>\r\n                )}\r\n              </button>\r\n            );\r\n          })}\r\n        </div>\r\n\r\n        <section className=\"space-y-3\">{renderList(filtered, activeTab)}</section>\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/layout.tsx",
        "summary": "",
        "content": "import type { Metadata } from \"next\";\nimport { Geist, Geist_Mono } from \"next/font/google\";\nimport \"./globals.css\";\n\nconst geistSans = Geist({\n  variable: \"--font-geist-sans\",\n  subsets: [\"latin\"],\n});\n\nconst geistMono = Geist_Mono({\n  variable: \"--font-geist-mono\",\n  subsets: [\"latin\"],\n});\n\nexport const metadata: Metadata = {\n  title: \"Create Next App\",\n  description: \"Generated by create next app\",\n};\n\nexport default function RootLayout({\n  children,\n}: Readonly<{\n  children: React.ReactNode;\n}>) {\n  return (\n    <html lang=\"en\">\n      <body\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n      >\n        {children}\n      </body>\n    </html>\n  );\n}\n"
      },
      {
        "path": "app/page.tsx",
        "summary": "",
        "content": "\"use client\";\n\nimport { FormEvent, useState } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { supabase } from \"@/lib/supabase\";\n\nexport default function LoginPage() {\n  const router = useRouter();\n\n  const [identifier, setIdentifier] = useState(\"\"); // –∏–º—ç–π–ª —ç—Å–≤—ç–ª —É—Ç–∞—Å\n  const [password, setPassword] = useState(\"\"); // 4 –æ—Ä–æ–Ω—Ç–æ–π PIN\n  const [showPassword, setShowPassword] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [error, setError] = useState(\"\");\n\n  async function handleSubmit(e: FormEvent<HTMLFormElement>) {\n    e.preventDefault();\n    setError(\"\");\n\n    if (!identifier.trim() || !password.trim()) {\n      setError(\"–ò–º—ç–π–ª/—É—Ç–∞—Å –±–æ–ª–æ–Ω –Ω—É—É—Ü “Ø–≥—ç—ç –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\n      return;\n    }\n\n    setIsSubmitting(true);\n\n    const { data, error: selectError } = await supabase\n      .from(\"users\")\n      .select(\"*\")\n      .or(`email.eq.${identifier},phone.eq.${identifier}`)\n      .maybeSingle();\n\n    if (selectError) {\n      console.error(selectError);\n      setIsSubmitting(false);\n      setError(\"–°–µ—Ä–≤–µ—Ä–∏–π–Ω –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\n      return;\n    }\n\n    if (!data) {\n      setIsSubmitting(false);\n      setError(\"–ò–π–º —Ö—ç—Ä—ç–≥–ª—ç–≥—á –±“Ø—Ä—Ç–≥—ç–ª–≥“Ø–π –±–∞–π–Ω–∞.\");\n      return;\n    }\n\n    if (data.pin !== password) {\n      setIsSubmitting(false);\n      setError(\"–ù—É—É—Ü “Ø–≥ –±—É—Ä—É—É –±–∞–π–Ω–∞.\");\n      return;\n    }\n\n    // ‚úÖ –ê–º–∂–∏–ª—Ç—Ç–∞–π –Ω—ç–≤—Ç—ç—Ä–≤—ç–ª localStorage-–¥ —Ö–∞–¥–≥–∞–ª–∞–∞–¥ role-–æ–æ—Ä –Ω—å —á–∏–≥–ª“Ø“Ø–ª–Ω—ç\n    const user = {\n      id: data.id,\n      role: data.role,\n      name: data.name,\n      phone: data.phone,\n      email: data.email,\n    };\n\n    if (typeof window !== \"undefined\") {\n      localStorage.setItem(\"incomeUser\", JSON.stringify(user));\n    }\n\n    setIsSubmitting(false);\n\n    if (data.role === \"seller\") {\n      router.push(\"/seller\");\n    } else {\n      router.push(\"/driver\");\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen bg-slate-50 flex items-center justify-center px-4\">\n      <div className=\"w-full max-w-md\">\n        {/* Top logo / title */}\n        <div className=\"mb-8 text-center\">\n          <div className=\"inline-flex items-center justify-center rounded-full bg-emerald-50 px-4 py-2 mb-3\">\n            <span className=\"text-sm font-semibold text-emerald-700\">\n              INCOME\n            </span>\n          </div>\n          <h1 className=\"text-2xl font-semibold text-slate-900\">\n            –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω marketplace\n          </h1>\n          <p className=\"mt-2 text-sm text-slate-500\">\n            –£—Ç–∞—Å —ç—Å–≤—ç–ª –∏–º—ç–π–ª—ç—ç—Ä—ç—ç –Ω—ç–≤—Ç—ç—Ä—á, —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Å–∏—Å—Ç–µ–º—ç—ç –∞—à–∏–≥–ª–∞.\n          </p>\n        </div>\n\n        {/* Card */}\n        <div className=\"bg-white rounded-2xl shadow-sm border border-slate-100 p-6\">\n          <h2 className=\"text-lg font-semibold text-slate-900 mb-1\">\n            –ù—ç–≤—Ç—Ä—ç—Ö\n          </h2>\n          <p className=\"text-sm text-slate-500 mb-6\">\n            ”®–º–Ω”© –±“Ø—Ä—Ç–≥“Ø“Ø–ª—Å—ç–Ω –∏–º—ç–π–ª —ç—Å–≤—ç–ª —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞—Ä –Ω—ç–≤—Ç—ç—Ä–Ω—ç.\n          </p>\n\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            {/* Email / Phone */}\n            <div>\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\n                –ò–º—ç–π–ª —ç—Å–≤—ç–ª —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä\n              </label>\n              <input\n                type=\"text\"\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\n                placeholder=\"example@mail.com —ç—Å–≤—ç–ª 88xxxxxx\"\n                value={identifier}\n                onChange={(e) => setIdentifier(e.target.value)}\n              />\n            </div>\n\n            {/* Password */}\n            <div>\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\n                –ù—É—É—Ü “Ø–≥ (4 –æ—Ä–æ–Ω—Ç–æ–π PIN)\n              </label>\n              <div className=\"relative\">\n                <input\n                  type={showPassword ? \"text\" : \"password\"}\n                  className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50 pr-10 tracking-[0.3em]\"\n                  placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                />\n                <button\n                  type=\"button\"\n                  className=\"absolute inset-y-0 right-0 px-3 text-xs text-slate-500 hover:text-slate-700\"\n                  onClick={() => setShowPassword((v) => !v)}\n                >\n                  {showPassword ? \"–ù—É—É—Ö\" : \"–•–∞—Ä–∞—Ö\"}\n                </button>\n              </div>\n            </div>\n\n            {/* Error */}\n            {error && (\n              <div className=\"rounded-xl bg-red-50 text-red-700 text-sm px-3 py-2\">\n                {error}\n              </div>\n            )}\n\n            {/* Submit */}\n            <button\n              type=\"submit\"\n              disabled={isSubmitting}\n              className=\"w-full inline-flex items-center justify-center rounded-xl bg-emerald-600 text-white text-sm font-semibold py-2.5 mt-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-emerald-700 transition-colors\"\n            >\n              {isSubmitting ? \"–ù—ç–≤—Ç—Ä—ç–∂ –±–∞–π–Ω–∞...\" : \"–ù—ç–≤—Ç—Ä—ç—Ö\"}\n            </button>\n          </form>\n\n          {/* Divider */}\n          <div className=\"flex items-center mt-6 mb-4\">\n            <div className=\"flex-1 h-px bg-slate-200\" />\n            <span className=\"mx-3 text-xs text-slate-400\">—ç—Å–≤—ç–ª</span>\n            <div className=\"flex-1 h-px bg-slate-200\" />\n          </div>\n\n          {/* Register link */}\n          <p className=\"text-sm text-slate-600 text-center\">\n            –®–∏–Ω—ç —Ö—ç—Ä—ç–≥–ª—ç–≥—á “Ø“Ø?{\" \"}\n            <Link\n              href=\"/register\"\n              className=\"font-semibold text-emerald-600 hover:text-emerald-700\"\n            >\n              –ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö\n            </Link>\n          </p>\n        </div>\n\n        {/* Footer */}\n        <p className=\"mt-6 text-xs text-slate-400 text-center\">\n          INCOME v1.0 ¬∑ BABA &amp; Hypatia ¬∑ 2025\n        </p>\n      </div>\n    </div>\n  );\n}\n"
      },
      {
        "path": "app/register/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport { FormEvent, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { supabase } from \"@/lib/supabase\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\nexport default function RegisterPage() {\r\n  const router = useRouter();\r\n\r\n  const [role, setRole] = useState<Role>(\"seller\");\r\n  const [name, setName] = useState(\"\");\r\n  const [phone, setPhone] = useState(\"\");\r\n  const [email, setEmail] = useState(\"\");\r\n  const [pin, setPin] = useState(\"\");\r\n  const [pin2, setPin2] = useState(\"\");\r\n  const [showPin, setShowPin] = useState(false);\r\n  const [agree, setAgree] = useState(false);\r\n\r\n  const [error, setError] = useState(\"\");\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n  const roleLabel = role === \"seller\" ? \"–•—É–¥–∞–ª–¥–∞–≥—á\" : \"–ñ–æ–ª–æ–æ—á\";\r\n\r\n  async function handleSubmit(e: FormEvent<HTMLFormElement>) {\r\n    e.preventDefault();\r\n    setError(\"\");\r\n\r\n    // --- –§—Ä–æ–Ω—Ç —Ç–∞–ª—ã–Ω —à–∞–ª–≥–∞–ª—Ç ---\r\n    if (!name.trim()) {\r\n      setError(\"–ù—ç—Ä—ç—ç –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!phone.trim()) {\r\n      setError(\"–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞ –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!email.trim()) {\r\n      setError(\"–ò–º—ç–π–ª —Ö–∞—è–≥–∞–∞ –±”©–≥–ª”©–Ω”© “Ø“Ø.\");\r\n      return;\r\n    }\r\n    if (!email.includes(\"@\") || !email.includes(\".\")) {\r\n      setError(\"–ò–º—ç–π–ª —Ö–∞—è–≥–∞–∞ –∑”©–≤ —Ñ–æ—Ä–º–∞—Ç—Ç–∞–π –æ—Ä—É—É–ª–Ω–∞ —É—É.\");\r\n      return;\r\n    }\r\n    if (!/^\\d{4}$/.test(pin)) {\r\n      setError(\"–ù—É—É—Ü “Ø–≥ 4 –æ—Ä–æ–Ω—Ç–æ–π —Ç–æ–æ –±–∞–π—Ö —ë—Å—Ç–æ–π.\");\r\n      return;\r\n    }\r\n    if (pin !== pin2) {\r\n      setError(\"–ù—É—É—Ü “Ø–≥ —Ö–æ—ë—Ä —Ç–∞–∞—Ä–∞—Ö–≥“Ø–π –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n    if (!agree) {\r\n      setError(\"–ê—à–∏–≥–ª–∞—Ö –Ω”©—Ö—Ü”©–ª—Ç—ç–π —Ç–∞–Ω–∏–ª—Ü–∞–∂ –∑”©–≤—à”©”©—Ä”©—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π.\");\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    // --- –£—Ç–∞—Å / –∏–º—ç–π–ª –¥–∞–≤—Ç–∞–≥–¥–∞–∂ –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞ ---\r\n    const { data: existing, error: existsError } = await supabase\r\n      .from(\"users\")\r\n      .select(\"id\")\r\n      .or(`phone.eq.${phone},email.eq.${email}`)\r\n      .maybeSingle();\r\n\r\n    if (existsError) {\r\n      console.error(existsError);\r\n      setIsSubmitting(false);\r\n      setError(\"–°–µ—Ä–≤–µ—Ä–∏–π–Ω –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ä–∞–∞ –¥–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.\");\r\n      return;\r\n    }\r\n\r\n    if (existing) {\r\n      setIsSubmitting(false);\r\n      setError(\"–≠–Ω—ç —É—Ç–∞—Å —ç—Å–≤—ç–ª –∏–º—ç–π–ª—ç—ç—Ä –∞–ª—å —Ö—ç–¥–∏–π–Ω –±“Ø—Ä—Ç–≥“Ø“Ø–ª—Å—ç–Ω –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n\r\n    // --- –ñ–∏–Ω—Ö—ç–Ω—ç insert ---\r\n    const { error: insertError } = await supabase.from(\"users\").insert({\r\n      role,\r\n      name,\r\n      phone,\r\n      email,\r\n      pin, // v2 –¥—ç—ç—Ä PIN-–≥ hash —Ö–∏–π–Ω—ç\r\n    });\r\n\r\n    if (insertError) {\r\n      console.error(insertError);\r\n      setIsSubmitting(false);\r\n      setError(\"–ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      return;\r\n    }\r\n\r\n    // –ê–º–∂–∏–ª—Ç—Ç–∞–π ‚Üí Login —Ä—É—É\r\n    setIsSubmitting(false);\r\n    router.push(\"/\");\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50 flex items-center justify-center px-4\">\r\n      <div className=\"w-full max-w-md\">\r\n        {/* Top logo / title */}\r\n        <div className=\"mb-8 text-center\">\r\n          <div className=\"inline-flex items-center justify-center rounded-full bg-emerald-50 px-4 py-2 mb-3\">\r\n            <span className=\"text-sm font-semibold text-emerald-700\">\r\n              INCOME\r\n            </span>\r\n          </div>\r\n          <h1 className=\"text-2xl font-semibold text-slate-900\">\r\n            –ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö\r\n          </h1>\r\n          <p className=\"mt-2 text-sm text-slate-500\">\r\n            –ñ–æ–ª–æ–æ—á —ç—Å–≤—ç–ª –•—É–¥–∞–ª–¥–∞–≥—á —Ö—ç–ª–±—ç—Ä—ç—ç—Ä –Ω—ç–≥ —É–¥–∞–∞ –±“Ø—Ä—Ç–≥“Ø“Ø–ª–∂ –∞—à–∏–≥–ª–∞–Ω–∞.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Card */}\r\n        <div className=\"bg-white rounded-2xl shadow-sm border border-slate-100 p-6\">\r\n          {/* Role toggle */}\r\n          <div className=\"flex mb-6 rounded-xl bg-slate-50 p-1\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setRole(\"seller\")}\r\n              className={`flex-1 text-sm font-medium py-2 rounded-lg transition ${\r\n                role === \"seller\"\r\n                  ? \"bg-white shadow-sm text-emerald-700\"\r\n                  : \"text-slate-500\"\r\n              }`}\r\n            >\r\n              –•—É–¥–∞–ª–¥–∞–≥—á\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setRole(\"driver\")}\r\n              className={`flex-1 text-sm font-medium py-2 rounded-lg transition ${\r\n                role === \"driver\"\r\n                  ? \"bg-white shadow-sm text-emerald-700\"\r\n                  : \"text-slate-500\"\r\n              }`}\r\n            >\r\n              –ñ–æ–ª–æ–æ—á\r\n            </button>\r\n          </div>\r\n\r\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n            {/* Name */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ù—ç—Ä\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\r\n                placeholder=\"–ñ–∏—à—ç—ç: –ë–∞—Ç–±–∞—è—Ä\"\r\n                value={name}\r\n                onChange={(e) => setName(e.target.value)}\r\n              />\r\n            </div>\r\n\r\n            {/* Phone */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä\r\n              </label>\r\n              <input\r\n                type=\"tel\"\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\r\n                placeholder=\"–ñ–∏—à—ç—ç: 88112233\"\r\n                value={phone}\r\n                onChange={(e) => setPhone(e.target.value)}\r\n              />\r\n              <p className=\"mt-1 text-xs text-slate-400\">\r\n                –ù—ç–≥ —É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞—Ä –∑”©–≤—Ö”©–Ω –Ω—ç–≥ –ª —É–¥–∞–∞ –±“Ø—Ä—Ç–≥“Ø“Ø–ª–Ω—ç.\r\n              </p>\r\n            </div>\r\n\r\n            {/* Email */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ò–º—ç–π–ª —Ö–∞—è–≥\r\n              </label>\r\n              <input\r\n                type=\"email\"\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50\"\r\n                placeholder=\"example@mail.com\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n              />\r\n              <p className=\"mt-1 text-xs text-slate-400\">\r\n                –ò–º—ç–π–ª—ç—ç—Ä –Ω—É—É—Ü “Ø–≥ —Å—ç—Ä–≥—ç—ç—Ö, –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö –º—ç–¥—ç—ç–ª—ç–ª –æ—á–Ω–æ.\r\n              </p>\r\n            </div>\r\n\r\n            {/* PIN */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ù—É—É—Ü “Ø–≥ (4 –æ—Ä–æ–Ω—Ç–æ–π PIN)\r\n              </label>\r\n              <div className=\"relative\">\r\n                <input\r\n                  type={showPin ? \"text\" : \"password\"}\r\n                  inputMode=\"numeric\"\r\n                  maxLength={4}\r\n                  className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50 pr-10 tracking-[0.3em]\"\r\n                  placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                  value={pin}\r\n                  onChange={(e) => {\r\n                    const v = e.target.value.replace(/\\D/g, \"\");\r\n                    setPin(v);\r\n                  }}\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"absolute inset-y-0 right-0 px-3 text-xs text-slate-500 hover:text-slate-700\"\r\n                  onClick={() => setShowPin((v) => !v)}\r\n                >\r\n                  {showPin ? \"–ù—É—É—Ö\" : \"–•–∞—Ä–∞—Ö\"}\r\n                </button>\r\n              </div>\r\n              <p className=\"mt-1 text-xs text-slate-400\">\r\n                –ó”©–≤—Ö”©–Ω 4 –æ—Ä–æ–Ω—Ç–æ–π —Ç–æ–æ –±–∞–π—Ö–∞–∞—Ä —Ç–æ—Ö–∏—Ä—É—É–ª–Ω–∞ (–∂–∏—à—ç—ç: 1234).\r\n              </p>\r\n            </div>\r\n\r\n            {/* PIN confirm */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-slate-700 mb-1\">\r\n                –ù—É—É—Ü “Ø–≥ –¥–∞–≤—Ç–∞—Ö\r\n              </label>\r\n              <input\r\n                type={showPin ? \"text\" : \"password\"}\r\n                inputMode=\"numeric\"\r\n                maxLength={4}\r\n                className=\"w-full rounded-xl border border-slate-200 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-slate-50 tracking-[0.3em]\"\r\n                placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢\"\r\n                value={pin2}\r\n                onChange={(e) => {\r\n                  const v = e.target.value.replace(/\\D/g, \"\");\r\n                  setPin2(v);\r\n                }}\r\n              />\r\n            </div>\r\n\r\n            {/* Terms */}\r\n            <div className=\"flex items-start gap-2 pt-1\">\r\n              <input\r\n                id=\"agree\"\r\n                type=\"checkbox\"\r\n                checked={agree}\r\n                onChange={(e) => setAgree(e.target.checked)}\r\n                className=\"mt-1 h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500\"\r\n              />\r\n              <label\r\n                htmlFor=\"agree\"\r\n                className=\"text-xs text-slate-600 leading-relaxed\"\r\n              >\r\n                –ë–∏ INCOME —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω marketplace-–∏–π–Ω –∞—à–∏–≥–ª–∞—Ö –Ω”©—Ö—Ü”©–ª, —Ö—É–≤–∏–π–Ω\r\n                –º—ç–¥—ç—ç–ª—ç–ª –∞—à–∏–≥–ª–∞—Ö –∂—É—Ä–º—ã–≥ —É–Ω—à–∏–∂ —Ç–∞–Ω–∏–ª—Ü—Å–∞–Ω –±”©–≥”©”©–¥{\" \"}\r\n                <span className=\"font-semibold\">–∑”©–≤—à”©”©—Ä—á –±–∞–π–Ω–∞.</span>\r\n              </label>\r\n            </div>\r\n\r\n            {/* Error */}\r\n            {error && (\r\n              <div className=\"rounded-xl bg-red-50 text-red-700 text-sm px-3 py-2\">\r\n                {error}\r\n              </div>\r\n            )}\r\n\r\n            {/* Submit */}\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isSubmitting}\r\n              className=\"w-full inline-flex items-center justify-center rounded-xl bg-emerald-600 text-white text-sm font-semibold py-2.5 mt-2 disabled:opacity-60 disabled:cursor-not-allowed hover:bg-emerald-700 transition-colors\"\r\n            >\r\n              {isSubmitting\r\n                ? \"–ë“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç–∂ –±–∞–π–Ω–∞...\"\r\n                : `${roleLabel} –±“Ø—Ä—Ç–≥—ç–ª “Ø“Ø—Å–≥—ç—Ö`}\r\n            </button>\r\n          </form>\r\n\r\n          {/* Divider */}\r\n          <div className=\"flex items-center mt-6 mb-4\">\r\n            <div className=\"flex-1 h-px bg-slate-200\" />\r\n            <span className=\"mx-3 text-xs text-slate-400\">—ç—Å–≤—ç–ª</span>\r\n            <div className=\"flex-1 h-px bg-slate-200\" />\r\n          </div>\r\n\r\n          {/* Back to login */}\r\n          <p className=\"text-sm text-slate-600 text-center\">\r\n            –ê–ª—å —Ö—ç–¥–∏–π–Ω –±“Ø—Ä—Ç–≥—ç–ª—Ç—ç–π —é—É?{\" \"}\r\n            <Link\r\n              href=\"/\"\r\n              className=\"font-semibold text-emerald-600 hover:text-emerald-700\"\r\n            >\r\n              –ù—ç–≤—Ç—Ä—ç—Ö\r\n            </Link>\r\n          </p>\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <p className=\"mt-6 text-xs text-slate-400 text-center\">\r\n          INCOME v1.0 ¬∑ {roleLabel} –±“Ø—Ä—Ç–≥—ç–ª ¬∑ –ú–æ–Ω–≥–æ–ª\r\n        </p>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/seller/delivery/[id]/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n/* ===========================\r\n * app/seller/delivery/[id]/page.tsx\r\n * - ‚úÖ Rating (–æ–¥ ”©–≥”©—Ö) –ª–æ–≥–∏–∫ –±“Ø—Ä—ç–Ω —Ö–∞—Å—Å–∞–Ω\r\n * - –ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö / —à–∏–π–¥–≤—ç—Ä–ª—ç—Ö, –∂–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Ö, —Ü—É—Ü–ª–∞—Ö, —Ç”©–ª–±”©—Ä —Ç—ç–º–¥—ç–≥–ª—ç—Ö —Ö—ç–≤—ç—ç—Ä\r\n * =========================== */\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useRouter, useParams, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { DeliveryStatus } from \"@/lib/deliveryLogic\";\r\n\r\n/* ===========================\r\n * TYPES\r\n * =========================== */\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryDetail = {\r\n  id: string;\r\n  seller_id: string;\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n  chosen_driver_id: string | null;\r\n\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n  closed_at: string | null;\r\n\r\n  dispute_reason?: string | null;\r\n  dispute_opened_at?: string | null;\r\n};\r\n\r\ntype DriverSummary = {\r\n  id: string;\r\n  name: string | null;\r\n  phone: string | null;\r\n  rating?: number | null;\r\n  total_deliveries?: number | null;\r\n};\r\n\r\ntype DriverBidRow = {\r\n  id: string;\r\n  driver_id: string;\r\n  created_at: string;\r\n  driver: DriverSummary | null;\r\n};\r\n\r\n/* ===========================\r\n * HELPERS\r\n * =========================== */\r\n\r\nfunction typeLabel(deliveryType: string | null): { icon: string; label: string } {\r\n  switch (deliveryType) {\r\n    case \"apartment\":\r\n      return { icon: \"üèô\", label: \"–ë–∞–π—Ä\" };\r\n    case \"ger\":\r\n      return { icon: \"üè†\", label: \"–ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª\" };\r\n    case \"camp\":\r\n      return { icon: \"üèï\", label: \"–õ–∞–≥–µ—Ä\" };\r\n    case \"countryside\":\r\n      return { icon: \"üöå\", label: \"–û—Ä–æ–Ω –Ω—É—Ç–∞–≥\" };\r\n    default:\r\n      return { icon: \"üì¶\", label: \"–•“Ø—Ä–≥—ç–ª—Ç\" };\r\n  }\r\n}\r\n\r\nfunction statusBadge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return { text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\", className: \"bg-emerald-50 text-emerald-700 border-emerald-100\" };\r\n    case \"ASSIGNED\":\r\n      return { text: \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\", className: \"bg-sky-50 text-sky-700 border-sky-100\" };\r\n    case \"ON_ROUTE\":\r\n      return { text: \"–ó–∞–º–¥ –≥–∞—Ä—Å–∞–Ω\", className: \"bg-indigo-50 text-indigo-700 border-indigo-100\" };\r\n    case \"DELIVERED\":\r\n      return { text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\", className: \"bg-slate-900 text-white border-slate-900\" };\r\n    case \"CLOSED\":\r\n      return { text: \"–•–∞–∞–≥–¥—Å–∞–Ω\", className: \"bg-emerald-900 text-emerald-50 border-emerald-900\" };\r\n    case \"CANCELLED\":\r\n      return { text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\", className: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    case \"DISPUTE\":\r\n      return { text: \"–ú–∞—Ä–≥–∞–∞–Ω\", className: \"bg-rose-50 text-rose-700 border-rose-100\" };\r\n    default:\r\n      return { text: status, className: \"bg-slate-50 text-slate-600 border-slate-100\" };\r\n  }\r\n}\r\n\r\nfunction shorten(s: string | null, max = 120) {\r\n  if (!s) return \"\";\r\n  const t = s.trim();\r\n  if (t.length <= max) return t;\r\n  return t.slice(0, max).replace(/\\s+$/, \"\") + \"‚Ä¶\";\r\n}\r\n\r\nfunction formatPrice(n: number | null) {\r\n  if (!n) return \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n  return n.toLocaleString(\"mn-MN\") + \"‚ÇÆ\";\r\n}\r\n\r\nfunction formatDateTime(iso: string) {\r\n  if (!iso) return \"\";\r\n  const d = new Date(iso);\r\n  return (\r\n    d.toLocaleDateString(\"mn-MN\", { month: \"2-digit\", day: \"2-digit\" }) +\r\n    \" \" +\r\n    d.toLocaleTimeString(\"mn-MN\", { hour: \"2-digit\", minute: \"2-digit\" })\r\n  );\r\n}\r\n\r\nfunction driverRatingText(driver: DriverSummary | null) {\r\n  if (!driver) return \"“Æ–Ω—ç–ª–≥—ç—ç –±–∞–π—Ö–≥“Ø–π\";\r\n  if (driver.rating == null) return \"“Æ–Ω—ç–ª–≥—ç—ç –±–∞–π—Ö–≥“Ø–π\";\r\n  const r = driver.rating.toFixed(1).replace(/\\.0$/, \"\");\r\n  const total = driver.total_deliveries || 0;\r\n  return `${r} ‚òÖ ‚Ä¢ ${total} —Ö“Ø—Ä–≥—ç–ª—Ç`;\r\n}\r\n\r\n/* ===========================\r\n * MAIN\r\n * =========================== */\r\n\r\nexport default function SellerDeliveryDetailPage() {\r\n  const router = useRouter();\r\n  const params = useParams();\r\n  const searchParams = useSearchParams();\r\n\r\n  const idParam = (params as any)?.id;\r\n  const deliveryId =\r\n    typeof idParam === \"string\" ? idParam : Array.isArray(idParam) ? idParam[0] : \"\";\r\n\r\n  const fromTab = searchParams.get(\"tab\");\r\n  const backUrl = fromTab ? `/seller?tab=${fromTab}` : \"/seller\";\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [loadingUser, setLoadingUser] = useState(true);\r\n\r\n  const [delivery, setDelivery] = useState<DeliveryDetail | null>(null);\r\n  const [bids, setBids] = useState<DriverBidRow[]>([]);\r\n  const [loadingDetail, setLoadingDetail] = useState(true);\r\n\r\n  const [assigningId, setAssigningId] = useState<string | null>(null);\r\n  const [markingPickedUp, setMarkingPickedUp] = useState(false);\r\n\r\n  const [showDisputeModal, setShowDisputeModal] = useState(false);\r\n  const [disputeReason, setDisputeReason] = useState(\"\");\r\n  const [openingDispute, setOpeningDispute] = useState(false);\r\n\r\n  // DISPUTE resolve\r\n  const [resolvingDispute, setResolvingDispute] = useState(false);\r\n  const [showResolveDisputeModal, setShowResolveDisputeModal] = useState(false);\r\n\r\n  // Cancel chosen driver\r\n  const [showCancelModal, setShowCancelModal] = useState(false);\r\n  const [cancelReasons, setCancelReasons] = useState({\r\n    no_show: false,\r\n    too_late: false,\r\n    no_contact: false,\r\n    bad_attitude: false,\r\n  });\r\n  const [cancelOtherReason, setCancelOtherReason] = useState(\"\");\r\n  const [cancelling, setCancelling] = useState(false);\r\n\r\n  // Driver detail modal\r\n  const [showDriverInfoModal, setShowDriverInfoModal] = useState(false);\r\n\r\n  // Payment toggle\r\n  const [payLoading, setPayLoading] = useState(false);\r\n\r\n  const [message, setMessage] = useState<string | null>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  /* ---------- LOGIN GUARD ---------- */\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) {\r\n        router.replace(\"/\");\r\n        return;\r\n      }\r\n      const parsed: IncomeUser = JSON.parse(raw);\r\n      if (parsed.role !== \"seller\") {\r\n        router.replace(\"/\");\r\n        return;\r\n      }\r\n      setUser(parsed);\r\n      setLoadingUser(false);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —É–Ω—à–∏—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      setLoadingUser(false);\r\n    }\r\n  }, [router]);\r\n\r\n  /* ---------- FETCH DETAIL ---------- */\r\n  useEffect(() => {\r\n    if (!user || !deliveryId) return;\r\n    void fetchDetail(user.id, deliveryId);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user, deliveryId]);\r\n\r\n  async function fetchDetail(sellerId: string, id: string) {\r\n    try {\r\n      setLoadingDetail(true);\r\n      setError(null);\r\n      setMessage(null);\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          seller_id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          chosen_driver_id,\r\n          seller_marked_paid,\r\n          driver_confirmed_payment,\r\n          closed_at,\r\n          dispute_reason,\r\n          dispute_opened_at,\r\n          driver_bids (\r\n            id,\r\n            driver_id,\r\n            created_at,\r\n            driver:driver_id (\r\n              id,\r\n              name,\r\n              phone,\r\n              rating,\r\n              total_deliveries\r\n            )\r\n          )\r\n        `\r\n        )\r\n        .eq(\"id\", id)\r\n        .eq(\"seller_id\", sellerId)\r\n        .maybeSingle();\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        setDelivery(null);\r\n        setBids([]);\r\n        return;\r\n      }\r\n\r\n      if (!data) {\r\n        setError(\"–ò–π–º —Ö“Ø—Ä–≥—ç–ª—Ç –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\");\r\n        setDelivery(null);\r\n        setBids([]);\r\n        return;\r\n      }\r\n\r\n      const d = data as any;\r\n\r\n      const detail: DeliveryDetail = {\r\n        id: d.id,\r\n        seller_id: d.seller_id,\r\n        from_address: d.from_address,\r\n        to_address: d.to_address,\r\n        note: d.note,\r\n        status: d.status,\r\n        created_at: d.created_at,\r\n        price_mnt: d.price_mnt,\r\n        delivery_type: d.delivery_type,\r\n        chosen_driver_id: d.chosen_driver_id,\r\n        seller_marked_paid: !!d.seller_marked_paid,\r\n        driver_confirmed_payment: !!d.driver_confirmed_payment,\r\n        closed_at: d.closed_at,\r\n        dispute_reason: d.dispute_reason,\r\n        dispute_opened_at: d.dispute_opened_at,\r\n      };\r\n\r\n      const bidRows: DriverBidRow[] = Array.isArray(d.driver_bids)\r\n        ? d.driver_bids.map((b: any) => ({\r\n            id: b.id,\r\n            driver_id: b.driver_id,\r\n            created_at: b.created_at,\r\n            driver: b.driver\r\n              ? {\r\n                  id: b.driver.id,\r\n                  name: b.driver.name,\r\n                  phone: b.driver.phone,\r\n                  rating: b.driver.rating,\r\n                  total_deliveries: b.driver.total_deliveries,\r\n                }\r\n              : null,\r\n          }))\r\n        : [];\r\n\r\n      setDelivery(detail);\r\n      setBids(bidRows);\r\n    } finally {\r\n      setLoadingDetail(false);\r\n    }\r\n  }\r\n\r\n  /* ---------- LOGOUT ---------- */\r\n  function handleLogout() {\r\n    if (typeof window !== \"undefined\") {\r\n      window.localStorage.removeItem(\"incomeUser\");\r\n    }\r\n    router.push(\"/\");\r\n  }\r\n\r\n  /* ---------- DRIVER SELECT (OPEN -> ASSIGNED) ---------- */\r\n  async function handleSelectDriver(driverId: string) {\r\n    if (!delivery || !user) return;\r\n\r\n    if (delivery.status !== \"OPEN\") {\r\n      setMessage(\"–ñ–æ–ª–æ–æ—á–∏–π–≥ –∑”©–≤—Ö”©–Ω –Ω—ç—ç–ª—Ç—Ç—ç–π —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä —Å–æ–Ω–≥–æ–∂ –±–æ–ª–Ω–æ.\");\r\n      return;\r\n    }\r\n\r\n    setAssigningId(driverId);\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ chosen_driver_id: driverId, status: \"ASSIGNED\" })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ñ–æ–ª–æ–æ—á–∏–π–≥ —Å–æ–Ω–≥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, chosen_driver_id: driverId, status: \"ASSIGNED\" });\r\n      setMessage(\"–ñ–æ–ª–æ–æ—á –∞–º–∂–∏–ª—Ç—Ç–∞–π —Å–æ–Ω–≥–æ–ª–æ–æ.\");\r\n    } finally {\r\n      setAssigningId(null);\r\n    }\r\n  }\r\n\r\n  /* ---------- ASSIGNED -> ON_ROUTE ---------- */\r\n  async function handleMarkPickedUp() {\r\n    if (!delivery || !user) return;\r\n\r\n    if (delivery.status !== \"ASSIGNED\" || !delivery.chosen_driver_id) {\r\n      setMessage(\"–≠—Ö–ª—ç—ç–¥ –∂–æ–ª–æ–æ—á–∏–π–≥ —Å–æ–Ω–≥–æ—Å–æ–Ω –±–∞–π—Ö —ë—Å—Ç–æ–π.\");\r\n      return;\r\n    }\r\n\r\n    setMarkingPickedUp(true);\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"ON_ROUTE\" })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç—ç–¥ –≥–∞—Ä—Å–∞–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"ON_ROUTE\" });\r\n      setMessage(\"–•“Ø—Ä–≥—ç–ª—Ç—ç–¥ –≥–∞—Ä—Å–∞–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\");\r\n\r\n      // ‚úÖ –ó–∞–º–¥ —Ç–∞–± —Ä—É—É –±—É—Ü–∞–∞—Ö (—Ç–∞–Ω—ã —Ö“Ø—Å—ç–ª—Ç)\r\n      setTimeout(() => {\r\n        router.push(\"/seller?tab=ON_ROUTE\");\r\n      }, 250);\r\n    } finally {\r\n      setMarkingPickedUp(false);\r\n    }\r\n  }\r\n\r\n  /* ---------- DISPUTE OPEN ---------- */\r\n  const canOpenDisputeFlag = !!delivery && !!delivery.chosen_driver_id && delivery.status === \"ON_ROUTE\";\r\n\r\n  async function handleOpenDisputeConfirm() {\r\n    if (!delivery || !user || !delivery.chosen_driver_id) return;\r\n\r\n    const reason = disputeReason.trim();\r\n    if (!reason) {\r\n      setError(\"–ú–∞—Ä–≥–∞–∞–Ω—ã —à–∞–ª—Ç–≥–∞–∞–Ω–∞–∞ —Ç–æ–≤—á—Ö–æ–Ω –±–∏—á–Ω—ç “Ø“Ø.\");\r\n      return;\r\n    }\r\n\r\n    setOpeningDispute(true);\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const nowIso = new Date().toISOString();\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"DISPUTE\", dispute_reason: reason, dispute_opened_at: nowIso })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"DISPUTE\", dispute_reason: reason, dispute_opened_at: nowIso });\r\n      setShowDisputeModal(false);\r\n      setDisputeReason(\"\");\r\n      setMessage(\"–ú–∞—Ä–≥–∞–∞–Ω –∞–º–∂–∏–ª—Ç—Ç–∞–π –Ω—ç—ç–≥–¥–ª—ç—ç.\");\r\n    } finally {\r\n      setOpeningDispute(false);\r\n    }\r\n  }\r\n\r\n  /* ---------- DISPUTE RESOLVE (DISPUTE -> DELIVERED) ---------- */\r\n  const canResolveDisputeFlag = !!delivery && delivery.status === \"DISPUTE\";\r\n\r\n  async function handleResolveDispute() {\r\n    if (!delivery || !user) return;\r\n\r\n    setResolvingDispute(true);\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"DELIVERED\", dispute_reason: null, dispute_opened_at: null })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"–ú–∞—Ä–≥–∞–∞–Ω —à–∏–π–¥–≤—ç—Ä–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"DELIVERED\", dispute_reason: null, dispute_opened_at: null });\r\n      setShowResolveDisputeModal(false);\r\n      setMessage(\"–ú–∞—Ä–≥–∞–∞–Ω—ã–≥ —à–∏–π–¥–≤—ç—Ä–ª—ç–∂, —Ö“Ø—Ä–≥—ç—Å—ç–Ω —Ç”©–ª”©–≤ —Ä“Ø“Ø —à–∏–ª–∂“Ø“Ø–ª–ª—ç—ç.\");\r\n\r\n      setTimeout(() => {\r\n        router.push(\"/seller?tab=DELIVERED\");\r\n      }, 450);\r\n    } finally {\r\n      setResolvingDispute(false);\r\n    }\r\n  }\r\n\r\n  /* ---------- CANCEL DRIVER (ASSIGNED -> OPEN + –±–ª–æ–∫) ---------- */\r\n  const canCancelDriver = !!delivery && delivery.status === \"ASSIGNED\" && !!delivery.chosen_driver_id;\r\n\r\n  function toggleCancelReason(key: keyof typeof cancelReasons) {\r\n    setCancelReasons((prev) => ({ ...prev, [key]: !prev[key] }));\r\n  }\r\n\r\n  async function handleCancelDriverConfirm() {\r\n    if (!delivery || !user || !delivery.chosen_driver_id) return;\r\n\r\n    const labels: string[] = [];\r\n    if (cancelReasons.no_show) labels.push(\"–ò—Ä—ç—ç–≥“Ø–π\");\r\n    if (cancelReasons.too_late) labels.push(\"–•—ç—Ç —É–¥—Å–∞–Ω\");\r\n    if (cancelReasons.no_contact) labels.push(\"–£—Ç–∞—Å —Ö–æ–ª–±–æ–≥–¥–æ—Ö–≥“Ø–π\");\r\n    if (cancelReasons.bad_attitude) labels.push(\"–•–∞—Ä–∏–ª—Ü–∞–∞ —Ç–∞–∞–ª–∞–≥–¥–∞–∞–≥“Ø–π\");\r\n    if (cancelOtherReason.trim()) labels.push(cancelOtherReason.trim());\r\n\r\n    if (labels.length === 0) {\r\n      setError(\"–ñ–æ–ª–æ–æ—á–∏–π–≥ —Ü—É—Ü–ª–∞—Ö —à–∞–ª—Ç–≥–∞–∞–Ω–∞–∞ —Å–æ–Ω–≥–æ–Ω–æ —É—É.\");\r\n      return;\r\n    }\r\n\r\n    const reasonText = labels.join(\" / \");\r\n    const blockedDriverId = delivery.chosen_driver_id;\r\n\r\n    setCancelling(true);\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const { error: blockError } = await supabase\r\n        .from(\"seller_blocked_drivers\")\r\n        .insert({ seller_id: user.id, driver_id: blockedDriverId, reason: reasonText });\r\n\r\n      if (blockError) {\r\n        console.error(blockError);\r\n        setError(\"–ñ–æ–ª–æ–æ—á–∏–π–≥ —Ü—É—Ü–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞ (–±–ª–æ–∫ —Ö—ç—Å—ç–≥).\");\r\n        return;\r\n      }\r\n\r\n      const { error: updError } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"OPEN\", chosen_driver_id: null })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (updError) {\r\n        console.error(updError);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ –Ω—ç—ç–ª—Ç—Ç—ç–π –±–æ–ª–≥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, status: \"OPEN\", chosen_driver_id: null });\r\n      setBids((prev) => prev.filter((b) => b.driver_id !== blockedDriverId));\r\n\r\n      setShowCancelModal(false);\r\n      setCancelReasons({ no_show: false, too_late: false, no_contact: false, bad_attitude: false });\r\n      setCancelOtherReason(\"\");\r\n\r\n      setMessage(\"–ñ–æ–ª–æ–æ—á–∏–π–≥ —Ü—É—Ü–∞–ª–∂, —ç–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ –¥–∞—Ö–∏–Ω –Ω—ç—ç–ª—Ç—Ç—ç–π –±–æ–ª–≥–æ–ª–æ–æ. –≠–Ω—ç –∂–æ–ª–æ–æ—á —Ç–∞–Ω—ã –¥–∞—Ä–∞–∞–≥–∏–π–Ω —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥ –¥—ç—ç—Ä —Ö–∞—Ä–∞–≥–¥–∞—Ö–≥“Ø–π.\");\r\n    } finally {\r\n      setCancelling(false);\r\n    }\r\n  }\r\n\r\n  /* ---------- SELLER PAID TOGGLE ---------- */\r\n  async function handleSellerPaid() {\r\n    if (!delivery || !user) return;\r\n\r\n    if (delivery.status === \"CLOSED\") {\r\n      setError(\"–•–∞–∞–≥–¥—Å–∞–Ω —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Ç”©–ª–±”©—Ä–∏–π–Ω –º—ç–¥—ç—ç–ª–ª–∏–π–≥ –∑–∞—Å–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π.\");\r\n      return;\r\n    }\r\n\r\n    if (delivery.status !== \"DELIVERED\") {\r\n      setError(\"–ó”©–≤—Ö”©–Ω —Ö“Ø—Ä–≥—ç—Å—ç–Ω —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä —Ç”©–ª–±”©—Ä —Ç—ç–º–¥—ç–≥–ª—ç–Ω—ç.\");\r\n      return;\r\n    }\r\n\r\n    setPayLoading(true);\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const newSellerMarked = !delivery.seller_marked_paid;\r\n\r\n      let newStatus: DeliveryStatus = delivery.status;\r\n      let newClosedAt: string | null = delivery.closed_at;\r\n\r\n      if (newSellerMarked) {\r\n        if (delivery.driver_confirmed_payment) {\r\n          newStatus = \"CLOSED\";\r\n          newClosedAt = new Date().toISOString();\r\n        } else {\r\n          newStatus = \"DELIVERED\";\r\n        }\r\n      } else {\r\n        newStatus = \"DELIVERED\";\r\n      }\r\n\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ seller_marked_paid: newSellerMarked, status: newStatus, closed_at: newClosedAt })\r\n        .eq(\"id\", delivery.id)\r\n        .eq(\"seller_id\", user.id);\r\n\r\n      if (error) {\r\n        console.error(\"SELLER PAID ERROR:\", error);\r\n        setError(\"–¢”©–ª–±”©—Ä —Ç”©–ª—Å–Ω”©”© —Ç—ç–º–¥—ç–≥–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      setDelivery({ ...delivery, seller_marked_paid: newSellerMarked, status: newStatus, closed_at: newClosedAt });\r\n\r\n      if (newSellerMarked) {\r\n        setMessage(\r\n          newStatus === \"CLOSED\"\r\n            ? \"–ñ–æ–ª–æ–æ—á–∏–¥ —Ç”©–ª–±”©—Ä —à–∏–ª–∂“Ø“Ø–ª—Å–Ω—ç—ç —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç. –ñ–æ–ª–æ–æ—á –º”©–Ω–≥”©”© –±–∞—Ç–∞–ª—Å–∞–Ω —Ç—É–ª —ç–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç —Ö–∞–∞–≥–¥–ª–∞–∞.\"\r\n            : \"–ñ–æ–ª–æ–æ—á–∏–¥ —Ç”©–ª–±”©—Ä —à–∏–ª–∂“Ø“Ø–ª—Å–Ω—ç—ç —Ç—ç–º–¥—ç–≥–ª—ç–ª—ç—ç.\"\r\n        );\r\n      } else {\r\n        setMessage(\"–ñ–æ–ª–æ–æ—á–∏–¥ —Ç”©–ª–±”©—Ä —à–∏–ª–∂“Ø“Ø–ª—ç—ç–≥“Ø–π –≥—ç–∂ –∑–∞—Å–ª–∞–∞.\");\r\n      }\r\n    } finally {\r\n      setPayLoading(false);\r\n    }\r\n  }\r\n\r\n  /* ===========================\r\n   * LOADING\r\n   * =========================== */\r\n\r\n  if (loadingUser || loadingDetail) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-sm text-slate-500\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user || !delivery) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-sm text-slate-500\">–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const t = typeLabel(delivery.delivery_type);\r\n  const sb = statusBadge(delivery.status);\r\n\r\n  const chosenBid = delivery.chosen_driver_id\r\n    ? bids.find((b) => b.driver_id === delivery.chosen_driver_id) || null\r\n    : null;\r\n\r\n  const hasChosenDriver = !!delivery.chosen_driver_id && !!chosenBid;\r\n  const isOpen = delivery.status === \"OPEN\";\r\n\r\n  const sellerPaid = !!delivery.seller_marked_paid;\r\n  const driverConfirmed = !!delivery.driver_confirmed_payment;\r\n\r\n  let driverSectionTitle = \"–ñ–æ–ª–æ–æ—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª\";\r\n  if (isOpen && !hasChosenDriver) driverSectionTitle = \"–ñ–æ–ª–æ–æ—á–∏–π–Ω –∞–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç“Ø“Ø–¥\";\r\n\r\n  const fromTab2 = searchParams.get(\"tab\");\r\n  const backUrl2 = fromTab2 ? `/seller?tab=${fromTab2}` : \"/seller\";\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <header className=\"border-b border-slate-200 bg-white\">\r\n        <div className=\"max-w-3xl mx-auto px-4 py-4 flex items-center justify-between gap-3\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <button\r\n              onClick={() => router.push(backUrl2)}\r\n              className=\"inline-flex sm:hidden items-center justify-center h-8 w-8 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n            >\r\n              ‚Üê\r\n            </button>\r\n\r\n            <div>\r\n              <div className=\"inline-flex items-center gap-1 rounded-full border border-slate-100 bg-slate-50 px-2 py-0.5\">\r\n                <span className=\"text-xs text-slate-600\">–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π</span>\r\n              </div>\r\n              <div className=\"mt-1 flex items-center gap-2\">\r\n                <span className=\"text-sm font-semibold text-slate-900\">#{delivery.id.slice(0, 6)}</span>\r\n                <span className={\"inline-flex items-center rounded-full border px-2 py-0.5 text-[11px] font-medium \" + sb.className}>\r\n                  {sb.text}\r\n                </span>\r\n              </div>\r\n              <p className=\"text-xs text-slate-500 mt-0.5\">“Æ“Ø—Å–≥—ç—Å—ç–Ω: {formatDateTime(delivery.created_at)}</p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <button\r\n              onClick={() => router.push(backUrl2)}\r\n              className=\"hidden sm:inline-flex text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n            >\r\n              ‚Üê –ë—É—Ü–∞—Ö\r\n            </button>\r\n            <button\r\n              onClick={handleLogout}\r\n              className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-700 hover:bg-slate-50\"\r\n            >\r\n              –ì–∞—Ä–∞—Ö\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      <main className=\"max-w-3xl mx-auto px-4 py-5 space-y-4\">\r\n        {delivery.status === \"DISPUTE\" && (\r\n          <div className=\"rounded-2xl border border-rose-100 bg-rose-50 px-4 py-3 text-xs text-rose-800\">\r\n            –≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç –¥—ç—ç—Ä <span className=\"font-semibold\">–º–∞—Ä–≥–∞–∞–Ω</span> –Ω—ç—ç–≥–¥—Å—ç–Ω.\r\n            {delivery.dispute_reason ? (\r\n              <div className=\"mt-2 text-[11px] text-rose-700\">\r\n                –®–∞–ª—Ç–≥–∞–∞–Ω: <span className=\"font-semibold\">{delivery.dispute_reason}</span>\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n        )}\r\n\r\n        {message && (\r\n          <div className=\"rounded-2xl border border-emerald-100 bg-emerald-50 px-4 py-2 text-xs text-emerald-800\">\r\n            {message}\r\n          </div>\r\n        )}\r\n\r\n        {error && (\r\n          <div className=\"rounded-2xl border border-rose-100 bg-rose-50 px-4 py-2 text-xs text-rose-700\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        {/* –ö–∞—Ä—Ç 1 */}\r\n        <section className=\"rounded-2xl border border-slate-200 bg-white px-4 py-4 space-y-3\">\r\n          <div className=\"flex items-center justify-between gap-2\">\r\n            <div className=\"flex items-center gap-2 text-xs\">\r\n              <span>{t.icon}</span>\r\n              <span className=\"font-medium text-slate-800\">{t.label}</span>\r\n            </div>\r\n            <div className=\"text-sm font-semibold text-slate-900\">{formatPrice(delivery.price_mnt)}</div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 text-xs text-slate-600\">\r\n            <div>\r\n              <div className=\"text-[11px] font-semibold text-slate-500\">–ê–í–ê–• –•–ê–Ø–ì</div>\r\n              <p className=\"mt-1\">{shorten(delivery.from_address)}</p>\r\n            </div>\r\n            <div>\r\n              <div className=\"text-[11px] font-semibold text-slate-500\">–•“Æ–†–ì–≠–• –•–ê–Ø–ì</div>\r\n              <p className=\"mt-1\">{shorten(delivery.to_address)}</p>\r\n            </div>\r\n          </div>\r\n\r\n          {delivery.note && (\r\n            <div className=\"pt-2 border-t border-slate-100\">\r\n              <div className=\"text-[11px] font-semibold text-slate-500\">–Æ–£ –•“Æ–†–ì–≠–• –í–≠?</div>\r\n              <p className=\"mt-1 text-xs text-slate-700\">{delivery.note}</p>\r\n            </div>\r\n          )}\r\n        </section>\r\n\r\n        {/* –ö–∞—Ä—Ç 2 ‚Äì –ñ–æ–ª–æ–æ—á / —Å–∞–Ω–∞–ª */}\r\n        <section className=\"rounded-2xl border border-slate-200 bg-white px-4 py-4 space-y-3\">\r\n          <div className=\"flex items-center justify-between gap-2\">\r\n            <h2 className=\"text-sm font-semibold text-slate-900\">{driverSectionTitle}</h2>\r\n            <div className=\"flex items-center gap-2\">\r\n              {isOpen && !hasChosenDriver && <span className=\"text-[11px] text-slate-500\">–ù–∏–π—Ç: {bids.length}</span>}\r\n              {hasChosenDriver && (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowDriverInfoModal(true)}\r\n                  className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n                >\r\n                  –ñ–æ–ª–æ–æ—á–∏–π–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π\r\n                </button>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {hasChosenDriver ? (\r\n            <div className=\"rounded-2xl border border-emerald-300 bg-emerald-50/60 px-3 py-3 flex items-center justify-between gap-3\">\r\n              <div className=\"space-y-1 text-xs text-slate-700\">\r\n                <div className=\"flex items-center gap-2 flex-wrap\">\r\n                  <span className=\"font-semibold\">{chosenBid?.driver?.name || \"–ñ–æ–ª–æ–æ—á\"}</span>\r\n                  <span className=\"text-[10px] rounded-full bg-emerald-600 text-white px-2 py-0.5\">\r\n                    {delivery.status === \"ON_ROUTE\" || delivery.status === \"DELIVERED\" ? \"–≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ —Ö–∏–π–∂ –±—É–π –∂–æ–ª–æ–æ—á\" : \"–°–æ–Ω–≥–æ—Å–æ–Ω –∂–æ–ª–æ–æ—á\"}\r\n                  </span>\r\n                </div>\r\n                <p className=\"text-[11px] text-slate-500\">–£—Ç–∞—Å: {chosenBid?.driver?.phone || \"—É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä –±“Ø—Ä—Ç–≥—ç–≥–¥—ç—ç–≥“Ø–π\"}</p>\r\n                <p className=\"text-[11px] text-slate-500\">{driverRatingText(chosenBid?.driver || null)}</p>\r\n                <p className=\"text-[10px] text-slate-400\">–°–∞–Ω–∞–ª –∏–ª–≥—ç—ç—Å—ç–Ω: {formatDateTime(chosenBid?.created_at || \"\")}</p>\r\n              </div>\r\n            </div>\r\n          ) : isOpen ? (\r\n            bids.length === 0 ? (\r\n              <p className=\"text-xs text-slate-500\">–û–¥–æ–æ–≥–æ–æ—Ä –∂–æ–ª–æ–æ—á –∞–≤–∞—Ö —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–≥—ç—ç–≥“Ø–π –±–∞–π–Ω–∞.</p>\r\n            ) : (\r\n              <div className=\"space-y-2\">\r\n                {bids.map((bid) => {\r\n                  const disabled = assigningId === bid.driver_id || !!delivery.chosen_driver_id;\r\n\r\n                  return (\r\n                    <div\r\n                      key={bid.id}\r\n                      className=\"rounded-2xl border border-slate-200 bg-slate-50 px-3 py-3 flex items-center justify-between gap-3\"\r\n                    >\r\n                      <div className=\"space-y-1 text-xs text-slate-700\">\r\n                        <div className=\"flex items-center gap-2 flex-wrap\">\r\n                          <span className=\"font-semibold\">{bid.driver?.name || \"–ñ–æ–ª–æ–æ—á\"}</span>\r\n                        </div>\r\n                        <p className=\"text-[11px] text-slate-500\">–£—Ç–∞—Å: {bid.driver?.phone || \"—É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä –±“Ø—Ä—Ç–≥—ç–≥–¥—ç—ç–≥“Ø–π\"}</p>\r\n                        <p className=\"text-[11px] text-slate-500\">{driverRatingText(bid.driver)}</p>\r\n                        <p className=\"text-[10px] text-slate-400\">–°–∞–Ω–∞–ª –∏–ª–≥—ç—ç—Å—ç–Ω: {formatDateTime(bid.created_at)}</p>\r\n                      </div>\r\n\r\n                      <div className=\"flex flex-col items-end gap-1\">\r\n                        <button\r\n                          onClick={() => handleSelectDriver(bid.driver_id)}\r\n                          disabled={disabled}\r\n                          className=\"text-[11px] px-3 py-1.5 rounded-full bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                        >\r\n                          {assigningId === bid.driver_id ? \"–°–æ–Ω–≥–æ–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–≠–Ω—ç –∂–æ–ª–æ–æ—á–∏–π–≥ —Å–æ–Ω–≥–æ—Ö\"}\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  );\r\n                })}\r\n              </div>\r\n            )\r\n          ) : (\r\n            <p className=\"text-xs text-slate-500\">–û–¥–æ–æ–≥–æ–æ—Ä –∂–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ–≥–¥–æ–æ–≥“Ø–π –±–∞–π–Ω–∞.</p>\r\n          )}\r\n        </section>\r\n\r\n        {/* –ö–∞—Ä—Ç 3 ‚Äì –Ø–≤—Ü / —à–∏–π–¥–≤—ç—Ä */}\r\n        <section className=\"rounded-2xl border border-slate-200 bg-white px-4 py-4 space-y-3\">\r\n          <h2 className=\"text-sm font-semibold text-slate-900\">–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —è–≤—Ü, —à–∏–π–¥–≤—ç—Ä</h2>\r\n\r\n          {/* –ú–∞—Ä–≥–∞–∞–Ω —à–∏–π–¥–≤—ç—Ä–ª—ç—Ö */}\r\n          {canResolveDisputeFlag && (\r\n            <div className=\"flex flex-wrap items-center justify-between gap-2 border border-rose-100 bg-rose-50 rounded-2xl px-3 py-3\">\r\n              <p className=\"text-xs text-rose-800\">\r\n                –ú–∞—Ä–≥–∞–∞–Ω —à–∏–π–¥–≤—ç—Ä–ª—ç–≥–¥—Å—ç–Ω –±–æ–ª <span className=\"font-semibold\">‚Äú–ú–∞—Ä–≥–∞–∞–Ω —à–∏–π–¥–≤—ç—Ä–ª—ç—Ö‚Äù</span> –¥–∞—Ä–∂ —Ö“Ø—Ä–≥—ç—Å—ç–Ω —Ç”©–ª”©–≤ —Ä“Ø“Ø –±—É—Ü–∞–∞–Ω–∞.\r\n              </p>\r\n              <button\r\n                onClick={() => setShowResolveDisputeModal(true)}\r\n                className=\"text-[11px] px-4 py-2 rounded-full bg-rose-600 text-white hover:bg-rose-700\"\r\n              >\r\n                –ú–∞—Ä–≥–∞–∞–Ω —à–∏–π–¥–≤—ç—Ä–ª—ç—Ö\r\n              </button>\r\n            </div>\r\n          )}\r\n\r\n          {/* –•“Ø—Ä–≥—ç–ª—Ç—ç–¥ –≥–∞—Ä—Å–∞–Ω */}\r\n          {delivery.status === \"ASSIGNED\" && delivery.chosen_driver_id && (\r\n            <div className=\"flex flex-wrap items-center justify-between gap-2\">\r\n              <p className=\"text-xs text-slate-600\">\r\n                –ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ–≥–¥—Å–æ–Ω –±–∞–π–Ω–∞. –ñ–æ–ª–æ–æ—á –±–∞—Ä–∞–∞–≥ –∞–≤–∞–∞–¥ —è–≤—Å–∞–Ω “Ø–µ–¥ <span className=\"font-medium\">‚Äú–•“Ø—Ä–≥—ç–ª—Ç—ç–¥ –≥–∞—Ä—Å–∞–Ω‚Äù</span> –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–Ω—ç.\r\n              </p>\r\n              <button\r\n                onClick={handleMarkPickedUp}\r\n                disabled={markingPickedUp}\r\n                className=\"text-[11px] px-4 py-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60\"\r\n              >\r\n                {markingPickedUp ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Ä–≥—ç–ª—Ç—ç–¥ –≥–∞—Ä—Å–∞–Ω\"}\r\n              </button>\r\n            </div>\r\n          )}\r\n\r\n          {/* –ñ–æ–ª–æ–æ—á–∏–π–≥ —Ü—É—Ü–ª–∞—Ö */}\r\n          {canCancelDriver && (\r\n            <div className=\"flex flex-wrap items-center justify-between gap-2 border-t border-slate-100 pt-3 mt-2\">\r\n              <p className=\"text-xs text-slate-600\">\r\n                –°–æ–Ω–≥–æ–≥–¥—Å–æ–Ω –∂–æ–ª–æ–æ—á <span className=\"font-medium\">–∏—Ä—ç—ç–≥“Ø–π, —Ö—ç—Ç —É–¥—Å–∞–Ω, —É—Ç–∞—Å —Ö–æ–ª–±–æ–≥–¥–æ—Ö–≥“Ø–π —ç—Å–≤—ç–ª —Ö–∞—Ä–∏–ª—Ü–∞–∞ —Ç–∞–∞–ª–∞–≥–¥–∞–∞–≥“Ø–π</span> –±–æ–ª –∂–æ–ª–æ–æ—á–∏–π–≥ —Ü—É—Ü–ª–∞–∂, —ç–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ –¥–∞—Ö–∏–Ω –Ω—ç—ç–ª—Ç—Ç—ç–π –±–æ–ª–≥–æ—Ö –±–æ–ª–æ–º–∂—Ç–æ–π.\r\n              </p>\r\n              <button\r\n                onClick={() => setShowCancelModal(true)}\r\n                className=\"text-[11px] px-4 py-2 rounded-full border border-slate-200 bg-slate-50 text-slate-700 hover:bg-slate-100\"\r\n              >\r\n                –ñ–æ–ª–æ–æ—á–∏–π–≥ —Ü—É—Ü–ª–∞—Ö\r\n              </button>\r\n            </div>\r\n          )}\r\n\r\n          {/* –ú–∞—Ä–≥–∞–∞–Ω “Ø“Ø—Å–≥—ç—Ö */}\r\n          {canOpenDisputeFlag && (\r\n            <div className=\"flex flex-wrap items-center justify-between gap-2 border-t border-slate-100 pt-3 mt-2\">\r\n              <p className=\"text-xs text-slate-600\">\r\n                –ñ–æ–ª–æ–æ—á –±–∞—Ä–∞–∞–≥ –∞–≤–∞–∞–¥ —É–¥–∞–∞–Ω —Ö—É–≥–∞—Ü–∞–∞–Ω–¥ —Ö–æ–ª–±–æ–æ –±–∞—Ä–∏—Ö–≥“Ø–π, —Ö“Ø—Ä–≥—ç–ª—Ç –≥“Ø–π—Ü—ç—Ç–≥—ç—ç–≥“Ø–π —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥{\" \"}\r\n                <span className=\"font-semibold text-rose-700\">–º–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç–∂</span> –±–æ–ª–Ω–æ.\r\n              </p>\r\n              <button\r\n                onClick={() => setShowDisputeModal(true)}\r\n                className=\"text-[11px] px-4 py-2 rounded-full border border-rose-200 bg-rose-50 text-rose-700 hover:bg-rose-100\"\r\n              >\r\n                –ú–∞—Ä–≥–∞–∞–Ω “Ø“Ø—Å–≥—ç—Ö\r\n              </button>\r\n            </div>\r\n          )}\r\n\r\n          {/* –¢”©–ª–±”©—Ä —Ç—ç–º–¥—ç–≥–ª—ç—Ö (DELIVERED) */}\r\n          {delivery.status === \"DELIVERED\" && (\r\n            <div className=\"border-t border-slate-100 pt-3 mt-2 space-y-2\">\r\n              {!sellerPaid ? (\r\n                <>\r\n                  <p className=\"text-xs text-slate-600\">\r\n                    –ñ–æ–ª–æ–æ—á –±–∞—Ä–∞–∞–≥ —Ö“Ø—Ä–≥—ç—Å—ç–Ω –±–∞–π–Ω–∞. –ñ–æ–ª–æ–æ—á–∏–¥ —Ç”©–ª–±”©—Ä”©”© —à–∏–ª–∂“Ø“Ø–ª—Å–Ω–∏–π –¥–∞—Ä–∞–∞ <span className=\"font-semibold\">‚Äú–¢”©–ª–±”©—Ä —Ç”©–ª—Å”©–Ω‚Äù</span> –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–Ω—ç “Ø“Ø.\r\n                  </p>\r\n                  <button\r\n                    onClick={handleSellerPaid}\r\n                    disabled={payLoading}\r\n                    className=\"text-[11px] px-4 py-2 rounded-full bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60\"\r\n                  >\r\n                    {payLoading ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–¢”©–ª–±”©—Ä —Ç”©–ª—Å”©–Ω\"}\r\n                  </button>\r\n                </>\r\n              ) : (\r\n                <p className=\"text-xs text-emerald-700\">\r\n                  –¢–∞ –∂–æ–ª–æ–æ—á–∏–¥ —Ç”©–ª–±”©—Ä —à–∏–ª–∂“Ø“Ø–ª—Å—ç–Ω –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç—Å—ç–Ω. –ñ–æ–ª–æ–æ—á —Ç”©–ª–±”©—Ä –∞–≤—Å–Ω–∞–∞ –±–∞—Ç–∞–ª—Å–Ω—ã –¥–∞—Ä–∞–∞ —ç–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç <span className=\"font-semibold\">‚Äú–•–∞–∞–≥–¥—Å–∞–Ω‚Äù</span> —Ç”©–ª”©–≤—Ç –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä —à–∏–ª–∂–∏–Ω—ç.\r\n                </p>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* –¢”©–ª–±”©—Ä–∏–π–Ω —Å—É–º–º–∞—Ä–∏ */}\r\n          <div className=\"border-t border-slate-100 pt-3 mt-2 space-y-1\">\r\n            <p className=\"text-[11px] text-slate-500\">\r\n              –•—É–¥–∞–ª–¥–∞–≥—á:{\" \"}\r\n              <span className={sellerPaid ? \"text-emerald-600 font-semibold\" : \"text-slate-700\"}>\r\n                {sellerPaid ? \"–ñ–æ–ª–æ–æ—á–∏–¥ –º”©–Ω–≥”©”© —à–∏–ª–∂“Ø“Ø–ª—Å—ç–Ω\" : \"–ú”©–Ω–≥”©”© —à–∏–ª–∂“Ø“Ø–ª—ç—ç–≥“Ø–π\"}\r\n              </span>\r\n            </p>\r\n            <p className=\"text-[11px] text-slate-500\">\r\n              –ñ–æ–ª–æ–æ—á:{\" \"}\r\n              <span className={driverConfirmed ? \"text-emerald-600 font-semibold\" : \"text-slate-700\"}>\r\n                {driverConfirmed ? \"–¢”©–ª–±”©—Ä”©”© –±“Ø—Ä—ç–Ω –∞–≤—Å–∞–Ω\" : \"–ë–∞—Ç–∞–ª–≥–∞–∞–∂–∞–∞–≥“Ø–π\"}\r\n              </span>\r\n            </p>\r\n            {delivery.closed_at && (\r\n              <p className=\"text-[11px] text-slate-400\">–•–∞–∞–≥–¥—Å–∞–Ω: {formatDateTime(delivery.closed_at)}</p>\r\n            )}\r\n          </div>\r\n\r\n          {delivery.status === \"CLOSED\" && (\r\n            <div className=\"border-t border-slate-100 pt-3 mt-2\">\r\n              <p className=\"text-xs text-slate-600\">\r\n                –≠–Ω—ç —Ö“Ø—Ä–≥—ç–ª—Ç <span className=\"font-semibold\">—Ö–∞–∞–≥–¥—Å–∞–Ω</span>.\r\n              </p>\r\n            </div>\r\n          )}\r\n        </section>\r\n\r\n        {/* DISPUTE RESOLVE confirm modal */}\r\n        {showResolveDisputeModal && (\r\n          <div className=\"fixed inset-0 z-20 flex items-center justify-center bg-black/30 px-4\">\r\n            <div className=\"max-w-md w-full rounded-2xl bg-white shadow-lg border border-slate-200 px-4 py-4 space-y-3\">\r\n              <h3 className=\"text-sm font-semibold text-slate-900\">–ú–∞—Ä–≥–∞–∞–Ω —à–∏–π–¥–≤—ç—Ä–ª—ç—Ö</h3>\r\n              <p className=\"text-xs text-slate-600\">\r\n                –≠–Ω—ç “Ø–π–ª–¥—ç–ª –Ω—å –º–∞—Ä–≥–∞–∞–Ω—ã–≥ —Ö–∞–∞–∂, —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–≥ <span className=\"font-semibold\">‚Äú–•“Ø—Ä–≥—ç—Å—ç–Ω‚Äù</span> —Ç”©–ª”©–≤ —Ä“Ø“Ø –±—É—Ü–∞–∞–Ω–∞.\r\n              </p>\r\n\r\n              <div className=\"flex items-center justify-end gap-2 pt-1\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowResolveDisputeModal(false)}\r\n                  disabled={resolvingDispute}\r\n                  className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n                >\r\n                  –ë–æ–ª–∏—Ö\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleResolveDispute}\r\n                  disabled={resolvingDispute}\r\n                  className=\"text-[11px] px-3 py-1.5 rounded-full bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-60\"\r\n                >\r\n                  {resolvingDispute ? \"–®–∏–π–¥–≤—ç—Ä–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–®–∏–π–¥–≤—ç—Ä–ª—ç—Ö\"}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Driver info modal */}\r\n        {showDriverInfoModal && hasChosenDriver && chosenBid && (\r\n          <div className=\"fixed inset-0 z-20 flex items-center justify-center bg-black/30 px-4\">\r\n            <div className=\"max-w-md w-full rounded-2xl bg-white shadow-lg border border-slate-200 px-4 py-4 space-y-3\">\r\n              <h3 className=\"text-sm font-semibold text-slate-900\">–ñ–æ–ª–æ–æ—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª</h3>\r\n\r\n              <div className=\"space-y-1 text-xs text-slate-700\">\r\n                <p>\r\n                  <span className=\"font-semibold\">–ù—ç—Ä:</span> {chosenBid.driver?.name || \"–ë“Ø—Ä—Ç–≥—ç–≥–¥—ç—ç–≥“Ø–π\"}\r\n                </p>\r\n                <p>\r\n                  <span className=\"font-semibold\">–£—Ç–∞—Å:</span> {chosenBid.driver?.phone || \"—É—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä –±“Ø—Ä—Ç–≥—ç–≥–¥—ç—ç–≥“Ø–π\"}\r\n                </p>\r\n                <p>\r\n                  <span className=\"font-semibold\">“Æ–Ω—ç–ª–≥—ç—ç:</span> {driverRatingText(chosenBid.driver || null)}\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-end gap-2 pt-1\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowDriverInfoModal(false)}\r\n                  className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n                >\r\n                  –•–∞–∞—Ö\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Dispute modal */}\r\n        {showDisputeModal && (\r\n          <div className=\"fixed inset-0 z-20 flex items-center justify-center bg-black/30 px-4\">\r\n            <div className=\"max-w-md w-full rounded-2xl bg-white shadow-lg border border-slate-200 px-4 py-4 space-y-3\">\r\n              <h3 className=\"text-sm font-semibold text-slate-900\">–ú–∞—Ä–≥–∞–∞–Ω “Ø“Ø—Å–≥—ç—Ö</h3>\r\n              <p className=\"text-xs text-slate-600\">–ù–æ—Ü—Ç–æ–π –∑”©—Ä—á–∏–ª –≥–∞—Ä—Å–∞–Ω “Ø–µ–¥ –ª –º–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç–Ω—ç.</p>\r\n              <textarea\r\n                value={disputeReason}\r\n                onChange={(e) => setDisputeReason(e.target.value)}\r\n                rows={4}\r\n                className=\"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-800 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-rose-500\"\r\n                placeholder=\"–Æ—É –±–æ–ª—Å–æ–Ω —Ç–∞–ª–∞–∞—Ä —Ç–æ–≤—á—Ö–æ–Ω, —Ç–æ–¥–æ—Ä—Ö–æ–π –±–∏—á–Ω—ç “Ø“Ø‚Ä¶\"\r\n              />\r\n              <div className=\"flex items-center justify-end gap-2 pt-1\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowDisputeModal(false)}\r\n                  disabled={openingDispute}\r\n                  className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n                >\r\n                  –ë–æ–ª–∏—Ö\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleOpenDisputeConfirm}\r\n                  disabled={openingDispute}\r\n                  className=\"text-[11px] px-3 py-1.5 rounded-full bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-60\"\r\n                >\r\n                  {openingDispute ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö\"}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Cancel modal */}\r\n        {showCancelModal && (\r\n          <div className=\"fixed inset-0 z-20 flex items-center justify-center bg-black/30 px-4\">\r\n            <div className=\"max-w-md w-full rounded-2xl bg-white shadow-lg border border-slate-200 px-4 py-4 space-y-3\">\r\n              <h3 className=\"text-sm font-semibold text-slate-900\">–°–æ–Ω–≥–æ–≥–¥—Å–æ–Ω –∂–æ–ª–æ–æ—á–∏–π–≥ —Ü—É—Ü–ª–∞—Ö</h3>\r\n\r\n              <div className=\"space-y-1 text-xs text-slate-700\">\r\n                <label className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={cancelReasons.no_show}\r\n                    onChange={() => toggleCancelReason(\"no_show\")}\r\n                    className=\"h-3 w-3 rounded border-slate-300\"\r\n                  />\r\n                  <span>–ò—Ä—ç—ç–≥“Ø–π</span>\r\n                </label>\r\n                <label className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={cancelReasons.too_late}\r\n                    onChange={() => toggleCancelReason(\"too_late\")}\r\n                    className=\"h-3 w-3 rounded border-slate-300\"\r\n                  />\r\n                  <span>–•—ç—Ç —É–¥—Å–∞–Ω</span>\r\n                </label>\r\n                <label className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={cancelReasons.no_contact}\r\n                    onChange={() => toggleCancelReason(\"no_contact\")}\r\n                    className=\"h-3 w-3 rounded border-slate-300\"\r\n                  />\r\n                  <span>–£—Ç–∞—Å —Ö–æ–ª–±–æ–≥–¥–æ—Ö–≥“Ø–π –±–æ–ª—Å–æ–Ω</span>\r\n                </label>\r\n                <label className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={cancelReasons.bad_attitude}\r\n                    onChange={() => toggleCancelReason(\"bad_attitude\")}\r\n                    className=\"h-3 w-3 rounded border-slate-300\"\r\n                  />\r\n                  <span>–•–∞—Ä–∏–ª—Ü–∞–∞ —Ç–∞–∞–ª–∞–≥–¥–∞–∞–≥“Ø–π</span>\r\n                </label>\r\n                <div className=\"pt-1\">\r\n                  <textarea\r\n                    value={cancelOtherReason}\r\n                    onChange={(e) => setCancelOtherReason(e.target.value)}\r\n                    rows={2}\r\n                    className=\"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-slate-500\"\r\n                    placeholder=\"–ë—É—Å–∞–¥ (–∑–∞–∞–≤–∞–ª –±–∏—à)‚Ä¶\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-end gap-2 pt-1\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowCancelModal(false)}\r\n                  disabled={cancelling}\r\n                  className=\"text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n                >\r\n                  –ë–æ–ª–∏—Ö\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleCancelDriverConfirm}\r\n                  disabled={cancelling}\r\n                  className=\"text-[11px] px-3 py-1.5 rounded-full bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-60\"\r\n                >\r\n                  {cancelling ? \"–¶—É—Ü–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–ñ–æ–ª–æ–æ—á–∏–π–≥ —Ü—É—Ü–ª–∞—Ö\"}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/seller/new-delivery/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\nexport default function NewDeliveryPage() {\r\n  const router = useRouter();\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n\r\n  const [deliveryType, setDeliveryType] = useState(\"apartment\");\r\n  const [fromAddress, setFromAddress] = useState(\"\");\r\n  const [toAddress, setToAddress] = useState(\"\");\r\n  const [receiverPhone, setReceiverPhone] = useState(\"\");\r\n  const [note, setNote] = useState(\"\");\r\n  const [price, setPrice] = useState(\"\");\r\n\r\n  const [loadingUser, setLoadingUser] = useState(true);\r\n  const [sending, setSending] = useState(false);\r\n\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [success, setSuccess] = useState(false);\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const raw = window.localStorage.getItem(\"incomeUser\");\r\n      if (!raw) {\r\n        router.replace(\"/\");\r\n        return;\r\n      }\r\n\r\n      const parsed: IncomeUser = JSON.parse(raw);\r\n\r\n      if (parsed.role !== \"seller\") {\r\n        router.replace(\"/driver\");\r\n        return;\r\n      }\r\n\r\n      setUser(parsed);\r\n\r\n      // üß† –ê–í–ê–• —Ö–∞—è–≥–∏–π–Ω —Å“Ø“Ø–ª–∏–π–Ω —É—Ç–≥—ã–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –¥“Ø“Ø—Ä–≥—ç—Ö\r\n      const savedFrom = window.localStorage.getItem(\r\n        \"incomeLastFromAddress\"\r\n      );\r\n      if (savedFrom && savedFrom.trim().length > 0) {\r\n        setFromAddress(savedFrom);\r\n      }\r\n\r\n      setLoadingUser(false);\r\n    } catch (e) {\r\n      console.error(e);\r\n      setError(\"–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —É–Ω—à–∏—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      setLoadingUser(false);\r\n    }\r\n  }, []);\r\n\r\n  async function handleSubmit(e: React.FormEvent) {\r\n    e.preventDefault();\r\n    if (!user) return;\r\n\r\n    setError(null);\r\n    setSuccess(false);\r\n\r\n    if (!fromAddress.trim()) {\r\n      setError(\"–ê–í–ê–• —Ö–∞—è–≥ —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n    if (!toAddress.trim()) {\r\n      setError(\"–•“Æ–†–ì–≠–• —Ö–∞—è–≥ —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.\");\r\n      return;\r\n    }\r\n    if (!receiverPhone.trim()) {\r\n      setError(\"–•“Æ–õ–≠–≠–ù –ê–í–ê–• —Ö“Ø–Ω–∏–π —É—Ç–∞—Å –∑–∞–∞–≤–∞–ª.\");\r\n      return;\r\n    }\r\n    if (!price.trim() || isNaN(Number(price))) {\r\n      setError(\"“Æ–Ω—ç (‚ÇÆ) –∑”©–≤ –æ—Ä—É—É–ª–Ω–∞ —É—É.\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setSending(true);\r\n\r\n      const { error: insertError } = await supabase\r\n        .from(\"deliveries\")\r\n        .insert({\r\n          seller_id: user.id,\r\n          delivery_type: deliveryType,\r\n          from_address: fromAddress,\r\n          to_address: toAddress,\r\n          receiver_phone: receiverPhone,\r\n          note,\r\n          price_mnt: Number(price),\r\n          status: \"OPEN\",\r\n        });\r\n\r\n      if (insertError) {\r\n        console.error(insertError);\r\n        setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        setSending(false);\r\n        return;\r\n      }\r\n\r\n      // ‚úÖ –ê–º–∂–∏–ª—Ç—Ç–∞–π –∏–ª–≥—ç—ç—Å–Ω–∏–π –¥–∞—Ä–∞–∞ –ê–í–ê–• —Ö–∞—è–≥–∏–π–≥ —Å–∞–Ω–∞—Ö\r\n      window.localStorage.setItem(\r\n        \"incomeLastFromAddress\",\r\n        fromAddress\r\n      );\r\n\r\n      setSuccess(true);\r\n\r\n      setTimeout(() => {\r\n        router.push(\"/seller\");\r\n      }, 900);\r\n    } catch (err) {\r\n      console.error(err);\r\n      setError(\"–°–µ—Ä–≤–µ—Ä—Ç—ç–π —Ö–æ–ª–±–æ–≥–¥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n    } finally {\r\n      setSending(false);\r\n    }\r\n  }\r\n\r\n  if (loadingUser) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-slate-500 text-sm\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-slate-500 text-sm\">–ù—ç–≤—Ç—Ä—ç—ç–≥“Ø–π –±–∞–π–Ω–∞.</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <header className=\"border-b border-slate-200 bg-white\">\r\n  <div className=\"max-w-3xl mx-auto px-4 py-4\">\r\n    <div className=\"flex items-center gap-3\">\r\n      <div className=\"inline-flex items-center justify-center rounded-full bg-emerald-50 px-3 py-1\">\r\n        <span className=\"text-xs font-semibold text-emerald-700\">\r\n          INCOME\r\n        </span>\r\n      </div>\r\n\r\n      <div>\r\n        <h1 className=\"text-sm font-semibold text-slate-900\">\r\n          –•“Ø—Ä–≥—ç–ª—Ç “Ø“Ø—Å–≥—ç—Ö\r\n        </h1>\r\n        <p className=\"text-xs text-slate-500\">\r\n          –ú—ç–¥—ç—ç–ª–ª—ç—ç “Ø–Ω—ç–Ω –∑”©–≤ –±”©–≥–ª”©”©–¥ –∏–ª–≥—ç—ç–≥—ç—ç—Ä—ç–π.\r\n        </p>\r\n      </div>\r\n    </div>\r\n\r\n    {/* ‚Üê –ë—É—Ü–∞—Ö */}\r\n    <button\r\n      onClick={() => router.push(\"/seller\")}\r\n      className=\"mt-3 text-xs px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50\"\r\n    >\r\n      ‚Üê –ë—É—Ü–∞—Ö\r\n    </button>\r\n  </div>\r\n</header>\r\n\r\n\r\n      <main className=\"max-w-3xl mx-auto px-4 py-6 space-y-5\">\r\n        {error && (\r\n          <div className=\"text-xs text-red-600 bg-red-50 border border-red-100 rounded-xl px-3 py-2\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        {success && (\r\n          <div className=\"text-xs text-emerald-600 bg-emerald-50 border border-emerald-100 rounded-xl px-3 py-2\">\r\n            –•“Ø—Ä–≥—ç–ª—Ç –∞–º–∂–∏–ª—Ç—Ç–∞–π “Ø“Ø—Å–≥—ç–≥–¥–ª—ç—ç!\r\n          </div>\r\n        )}\r\n\r\n        <form onSubmit={handleSubmit} className=\"space-y-5\">\r\n          {/* –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Ç”©—Ä”©–ª */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">\r\n              –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Ç”©—Ä”©–ª\r\n            </label>\r\n            <select\r\n              value={deliveryType}\r\n              onChange={(e) => setDeliveryType(e.target.value)}\r\n              className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm\"\r\n            >\r\n              <option value=\"apartment\">üèô –ë–∞–π—Ä</option>\r\n              <option value=\"ger\">üè† –ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª</option>\r\n              <option value=\"camp\">üèï –õ–∞–≥–µ—Ä</option>\r\n              <option value=\"countryside\">\r\n                üöå –û—Ä–æ–Ω –Ω—É—Ç–∞–≥ (—É–Ω–∞–∞–Ω–¥ —Ç–∞–≤–∏—Ö)\r\n              </option>\r\n            </select>\r\n          </div>\r\n\r\n          {/* “Æ–Ω—ç */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">\r\n              “Æ–Ω—ç (‚ÇÆ)\r\n            </label>\r\n            <input\r\n              type=\"number\"\r\n              inputMode=\"numeric\"\r\n              className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm\"\r\n              placeholder=\"–ñ: 5000\"\r\n              value={price}\r\n              onChange={(e) => setPrice(e.target.value)}\r\n            />\r\n          </div>\r\n\r\n          {/* –ê–≤–∞—Ö —Ö–∞—è–≥ */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">\r\n              –ê–í–ê–• —Ö–∞—è–≥\r\n            </label>\r\n            <input\r\n              type=\"text\"\r\n              className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm\"\r\n              placeholder=\"–ñ: –ë–ì–î, 3-—Ä —Ö–æ—Ä–æ–æ, 5-—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª‚Ä¶\"\r\n              value={fromAddress}\r\n              onChange={(e) => setFromAddress(e.target.value)}\r\n            />\r\n            <p className=\"text-[11px] text-slate-400\">\r\n              –≠–Ω—ç –Ω—å –∏—Ö—ç–≤—á–ª—ç–Ω ”©”©—Ä—á–ª”©–≥–¥”©—Ö–≥“Ø–π (—Ç–∞–Ω–∞–π –¥—ç–ª–≥“Ø“Ø—Ä/–∞–≥—É—É–ª–∞—Ö). –ù—ç–≥\r\n              —É–¥–∞–∞ –±”©–≥–ª”©—Å–Ω–∏–π –¥–∞—Ä–∞–∞ –¥–∞—Ä–∞–∞–≥–∏–π–Ω —Ö“Ø—Ä–≥—ç–ª—Ç“Ø“Ø–¥—ç–¥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä\r\n              –≥–∞—Ä—á –∏—Ä–Ω—ç.\r\n            </p>\r\n          </div>\r\n\r\n          {/* –•“Ø—Ä–≥—ç—Ö —Ö–∞—è–≥ */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">\r\n              –•“Æ–†–ì–≠–• —Ö–∞—è–≥\r\n            </label>\r\n            <input\r\n              type=\"text\"\r\n              className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm\"\r\n              placeholder=\"–ñ: –°–ë–î, 6-—Ä —Ö–æ—Ä–æ–æ, –≠–Ω—Ö —Ç–∞–π–≤–Ω—ã ”©—Ä–≥”©–Ω —á”©–ª”©”©‚Ä¶\"\r\n              value={toAddress}\r\n              onChange={(e) => setToAddress(e.target.value)}\r\n            />\r\n          </div>\r\n\r\n          {/* –•“Ø–ª—ç—ç–Ω –∞–≤–∞–≥—á */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">\r\n              –•“Æ–õ–≠–≠–ù –ê–í–ê–• —Ö“Ø–Ω–∏–π —É—Ç–∞—Å\r\n            </label>\r\n            <input\r\n              type=\"text\"\r\n              className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm\"\r\n              placeholder=\"–ñ: 9911XXXX\"\r\n              value={receiverPhone}\r\n              onChange={(e) => setReceiverPhone(e.target.value)}\r\n            />\r\n          </div>\r\n\r\n          {/* –Æ—É —Ö“Ø—Ä–≥“Ø“Ø–ª—ç—Ö */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-slate-800\">\r\n              –Æ—É —Ö“Ø—Ä–≥“Ø“Ø–ª—ç—Ö –≥—ç–∂ –±–∞–π–≥–∞–∞ (—Ç–æ–≤—á)\r\n            </label>\r\n            <textarea\r\n              className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm h-20\"\r\n              placeholder=\"–ñ: 2 —Ö–∞–π—Ä—Ü–∞–≥ —É—Å, 1 —Ç–æ–Ω–æ–≥ —Ç”©—Ö”©”©—Ä”©–º–∂‚Ä¶\"\r\n              value={note}\r\n              onChange={(e) => setNote(e.target.value)}\r\n            />\r\n          </div>\r\n\r\n          {/* –ò–ª–≥—ç—ç—Ö */}\r\n          <div>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={sending}\r\n              className=\"w-full rounded-xl bg-emerald-600 text-white text-sm font-medium px-4 py-2 hover:bg-emerald-700 disabled:bg-emerald-400 transition\"\r\n            >\r\n              {sending ? \"–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Ä–≥—ç–ª—Ç “Ø“Ø—Å–≥—ç—Ö\"}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "app/seller/page.tsx",
        "summary": "",
        "content": "\"use client\";\r\n\r\n/* ===========================\r\n * app/seller/page.tsx\r\n * CLEAN:\r\n * - OPEN –¥—ç—ç—Ä driver_bids count —Ö–∞—Ä—É—É–ª–Ω–∞\r\n * - Tab –¥–∞—Ä–∞–∞–ª–∞–ª lib/deliveryLogic.ts-—Ç—ç–π —Ç–∞–∞—Ä—Å–∞–Ω\r\n * - ‚úÖ Quick action: ASSIGNED –¥—ç—ç—Ä \"–•“Ø—Ä–≥—ç–ª—Ç—ç–¥ –≥–∞—Ä—Å–∞–Ω\" —Ç–æ–≤—á (ON_ROUTE + redirect)\r\n * =========================== */\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { DeliveryStatus, SELLER_TABS, SellerTabId } from \"@/lib/deliveryLogic\";\r\n\r\ntype Role = \"seller\" | \"driver\";\r\n\r\ntype IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n\r\ntype DeliveryRow = {\r\n  id: string;\r\n  seller_id: string;\r\n  from_address: string | null;\r\n  to_address: string | null;\r\n  note: string | null;\r\n  status: DeliveryStatus;\r\n  created_at: string;\r\n  price_mnt: number | null;\r\n  delivery_type: string | null;\r\n\r\n  seller_marked_paid: boolean | null;\r\n  driver_confirmed_payment: boolean | null;\r\n  closed_at: string | null;\r\n\r\n  seller_hidden: boolean | null;\r\n  bids_count: number;\r\n\r\n  chosen_driver_id: string | null;\r\n};\r\n\r\nconst TAB_IDS: SellerTabId[] = SELLER_TABS.map((t) => t.id);\r\n\r\n/* ---------- helpers ---------- */\r\nfunction typeLabel(deliveryType: string | null) {\r\n  switch (deliveryType) {\r\n    case \"apartment\":\r\n      return { icon: \"üèô\", label: \"–ë–∞–π—Ä\" };\r\n    case \"ger\":\r\n      return { icon: \"üè†\", label: \"–ì—ç—Ä —Ö–æ—Ä–æ–æ–ª–æ–ª\" };\r\n    case \"camp\":\r\n      return { icon: \"üèï\", label: \"–õ–∞–≥–µ—Ä\" };\r\n    case \"countryside\":\r\n      return { icon: \"üöå\", label: \"–û—Ä–æ–Ω –Ω—É—Ç–∞–≥\" };\r\n    default:\r\n      return { icon: \"üì¶\", label: \"–•“Ø—Ä–≥—ç–ª—Ç\" };\r\n  }\r\n}\r\n\r\nfunction statusBadge(status: DeliveryStatus) {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return {\r\n        text: \"–ù—ç—ç–ª—Ç—Ç—ç–π\",\r\n        className: \"bg-emerald-50 text-emerald-700 border-emerald-100\",\r\n      };\r\n    case \"ASSIGNED\":\r\n      return {\r\n        text: \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\",\r\n        className: \"bg-sky-50 text-sky-700 border-sky-100\",\r\n      };\r\n    case \"ON_ROUTE\":\r\n      return {\r\n        text: \"–ó–∞–º–¥\",\r\n        className: \"bg-indigo-50 text-indigo-700 border-indigo-100\",\r\n      };\r\n    case \"DELIVERED\":\r\n      return {\r\n        text: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\",\r\n        className: \"bg-slate-900 text-white border-slate-900\",\r\n      };\r\n    case \"DISPUTE\":\r\n      return {\r\n        text: \"–ú–∞—Ä–≥–∞–∞–Ω\",\r\n        className: \"bg-rose-50 text-rose-700 border-rose-100\",\r\n      };\r\n    case \"CLOSED\":\r\n      return {\r\n        text: \"–•–∞–∞–≥–¥—Å–∞–Ω\",\r\n        className: \"bg-emerald-900 text-emerald-50 border-emerald-900\",\r\n      };\r\n    case \"CANCELLED\":\r\n      return {\r\n        text: \"–¶—É—Ü–∞–ª—Å–∞–Ω\",\r\n        className: \"bg-rose-50 text-rose-700 border-rose-100\",\r\n      };\r\n    default:\r\n      return {\r\n        text: status,\r\n        className: \"bg-slate-50 text-slate-600 border-slate-100\",\r\n      };\r\n  }\r\n}\r\n\r\nfunction shorten(s: string | null, max = 110) {\r\n  if (!s) return \"\";\r\n  const t = s.trim();\r\n  if (t.length <= max) return t;\r\n  return t.slice(0, max).replace(/\\s+$/, \"\") + \"‚Ä¶\";\r\n}\r\n\r\nfunction formatPrice(n: number | null) {\r\n  if (!n) return \"“Æ–Ω—ç —Ç–æ—Ö–∏—Ä–æ–ª—Ü–æ–Ω–æ\";\r\n  return n.toLocaleString(\"mn-MN\") + \"‚ÇÆ\";\r\n}\r\n\r\nfunction formatDateTime(iso: string) {\r\n  const d = new Date(iso);\r\n  return (\r\n    d.toLocaleDateString(\"mn-MN\", { month: \"2-digit\", day: \"2-digit\" }) +\r\n    \" \" +\r\n    d.toLocaleTimeString(\"mn-MN\", { hour: \"2-digit\", minute: \"2-digit\" })\r\n  );\r\n}\r\n\r\nfunction filterByTab(tab: SellerTabId, items: DeliveryRow[]) {\r\n  return items.filter((d) => {\r\n    switch (tab) {\r\n      case \"OPEN\":\r\n        return d.status === \"OPEN\";\r\n      case \"ASSIGNED\":\r\n        return d.status === \"ASSIGNED\";\r\n      case \"ON_ROUTE\":\r\n        return d.status === \"ON_ROUTE\";\r\n      case \"DELIVERED\":\r\n        return d.status === \"DELIVERED\";\r\n      case \"DISPUTE\":\r\n        return d.status === \"DISPUTE\";\r\n      case \"CLOSED\":\r\n        return d.status === \"CLOSED\" || d.status === \"CANCELLED\";\r\n      default:\r\n        return true;\r\n    }\r\n  });\r\n}\r\n\r\n/* =========================== */\r\n\r\nexport default function SellerDashboardPage() {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n\r\n  const [user, setUser] = useState<IncomeUser | null>(null);\r\n  const [loadingUser, setLoadingUser] = useState(true);\r\n\r\n  const [deliveries, setDeliveries] = useState<DeliveryRow[]>([]);\r\n  const [loadingList, setLoadingList] = useState(true);\r\n\r\n  const [activeTab, setActiveTab] = useState<SellerTabId>(\"OPEN\");\r\n  const [message, setMessage] = useState<string | null>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // ‚úÖ Quick action loading: deliveryId -> boolean\r\n  const [quickLoading, setQuickLoading] = useState<Record<string, boolean>>({});\r\n\r\n  const filtered = useMemo(\r\n    () => filterByTab(activeTab, deliveries),\r\n    [activeTab, deliveries]\r\n  );\r\n\r\n  const tabCounts = useMemo(() => {\r\n    return SELLER_TABS.reduce((acc, t) => {\r\n      acc[t.id] = filterByTab(t.id, deliveries).length;\r\n      return acc;\r\n    }, {} as Record<SellerTabId, number>);\r\n  }, [deliveries]);\r\n\r\n  /* ---------- auth ---------- */\r\n  useEffect(() => {\r\n    const raw = window.localStorage.getItem(\"incomeUser\");\r\n    if (!raw) {\r\n      router.replace(\"/\");\r\n      return;\r\n    }\r\n    const parsed: IncomeUser = JSON.parse(raw);\r\n    if (parsed.role !== \"seller\") {\r\n      router.replace(\"/\");\r\n      return;\r\n    }\r\n    setUser(parsed);\r\n    setLoadingUser(false);\r\n  }, [router]);\r\n\r\n  /* ---------- tab init ---------- */\r\n  useEffect(() => {\r\n    const urlTab = searchParams.get(\"tab\");\r\n    if (urlTab && TAB_IDS.includes(urlTab as SellerTabId)) {\r\n      setActiveTab(urlTab as SellerTabId);\r\n      localStorage.setItem(\"sellerActiveTab\", urlTab);\r\n      return;\r\n    }\r\n    const stored = localStorage.getItem(\"sellerActiveTab\");\r\n    if (stored && TAB_IDS.includes(stored as SellerTabId)) {\r\n      setActiveTab(stored as SellerTabId);\r\n    }\r\n  }, [searchParams]);\r\n\r\n  function changeTab(tab: SellerTabId) {\r\n    setActiveTab(tab);\r\n    localStorage.setItem(\"sellerActiveTab\", tab);\r\n    router.push(`/seller?tab=${tab}`);\r\n  }\r\n\r\n  /* ---------- fetch ---------- */\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    void fetchDeliveries(user.id);\r\n  }, [user]);\r\n\r\n  async function fetchDeliveries(sellerId: string) {\r\n    try {\r\n      setLoadingList(true);\r\n      setError(null);\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"deliveries\")\r\n        .select(\r\n          `\r\n          id,\r\n          seller_id,\r\n          from_address,\r\n          to_address,\r\n          note,\r\n          status,\r\n          created_at,\r\n          price_mnt,\r\n          delivery_type,\r\n          seller_marked_paid,\r\n          driver_confirmed_payment,\r\n          closed_at,\r\n          seller_hidden,\r\n          chosen_driver_id,\r\n          driver_bids(count)\r\n        `\r\n        )\r\n        .eq(\"seller_id\", sellerId)\r\n        .eq(\"seller_hidden\", false)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n      if (error) throw error;\r\n\r\n      const rows: DeliveryRow[] = (data || []).map((d: any) => ({\r\n        id: d.id,\r\n        seller_id: d.seller_id,\r\n        from_address: d.from_address,\r\n        to_address: d.to_address,\r\n        note: d.note,\r\n        status: d.status,\r\n        created_at: d.created_at,\r\n        price_mnt: d.price_mnt,\r\n        delivery_type: d.delivery_type,\r\n        seller_marked_paid: !!d.seller_marked_paid,\r\n        driver_confirmed_payment: !!d.driver_confirmed_payment,\r\n        closed_at: d.closed_at,\r\n        seller_hidden: !!d.seller_hidden,\r\n        chosen_driver_id: d.chosen_driver_id ?? null,\r\n        bids_count:\r\n          Array.isArray(d.driver_bids) && d.driver_bids[0]?.count\r\n            ? Number(d.driver_bids[0].count)\r\n            : 0,\r\n      }));\r\n\r\n      setDeliveries(rows);\r\n    } catch {\r\n      setError(\"–•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n      setDeliveries([]);\r\n    } finally {\r\n      setLoadingList(false);\r\n    }\r\n  }\r\n\r\n  /* ‚úÖ QUICK: ASSIGNED -> ON_ROUTE + redirect */\r\n  async function handleQuickMarkOnRoute(deliveryId: string) {\r\n    if (!user) return;\r\n\r\n    setQuickLoading((prev) => ({ ...prev, [deliveryId]: true }));\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"deliveries\")\r\n        .update({ status: \"ON_ROUTE\" })\r\n        .eq(\"id\", deliveryId)\r\n        .eq(\"seller_id\", user.id)\r\n        .eq(\"status\", \"ASSIGNED\"); // —Ö–∞–º–≥–∞–∞–ª–∞–ª—Ç\r\n\r\n      if (error) {\r\n        console.error(error);\r\n        setError(\"‚Äú–•“Ø—Ä–≥—ç–ª—Ç—ç–¥ –≥–∞—Ä—Å–∞–Ω‚Äù —Ç—ç–º–¥—ç–≥–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.\");\r\n        return;\r\n      }\r\n\r\n      // UI –¥—ç—ç—Ä –ª–æ–∫–∞–ª update\r\n      setDeliveries((prev) =>\r\n        prev.map((d) => (d.id === deliveryId ? { ...d, status: \"ON_ROUTE\" } : d))\r\n      );\r\n\r\n      // ‚úÖ –®–£–£–î ON_ROUTE tab —Ä—É—É\r\n      localStorage.setItem(\"sellerActiveTab\", \"ON_ROUTE\");\r\n      router.push(\"/seller?tab=ON_ROUTE\");\r\n    } finally {\r\n      setQuickLoading((prev) => ({ ...prev, [deliveryId]: false }));\r\n    }\r\n  }\r\n\r\n  /* ---------- render ---------- */\r\n  if (loadingUser || loadingList) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-sm text-slate-500\">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞‚Ä¶</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-slate-50 flex items-center justify-center\">\r\n        <div className=\"text-sm text-slate-500\">–•—ç—Ä—ç–≥–ª—ç–≥—á –æ–ª–¥—Å–æ–Ω–≥“Ø–π.</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50\">\r\n      <header className=\"border-b border-slate-200 bg-white\">\r\n        <div className=\"max-w-3xl mx-auto px-4 py-4 flex items-center justify-between\">\r\n          <h1 className=\"text-sm font-semibold\">–•—É–¥–∞–ª–¥–∞–≥—á–∏–π–Ω —Å–∞–º–±–∞—Ä</h1>\r\n          <div className=\"flex gap-2\">\r\n            <button\r\n              onClick={() => router.push(\"/seller/new-delivery\")}\r\n              className=\"text-[11px] px-5 py-2 rounded-full bg-emerald-600 text-white font-semibold\"\r\n            >\r\n              + –•“Ø—Ä–≥—ç–ª—Ç –Ω—ç–º—ç—Ö\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      <main className=\"max-w-3xl mx-auto px-4 py-5 space-y-4\">\r\n        {message && (\r\n          <div className=\"rounded-2xl border border-emerald-100 bg-emerald-50 px-4 py-2 text-xs\">\r\n            {message}\r\n          </div>\r\n        )}\r\n        {error && (\r\n          <div className=\"rounded-2xl border border-rose-100 bg-rose-50 px-4 py-2 text-xs\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"rounded-2xl border border-slate-200 bg-white px-2 py-2 flex flex-wrap gap-1\">\r\n          {SELLER_TABS.map((tab) => (\r\n            <button\r\n              key={tab.id}\r\n              onClick={() => changeTab(tab.id)}\r\n              className={\r\n                \"text-[11px] px-3 py-1.5 rounded-full border \" +\r\n                (tab.id === activeTab\r\n                  ? \"bg-emerald-600 text-white border-emerald-600\"\r\n                  : \"bg-white text-slate-600 border-slate-200\")\r\n              }\r\n            >\r\n              {tab.label}\r\n              {tabCounts[tab.id] > 0 && (\r\n                <span className=\"ml-1\">({tabCounts[tab.id]})</span>\r\n              )}\r\n            </button>\r\n          ))}\r\n        </div>\r\n\r\n        <section className=\"space-y-3\">\r\n          {filtered.length === 0 ? (\r\n            <div className=\"rounded-2xl border border-dashed border-slate-200 bg-slate-50 px-4 py-6 text-center text-xs text-slate-500\">\r\n              –≠–Ω—ç —Ç–∞–± –¥—ç—ç—Ä –æ–¥–æ–æ–≥–æ–æ—Ä —Ö“Ø—Ä–≥—ç–ª—Ç –∞–ª–≥–∞ –±–∞–π–Ω–∞.\r\n            </div>\r\n          ) : (\r\n            filtered.map((d) => {\r\n              const t = typeLabel(d.delivery_type);\r\n              const sb = statusBadge(d.status);\r\n              const canQuickOnRoute = d.status === \"ASSIGNED\" && !!d.chosen_driver_id;\r\n\r\n              return (\r\n                <div\r\n                  key={d.id}\r\n                  className=\"w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 hover:border-emerald-300 hover:shadow-sm transition\"\r\n                >\r\n                  {/* CARD TOP */}\r\n                  <button\r\n                    onClick={() => router.push(`/seller/delivery/${d.id}?tab=${activeTab}`)}\r\n                    className=\"w-full text-left\"\r\n                  >\r\n                    <div className=\"space-y-1\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <span className=\"text-xs font-semibold\">\r\n                          #{d.id.slice(0, 6)}\r\n                        </span>\r\n\r\n                        <span\r\n                          className={\r\n                            \"inline-flex rounded-full border px-2 py-0.5 text-[10px] \" +\r\n                            sb.className\r\n                          }\r\n                        >\r\n                          {sb.text}\r\n                        </span>\r\n\r\n                        {d.status === \"OPEN\" && d.bids_count > 0 && (\r\n                          <span className=\"inline-flex rounded-full border border-amber-200 bg-amber-50 px-2 py-0.5 text-[10px] font-semibold text-amber-800\">\r\n                            –°–∞–Ω–∞–ª: {d.bids_count}\r\n                          </span>\r\n                        )}\r\n                      </div>\r\n\r\n                      <div className=\"flex items-center gap-2 text-[11px] text-slate-600\">\r\n                        <span>{t.icon}</span>\r\n                        <span className=\"font-medium\">{t.label}</span>\r\n                        <span>‚Ä¢</span>\r\n                        <span>{formatPrice(d.price_mnt)}</span>\r\n                      </div>\r\n\r\n                      <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2 text-[11px] text-slate-600\">\r\n                        <div>\r\n                          <div className=\"text-[10px] font-semibold text-slate-500\">\r\n                            –ê–í–ê–•\r\n                          </div>\r\n                          <p>{shorten(d.from_address, 60)}</p>\r\n                        </div>\r\n                        <div>\r\n                          <div className=\"text-[10px] font-semibold text-slate-500\">\r\n                            –•“Æ–†–ì–≠–•\r\n                          </div>\r\n                          <p>{shorten(d.to_address, 60)}</p>\r\n                        </div>\r\n                      </div>\r\n\r\n                      <p className=\"text-[10px] text-slate-400\">\r\n                        “Æ“Ø—Å–≥—ç—Å—ç–Ω: {formatDateTime(d.created_at)}\r\n                      </p>\r\n                    </div>\r\n                  </button>\r\n\r\n                  {/* QUICK ACTIONS (–∫–∞—Ä—Ç –¥—ç—ç—Ä —à—É—É–¥) */}\r\n                  {canQuickOnRoute && (\r\n                    <div className=\"mt-3 flex flex-wrap gap-2\">\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={(e) => {\r\n                          e.preventDefault();\r\n                          e.stopPropagation();\r\n                          void handleQuickMarkOnRoute(d.id);\r\n                        }}\r\n                        disabled={!!quickLoading[d.id]}\r\n                        className=\"text-[11px] px-4 py-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60\"\r\n                      >\r\n                        {quickLoading[d.id] ? \"–¢—ç–º–¥—ç–≥–ª—ç–∂ –±–∞–π–Ω–∞‚Ä¶\" : \"–•“Ø—Ä–≥—ç–ª—Ç—ç–¥ –≥–∞—Ä—Å–∞–Ω\"}\r\n                      </button>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              );\r\n            })\r\n          )}\r\n        </section>\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n"
      },
      {
        "path": "lib/deliveryLogic.ts",
        "summary": "",
        "content": "// ===================== lib/deliveryLogic.ts =====================\r\n// –•“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Å—Ç–∞—Ç—É—Å, —Ç–∞–±—É—É–¥—ã–Ω —Ç”©–≤–ª”©—Ä—Å”©–Ω –ª–æ–≥–∏–∫\r\n// - PAID —Å—Ç–∞—Ç—É—Å / —Ç–∞–± –∞—à–∏–≥–ª–∞—Ö–≥“Ø–π\r\n// - –¢”©–ª–±”©—Ä–∏–π–Ω —Ç–æ—Ö–∏—Ä–æ–æ: DELIVERED –¥—ç—ç—Ä seller_marked_paid + driver_confirmed_payment —Ö–æ—ë—É–ª–∞–∞ true –±–æ–ª CLOSED –±–æ–ª–Ω–æ.\r\n\r\nexport type DeliveryStatus =\r\n  | \"OPEN\"\r\n  | \"ASSIGNED\"\r\n  | \"ON_ROUTE\"\r\n  | \"DELIVERED\"\r\n  | \"DISPUTE\"\r\n  | \"CLOSED\"\r\n  | \"CANCELLED\";\r\n\r\n// ---------- SELLER TABS ----------\r\n\r\nexport type SellerTabId =\r\n  | \"OPEN\"\r\n  | \"ASSIGNED\"\r\n  | \"ON_ROUTE\"\r\n  | \"DELIVERED\"\r\n  | \"DISPUTE\"\r\n  | \"CLOSED\";\r\n\r\nexport const SELLER_TABS: { id: SellerTabId; label: string }[] = [\r\n  { id: \"OPEN\", label: \"–ù—ç—ç–ª—Ç—Ç—ç–π\" },\r\n  { id: \"ASSIGNED\", label: \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\" },\r\n  { id: \"ON_ROUTE\", label: \"–ó–∞–º–¥\" },\r\n  { id: \"DELIVERED\", label: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\" },\r\n  { id: \"DISPUTE\", label: \"–ú–∞—Ä–≥–∞–∞–Ω\" },\r\n  { id: \"CLOSED\", label: \"–•–∞–∞–≥–¥—Å–∞–Ω\" },\r\n];\r\n\r\n// ---------- DRIVER TABS ----------\r\n\r\nexport type DriverTabId =\r\n  | \"OPEN\"\r\n  | \"ASSIGNED\"\r\n  | \"ON_ROUTE\"\r\n  | \"DELIVERED\"\r\n  | \"CLOSED\"\r\n  | \"DISPUTE\";\r\n\r\nexport const DRIVER_TABS: { id: DriverTabId; label: string }[] = [\r\n  { id: \"OPEN\", label: \"–ù—ç—ç–ª—Ç—Ç—ç–π\" },\r\n  { id: \"ASSIGNED\", label: \"–ù–∞–º–∞–π–≥ —Å–æ–Ω–≥–æ—Å–æ–Ω\" },\r\n  { id: \"ON_ROUTE\", label: \"–ó–∞–º–¥\" },\r\n  { id: \"DELIVERED\", label: \"–•“Ø—Ä–≥—ç—Å—ç–Ω\" },\r\n  { id: \"CLOSED\", label: \"–•–∞–∞–≥–¥—Å–∞–Ω\" },\r\n  { id: \"DISPUTE\", label: \"–ú–∞—Ä–≥–∞–∞–Ω—Ç–∞–π\" }, // ‚úÖ —Ö–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–¥\r\n];\r\n\r\n// ---------- –¢–£–°–õ–ê–• ----------\r\n\r\n// –°—Ç–∞—Ç—É—Å—ã–≥ –º–æ–Ω–≥–æ–ª–æ–æ—Ä\r\nexport function statusLabel(status: DeliveryStatus): string {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return \"–ù—ç—ç–ª—Ç—Ç—ç–π\";\r\n    case \"ASSIGNED\":\r\n      return \"–ñ–æ–ª–æ–æ—á —Å–æ–Ω–≥–æ—Å–æ–Ω\";\r\n    case \"ON_ROUTE\":\r\n      return \"–ó–∞–º–¥\";\r\n    case \"DELIVERED\":\r\n      return \"–•“Ø—Ä–≥—ç—Å—ç–Ω\";\r\n    case \"DISPUTE\":\r\n      return \"–ú–∞—Ä–≥–∞–∞–Ω\";\r\n    case \"CLOSED\":\r\n      return \"–•–∞–∞–≥–¥—Å–∞–Ω\";\r\n    case \"CANCELLED\":\r\n      return \"–¶—É—Ü–∞–ª—Å–∞–Ω\";\r\n    default:\r\n      return status;\r\n  }\r\n}\r\n\r\n// –•–∞–∞–ª—Ç—Ç–∞–π –∞–Ω–≥–∏–ª–∞–ª\r\nexport function isClosedStatus(status: DeliveryStatus): boolean {\r\n  return status === \"CLOSED\" || status === \"CANCELLED\";\r\n}\r\n\r\n// Status ‚Üí SellerTab\r\nexport function getSellerTabForStatus(status: DeliveryStatus): SellerTabId {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return \"OPEN\";\r\n    case \"ASSIGNED\":\r\n      return \"ASSIGNED\";\r\n    case \"ON_ROUTE\":\r\n      return \"ON_ROUTE\";\r\n    case \"DELIVERED\":\r\n      return \"DELIVERED\";\r\n    case \"DISPUTE\":\r\n      return \"DISPUTE\";\r\n    case \"CLOSED\":\r\n    case \"CANCELLED\":\r\n      return \"CLOSED\";\r\n  }\r\n}\r\n\r\n// Status ‚Üí DriverTab\r\nexport function getDriverTabForStatus(status: DeliveryStatus): DriverTabId {\r\n  switch (status) {\r\n    case \"OPEN\":\r\n      return \"OPEN\";\r\n    case \"ASSIGNED\":\r\n      return \"ASSIGNED\";\r\n    case \"ON_ROUTE\":\r\n      return \"ON_ROUTE\";\r\n    case \"DELIVERED\":\r\n      return \"DELIVERED\";\r\n    case \"CLOSED\":\r\n    case \"CANCELLED\":\r\n      return \"CLOSED\";\r\n    case \"DISPUTE\":\r\n      return \"DISPUTE\";\r\n  }\r\n}\r\n\r\n// CLOSED –±–æ–ª–æ—Ö —ë—Å—Ç–æ–π —ç—Å—ç—Ö (—Ç–æ–≤—á –Ω—ç–≥ –≥–∞–∑–∞—Ä)\r\n// ‚úÖ –∑”©–≤—Ö”©–Ω DELIVERED –¥—ç—ç—Ä 2 —Ç–∞–ª—ã–Ω —Ç”©–ª–±”©—Ä –±–∞—Ç–ª–∞–≥–¥–≤–∞–ª —Ö–∞–∞–≥–¥–∞–Ω–∞\r\nexport function shouldCloseDelivery(input: {\r\n  status: DeliveryStatus;\r\n  seller_marked_paid: boolean;\r\n  driver_confirmed_payment: boolean;\r\n}): boolean {\r\n  return (\r\n    input.status === \"DELIVERED\" &&\r\n    !!input.seller_marked_paid &&\r\n    !!input.driver_confirmed_payment\r\n  );\r\n}\r\n\r\n// ---------- –ú–∞—Ä–≥–∞–∞–Ω –Ω—ç—ç—Ö –±–æ–ª–æ–º–∂ ----------\r\n// ‚úÖ –ñ–æ–ª–æ–æ—á —Ç–∞–ª: ON_ROUTE —ç—Å–≤—ç–ª DELIVERED “Ø–µ–¥ (—Ç–∞–Ω–∞–π Driver detail –ª–æ–≥–∏–∫—Ç–æ–π —Ç–∞–∞—Ä—É—É–ª—Å–∞–Ω)\r\nexport function canOpenDisputeForDriver(status: DeliveryStatus): boolean {\r\n  return status === \"ON_ROUTE\" || status === \"DELIVERED\";\r\n}\r\n"
      },
      {
        "path": "lib/supabase.ts",
        "summary": "",
        "content": "// lib/supabase.ts\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nexport const supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n);\r\n"
      },
      {
        "path": "lib/types.ts",
        "summary": "",
        "content": "// lib/types.ts\r\n// –ê–ø–ø –¥–∞—è–∞—Ä –∞—à–∏–≥–ª–∞—Ö “Ø–Ω–¥—Å—ç–Ω —Ç”©—Ä–ª“Ø“Ø–¥\r\n\r\nexport type Role = \"seller\" | \"driver\";\r\n\r\nexport type IncomeUser = {\r\n  id: string;\r\n  role: Role;\r\n  name: string;\r\n  phone: string;\r\n  email: string;\r\n};\r\n"
      }
    ]
  }
}